# API漂移的浪潮：使用模拟来保持稳定

![Featued image for: The Tidal Wave of API Drift: Use Mocking To Stay Afloat](https://cdn.thenewstack.io/media/2024/11/b4281d27-surfing-1024x575.png)

*一个两部分系列中的第一部分*

随着[APIs](https://www.getambassador.io/blog/api-development-comprehensive-guide) 的发展，它们面临着一个常见的问题：API漂移。

API漂移是指API的实际实现随着时间的推移偏离其已记录或预期的设计（规范）的情况。这是一个日益严重的问题，它会困扰开发团队，导致代价高昂的错误，并最终影响最终用户。它还会给维护向后兼容性带来挑战，从而产生破坏开发人员依赖系统的一致性问题。

由于API是关键集成的基础，即使是很小的更改也会在整个生态系统中产生连锁反应，导致停机或代价高昂的修复。在处理API漂移时，它常常让人感觉像是一股错误的潮流，席卷了您的开发团队和安心感。

在您“漂流”出海之前，请了解，管理这种漂移需要清晰的版本控制、强大的测试和有效的沟通，以保持稳定性和信任。现在，这听起来像是很多工作。但是，有一个救生衣——在这种情况下，您的模拟能力——可以决定您在开发旅程中是沉是浮。

**关于API漂移的详解**

从根本上说，当API在功能、格式或结构方面承诺交付的内容（通常在[API文档](https://www.getambassador.io/blog/api-documentation-done-right-technical-guide)中说明）与它在运行时实际交付的内容不匹配时，API漂移就显而易见了。

文档是蓝图，指导开发人员如何使用API，预期什么数据以及系统将如何响应。但在快速发展的项目中，对实现的更改可能会超过对文档的更新，反之亦然。这种差距造成了API漂移，这可能会导致许多问题。

**API漂移的后果**

**预期不符**: 开发人员需要清晰的API文档来了解端点应该如何运行，预期什么数据格式以及如何有效地集成API。当存在脱节时，开发人员可能会基于过时或不正确的假设进行编码，从而导致本可以在文档与实际实现一致的情况下避免的错误。这会导致不必要的挫败感，糟糕的[开发者体验](https://blog.getambassador.io/tagged/developer-experience)和潜在的项目延误。

**重大更改**: 即使是看似很小的更改，例如重命名字段或更改答案类型，也会影响依赖于API的应用程序。由于许多API支持关键应用程序，这些看似很小的更改可能会导致严重的后果，包括部分中断或应用程序完全失败。如果未记录此类重大更改，用户在尝试解决问题时可能会发现自己处于困境，通常缺乏对根本问题的清晰理解。

**耗时的返工**: 当开发人员遇到API的意外行为时，他们经常不得不更改其实现以适应这些更改。这导致时间损失，有时需要额外的冲刺来排除故障并重新调整功能。开发人员花费宝贵的时间甚至几天来解决本可以通过清晰一致的API文档避免的问题。

**增加的支持请求**: 不一致的API会导致支持请求激增，这会减慢响应时间并让只想让其集成顺利运行的用户感到沮丧。这种情况可能会破坏开发人员和API提供商之间的信任，尤其是在问题似乎持续存在或被忽视的情况下。下游影响还会导致更高的成本，因为需要更多资源来管理支持渠道。

**API模拟作为避免API漂移的主动解决方案**

使用[API模拟](https://www.google.com/aclk?sa=l&ai=DChcSEwj87PfCueaJAxVS28IEHQiuIvUYABAAGgJwdg&co=1&ase=2&gclid=Cj0KCQiA6Ou5BhCrARIsAPoTxrAjT4YQWW8GH49XpZio99GdU56PL1W_WmCNbLTVOzydCXu6zyzz-q8aAu1mEALw_wcB&sig=AOD64_3Cecdtx73p5Lgq99rRC7Nm_JeNbg&q&nis=4&adurl&ved=2ahUKEwj4l_HCueaJAxUMweYEHYrXF24Q0Qx6BAgLEAE)是阻止API漂移的最佳策略之一。创建模拟API响应以反映实际API的预期行为是[API模拟](https://www.getambassador.io/blog/api-mocking-guide) 的本质。使用[模拟有助于开发人员标准化API交互](https://www.getambassador.io/blog/api-mocking-guide)，从而保证他们创建的功能与API的预期标准相匹配。模拟不仅在开发过程中很有帮助，而且还有助于防止漂移，因为它为API的预期行为提供了一个参考，即使在实际实现未来演变的情况下也是如此。
API 模拟帮助团队：

**测试一致性**: 验证API是否按规定执行有助于开发人员尽早发现不匹配之处，从而减少可能的漂移潜力。**减少对实时API的依赖**: 通过使用模拟响应，团队即使在API发生变化时也能保持一致性，从而减少对实时API的依赖，并使开发能够不受实际API变化的影响而进行。**提高文档准确性**: 模拟响应提供了API应如何运行的模型，从而能够创建正确的文档，并可以轻松地与实际部署进行检查。
API 模拟不仅帮助团队更高效地运行，而且还增强了对API的可靠性和性能的信任。

## API 模拟在解决API漂移中的作用
API 模拟已成为现代软件开发中的一种重要策略，特别是对于那些希望确保API文档和实现之间一致性的团队而言。模拟允许开发人员模仿API的响应，而无需使用实时后端，从而提供API在不同情况下应如何运行的清晰且可靠的快照。这种一致性对于防止API漂移至关重要，因为它保证了前端和后端团队都对API的预期结构、功能和数据流具有共同的认识。

诸如[Blackbird](https://www.getambassador.io/products/blackbird/api-development)之类的API开发工具通过允许开发人员立即启动模拟服务器并通过内置的灵活性和速度使所有参与者满意，从而节省了时间。您甚至可以免费试用30天的模拟功能[通过此页面](https://blackbird.a8r.io/login)。

**我为什么要关心模拟？**
API 模拟需要开发模拟或“模拟”版本的API，该版本会生成对请求的预定响应。模拟通过使用预定义的规范或文档来模拟API的预期响应——而不是使用实时API进行测试，这需要一个完全可运行的后端。这使开发人员能够与API交互，就好像它在线一样，无论后端是否仍在开发过程中、不可预测或容易发生频繁更改。

模拟通过响应API请求返回特定的JSON或XML响应来实现其功能。开发人员能够控制模拟API的各种组件，例如：

**数据结构**: 定义预期的响应结构。**响应类型**: 确保模拟答案符合文档中指定的类型。**错误处理**: 配置如何返回错误以表示可能的API故障场景。
API 模拟提供了一个沙盒环境，开发人员可以在其中评估应用程序逻辑、检查响应结构并在任何实时API可用之前确认行为，方法是模拟实际API应如何运行。

**开发过程中可靠且一致的参考点**
API 模拟的主要好处是它能够充当一致的参考点，从而指导开发朝着预期的设计和标准发展。通过强制使用API的静态版本，模拟在更改文档和实现时提供稳定性。由于此静态版本不会因后端更改而发生变化，因此开发人员可以放心地工作，因为他们的代码将与预期功能匹配。

模拟通过充当一致的API替代品来减少对后端开发的依赖，从而使前端团队能够在无需持续担心后端更改的情况下继续工作。模拟基本上在前端和后端团队之间提供了一个“契约”，其中商定的API结构独立于各个开发进度或意外的后端延迟而得以保留。

[使用模拟的好处](https://www.getambassador.io/blog/api-mocking-benefits-best-practices-guide)包括镜像预期的API结构：
**数据结构的准确性和一致性**: 使用模拟数据时，开发人员使用的数据结构精确地反映了声明的API。尤其是在多个团队参与同一个项目的情况下，这种准确性有助于防止对API设计的任何误解。当实际API准备就绪时，开发人员确切地知道预期哪些数据格式，从而减少了代码重写的需求。避免数据格式、嵌套和键名上的差异，否则会导致恼人的调试会话，这尤其取决于这一点。

**稳定的测试环境**: API模拟提供了一个可靠的测试环境，消除了对实际API可用性和性能的依赖。当使用实际API时，开发人员经常受制于后端团队的进度、维护计划和升级。模拟允许团队在无需等待后端启动或完成的情况下运行测试。这种稳定性能够实现更快的原型设计、持续测试和更大的灵活性，同时保证API行为与文档一致。

**降低重大更改的风险**: API模拟作为一种预防重大更改的措施，因为它提供了API的可信副本。因为模拟版本将始终如一地运行，所以开发人员可以自信地构建和测试代码。由于任何与模拟API的偏差都将立即显而易见，因此这降低了最终连接实际API时发生重大更改的可能性。

**模拟支持前端和后端团队**

API模拟以不同但互补的方式帮助前端和后端团队。它确保每个人都从相同的基准出发，并知道预期结果是什么。

**前端团队**使用API模拟生成的数据来创建和测试接口，验证数据格式并确保应用程序逻辑与预期回复匹配。例如，如果前端团队正在开发一个电子商务平台，他们可以使用模拟来测试产品列表、购物车和用户帐户。这些模拟允许前端团队彻底测试UI和UX，而无需等待后端端点完成。模拟还允许前端团队复制各种场景，包括成功的产品结账、无效的支付问题和网络超时。这对于开发一个健壮且响应迅速的界面至关重要，该界面可以优雅地处理成功和错误的答案，从而降低集成实际API时出现意外问题的可能性。

**后端团队**可以在与前端团队集成实际API之前，检查他们正在处理的回复是否符合商定的结构。模拟允许后端开发人员确认每个端点都提供正确的数据结构和响应类型，以及根据文档测试端点功能。模拟测试允许后端团队确认他们的输出是准确的，并且与前端开发人员测试他们自己的端点时所要求的一致。在处理遗留系统或外部供应商时，后端团队尤其受益于API模拟。后端团队可以通过模拟外部来源的响应来扩展和测试他们自己的系统。例如，如果他们正在开发一个依赖于外部支付网关的支付处理API，则后端团队可以复制外部支付网关的回复以复制支付成功、失败和其他结果。这使后端开发人员能够管理各种情况，而无需依赖外部供应商的可用性或一致性。

然而，API模拟的好处不仅仅局限于测试。模拟是一种主动的方法，可以防止API漂移并保持文档和实现的完整性。

## API漂移对变更管理的影响

[API生命周期](https://www.getambassador.io/blog/optimizing-api-lifecycle-complete-guide)中的变更管理是一种系统化的技术，用于在API更改部署之前跟踪、评估和批准这些更改。此过程旨在确定API更新如何、何时以及为何发生，确保更改得到适当的规划、审查和沟通。在API生命周期中，变更管理通常包括三个关键组成部分：

* **监控**: 持续检查API的使用情况、性能以及与其他系统的兼容性。
* **审批流程**: 审查建议的修改，确定其可能的影响并获得必要的权限。
* **部署**: 在受控环境中实施更改的过程，这通常从登台阶段开始，然后才能全面投入生产。

通过遵循这些流程，变更管理降低了API相关应用程序和服务意外中断的可能性。但是，API漂移会造成不一致，从而难以准确评估、规划和批准修改。

**API漂移如何使变更管理复杂化**
API漂移导致API的文档行为与实际行为之间出现差异，从而无法精确跟踪和协作，这对于高效的变更管理至关重要。随着漂移的累积，在不产生意外后果的情况下管理API修改变得越来越困难。以下是漂移如何阻碍变更管理：

**跟踪变更变得具有挑战性**: 变更管理最核心的方面之一是跟踪API的更改，这些更改范围从小小的调整到大功能的升级。当出现API漂移时，文档可能无法代表API的当前状态，使团队难以了解所有更改的整体情况。这可能会导致开发团队无意中实施破坏现有功能或引入安全漏洞的修改，仅仅是因为文档与现实之间存在不匹配。

**破坏性变更的可能性增加**: 在理想的变更管理工作流程中，会评估API更新以避免引入破坏性变更，这些变更会扰乱现有用户与API的交互方式。然而，API漂移会掩盖修改的可能影响，从而导致意外的破坏性变更。例如，如果实际实现与声明的响应结构不同，开发人员可能会发布一个更改，认为它是向后兼容的，但客户端却会遇到集成中断的情况。

**沟通变更的难度**: 有效的变更管理主要取决于沟通API变更，特别是对于服务于多个团队或外部合作伙伴的API。漂移使沟通更具挑战性，因为它质疑文档和执行之间不一致的真正变化是什么。由此产生的不清晰的发布说明可能会导致API提供者和用户之间产生误解，从而损害对API可靠性的信任。

**准确的实时数据对于变更管理至关重要**

有效的变更管理依赖于准确的实时数据，尤其是在多个团队依赖于同一个API或为其自身的流程做出贡献的情况下。这种实时准确性使团队能够了解API的当前状态，并确定更改将如何影响用户。在连接普遍且相互关联的复杂系统中，最大限度地减少干扰需要准确了解API的行为。

因此，变更管理策略必须结合能够保证文档和实现保持一致的工具和技术。这种一致性有助于团队维护API的实时知识，从而能够跟踪和批准修改，从而降低漂移的风险。因此，在复杂的系统中，实时数据的准确性至关重要，原因如下：

**跨依赖项的即时影响评估**: 复杂系统中的API可能依赖于多个服务和团队。实时数据允许变更管理人员快速找到哪些部分可能会受到更改的影响，即使这些更改仍在提案中。准确的当前数据允许团队复制这些依赖项并测试任何修改的影响，从而降低突破的可能性，并保证在关联系统中高效管理更改。

**增强的协作和可见性**: 许多公司都有多个团队依赖于或贡献于单个API，包括前端、后端和外部开发人员。实时数据的透明度使每个团队都能保持对API在任何时刻应如何运行的共同认识。这种开放性降低了误解的可能性，增强了协调性，并保证每个修改都针对相同的准确基线进行评估。

**降低累积漂移的风险**: 实时数据还有助于防止累积漂移。当文档和实现处于持续观察和改进状态时，漂移的可能性较小。及早发现更改使团队能够根据需要修改文档和执行。此技术产生更紧密的反馈循环，因此任何偏差都会尽早发现并纠正，以免成为更大的问题。

在本模拟系列的第二部分中，我将进一步探讨API模拟与有效的变更管理之间的关系，远远超出漂移的基础知识。敬请期待，同时，请查看API模拟工具，例如[Blackbird](http://getblackbird.io)，并亲自试用一下。

[YOUTUBE.COM/THENEWSTACK 技术发展迅速，不要错过任何一集。订阅我们的YouTube频道，收看我们所有的播客、访谈、演示等等。](https://youtube.com/thenewstack?sub_confirmation=1)