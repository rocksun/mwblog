<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="norton-safeweb-site-verification" content="24usqpep0ejc5w6hod3dulxwciwp0djs6c6ufp96av3t4whuxovj72wfkdjxu82yacb7430qjm8adbd5ezlt4592dq4zrvadcn9j9n-0btgdzpiojfzno16-fnsnu7xd" />
        
        <link rel="preconnect" href="https://substackcdn.com" />
        

        

        
        <link rel="preload" as="style" href="https://substackcdn.com/bundle/theme/main.8b99fa5d20dee4ffcfea.css" />
        
        <link rel="preload" as="style" href="https://substackcdn.com/bundle/theme/color_links.33eb7c3bd37d78bc2dc3.css" />
        
        
        

        
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/entry-bf738a91.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/index-63233a1b.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/user-51b02764.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/FlexBox-16929af4.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/free_email_form-25f68dbb.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/Modal-507c84e7.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/app_install_modal-1b80d39d.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/IntroPopup-96bfa55d.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/Banner-cc32eba2.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/NavbarUserWidget-a83cba36.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/homepage_hooks-fbc8ad3d.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/sortBy-cf4e318d.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/HoverCard-41ea4b50.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/_defineProperty-213a01f6.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/Tooltip-d0af0cf2.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/Divider-f25512a6.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/Progress-f0f26f86.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/Menu-2d943942.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/Select-317e3505.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/ProfileHoverCard-739c5a84.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/UserBadge-fb9c174e.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/user_indicator-c1a5a8fb.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/ShareableImageModal-6a735338.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/object-9cd347fc.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/PubAccentTheme-e486b485.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/overflow_menu-db9a534e.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/newsletter_item_list-03468b3d.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/ProfileSetupToast-60e0a843.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/CommunityPostView-7e76b08b.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/Attachments-7f30a20d.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/CommentBody-14e5209b.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/AlertDialog-5fcadbc2.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/Popover-184969d7.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/ChatAppUpsell-fcae8c79.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/post-7847bb1a.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/FollowPrompt-a56b28dc.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/VideoVerticalMenu-80ba221a.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/facepile-2e21e967.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/mention-c16644d6.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/ImageViewerModal-1fbca395.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/Recipe-53df0851.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/recommend_linked_publication_modal-c1f05406.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/AuditionPlayer-5637d633.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/TabBar-0bad8701.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/comments_page-83ec46a1.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/RewardBox-5297e7a9.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/Field-cea155ef.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/Radio-148681a8.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/Logo-f0548763.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/FilePicker-ceb0fe25.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/setup_all_podcasts-b481ea39.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/CookieConsentFooter-0d9aca19.css" />
            
        

        
        
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
        <meta name="author" content="CSS Engineering" />
        <meta property="og:url" content="https://techblog.citystoragesystems.com/p/kubernetes-self-healing" />
        <title data-preact-helmet>From Fragile to Faultless: Kubernetes Self-Healing In Practice</title>
        <meta data-preact-helmet name="theme-color" content="#151513"><meta data-preact-helmet property="og:type" content="article"><meta data-preact-helmet property="og:title" content="From Fragile to Faultless: Kubernetes Self-Healing In Practice"><meta data-preact-helmet name="twitter:title" content="From Fragile to Faultless: Kubernetes Self-Healing In Practice"><meta data-preact-helmet name="description" content="Overcoming imperfections of managed Kubernetes with early self-healing."><meta data-preact-helmet property="og:description" content="Overcoming imperfections of managed Kubernetes with early self-healing."><meta data-preact-helmet name="twitter:description" content="Overcoming imperfections of managed Kubernetes with early self-healing."><meta data-preact-helmet property="og:image" content="https://substackcdn.com/image/fetch/w_1200,h_600,c_fill,f_jpg,q_auto:good,fl_progressive:steep,g_auto/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F11e401f2-cdd8-440b-89eb-7f6eaeeb3aae_1689x990.png"><meta data-preact-helmet name="twitter:image" content="https://substackcdn.com/image/fetch/f_auto,q_auto:best,fl_progressive:steep/https%3A%2F%2Fengineering4citystoragesystems.substack.com%2Fapi%2Fv1%2Fpost_preview%2F145625273%2Ftwitter.jpg%3Fversion%3D4"><meta data-preact-helmet name="twitter:card" content="summary_large_image">
        <link rel="canonical" href="https://techblog.citystoragesystems.com/p/kubernetes-self-healing" />

        

        

        
            
                <link rel="shortcut icon" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57c6bdf0-e917-4c62-a93b-73dc08f52ce5%2Ffavicon.ico">
            
        
            
                <link rel="icon" type="image/png" sizes="16x16" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57c6bdf0-e917-4c62-a93b-73dc08f52ce5%2Ffavicon-16x16.png">
            
        
            
                <link rel="icon" type="image/png" sizes="32x32" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57c6bdf0-e917-4c62-a93b-73dc08f52ce5%2Ffavicon-32x32.png">
            
        
            
                <link rel="icon" type="image/png" sizes="48x48" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57c6bdf0-e917-4c62-a93b-73dc08f52ce5%2Ffavicon-48x48.png">
            
        
            
                <link rel="apple-touch-icon" sizes="57x57" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57c6bdf0-e917-4c62-a93b-73dc08f52ce5%2Fapple-touch-icon-57x57.png">
            
        
            
                <link rel="apple-touch-icon" sizes="60x60" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57c6bdf0-e917-4c62-a93b-73dc08f52ce5%2Fapple-touch-icon-60x60.png">
            
        
            
                <link rel="apple-touch-icon" sizes="72x72" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57c6bdf0-e917-4c62-a93b-73dc08f52ce5%2Fapple-touch-icon-72x72.png">
            
        
            
                <link rel="apple-touch-icon" sizes="76x76" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57c6bdf0-e917-4c62-a93b-73dc08f52ce5%2Fapple-touch-icon-76x76.png">
            
        
            
                <link rel="apple-touch-icon" sizes="114x114" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57c6bdf0-e917-4c62-a93b-73dc08f52ce5%2Fapple-touch-icon-114x114.png">
            
        
            
                <link rel="apple-touch-icon" sizes="120x120" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57c6bdf0-e917-4c62-a93b-73dc08f52ce5%2Fapple-touch-icon-120x120.png">
            
        
            
                <link rel="apple-touch-icon" sizes="144x144" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57c6bdf0-e917-4c62-a93b-73dc08f52ce5%2Fapple-touch-icon-144x144.png">
            
        
            
                <link rel="apple-touch-icon" sizes="152x152" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57c6bdf0-e917-4c62-a93b-73dc08f52ce5%2Fapple-touch-icon-152x152.png">
            
        
            
                <link rel="apple-touch-icon" sizes="167x167" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57c6bdf0-e917-4c62-a93b-73dc08f52ce5%2Fapple-touch-icon-167x167.png">
            
        
            
                <link rel="apple-touch-icon" sizes="180x180" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57c6bdf0-e917-4c62-a93b-73dc08f52ce5%2Fapple-touch-icon-180x180.png">
            
        
            
                <link rel="apple-touch-icon" sizes="1024x1024" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57c6bdf0-e917-4c62-a93b-73dc08f52ce5%2Fapple-touch-icon-1024x1024.png">
            
        
            
        
            
        
            
        

        

        
            <link rel="alternate" type="application/rss+xml" href="/feed" title="City Storage Systems"/>
        

        
        

        <style>:root{--color_theme_bg_pop:#464EE7;--background_pop:#464EE7;--color_theme_bg_web:#151513;--cover_bg_color:#151513;--background_pop_darken:#2f38e4;--print_on_pop:#ffffff;--color_theme_bg_pop_darken:#2f38e4;--color_theme_print_on_pop:#ffffff;--border_subtle:rgba(68, 68, 66, 0.5);--background_subtle:rgba(227, 228, 251, 0.4);--print_pop:#464ee7;--color_theme_accent:#464ee7;--cover_print_primary:#ffffff;--cover_print_secondary:#d9d9d9;--cover_border_color:#ffffff;--font_family_headings_preset:'SF Pro Display', -apple-system, system-ui, BlinkMacSystemFont, 'Inter', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';--font_weight_headings_preset:900;--font_family_body_preset:'SF Pro Display', -apple-system, system-ui, BlinkMacSystemFont, 'Inter', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';--font_weight_body_preset:400;--font_preset_heading:heavy_sans;--font_preset_body:sans;--home_hero:newspaper;--home_posts:list;--web_bg_color:#151513;--background_contrast_1:#232321;--color_theme_bg_contrast_1:#232321;--background_contrast_2:#353533;--color_theme_bg_contrast_2:#353533;--background_contrast_3:#575756;--color_theme_bg_contrast_3:#575756;--background_contrast_4:#797977;--color_theme_bg_contrast_4:#797977;--background_contrast_5:#b5b5b4;--color_theme_bg_contrast_5:#b5b5b4;--color_theme_detail:#2c2c2b;--background_contrast_pop:rgba(70, 78, 231, 0.4);--color_theme_bg_contrast_pop:rgba(70, 78, 231, 0.4);--input_background:#21211f;--cover_input_background:#21211f;--tooltip_background:#414140;--web_bg_color_h:60;--web_bg_color_s:5%;--web_bg_color_l:7.8431372549019605%;--print_on_web_bg_color:#ffffff;--print_secondary_on_web_bg_color:#a1a1a1;--selected_comment_background_color:#201c14;--background_pop_rgb:70, 78, 231;--background_pop_rgb_pc:70 78 231;--color_theme_bg_pop_rgb:70, 78, 231;--color_theme_bg_pop_rgb_pc:70 78 231;--color_theme_accent_rgb:70, 78, 231;--color_theme_accent_rgb_pc:70 78 231;}</style>

        
            <link rel="stylesheet" href="https://substackcdn.com/bundle/theme/main.8b99fa5d20dee4ffcfea.css" />
        
            <link rel="stylesheet" href="https://substackcdn.com/bundle/theme/color_links.33eb7c3bd37d78bc2dc3.css" />
        

        <style></style>

        

        

        
    </head>

    <body class="">
        

        

        <div id="entry">
            <div id="main" class="main typography use-theme-bg"><div data-testid="navbar" class="main-menu animated with-wordmark"><div class="main-menu-content"><div class="topbar"><div class="topbar-content"><div class="navbar-logo-container"><a href="/" native><img src="https://substackcdn.com/image/fetch/w_96,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00427a51-29da-4fd7-b0ea-75bf09b879c5_512x512.png" class="navbar-logo" /></a></div><h1 class="navbar-title left-align loading"><a href="/" native class="navbar-title-link"><img src="https://substackcdn.com/image/fetch/e_trim:10:white/e_trim:10:transparent/h_72,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F494bd983-fb57-4ec0-ac8e-d62647802192_2688x512.jpeg" alt="City Storage Systems" class="navbar-logo-wordmark" /></a></h1><div class="navbar-buttons"><div class="pencraft pc-display-contents pc-reset _pubTheme_1lb4s_1"><div style="width: 40px;" class="pencraft pc-display-flex pc-gap-4 pc-paddingLeft-0 pc-justifyContent-center pc-alignItems-center pc-reset _searchWrapper_933k8_1 _marginRight_933k8_19"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--color-fg-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search " area-hidden="true"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></svg></div><button tabIndex="0" type="button" aria-label="Share Publication" id="trigger388863" aria-expanded="false" aria-haspopup="dialog" aria-controls="dialog388864" ariaLabel="View more" class="pencraft pc-reset pencraft _iconButton2_kqk6u_628 _iconButtonBase_kqk6u_145 _buttonBase_kqk6u_1 _buttonNew_kqk6u_83 _size_md_kqk6u_127 _priority_tertiary_kqk6u_69"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-share "><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" x2="12" y1="2" y2="15"></line></svg></button><button tabIndex="0" type="button" data-testid="noncontributor-cta-button" class="pencraft pc-reset pencraft _buttonBase_kqk6u_1 _button_kqk6u_1 _buttonNew_kqk6u_83 _button2_kqk6u_117 _priority_primary_kqk6u_57 _size_md_kqk6u_127">Subscribe</button><button tabIndex="0" type="button" native="true" data-href="https://substack.com/sign-in?redirect=%2Fp%2Fkubernetes-self-healing&amp;for_pub=engineering4citystoragesystems" class="pencraft pc-reset pencraft _buttonBase_kqk6u_1 _button_kqk6u_1 _buttonNew_kqk6u_83 _button2_kqk6u_117 _priority_tertiary_kqk6u_69 _size_md_kqk6u_127">Sign in</button></div></div></div></div></div><div class="topbar-spacer"></div></div><div><script type="application/ld+json">{"@context":"https://schema.org","@type":"NewsArticle","url":"https://techblog.citystoragesystems.com/p/kubernetes-self-healing","mainEntityOfPage":"https://techblog.citystoragesystems.com/p/kubernetes-self-healing","headline":"From Fragile to Faultless: Kubernetes Self-Healing In Practice","description":"Overcoming imperfections of managed Kubernetes with early self-healing.","image":[{"@type":"ImageObject","url":"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F11e401f2-cdd8-440b-89eb-7f6eaeeb3aae_1689x990.png"}],"datePublished":"2024-06-15T14:01:47+00:00","dateModified":"2024-06-15T14:01:47+00:00","isAccessibleForFree":true,"author":{"@type":"Organization","name":"City Storage Systems","url":"https://techblog.citystoragesystems.com","description":"Engineering the future of food at Otter & CloudKitchens","interactionStatistic":{"@type":"InteractionCounter","name":"Subscribers","interactionType":"https://schema.org/SubscribeAction","userInteractionCount":100},"identifier":"pub:2259056","logo":{"@type":"ImageObject","url":"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00427a51-29da-4fd7-b0ea-75bf09b879c5_512x512.png","contentUrl":"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00427a51-29da-4fd7-b0ea-75bf09b879c5_512x512.png","thumbnailUrl":"https://substackcdn.com/image/fetch/w_128,h_128,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00427a51-29da-4fd7-b0ea-75bf09b879c5_512x512.png"},"image":{"@type":"ImageObject","url":"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00427a51-29da-4fd7-b0ea-75bf09b879c5_512x512.png","contentUrl":"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00427a51-29da-4fd7-b0ea-75bf09b879c5_512x512.png","thumbnailUrl":"https://substackcdn.com/image/fetch/w_128,h_128,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00427a51-29da-4fd7-b0ea-75bf09b879c5_512x512.png"}},"publisher":{"@type":"Organization","name":"City Storage Systems","url":"https://techblog.citystoragesystems.com","description":"Engineering the future of food at Otter & CloudKitchens","interactionStatistic":{"@type":"InteractionCounter","name":"Subscribers","interactionType":"https://schema.org/SubscribeAction","userInteractionCount":100},"identifier":"pub:2259056","logo":{"@type":"ImageObject","url":"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00427a51-29da-4fd7-b0ea-75bf09b879c5_512x512.png","contentUrl":"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00427a51-29da-4fd7-b0ea-75bf09b879c5_512x512.png","thumbnailUrl":"https://substackcdn.com/image/fetch/w_128,h_128,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00427a51-29da-4fd7-b0ea-75bf09b879c5_512x512.png"},"image":{"@type":"ImageObject","url":"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00427a51-29da-4fd7-b0ea-75bf09b879c5_512x512.png","contentUrl":"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00427a51-29da-4fd7-b0ea-75bf09b879c5_512x512.png","thumbnailUrl":"https://substackcdn.com/image/fetch/w_128,h_128,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00427a51-29da-4fd7-b0ea-75bf09b879c5_512x512.png"}}}</script><div class="single-post-container"><div class="container"><div class="single-post"><article class="typography newsletter-post post"><div inert role="dialog" class="modal typography out gone share-dialog popup"><div class="modal-table"><div class="modal-row"><div class="modal-cell modal-content no-fullscreen"><div class="container"><button tabIndex="0" type="button" data-testid="close-modal" class="pencraft pc-reset pencraft modal-btn modal-exit-btn no-margin _iconButton_kqk6u_145 _iconButtonBase_kqk6u_145 _buttonBase_kqk6u_1 _buttonOldColors_kqk6u_56 _size_40_kqk6u_175 _priority_secondary_kqk6u_63 _fill_empty_kqk6u_316 _rounded_kqk6u_155"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="secondary" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x "><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg></button><div class="share-dialog-title">Share this post</div><div class="pencraft pc-display-flex pc-flexDirection-column pc-gap-32 pc-paddingLeft-24 pc-paddingRight-24 pc-paddingTop-32 pc-paddingBottom-48 pc-reset"><div class="pencraft pc-display-flex pc-padding-8 pc-reset _border-detail_1w60r_25 pc-borderRadius-md social-preview-box post"><div class="social-image-box"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_120,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F11e401f2-cdd8-440b-89eb-7f6eaeeb3aae_1689x990.png" /><img src="https://substackcdn.com/image/fetch/w_120,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F11e401f2-cdd8-440b-89eb-7f6eaeeb3aae_1689x990.png" sizes="100vw" alt width="120" loading="lazy" class="_img_16u6n_1 social-image pencraft pc-reset" /></picture></div><div class="pencraft pc-display-flex pc-flexDirection-column pc-paddingTop-8 pc-paddingBottom-8 pc-paddingLeft-12 pc-reset"><h4 class="pencraft pc-reset _line-height-24_1k90y_98 _font-display_1k90y_118 _size-20_1k90y_70 _weight-bold_1k90y_168 _reset_1k90y_1">From Fragile to Faultless: Kubernetes Self-Healing In Practice</h4><div class="pencraft pc-reset _color-secondary_1k90y_186 _line-height-20_1k90y_95 _font-text_1k90y_121 _size-13_1k90y_45 _weight-regular_1k90y_159 _reset_1k90y_1">techblog.citystoragesystems.com</div></div></div><div class="pencraft pc-display-flex pc-gap-8 pc-justifyContent-space-between pc-reset share-dialog-buttons-wrapper"><button tabIndex="0" type="button" class="button share-action"><div class="action-icon"><svg role="img" width="20" height="16" viewBox="0 0 20 16" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><path fill-rule="evenodd" clip-rule="evenodd" d="M12.1303 0.000379039C10.9833 -0.00959082 9.87819 0.431464 9.05309 1.22855L9.04556 1.23593L7.79145 2.48303C7.50587 2.767 7.50453 3.22877 7.78844 3.51441C8.07235 3.80004 8.53401 3.80139 8.81959 3.51741L10.0698 2.27423C10.6194 1.74503 11.3546 1.45229 12.1177 1.45892C12.8824 1.46556 13.6139 1.77236 14.1546 2.31323C14.6954 2.8541 15.0021 3.58577 15.0087 4.35065C15.0154 5.11353 14.7229 5.84857 14.1943 6.39829L12.0116 8.58145L12.0115 8.58155C11.7159 8.87739 11.36 9.10617 10.9682 9.25237C10.5764 9.39857 10.1577 9.45878 9.74051 9.42889C9.32337 9.39901 8.91752 9.27975 8.55051 9.07918C8.1835 8.87862 7.8639 8.60146 7.6134 8.26649C7.3722 7.94396 6.91526 7.87807 6.5928 8.11933C6.27034 8.36059 6.20447 8.81763 6.44567 9.14016C6.82142 9.64261 7.30082 10.0584 7.85134 10.3592C8.40186 10.66 9.01062 10.8389 9.63634 10.8838C10.2621 10.9286 10.8901 10.8383 11.4779 10.619C12.0656 10.3997 12.5994 10.0565 13.0429 9.61274L15.2302 7.42494L15.2391 7.4159C16.036 6.59062 16.4769 5.48529 16.467 4.33797C16.457 3.19066 15.9969 2.09316 15.1858 1.28185C14.3746 0.470545 13.2774 0.0103489 12.1303 0.000379039ZM7.29806 5.11625C6.67234 5.07142 6.0443 5.16173 5.45654 5.38103C4.86882 5.60031 4.33502 5.94355 3.89153 6.38727L1.70423 8.57506L1.69534 8.5841C0.898438 9.40939 0.457483 10.5147 0.467451 11.662C0.477418 12.8094 0.937512 13.9069 1.74864 14.7182C2.55976 15.5295 3.65701 15.9897 4.80407 15.9996C5.95113 16.0096 7.05622 15.5685 7.88132 14.7715L7.89035 14.7626L9.13717 13.5155C9.42192 13.2307 9.42192 12.7689 9.13717 12.4841C8.85243 12.1993 8.39077 12.1993 8.10602 12.4841L6.86392 13.7265C6.31432 14.2552 5.57945 14.5477 4.81675 14.5411C4.05204 14.5344 3.32054 14.2276 2.77979 13.6868C2.23904 13.1459 1.93231 12.4142 1.92566 11.6494C1.91904 10.8865 2.21146 10.1514 2.74011 9.60172L4.92287 7.41846C5.21854 7.12262 5.57437 6.89384 5.96621 6.74763C6.35805 6.60143 6.77674 6.54123 7.19389 6.57111C7.61104 6.601 8.01688 6.72026 8.38389 6.92082C8.75091 7.12138 9.0705 7.39855 9.32101 7.73352C9.56221 8.05605 10.0191 8.12194 10.3416 7.88068C10.6641 7.63942 10.7299 7.18238 10.4887 6.85985C10.113 6.3574 9.63359 5.94165 9.08307 5.64081C8.53255 5.33997 7.92378 5.16107 7.29806 5.11625Z"></path></g></svg></div><div translated class="pencraft pc-reset _color-secondary_1k90y_186 _line-height-20_1k90y_95 _font-text_1k90y_121 _size-13_1k90y_45 _weight-regular_1k90y_159 _reset_1k90y_1">Copy link</div></button><button tabIndex="0" type="button" class="button share-action"><div class="action-icon"><svg role="img" width="16" height="17" viewBox="0 0 16 17" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><path d="M10.6543 1.38723C10.3533 0.960814 9.95383 0.61341 9.48976 0.374567C9.02902 0.137956 8.51908 0.0130716 8.00115 0.0100098C7.86087 0.0101844 7.72354 0.0502687 7.60519 0.125581C7.48684 0.200893 7.39237 0.308324 7.3328 0.435326L5.00368 5.67077H3.029C2.72335 5.66964 2.42059 5.73003 2.13876 5.84833C1.85692 5.96663 1.60177 6.14043 1.38849 6.35938C1.16707 6.57502 0.991841 6.83346 0.873459 7.11897C0.755078 7.40447 0.696022 7.71108 0.699885 8.02014V13.691C0.699885 14.3087 0.945273 14.9012 1.38207 15.338C1.81886 15.7747 2.41128 16.0201 3.029 16.0201H13.348C13.8951 16.021 14.425 15.8283 14.8438 15.4762C15.2626 15.1241 15.5434 14.6352 15.6366 14.0961L16.6493 8.4252C16.7252 8.09192 16.7252 7.74582 16.6493 7.41254C16.566 7.08205 16.4104 6.7742 16.1936 6.51128C15.9746 6.25 15.7017 6.03926 15.3936 5.89355C15.0762 5.7467 14.7306 5.67068 14.3809 5.67077H10.5328L11.0391 4.37457C11.2397 3.88784 11.3162 3.35894 11.2619 2.83533C11.1853 2.30894 10.9763 1.81065 10.6543 1.38723ZM4.75052 14.5518H3.029C2.91049 14.5525 2.79303 14.5296 2.68349 14.4844C2.57394 14.4392 2.47452 14.3726 2.39102 14.2885C2.23609 14.1199 2.14945 13.8997 2.14799 13.6708V8.02014C2.14913 7.901 2.17389 7.78328 2.22082 7.67377C2.26775 7.56427 2.33592 7.46515 2.4214 7.38216C2.50369 7.29576 2.60267 7.22698 2.71233 7.17998C2.822 7.13298 2.94007 7.10874 3.05938 7.10874H4.7809L4.75052 14.5518ZM10.6746 7.05811H14.3809C14.5145 7.05821 14.6462 7.08942 14.7657 7.14925C14.8875 7.20532 14.9948 7.28845 15.0796 7.39229C15.1675 7.49052 15.2301 7.60871 15.2619 7.73659C15.2922 7.8665 15.2922 8.00162 15.2619 8.13153L14.2493 13.8024C14.2087 14.017 14.094 14.2106 13.9252 14.3492C13.7619 14.4812 13.558 14.5528 13.348 14.5518H6.19862V6.45052L8.43659 1.38723H8.52773C8.9042 1.50037 9.23304 1.73413 9.4636 2.05252C9.69416 2.37092 9.81365 2.75627 9.80368 3.14925C9.8181 3.39741 9.78015 3.64583 9.69229 3.87836L9.23659 5.04292C9.15397 5.273 9.12623 5.51921 9.15558 5.76191C9.1877 6.00427 9.27425 6.23623 9.40875 6.44039C9.5535 6.6376 9.74028 6.80017 9.95558 6.91634C10.1774 7.03206 10.4244 7.0912 10.6746 7.08849V7.05811Z"></path></g></svg></div><div translated class="pencraft pc-reset _color-secondary_1k90y_186 _line-height-20_1k90y_95 _font-text_1k90y_121 _size-13_1k90y_45 _weight-regular_1k90y_159 _reset_1k90y_1">Facebook</div></button><button tabIndex="0" type="button" class="button share-action"><div class="action-icon"><svg role="img" width="21" height="16" viewBox="0 0 21 16" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><path fill-rule="evenodd" clip-rule="evenodd" d="M2.22192 2.20503C2.36754 1.77115 2.78269 1.45455 3.26639 1.45455H17.9332C18.4169 1.45455 18.8321 1.77118 18.9777 2.2051L10.5999 8.02107L2.22192 2.20503ZM2.16639 3.94198V13.4545C2.16639 14.0529 2.66307 14.5455 3.26639 14.5455H17.9332C18.5365 14.5455 19.0332 14.0529 19.0332 13.4545V3.94206L11.0204 9.50462C10.7679 9.67991 10.4318 9.67991 10.1793 9.50462L2.16639 3.94198ZM20.4999 2.55809V13.4545C20.4999 14.8562 19.3465 16 17.9332 16H3.26639C1.85304 16 0.699707 14.8562 0.699707 13.4545V2.54545C0.699707 1.14379 1.85304 0 3.26639 0H17.9332C19.3407 0 20.4904 1.13441 20.4998 2.52818C20.5 2.53816 20.5001 2.54813 20.4999 2.55809Z"></path></g></svg></div><div translated class="pencraft pc-reset _color-secondary_1k90y_186 _line-height-20_1k90y_95 _font-text_1k90y_121 _size-13_1k90y_45 _weight-regular_1k90y_159 _reset_1k90y_1">Email</div></button><button tabIndex="0" type="button" class="button share-action"><div class="action-icon"><svg role="img" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><path d="M6.785 1.92766C5.45134 1.57031 4.08049 2.36176 3.72314 3.69543L0.444815 15.9303C0.0874636 17.264 0.878901 18.6348 2.21255 18.9922L5.37495 19.8396V7.66664C5.37495 6.40099 6.40096 5.37498 7.66661 5.37498H19.4723C19.3299 5.30548 19.1788 5.24858 19.0201 5.20604L6.785 1.92766Z" stroke="none"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M8.44161 7.4C7.86632 7.4 7.39995 7.86637 7.39995 8.44167V22.1081C7.39995 22.6834 7.86631 23.1498 8.4416 23.1498L22.1083 23.15C22.6836 23.15 23.1499 22.6836 23.1499 22.1083V8.44167C23.1499 7.86637 22.6836 7.4 22.1083 7.4H8.44161ZM10.3999 9.65C9.84766 9.65 9.39995 10.0977 9.39995 10.65C9.39995 11.2023 9.84766 11.65 10.3999 11.65H18.3999C18.9522 11.65 19.3999 11.2023 19.3999 10.65C19.3999 10.0977 18.9522 9.65 18.3999 9.65H10.3999ZM10.3999 14.15C9.84766 14.15 9.39995 14.5977 9.39995 15.15C9.39995 15.7023 9.84766 16.15 10.3999 16.15H15.3999C15.9522 16.15 16.3999 15.7023 16.3999 15.15C16.3999 14.5977 15.9522 14.15 15.3999 14.15H10.3999Z" stroke="none"></path></g></svg></div><div class="pencraft pc-reset _color-secondary_1k90y_186 _line-height-20_1k90y_95 _font-text_1k90y_121 _size-13_1k90y_45 _weight-regular_1k90y_159 _reset_1k90y_1">Note</div></button><button tabIndex="0" id="trigger388865" aria-expanded="false" aria-haspopup="dialog" aria-controls="dialog388866" ariaLabel="View more" type="button" class="button share-action"><div class="action-icon"><svg role="img" width="100" height="100" viewBox="0 0 100 100" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><circle cx="23" cy="50" r="9"></circle><circle cx="50" cy="50" r="9"></circle><circle cx="77" cy="50" r="9"></circle></g></svg></div><div translated class="pencraft pc-reset _color-secondary_1k90y_186 _line-height-20_1k90y_95 _font-text_1k90y_121 _size-13_1k90y_45 _weight-regular_1k90y_159 _reset_1k90y_1">Other</div></button></div></div></div></div></div></div></div><div class="post-header"><h1 class="post-title unpublished">From Fragile to Faultless: Kubernetes Self-Healing In Practice</h1><h3 class="subtitle">Overcoming imperfections of managed Kubernetes with early self-healing.</h3><div class="pencraft pc-display-flex pc-flexDirection-column pc-paddingBottom-16 pc-reset"><div class="pencraft pc-display-flex pc-flexDirection-column pc-paddingTop-16 pc-paddingBottom-16 pc-reset"><div class="pencraft pc-display-flex pc-gap-12 pc-alignItems-center pc-reset byline-wrapper"><div class="pencraft pc-display-flex pc-flexDirection-column pc-reset"><div class="pencraft pc-display-flex pc-gap-4 pc-reset"><div class="pencraft pc-reset _color-pub-secondary-text_1k90y_207 _line-height-20_1k90y_95 _font-meta_1k90y_131 _size-11_1k90y_35 _weight-medium_1k90y_162 _transform-uppercase_1k90y_242 _reset_1k90y_1 _meta_1k90y_442">Jun 15, 2024</div></div></div></div></div><div class="pencraft pc-display-flex pc-gap-16 pc-paddingTop-16 pc-paddingBottom-16 pc-justifyContent-space-between pc-alignItems-center _flexGrow_1w60r_230 pc-reset _border-top-detail-themed_1w60r_47 _border-bottom-detail-themed_1w60r_50 post-ufi"><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><div class="like-button-container post-ufi-button style-button"><a role="button" class="post-ufi-button style-button no-label with-border"><svg role="img" style="height: 20px; width: 20px;" width="20" height="20" viewBox="0 0 24 24" fill="#000000" stroke-width="2" stroke="#000" xmlns="http://www.w3.org/2000/svg" class="icon"><g><title></title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-heart "><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path></svg></g></svg></a><div inert role="dialog" class="modal typography out gone share-dialog popup"><div class="modal-table"><div class="modal-row"><div class="modal-cell modal-content no-fullscreen"><div class="container"><button tabIndex="0" type="button" data-testid="close-modal" class="pencraft pc-reset pencraft modal-btn modal-exit-btn no-margin _iconButton_kqk6u_145 _iconButtonBase_kqk6u_145 _buttonBase_kqk6u_1 _buttonOldColors_kqk6u_56 _size_40_kqk6u_175 _priority_secondary_kqk6u_63 _fill_empty_kqk6u_316 _rounded_kqk6u_155"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="secondary" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x "><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg></button><div class="share-dialog-title">Share this post</div><div class="pencraft pc-display-flex pc-flexDirection-column pc-gap-32 pc-paddingLeft-24 pc-paddingRight-24 pc-paddingTop-32 pc-paddingBottom-48 pc-reset"><div class="pencraft pc-display-flex pc-padding-8 pc-reset _border-detail_1w60r_25 pc-borderRadius-md social-preview-box post"><div class="social-image-box"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_120,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F11e401f2-cdd8-440b-89eb-7f6eaeeb3aae_1689x990.png" /><img src="https://substackcdn.com/image/fetch/w_120,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F11e401f2-cdd8-440b-89eb-7f6eaeeb3aae_1689x990.png" sizes="100vw" alt width="120" loading="lazy" class="_img_16u6n_1 social-image pencraft pc-reset" /></picture></div><div class="pencraft pc-display-flex pc-flexDirection-column pc-paddingTop-8 pc-paddingBottom-8 pc-paddingLeft-12 pc-reset"><h4 class="pencraft pc-reset _line-height-24_1k90y_98 _font-display_1k90y_118 _size-20_1k90y_70 _weight-bold_1k90y_168 _reset_1k90y_1">From Fragile to Faultless: Kubernetes Self-Healing In Practice</h4><div class="pencraft pc-reset _color-secondary_1k90y_186 _line-height-20_1k90y_95 _font-text_1k90y_121 _size-13_1k90y_45 _weight-regular_1k90y_159 _reset_1k90y_1">techblog.citystoragesystems.com</div></div></div><div class="pencraft pc-display-flex pc-gap-8 pc-justifyContent-space-between pc-reset share-dialog-buttons-wrapper"><button tabIndex="0" type="button" class="button share-action"><div class="action-icon"><svg role="img" width="20" height="16" viewBox="0 0 20 16" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><path fill-rule="evenodd" clip-rule="evenodd" d="M12.1303 0.000379039C10.9833 -0.00959082 9.87819 0.431464 9.05309 1.22855L9.04556 1.23593L7.79145 2.48303C7.50587 2.767 7.50453 3.22877 7.78844 3.51441C8.07235 3.80004 8.53401 3.80139 8.81959 3.51741L10.0698 2.27423C10.6194 1.74503 11.3546 1.45229 12.1177 1.45892C12.8824 1.46556 13.6139 1.77236 14.1546 2.31323C14.6954 2.8541 15.0021 3.58577 15.0087 4.35065C15.0154 5.11353 14.7229 5.84857 14.1943 6.39829L12.0116 8.58145L12.0115 8.58155C11.7159 8.87739 11.36 9.10617 10.9682 9.25237C10.5764 9.39857 10.1577 9.45878 9.74051 9.42889C9.32337 9.39901 8.91752 9.27975 8.55051 9.07918C8.1835 8.87862 7.8639 8.60146 7.6134 8.26649C7.3722 7.94396 6.91526 7.87807 6.5928 8.11933C6.27034 8.36059 6.20447 8.81763 6.44567 9.14016C6.82142 9.64261 7.30082 10.0584 7.85134 10.3592C8.40186 10.66 9.01062 10.8389 9.63634 10.8838C10.2621 10.9286 10.8901 10.8383 11.4779 10.619C12.0656 10.3997 12.5994 10.0565 13.0429 9.61274L15.2302 7.42494L15.2391 7.4159C16.036 6.59062 16.4769 5.48529 16.467 4.33797C16.457 3.19066 15.9969 2.09316 15.1858 1.28185C14.3746 0.470545 13.2774 0.0103489 12.1303 0.000379039ZM7.29806 5.11625C6.67234 5.07142 6.0443 5.16173 5.45654 5.38103C4.86882 5.60031 4.33502 5.94355 3.89153 6.38727L1.70423 8.57506L1.69534 8.5841C0.898438 9.40939 0.457483 10.5147 0.467451 11.662C0.477418 12.8094 0.937512 13.9069 1.74864 14.7182C2.55976 15.5295 3.65701 15.9897 4.80407 15.9996C5.95113 16.0096 7.05622 15.5685 7.88132 14.7715L7.89035 14.7626L9.13717 13.5155C9.42192 13.2307 9.42192 12.7689 9.13717 12.4841C8.85243 12.1993 8.39077 12.1993 8.10602 12.4841L6.86392 13.7265C6.31432 14.2552 5.57945 14.5477 4.81675 14.5411C4.05204 14.5344 3.32054 14.2276 2.77979 13.6868C2.23904 13.1459 1.93231 12.4142 1.92566 11.6494C1.91904 10.8865 2.21146 10.1514 2.74011 9.60172L4.92287 7.41846C5.21854 7.12262 5.57437 6.89384 5.96621 6.74763C6.35805 6.60143 6.77674 6.54123 7.19389 6.57111C7.61104 6.601 8.01688 6.72026 8.38389 6.92082C8.75091 7.12138 9.0705 7.39855 9.32101 7.73352C9.56221 8.05605 10.0191 8.12194 10.3416 7.88068C10.6641 7.63942 10.7299 7.18238 10.4887 6.85985C10.113 6.3574 9.63359 5.94165 9.08307 5.64081C8.53255 5.33997 7.92378 5.16107 7.29806 5.11625Z"></path></g></svg></div><div translated class="pencraft pc-reset _color-secondary_1k90y_186 _line-height-20_1k90y_95 _font-text_1k90y_121 _size-13_1k90y_45 _weight-regular_1k90y_159 _reset_1k90y_1">Copy link</div></button><button tabIndex="0" type="button" class="button share-action"><div class="action-icon"><svg role="img" width="16" height="17" viewBox="0 0 16 17" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><path d="M10.6543 1.38723C10.3533 0.960814 9.95383 0.61341 9.48976 0.374567C9.02902 0.137956 8.51908 0.0130716 8.00115 0.0100098C7.86087 0.0101844 7.72354 0.0502687 7.60519 0.125581C7.48684 0.200893 7.39237 0.308324 7.3328 0.435326L5.00368 5.67077H3.029C2.72335 5.66964 2.42059 5.73003 2.13876 5.84833C1.85692 5.96663 1.60177 6.14043 1.38849 6.35938C1.16707 6.57502 0.991841 6.83346 0.873459 7.11897C0.755078 7.40447 0.696022 7.71108 0.699885 8.02014V13.691C0.699885 14.3087 0.945273 14.9012 1.38207 15.338C1.81886 15.7747 2.41128 16.0201 3.029 16.0201H13.348C13.8951 16.021 14.425 15.8283 14.8438 15.4762C15.2626 15.1241 15.5434 14.6352 15.6366 14.0961L16.6493 8.4252C16.7252 8.09192 16.7252 7.74582 16.6493 7.41254C16.566 7.08205 16.4104 6.7742 16.1936 6.51128C15.9746 6.25 15.7017 6.03926 15.3936 5.89355C15.0762 5.7467 14.7306 5.67068 14.3809 5.67077H10.5328L11.0391 4.37457C11.2397 3.88784 11.3162 3.35894 11.2619 2.83533C11.1853 2.30894 10.9763 1.81065 10.6543 1.38723ZM4.75052 14.5518H3.029C2.91049 14.5525 2.79303 14.5296 2.68349 14.4844C2.57394 14.4392 2.47452 14.3726 2.39102 14.2885C2.23609 14.1199 2.14945 13.8997 2.14799 13.6708V8.02014C2.14913 7.901 2.17389 7.78328 2.22082 7.67377C2.26775 7.56427 2.33592 7.46515 2.4214 7.38216C2.50369 7.29576 2.60267 7.22698 2.71233 7.17998C2.822 7.13298 2.94007 7.10874 3.05938 7.10874H4.7809L4.75052 14.5518ZM10.6746 7.05811H14.3809C14.5145 7.05821 14.6462 7.08942 14.7657 7.14925C14.8875 7.20532 14.9948 7.28845 15.0796 7.39229C15.1675 7.49052 15.2301 7.60871 15.2619 7.73659C15.2922 7.8665 15.2922 8.00162 15.2619 8.13153L14.2493 13.8024C14.2087 14.017 14.094 14.2106 13.9252 14.3492C13.7619 14.4812 13.558 14.5528 13.348 14.5518H6.19862V6.45052L8.43659 1.38723H8.52773C8.9042 1.50037 9.23304 1.73413 9.4636 2.05252C9.69416 2.37092 9.81365 2.75627 9.80368 3.14925C9.8181 3.39741 9.78015 3.64583 9.69229 3.87836L9.23659 5.04292C9.15397 5.273 9.12623 5.51921 9.15558 5.76191C9.1877 6.00427 9.27425 6.23623 9.40875 6.44039C9.5535 6.6376 9.74028 6.80017 9.95558 6.91634C10.1774 7.03206 10.4244 7.0912 10.6746 7.08849V7.05811Z"></path></g></svg></div><div translated class="pencraft pc-reset _color-secondary_1k90y_186 _line-height-20_1k90y_95 _font-text_1k90y_121 _size-13_1k90y_45 _weight-regular_1k90y_159 _reset_1k90y_1">Facebook</div></button><button tabIndex="0" type="button" class="button share-action"><div class="action-icon"><svg role="img" width="21" height="16" viewBox="0 0 21 16" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><path fill-rule="evenodd" clip-rule="evenodd" d="M2.22192 2.20503C2.36754 1.77115 2.78269 1.45455 3.26639 1.45455H17.9332C18.4169 1.45455 18.8321 1.77118 18.9777 2.2051L10.5999 8.02107L2.22192 2.20503ZM2.16639 3.94198V13.4545C2.16639 14.0529 2.66307 14.5455 3.26639 14.5455H17.9332C18.5365 14.5455 19.0332 14.0529 19.0332 13.4545V3.94206L11.0204 9.50462C10.7679 9.67991 10.4318 9.67991 10.1793 9.50462L2.16639 3.94198ZM20.4999 2.55809V13.4545C20.4999 14.8562 19.3465 16 17.9332 16H3.26639C1.85304 16 0.699707 14.8562 0.699707 13.4545V2.54545C0.699707 1.14379 1.85304 0 3.26639 0H17.9332C19.3407 0 20.4904 1.13441 20.4998 2.52818C20.5 2.53816 20.5001 2.54813 20.4999 2.55809Z"></path></g></svg></div><div translated class="pencraft pc-reset _color-secondary_1k90y_186 _line-height-20_1k90y_95 _font-text_1k90y_121 _size-13_1k90y_45 _weight-regular_1k90y_159 _reset_1k90y_1">Email</div></button><button tabIndex="0" type="button" class="button share-action"><div class="action-icon"><svg role="img" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><path d="M6.785 1.92766C5.45134 1.57031 4.08049 2.36176 3.72314 3.69543L0.444815 15.9303C0.0874636 17.264 0.878901 18.6348 2.21255 18.9922L5.37495 19.8396V7.66664C5.37495 6.40099 6.40096 5.37498 7.66661 5.37498H19.4723C19.3299 5.30548 19.1788 5.24858 19.0201 5.20604L6.785 1.92766Z" stroke="none"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M8.44161 7.4C7.86632 7.4 7.39995 7.86637 7.39995 8.44167V22.1081C7.39995 22.6834 7.86631 23.1498 8.4416 23.1498L22.1083 23.15C22.6836 23.15 23.1499 22.6836 23.1499 22.1083V8.44167C23.1499 7.86637 22.6836 7.4 22.1083 7.4H8.44161ZM10.3999 9.65C9.84766 9.65 9.39995 10.0977 9.39995 10.65C9.39995 11.2023 9.84766 11.65 10.3999 11.65H18.3999C18.9522 11.65 19.3999 11.2023 19.3999 10.65C19.3999 10.0977 18.9522 9.65 18.3999 9.65H10.3999ZM10.3999 14.15C9.84766 14.15 9.39995 14.5977 9.39995 15.15C9.39995 15.7023 9.84766 16.15 10.3999 16.15H15.3999C15.9522 16.15 16.3999 15.7023 16.3999 15.15C16.3999 14.5977 15.9522 14.15 15.3999 14.15H10.3999Z" stroke="none"></path></g></svg></div><div class="pencraft pc-reset _color-secondary_1k90y_186 _line-height-20_1k90y_95 _font-text_1k90y_121 _size-13_1k90y_45 _weight-regular_1k90y_159 _reset_1k90y_1">Note</div></button><button tabIndex="0" id="trigger388867" aria-expanded="false" aria-haspopup="dialog" aria-controls="dialog388868" ariaLabel="View more" type="button" class="button share-action"><div class="action-icon"><svg role="img" width="100" height="100" viewBox="0 0 100 100" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><circle cx="23" cy="50" r="9"></circle><circle cx="50" cy="50" r="9"></circle><circle cx="77" cy="50" r="9"></circle></g></svg></div><div translated class="pencraft pc-reset _color-secondary_1k90y_186 _line-height-20_1k90y_95 _font-text_1k90y_121 _size-13_1k90y_45 _weight-regular_1k90y_159 _reset_1k90y_1">Other</div></button></div></div></div></div></div></div></div></div></div><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><a role="button" href="javascript:void(0)" class="post-ufi-button style-button no-icon has-label with-border"><div class="label">Share</div></a></div></div></div></div><div class="visibility-check"></div><div><div class="available-content"><div dir="auto" class="body markup"><div class="captioned-image-container"><figure><a class="image-link is-viewable-img image2" target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F11e401f2-cdd8-440b-89eb-7f6eaeeb3aae_1689x990.png" data-component-name="Image2ToDOM" rel><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F11e401f2-cdd8-440b-89eb-7f6eaeeb3aae_1689x990.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F11e401f2-cdd8-440b-89eb-7f6eaeeb3aae_1689x990.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F11e401f2-cdd8-440b-89eb-7f6eaeeb3aae_1689x990.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F11e401f2-cdd8-440b-89eb-7f6eaeeb3aae_1689x990.png 1456w" sizes="100vw" /><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F11e401f2-cdd8-440b-89eb-7f6eaeeb3aae_1689x990.png" width="1456" height="853" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/11e401f2-cdd8-440b-89eb-7f6eaeeb3aae_1689x990.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:853,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:274179,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:false,&quot;topImage&quot;:true,&quot;internalRedirect&quot;:null}" class="sizing-normal" alt srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F11e401f2-cdd8-440b-89eb-7f6eaeeb3aae_1689x990.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F11e401f2-cdd8-440b-89eb-7f6eaeeb3aae_1689x990.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F11e401f2-cdd8-440b-89eb-7f6eaeeb3aae_1689x990.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F11e401f2-cdd8-440b-89eb-7f6eaeeb3aae_1689x990.png 1456w" sizes="100vw" fetchpriority="high" /></picture><div class="image-link-expand"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 "><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></div></div></a></figure></div><p><em>Written by Grzegorz Głąb and Nibir Bora, members of the engineering teams that work on core infrastructure.</em></p><p>Many organizations opt for managed Kubernetes distributions like Azure Kubernetes Service (AKS) to get up and running quickly without needing a large engineering team to operate Kubernetes clusters. This is a core design principle of the Core Infrastructure team at City Storage Systems. However, over the years, we’ve learned that the true operating cost of managed Kubernetes distributions is not in fact zero.</p><p>Even public cloud experiences occasional failures. Hardware faults, kernel misconfigurations, network bottlenecks, problematic rollouts, resource scarcity, security vulnerability, etc. leads to complications lasting for minutes, or in some cases, weeks. In this blog we share our experience illustrating how minor glitches, if left unattended, could quickly escalate and impact business continuity.</p><p>Rather than engaging in constant firefighting we designed a self-healing framework, often implementing automations with a turnaround time of as little as 1 day. These automations were sometimes temporary fixes until resolved by the cloud provider, and at other times, they became permanent enhancements to our platform’s reliability. While our journey began with a focus on AKS, this framework is a general-purpose pattern to improve resilience of any Kubernetes platform.</p><h1 class="header-with-anchor-widget">The Self-Healing Framework<div id="§the-self-healing-framework" class="header-anchor-widget offset-top"><div class="header-anchor-widget-button-container"><div href="https://techblog.citystoragesystems.com/i/145625273/the-self-healing-framework" class="header-anchor-widget-button"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="header-anchor-widget-icon"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></div></div></div></h1><p><span>The first self-healing use case was implemented as a monolithic program. But, as we added new use cases, we identified several reusable libraries that nudged us to organize it into a framework. The framework today consists of </span><em>Automation</em><span>s that each address a specific failure mode. Automations are implemented as an independent </span><em>Detector</em><span> and a </span><em>Fixer</em><span>, which are either a </span><a href="https://kubernetes.io/docs/concepts/architecture/controller/" rel>controller</a><span> or a </span><a href="https://go.dev/" rel>Go</a><span> program.</span></p><p><em>Detectors</em><span> are responsible for collecting signals and flagging failure conditions. There are two types of detectors - Cluster level (Deployment) and Node level (DaemonSet). Cluster level detectors monitor for cluster-wide failure events and have permissions to watch or create API server resources. Node level detectors monitor for node level failures (e.g. misconfigured OS flags, image pull issues, missing systemd services, etc.) and have privileged host access.</span></p><p><em>Fixers</em><span> complement detectors by executing remediation steps to rectify or cleanup failure states. Similar to Detectors, there are two types of fixers - Cluster level (Deployment) and Node level (DaemonSet). Cluster level fixers execute remediation actions that operate on cluster-level resources and have permissions to watch API server resources. Node level fixers execute remediation action at node level, or operations that require privileged host access.</span></p><div class="captioned-image-container"><figure><a class="image-link is-viewable-img image2" target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbed218a4-bc4e-4a4d-be5e-458df638bde0_1600x830.png" data-component-name="Image2ToDOM" rel><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbed218a4-bc4e-4a4d-be5e-458df638bde0_1600x830.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbed218a4-bc4e-4a4d-be5e-458df638bde0_1600x830.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbed218a4-bc4e-4a4d-be5e-458df638bde0_1600x830.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbed218a4-bc4e-4a4d-be5e-458df638bde0_1600x830.png 1456w" sizes="100vw" /><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbed218a4-bc4e-4a4d-be5e-458df638bde0_1600x830.png" width="1456" height="755" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/bed218a4-bc4e-4a4d-be5e-458df638bde0_1600x830.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:755,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:null,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" class="sizing-normal" alt srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbed218a4-bc4e-4a4d-be5e-458df638bde0_1600x830.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbed218a4-bc4e-4a4d-be5e-458df638bde0_1600x830.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbed218a4-bc4e-4a4d-be5e-458df638bde0_1600x830.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbed218a4-bc4e-4a4d-be5e-458df638bde0_1600x830.png 1456w" sizes="100vw" loading="lazy" /></picture><div class="image-link-expand"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 "><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></div></div></a><figcaption class="image-caption">Figure 1: Diagram showing architecture of the self-healing framework operating in a Kubernetes cluster.</figcaption></figure></div><p>Generalizing as such allows us to keep the framework simple and appropriately isolate permissions. This was key to swiftly adding new automations when needed. Whenever we identify a new degradation, we implement and deploy the corresponding detector and fixer across all our clusters. The following automations are a few examples that shielded our internal developers and applications from potential impact, and also significantly reduced our team’s support toil - cutting it in half from 30% of engineering time.</p><div class="captioned-image-container"><figure><a class="image-link is-viewable-img image2" target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f1cacbd-c468-46ca-a8fd-928b02eb2362_2290x1169.png" data-component-name="Image2ToDOM" rel><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f1cacbd-c468-46ca-a8fd-928b02eb2362_2290x1169.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f1cacbd-c468-46ca-a8fd-928b02eb2362_2290x1169.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f1cacbd-c468-46ca-a8fd-928b02eb2362_2290x1169.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f1cacbd-c468-46ca-a8fd-928b02eb2362_2290x1169.png 1456w" sizes="100vw" /><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f1cacbd-c468-46ca-a8fd-928b02eb2362_2290x1169.png" width="1456" height="743" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/3f1cacbd-c468-46ca-a8fd-928b02eb2362_2290x1169.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:743,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:154548,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" class="sizing-normal" alt srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f1cacbd-c468-46ca-a8fd-928b02eb2362_2290x1169.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f1cacbd-c468-46ca-a8fd-928b02eb2362_2290x1169.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f1cacbd-c468-46ca-a8fd-928b02eb2362_2290x1169.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f1cacbd-c468-46ca-a8fd-928b02eb2362_2290x1169.png 1456w" sizes="100vw" loading="lazy" /></picture><div class="image-link-expand"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 "><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></div></div></a><figcaption class="image-caption">Figure 2: List of self-healing automations that are currently active on our Kubernetes platform.</figcaption></figure></div><p>Building these automations over the last year and a half has taught us some key lessons:</p><ol><li><p><strong>Kubernetes is not the end product</strong><span>. It is a framework for building platforms. Managed Kubernetes still greatly benefits from business specific customizations that create leverage for developers.</span></p></li><li><p><strong>Abstractions don’t erase underlying layers</strong><span>. Kubernetes, while powerful, still requires us to dive into the host VM or kernel layer for deep debugging - a skill set we've honed through experience.</span></p></li><li><p><strong>Cost optimization has a reliability tax</strong><span>. Optimizing cost needs to be counterbalanced with increased vigilance on reliability. For example, running stateful workloads on Spot nodes required us to invest further in automation.</span></p></li><li><p><strong>Cloud bugs cannot be predicted</strong><span>. Instead of anticipating imaginary failure scenarios, it’s better to optimize for speed of diagnosing unforeseen issues and implementing automation for them. For example, we consolidated all node malfunction signals on a single “node inspector” dashboard empowering our developers to respond swiftly when paged.</span></p></li></ol><p>In the following sections we describe a few of the automations in detail, covering how each failure mode was identified and how we automated its self-healing.</p><h1 class="header-with-anchor-widget">Handling Abrupt Spot Node Preemptions<div id="§handling-abrupt-spot-node-preemptions" class="header-anchor-widget offset-top"><div class="header-anchor-widget-button-container"><div href="https://techblog.citystoragesystems.com/i/145625273/handling-abrupt-spot-node-preemptions" class="header-anchor-widget-button"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="header-anchor-widget-icon"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></div></div></div></h1><p><span>We use Spot nodes extensively on our Kubernetes platform to optimize resource costs, running both stateless and less critical stateful workloads. However, Spot nodes on AKS </span><a href="https://learn.microsoft.com/en-us/azure/aks/spot-node-pool" rel>lack any SLA</a><span>, which can lead to potential abrupt preemptions. We experienced an incident where a large number of Spot node preemptions caused multiple stateful workloads to fail, causing cascading application failures resulting in downtime.</span></p><p><span>When Spot nodes on AKS are preempted, a </span><em>scheduled preemption</em><span> event is emitted 30 seconds before the underlying VM is abruptly removed. The node isn’t cordoned, workloads aren’t gracefully shut down, and the Node isn’t deregistered from the Kubernetes API server. The Node object remains without a physical VM (see issue </span><a href="https://github.com/Azure/AKS/issues/3528" rel>#3528</a><span>) until cleaned up after 5 minutes due to failed heartbeats. When this happens, stateless workload pods (controlled by Deployment and ReplicaSet) are automatically rescheduled, but not StatefulSet pods. StatefulSet pods leave behind “phantom” pod objects (with </span><code>.status.phase: Unknown</code><span>) in the API server, which is not an acceptable behavior for our stateful workloads.</span></p><p><span>To address this, we implemented a self-healing automation that intercepts Spot node preemption signals and gracefully evicts all pods on the affected node. A detector watches for </span><code>VMEventScheduled</code><span> node conditions (example below) and creates a </span><code>SpotNodePreemption</code><span> </span><a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/" rel>Custom Resource</a><span> (CR) with details for the fixer. The fixer then evicts the pods with a 10-second grace period.</span></p><pre><code>.status.conditions: [
    {
        status: &quot;True&quot;,
        type: &quot;VMEventScheduled&quot;,
        reason: &quot;VMEventScheduled&quot;,
        message: &quot;Preempt Scheduled : Tue, 14 May 2024 12:57:00 GMT&quot;,
        lastHeartbeatTime: &quot;2024-05-14T12:56:43Z&quot;,
        lastTransitionTime: &quot;2024-05-14T12:56:42Z&quot;
    }
]</code></pre><div class="captioned-image-container"><figure><a class="image-link image2" target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3194da73-7ca8-46be-9e44-cfc97b9dc784_1496x226.png" data-component-name="Image2ToDOM" rel><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3194da73-7ca8-46be-9e44-cfc97b9dc784_1496x226.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3194da73-7ca8-46be-9e44-cfc97b9dc784_1496x226.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3194da73-7ca8-46be-9e44-cfc97b9dc784_1496x226.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3194da73-7ca8-46be-9e44-cfc97b9dc784_1496x226.png 1456w" sizes="100vw" /><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3194da73-7ca8-46be-9e44-cfc97b9dc784_1496x226.png" width="1456" height="220" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/3194da73-7ca8-46be-9e44-cfc97b9dc784_1496x226.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:220,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:null,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" class="sizing-normal" alt srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3194da73-7ca8-46be-9e44-cfc97b9dc784_1496x226.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3194da73-7ca8-46be-9e44-cfc97b9dc784_1496x226.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3194da73-7ca8-46be-9e44-cfc97b9dc784_1496x226.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3194da73-7ca8-46be-9e44-cfc97b9dc784_1496x226.png 1456w" sizes="100vw" loading="lazy" /></picture><div></div></div></a><figcaption class="image-caption">Figure 3: Example timeline of Kubernetes events for a pod that was scheduled on a preempted Spot node.</figcaption></figure></div><div class="captioned-image-container"><figure><a class="image-link is-viewable-img image2" target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52b40c32-cf98-4ee8-99e1-1f8d2ec37929_938x292.png" data-component-name="Image2ToDOM" rel><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52b40c32-cf98-4ee8-99e1-1f8d2ec37929_938x292.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52b40c32-cf98-4ee8-99e1-1f8d2ec37929_938x292.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52b40c32-cf98-4ee8-99e1-1f8d2ec37929_938x292.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52b40c32-cf98-4ee8-99e1-1f8d2ec37929_938x292.png 1456w" sizes="100vw" /><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52b40c32-cf98-4ee8-99e1-1f8d2ec37929_938x292.png" width="938" height="292" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/52b40c32-cf98-4ee8-99e1-1f8d2ec37929_938x292.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:292,&quot;width&quot;:938,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:null,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" class="sizing-normal" alt srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52b40c32-cf98-4ee8-99e1-1f8d2ec37929_938x292.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52b40c32-cf98-4ee8-99e1-1f8d2ec37929_938x292.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52b40c32-cf98-4ee8-99e1-1f8d2ec37929_938x292.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52b40c32-cf98-4ee8-99e1-1f8d2ec37929_938x292.png 1456w" sizes="100vw" loading="lazy" /></picture><div class="image-link-expand"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 "><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></div></div></a><figcaption class="image-caption">Figure 4: High volume of spot node preemption around November 2023.</figcaption></figure></div><p><span>Once this automation was operationalized, we noticed that some Spot nodes were still terminated without a scheduled </span><em>preemption event</em><span>. This was because when Node Problem Detector (NPD) queries Azure Metadata Service for the </span><code>VMEventSchedule</code><span> event, the request occasionally fails resulting in a </span><code>NoVMEventScheduled</code><span> node condition (example below). To handle this, we added another self-healing automation to clean up after terminated Spot nodes when the preemption event wasn’t intercepted. The detector creates a </span><code>SpotNodeDeletion</code><span> CR when a Spot Node object is deleted from the API server, and the fixer force deletes all pod objects on that node assuming they are no longer reachable.</span></p><pre><code>.status.conditions: [
    {
        ...
        type: &quot;Unknown&quot;,
        reason: &quot;NoVMEventScheduled&quot;,
        message: “Timeout when running plugin \&quot;/etc/node-problem-detector.d/plugin/check_scheduledevent_consolidated.sh\&quot;: state - signal: killed. output - \&quot;\&quot;”
    }
]</code></pre><h1 class="header-with-anchor-widget">Handling StatefulSet pods on Unreachable Nodes<div id="§handling-statefulset-pods-on-unreachable-nodes" class="header-anchor-widget offset-top"><div class="header-anchor-widget-button-container"><div href="https://techblog.citystoragesystems.com/i/145625273/handling-statefulset-pods-on-unreachable-nodes" class="header-anchor-widget-button"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="header-anchor-widget-icon"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></div></div></div></h1><p><span>AKS node pools are built on Azure Virtual Machine Scale Sets (VMSS) infrastructure. We observed that VM failures in the VMSS layer often make AKS Nodes unreachable. When this happens, the node controller adds a </span><code>NoExecute</code><span> taint, and all pods on the node are evicted after 5 minutes. While stateless pods are rescheduled automatically, StatefulSet pods are not (see issue </span><a href="https://github.com/kubernetes/kubernetes/issues/54368" rel>#54368</a><span>, and </span><a href="https://github.com/kubernetes/design-proposals-archive/blob/main/storage/pod-safety.md#avoid-multiple-instances-of-pods" rel>design proposal</a><span>). This can lead to data loss caused by under-replication in stateful workloads like CockroachDB or OpenSearch.</span></p><p><span>To address this, we implemented a self-healing automation that watches the Kubernetes API server for Node objects with a </span><code>node.kubernetes.io/unreachable</code><span> taint. The detector filters nodes tainted for more than 5 minutes, and the fixer force deletes all pods (assuming they are unrecoverable) on these nodes, allowing new pods to be scheduled.</span></p><div class="captioned-image-container"><figure><a class="image-link is-viewable-img image2" target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32f1641e-8000-4905-b1d4-58f265cd61f7_936x292.png" data-component-name="Image2ToDOM" rel><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32f1641e-8000-4905-b1d4-58f265cd61f7_936x292.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32f1641e-8000-4905-b1d4-58f265cd61f7_936x292.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32f1641e-8000-4905-b1d4-58f265cd61f7_936x292.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32f1641e-8000-4905-b1d4-58f265cd61f7_936x292.png 1456w" sizes="100vw" /><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32f1641e-8000-4905-b1d4-58f265cd61f7_936x292.png" width="936" height="292" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/32f1641e-8000-4905-b1d4-58f265cd61f7_936x292.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:292,&quot;width&quot;:936,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:null,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" class="sizing-normal" alt srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32f1641e-8000-4905-b1d4-58f265cd61f7_936x292.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32f1641e-8000-4905-b1d4-58f265cd61f7_936x292.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32f1641e-8000-4905-b1d4-58f265cd61f7_936x292.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32f1641e-8000-4905-b1d4-58f265cd61f7_936x292.png 1456w" sizes="100vw" loading="lazy" /></picture><div class="image-link-expand"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 "><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></div></div></a><figcaption class="image-caption">Figure 5: Daily unreachable nodes detected (last 3 months).</figcaption></figure></div><div class="captioned-image-container"><figure><a class="image-link is-viewable-img image2" target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32872e9d-09f0-46bc-9726-069f922664c2_937x294.png" data-component-name="Image2ToDOM" rel><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32872e9d-09f0-46bc-9726-069f922664c2_937x294.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32872e9d-09f0-46bc-9726-069f922664c2_937x294.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32872e9d-09f0-46bc-9726-069f922664c2_937x294.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32872e9d-09f0-46bc-9726-069f922664c2_937x294.png 1456w" sizes="100vw" /><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32872e9d-09f0-46bc-9726-069f922664c2_937x294.png" width="937" height="294" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/32872e9d-09f0-46bc-9726-069f922664c2_937x294.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:294,&quot;width&quot;:937,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:null,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" class="sizing-normal" alt srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32872e9d-09f0-46bc-9726-069f922664c2_937x294.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32872e9d-09f0-46bc-9726-069f922664c2_937x294.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32872e9d-09f0-46bc-9726-069f922664c2_937x294.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32872e9d-09f0-46bc-9726-069f922664c2_937x294.png 1456w" sizes="100vw" loading="lazy" /></picture><div class="image-link-expand"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 "><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></div></div></a><figcaption class="image-caption">Figure 6: Daily pods deleted by fixer for unreachable nodes (last 3 months).</figcaption></figure></div><h1 class="header-with-anchor-widget">Cleaning Up Succeeded and Evicted Pods<div id="§cleaning-up-succeeded-and-evicted-pods" class="header-anchor-widget offset-top"><div class="header-anchor-widget-button-container"><div href="https://techblog.citystoragesystems.com/i/145625273/cleaning-up-succeeded-and-evicted-pods" class="header-anchor-widget-button"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="header-anchor-widget-icon"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></div></div></div></h1><p><span>While investigating a cluster health degradation due to increased etcd disk size, we identified the accumulation of </span><code>Succeeded</code><span> pods as a significant factor. These were created by short lived cron jobs, pods without a controller (e.g. Flink jobs), and evicted pods. Since kube-controller-manager doesn't automatically clean up succeeded pods, this is a problem on our large multi-tenant clusters. This default behavior can be modified by configuring the </span><code>--terminated-pod-gc-threshold</code><span> flag. However, since we use managed Kubernetes the control plane is managed by the cloud provider and not user-configurable.</span></p><p><span>To address this, we implemented a self-healing automation that monitors the Kubernetes API server for pods with, either </span><code>status.phase = Succeeded</code><span>, or </span><code>status.phase = Failed</code><span> with </span><code>pod.Status.Reason = Evicted</code><span>. The detector flags pods that have remained in these phases for at least 15 minutes. This threshold is configurable per namespace. The corresponding fixer deletes these flagged pods from the API server.</span></p><div class="captioned-image-container"><figure><a class="image-link is-viewable-img image2" target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fea333b69-e7d8-4cec-a760-b8a5f68a4e47_937x293.png" data-component-name="Image2ToDOM" rel><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fea333b69-e7d8-4cec-a760-b8a5f68a4e47_937x293.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fea333b69-e7d8-4cec-a760-b8a5f68a4e47_937x293.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fea333b69-e7d8-4cec-a760-b8a5f68a4e47_937x293.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fea333b69-e7d8-4cec-a760-b8a5f68a4e47_937x293.png 1456w" sizes="100vw" /><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fea333b69-e7d8-4cec-a760-b8a5f68a4e47_937x293.png" width="937" height="293" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/ea333b69-e7d8-4cec-a760-b8a5f68a4e47_937x293.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:293,&quot;width&quot;:937,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:null,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" class="sizing-normal" alt srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fea333b69-e7d8-4cec-a760-b8a5f68a4e47_937x293.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fea333b69-e7d8-4cec-a760-b8a5f68a4e47_937x293.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fea333b69-e7d8-4cec-a760-b8a5f68a4e47_937x293.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fea333b69-e7d8-4cec-a760-b8a5f68a4e47_937x293.png 1456w" sizes="100vw" loading="lazy" /></picture><div class="image-link-expand"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 "><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></div></div></a><figcaption class="image-caption">Figure 7: Daily pods cleaned up by fixer for succeeded &amp; evicted pods (last 3 months).</figcaption></figure></div><h1 class="header-with-anchor-widget">Handling Network Packet Drops Due to Unbalanced IRQ<div id="§handling-network-packet-drops-due-to-unbalanced-irq" class="header-anchor-widget offset-top"><div class="header-anchor-widget-button-container"><div href="https://techblog.citystoragesystems.com/i/145625273/handling-network-packet-drops-due-to-unbalanced-irq" class="header-anchor-widget-button"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="header-anchor-widget-icon"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></div></div></div></h1><p><span>We noticed increased packet drop rates in network IO-intensive workloads, initially thought to be application errors. However, we saw that the nodes with affected workloads had </span><code>VMFreezeEvents</code><span> (see AKS </span><a href="https://learn.microsoft.com/en-us/azure/virtual-machines/linux/scheduled-events#event-properties" rel>docs</a><span>). Investigation showed hardware interrupts from the node’s network interface were unevenly handled by only 2 of 8 CPU cores, causing 100% utilization on those cores (see detailed investigation in </span><a href="https://zmalik.dev/posts/packet-drop" rel>blog</a><span>). Restarting the </span><code>irqbalance</code><span> service, which should distribute interrupts evenly, resolved the issue.</span></p><p><span>To address this, we implemented a self-healing automation that flags nodes where fewer than half of the CPU cores are configured to handle interrupts from the network interface. This is done by checking </span><code>/proc/irq/IRQ#/smp_affinity</code><span>, which denotes CPU core affinity to the interrupt request queue (IRQ). The corresponding fixer restarts the </span><code>irqbalance</code><span> systemd service on the host VM. We also expose the number of cores used for IRQ per node as a metric for continued observability. The upstream issue was later fixed in later versions of ubuntu (see bug </span><a href="https://bugs.launchpad.net/ubuntu/+source/irqbalance/+bug/2038573" rel>#2038573</a><span>).</span></p><div class="captioned-image-container"><figure><a class="image-link is-viewable-img image2" target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4b76bcb6-3d32-444c-b8de-cd57d93fa7cf_936x292.png" data-component-name="Image2ToDOM" rel><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4b76bcb6-3d32-444c-b8de-cd57d93fa7cf_936x292.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4b76bcb6-3d32-444c-b8de-cd57d93fa7cf_936x292.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4b76bcb6-3d32-444c-b8de-cd57d93fa7cf_936x292.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4b76bcb6-3d32-444c-b8de-cd57d93fa7cf_936x292.png 1456w" sizes="100vw" /><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4b76bcb6-3d32-444c-b8de-cd57d93fa7cf_936x292.png" width="936" height="292" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/4b76bcb6-3d32-444c-b8de-cd57d93fa7cf_936x292.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:292,&quot;width&quot;:936,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:null,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" class="sizing-normal" alt srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4b76bcb6-3d32-444c-b8de-cd57d93fa7cf_936x292.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4b76bcb6-3d32-444c-b8de-cd57d93fa7cf_936x292.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4b76bcb6-3d32-444c-b8de-cd57d93fa7cf_936x292.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4b76bcb6-3d32-444c-b8de-cd57d93fa7cf_936x292.png 1456w" sizes="100vw" loading="lazy" /></picture><div class="image-link-expand"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 "><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></div></div></a><figcaption class="image-caption">Figure 8: A recent spike in nodes with Unbalanced IRQ (post upstream fix).</figcaption></figure></div><p><span>Despite this fix, some packet drops persisted. This was traced to a backlog in the network interface's receive queue. We found if the receive queue size was set to less than 10000 it caused packet drops. To address this, we implemented another automation that flags nodes where </span><code>net.core.netdev_max_backlog</code><span> is less than 10000. The corresponding fixer, resets it to 10000 on the host VM.</span></p><h1 class="header-with-anchor-widget"><span>Addressing Failing </span><code>nftables</code><span> During OS Image Migration</span><div id="§addressing-failing-nftables-during-os-image-migration" class="header-anchor-widget offset-top"><div class="header-anchor-widget-button-container"><div href="https://techblog.citystoragesystems.com/i/145625273/addressing-failing-nftables-during-os-image-migration" class="header-anchor-widget-button"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="header-anchor-widget-icon"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></div></div></div></h1><p><span>While migrating our nodes from Ubuntu to </span><a href="https://learn.microsoft.com/en-us/azure/azure-linux/intro-azure-linux" rel>Azure Linux</a><span> OS, we noticed </span><a href="https://nftables.org/" rel>nftables</a><span> wasn’t running on the migrated nodes. Kubernetes relies on </span><code>nftables</code><span> on the host VM for inter-pod routing rules on the node and egress traffic. This prevented Network Policies from being applied correctly, leading to irregular network failure on nodes. After investigation, we identified this was due to a missing newline in the </span><code>nftables.conf</code><span> file (see issues </span><a href="https://github.com/Azure/AKS/issues/4144" rel>#4144</a><span> and </span><a href="https://github.com/microsoft/azurelinux/issues/7301" rel>#7301</a><span>, and pull request </span><a href="https://github.com/microsoft/azurelinux/pull/8310" rel>#8310</a><span>).</span></p><p><span>To address this, we implemented a self-healing automation that flags nodes where the host VM isn’t running </span><code>nftables</code><span>. The corresponding fixer corrects the nftables.conf file by appending a newline to the end and restarts the </span><code>nftables</code><span> systemd service.</span></p><div class="captioned-image-container"><figure><a class="image-link is-viewable-img image2" target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3268575d-af8e-40ec-960f-f3e8f7c617a2_936x294.png" data-component-name="Image2ToDOM" rel><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3268575d-af8e-40ec-960f-f3e8f7c617a2_936x294.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3268575d-af8e-40ec-960f-f3e8f7c617a2_936x294.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3268575d-af8e-40ec-960f-f3e8f7c617a2_936x294.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3268575d-af8e-40ec-960f-f3e8f7c617a2_936x294.png 1456w" sizes="100vw" /><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3268575d-af8e-40ec-960f-f3e8f7c617a2_936x294.png" width="936" height="294" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/3268575d-af8e-40ec-960f-f3e8f7c617a2_936x294.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:294,&quot;width&quot;:936,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:null,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" class="sizing-normal" alt srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3268575d-af8e-40ec-960f-f3e8f7c617a2_936x294.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3268575d-af8e-40ec-960f-f3e8f7c617a2_936x294.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3268575d-af8e-40ec-960f-f3e8f7c617a2_936x294.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3268575d-af8e-40ec-960f-f3e8f7c617a2_936x294.png 1456w" sizes="100vw" loading="lazy" /></picture><div class="image-link-expand"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 "><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></div></div></a><figcaption class="image-caption"><span>Figure 9: Number of nodes with failing </span><code>nftables</code><span> until the fixer was deployed.</span></figcaption></figure></div><h1 class="header-with-anchor-widget"><span>Addressing </span><code>node-problem-detector</code><span> Missing on Nodes</span><div id="§addressing-node-problem-detector-missing-on-nodes" class="header-anchor-widget offset-top"><div class="header-anchor-widget-button-container"><div href="https://techblog.citystoragesystems.com/i/145625273/addressing-node-problem-detector-missing-on-nodes" class="header-anchor-widget-button"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="header-anchor-widget-icon"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></div></div></div></h1><p><span>AKS </span><a href="https://learn.microsoft.com/en-us/azure/aks/faq#what-is-the-purpose-of-the-aks-linux-extension-i-see-installed-on-my-linux-virtual-machine-scale-sets-instances" rel>runs</a><span> </span><a href="https://github.com/kubernetes/node-problem-detector" rel>node-problem-detector</a><span> (NPD) to monitor </span><a href="https://learn.microsoft.com/en-us/azure/aks/node-problem-detector" rel>node health</a><span> and flag for removal during malfunction. It runs 10 checks every 30 seconds and injects the output into node conditions. We integrated these conditions into our observability stack. During a workload failure investigation, we noticed a node had only 4 status conditions instead of the usual 14 (10 from NPD and 4 from kubelet). This led us to discover NPD wasn’t running on the node. The workload failed because Container Runtime Interface (CRI) malfunctioned on the node preventing kubelet from verifying workload status.</span></p><p><span>We implemented a self-healing detector that flags nodes where NPD isn’t running. Further analysis revealed 25% of our nodes had this issue. Automatically terminating these nodes was deemed too risky. Instead, we rolled back the node OS on all of our nodes to a previously working version and escalated the issue to the cloud provider (see issue </span><a href="https://github.com/Azure/AKS/issues/3988" rel>#3988</a><span>). This was later attributed to an upstream </span><a href="https://security.snyk.io/vuln/SNYK-WOLFILATEST-NODEPROBLEMDETECTOR-5862811" rel>CVE</a><span> that was fixed. We also set up automated alerts for nodes without NPD to prevent future issues.</span></p><div class="captioned-image-container"><figure><a class="image-link is-viewable-img image2" target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52189f1e-c380-4a08-acec-21cbf643a276_1600x575.png" data-component-name="Image2ToDOM" rel><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52189f1e-c380-4a08-acec-21cbf643a276_1600x575.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52189f1e-c380-4a08-acec-21cbf643a276_1600x575.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52189f1e-c380-4a08-acec-21cbf643a276_1600x575.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52189f1e-c380-4a08-acec-21cbf643a276_1600x575.png 1456w" sizes="100vw" /><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52189f1e-c380-4a08-acec-21cbf643a276_1600x575.png" width="1456" height="523" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/52189f1e-c380-4a08-acec-21cbf643a276_1600x575.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:523,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:null,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" class="sizing-normal" alt srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52189f1e-c380-4a08-acec-21cbf643a276_1600x575.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52189f1e-c380-4a08-acec-21cbf643a276_1600x575.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52189f1e-c380-4a08-acec-21cbf643a276_1600x575.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52189f1e-c380-4a08-acec-21cbf643a276_1600x575.png 1456w" sizes="100vw" loading="lazy" /></picture><div class="image-link-expand"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 "><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></div></div></a><figcaption class="image-caption"><span>Figure 10: Nodes without </span><code>node-problem-detector</code><span> detected.</span></figcaption></figure></div><h1 class="header-with-anchor-widget"><span>Mitigating </span><code>ImagePullBackOff</code><span> Errors for Large Container Images</span><div id="§mitigating-imagepullbackoff-errors-for-large-container-images" class="header-anchor-widget offset-top"><div class="header-anchor-widget-button-container"><div href="https://techblog.citystoragesystems.com/i/145625273/mitigating-imagepullbackoff-errors-for-large-container-images" class="header-anchor-widget-button"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="header-anchor-widget-icon"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></div></div></div></h1><p><span>We faced a surge in </span><code>ImagePullBackOff</code><span> errors for workloads with large container images (7-10GB). The kubelet error messages (example below) were unhelpful, and workloads failed to start for hours. Manual eviction sometimes helped after multiple retries. An unrelated experiment benchmarking write speeds on </span><a href="https://learn.microsoft.com/en-us/azure/virtual-machines/disks-types" rel>Azure Managed OS disk</a><span> and </span><a href="https://learn.microsoft.com/en-us/azure/virtual-machines/ephemeral-os-disks" rel>Ephemeral OS disk</a><span>, led us to identify that the issues occurred exclusively on nodes with Managed OS disks.</span></p><pre><code>Oct 31 11:57:43 aks-nodepool0392-17898922-vmss0000LX kubelet[2874]: E1031 11:57:43.120279    2874 remote_image.go:242] &quot;PullImage from image service failed&quot; err=&quot;rpc error: code = Canceled desc = failed to pull and unpack image \&quot;cssacrprod.azurecr.io/chronorepo-companion-cron:efdc4a316aebcc878c38483b09bb939524dbd94a\&quot;: failed to commit snapshot extract-332345855-2JgL sha256:d2bd2b7dd52900b17c2e8d2f50d94273892a45d96a760f078aeb58bc54fbc160: context canceled&quot; image=&quot;cssacrprod.azurecr.io/chronorepo-companion-cron:efdc4a316aebcc878c38483b09bb939524dbd94a&quot;</code></pre><p><span>We implemented a self-healing detector that flags nodes with </span><code>ImagePullBackOff</code><span> errors by parsing kubelet logs. Currently, we lack an automatic fixer. Instead, we emit a custom warning event for each affected pod. Affected workloads can either retry, or if the issue persists, set a node affinity for label </span><code>ephemeral-storage = true</code><span>. All nodes in our platform with Ephemeral OS disks have this label.</span></p><h1 class="header-with-anchor-widget">Conclusion<div id="§conclusion" class="header-anchor-widget offset-top"><div class="header-anchor-widget-button-container"><div href="https://techblog.citystoragesystems.com/i/145625273/conclusion" class="header-anchor-widget-button"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="header-anchor-widget-icon"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></div></div></div></h1><p><span>Building out a self-healing solution for Kubernetes has allowed us to enhance the reliability of our Kubernetes platform without burdening ourselves with operational and support toil. Automation proved to be the right principle for us to scale to </span><a href="https://techblog.citystoragesystems.com/p/managing-100s-of-kubernetes-clusters" rel>100s of clusters</a><span>.</span></p><p>So, what’s next? We are constantly adding new detectors and fixers to our self-healing framework. Low level networking, noisy neighbor problems, CPU core use optimizations are few examples of areas we are actively investigating how to automatically detect and rectify problems. Furthermore, we plan on extending the framework beyond platform deficiencies to application deficiencies. We are confident the same mechanics of self-healing are widely applicable. Self-healing is the only answer to having a platform’s maintenance costs scale sublinearly with business growth. So we’re serious about investing in it further.</p></div></div><div class="visibility-check"></div><div class="post-footer"><div class="pencraft pc-display-flex pc-gap-16 pc-paddingTop-16 pc-paddingBottom-16 pc-justifyContent-space-between pc-alignItems-center _flexGrow_1w60r_230 pc-reset _border-top-detail-themed_1w60r_47 _border-bottom-detail-themed_1w60r_50 post-ufi"><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><div class="like-button-container post-ufi-button style-button"><a role="button" class="post-ufi-button style-button no-label with-border"><svg role="img" style="height: 20px; width: 20px;" width="20" height="20" viewBox="0 0 24 24" fill="#000000" stroke-width="2" stroke="#000" xmlns="http://www.w3.org/2000/svg" class="icon"><g><title></title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-heart "><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path></svg></g></svg></a><div inert role="dialog" class="modal typography out gone share-dialog popup"><div class="modal-table"><div class="modal-row"><div class="modal-cell modal-content no-fullscreen"><div class="container"><button tabIndex="0" type="button" data-testid="close-modal" class="pencraft pc-reset pencraft modal-btn modal-exit-btn no-margin _iconButton_kqk6u_145 _iconButtonBase_kqk6u_145 _buttonBase_kqk6u_1 _buttonOldColors_kqk6u_56 _size_40_kqk6u_175 _priority_secondary_kqk6u_63 _fill_empty_kqk6u_316 _rounded_kqk6u_155"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="secondary" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x "><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg></button><div class="share-dialog-title">Share this post</div><div class="pencraft pc-display-flex pc-flexDirection-column pc-gap-32 pc-paddingLeft-24 pc-paddingRight-24 pc-paddingTop-32 pc-paddingBottom-48 pc-reset"><div class="pencraft pc-display-flex pc-padding-8 pc-reset _border-detail_1w60r_25 pc-borderRadius-md social-preview-box post"><div class="social-image-box"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_120,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F11e401f2-cdd8-440b-89eb-7f6eaeeb3aae_1689x990.png" /><img src="https://substackcdn.com/image/fetch/w_120,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F11e401f2-cdd8-440b-89eb-7f6eaeeb3aae_1689x990.png" sizes="100vw" alt width="120" loading="lazy" class="_img_16u6n_1 social-image pencraft pc-reset" /></picture></div><div class="pencraft pc-display-flex pc-flexDirection-column pc-paddingTop-8 pc-paddingBottom-8 pc-paddingLeft-12 pc-reset"><h4 class="pencraft pc-reset _line-height-24_1k90y_98 _font-display_1k90y_118 _size-20_1k90y_70 _weight-bold_1k90y_168 _reset_1k90y_1">From Fragile to Faultless: Kubernetes Self-Healing In Practice</h4><div class="pencraft pc-reset _color-secondary_1k90y_186 _line-height-20_1k90y_95 _font-text_1k90y_121 _size-13_1k90y_45 _weight-regular_1k90y_159 _reset_1k90y_1">techblog.citystoragesystems.com</div></div></div><div class="pencraft pc-display-flex pc-gap-8 pc-justifyContent-space-between pc-reset share-dialog-buttons-wrapper"><button tabIndex="0" type="button" class="button share-action"><div class="action-icon"><svg role="img" width="20" height="16" viewBox="0 0 20 16" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><path fill-rule="evenodd" clip-rule="evenodd" d="M12.1303 0.000379039C10.9833 -0.00959082 9.87819 0.431464 9.05309 1.22855L9.04556 1.23593L7.79145 2.48303C7.50587 2.767 7.50453 3.22877 7.78844 3.51441C8.07235 3.80004 8.53401 3.80139 8.81959 3.51741L10.0698 2.27423C10.6194 1.74503 11.3546 1.45229 12.1177 1.45892C12.8824 1.46556 13.6139 1.77236 14.1546 2.31323C14.6954 2.8541 15.0021 3.58577 15.0087 4.35065C15.0154 5.11353 14.7229 5.84857 14.1943 6.39829L12.0116 8.58145L12.0115 8.58155C11.7159 8.87739 11.36 9.10617 10.9682 9.25237C10.5764 9.39857 10.1577 9.45878 9.74051 9.42889C9.32337 9.39901 8.91752 9.27975 8.55051 9.07918C8.1835 8.87862 7.8639 8.60146 7.6134 8.26649C7.3722 7.94396 6.91526 7.87807 6.5928 8.11933C6.27034 8.36059 6.20447 8.81763 6.44567 9.14016C6.82142 9.64261 7.30082 10.0584 7.85134 10.3592C8.40186 10.66 9.01062 10.8389 9.63634 10.8838C10.2621 10.9286 10.8901 10.8383 11.4779 10.619C12.0656 10.3997 12.5994 10.0565 13.0429 9.61274L15.2302 7.42494L15.2391 7.4159C16.036 6.59062 16.4769 5.48529 16.467 4.33797C16.457 3.19066 15.9969 2.09316 15.1858 1.28185C14.3746 0.470545 13.2774 0.0103489 12.1303 0.000379039ZM7.29806 5.11625C6.67234 5.07142 6.0443 5.16173 5.45654 5.38103C4.86882 5.60031 4.33502 5.94355 3.89153 6.38727L1.70423 8.57506L1.69534 8.5841C0.898438 9.40939 0.457483 10.5147 0.467451 11.662C0.477418 12.8094 0.937512 13.9069 1.74864 14.7182C2.55976 15.5295 3.65701 15.9897 4.80407 15.9996C5.95113 16.0096 7.05622 15.5685 7.88132 14.7715L7.89035 14.7626L9.13717 13.5155C9.42192 13.2307 9.42192 12.7689 9.13717 12.4841C8.85243 12.1993 8.39077 12.1993 8.10602 12.4841L6.86392 13.7265C6.31432 14.2552 5.57945 14.5477 4.81675 14.5411C4.05204 14.5344 3.32054 14.2276 2.77979 13.6868C2.23904 13.1459 1.93231 12.4142 1.92566 11.6494C1.91904 10.8865 2.21146 10.1514 2.74011 9.60172L4.92287 7.41846C5.21854 7.12262 5.57437 6.89384 5.96621 6.74763C6.35805 6.60143 6.77674 6.54123 7.19389 6.57111C7.61104 6.601 8.01688 6.72026 8.38389 6.92082C8.75091 7.12138 9.0705 7.39855 9.32101 7.73352C9.56221 8.05605 10.0191 8.12194 10.3416 7.88068C10.6641 7.63942 10.7299 7.18238 10.4887 6.85985C10.113 6.3574 9.63359 5.94165 9.08307 5.64081C8.53255 5.33997 7.92378 5.16107 7.29806 5.11625Z"></path></g></svg></div><div translated class="pencraft pc-reset _color-secondary_1k90y_186 _line-height-20_1k90y_95 _font-text_1k90y_121 _size-13_1k90y_45 _weight-regular_1k90y_159 _reset_1k90y_1">Copy link</div></button><button tabIndex="0" type="button" class="button share-action"><div class="action-icon"><svg role="img" width="16" height="17" viewBox="0 0 16 17" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><path d="M10.6543 1.38723C10.3533 0.960814 9.95383 0.61341 9.48976 0.374567C9.02902 0.137956 8.51908 0.0130716 8.00115 0.0100098C7.86087 0.0101844 7.72354 0.0502687 7.60519 0.125581C7.48684 0.200893 7.39237 0.308324 7.3328 0.435326L5.00368 5.67077H3.029C2.72335 5.66964 2.42059 5.73003 2.13876 5.84833C1.85692 5.96663 1.60177 6.14043 1.38849 6.35938C1.16707 6.57502 0.991841 6.83346 0.873459 7.11897C0.755078 7.40447 0.696022 7.71108 0.699885 8.02014V13.691C0.699885 14.3087 0.945273 14.9012 1.38207 15.338C1.81886 15.7747 2.41128 16.0201 3.029 16.0201H13.348C13.8951 16.021 14.425 15.8283 14.8438 15.4762C15.2626 15.1241 15.5434 14.6352 15.6366 14.0961L16.6493 8.4252C16.7252 8.09192 16.7252 7.74582 16.6493 7.41254C16.566 7.08205 16.4104 6.7742 16.1936 6.51128C15.9746 6.25 15.7017 6.03926 15.3936 5.89355C15.0762 5.7467 14.7306 5.67068 14.3809 5.67077H10.5328L11.0391 4.37457C11.2397 3.88784 11.3162 3.35894 11.2619 2.83533C11.1853 2.30894 10.9763 1.81065 10.6543 1.38723ZM4.75052 14.5518H3.029C2.91049 14.5525 2.79303 14.5296 2.68349 14.4844C2.57394 14.4392 2.47452 14.3726 2.39102 14.2885C2.23609 14.1199 2.14945 13.8997 2.14799 13.6708V8.02014C2.14913 7.901 2.17389 7.78328 2.22082 7.67377C2.26775 7.56427 2.33592 7.46515 2.4214 7.38216C2.50369 7.29576 2.60267 7.22698 2.71233 7.17998C2.822 7.13298 2.94007 7.10874 3.05938 7.10874H4.7809L4.75052 14.5518ZM10.6746 7.05811H14.3809C14.5145 7.05821 14.6462 7.08942 14.7657 7.14925C14.8875 7.20532 14.9948 7.28845 15.0796 7.39229C15.1675 7.49052 15.2301 7.60871 15.2619 7.73659C15.2922 7.8665 15.2922 8.00162 15.2619 8.13153L14.2493 13.8024C14.2087 14.017 14.094 14.2106 13.9252 14.3492C13.7619 14.4812 13.558 14.5528 13.348 14.5518H6.19862V6.45052L8.43659 1.38723H8.52773C8.9042 1.50037 9.23304 1.73413 9.4636 2.05252C9.69416 2.37092 9.81365 2.75627 9.80368 3.14925C9.8181 3.39741 9.78015 3.64583 9.69229 3.87836L9.23659 5.04292C9.15397 5.273 9.12623 5.51921 9.15558 5.76191C9.1877 6.00427 9.27425 6.23623 9.40875 6.44039C9.5535 6.6376 9.74028 6.80017 9.95558 6.91634C10.1774 7.03206 10.4244 7.0912 10.6746 7.08849V7.05811Z"></path></g></svg></div><div translated class="pencraft pc-reset _color-secondary_1k90y_186 _line-height-20_1k90y_95 _font-text_1k90y_121 _size-13_1k90y_45 _weight-regular_1k90y_159 _reset_1k90y_1">Facebook</div></button><button tabIndex="0" type="button" class="button share-action"><div class="action-icon"><svg role="img" width="21" height="16" viewBox="0 0 21 16" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><path fill-rule="evenodd" clip-rule="evenodd" d="M2.22192 2.20503C2.36754 1.77115 2.78269 1.45455 3.26639 1.45455H17.9332C18.4169 1.45455 18.8321 1.77118 18.9777 2.2051L10.5999 8.02107L2.22192 2.20503ZM2.16639 3.94198V13.4545C2.16639 14.0529 2.66307 14.5455 3.26639 14.5455H17.9332C18.5365 14.5455 19.0332 14.0529 19.0332 13.4545V3.94206L11.0204 9.50462C10.7679 9.67991 10.4318 9.67991 10.1793 9.50462L2.16639 3.94198ZM20.4999 2.55809V13.4545C20.4999 14.8562 19.3465 16 17.9332 16H3.26639C1.85304 16 0.699707 14.8562 0.699707 13.4545V2.54545C0.699707 1.14379 1.85304 0 3.26639 0H17.9332C19.3407 0 20.4904 1.13441 20.4998 2.52818C20.5 2.53816 20.5001 2.54813 20.4999 2.55809Z"></path></g></svg></div><div translated class="pencraft pc-reset _color-secondary_1k90y_186 _line-height-20_1k90y_95 _font-text_1k90y_121 _size-13_1k90y_45 _weight-regular_1k90y_159 _reset_1k90y_1">Email</div></button><button tabIndex="0" type="button" class="button share-action"><div class="action-icon"><svg role="img" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><path d="M6.785 1.92766C5.45134 1.57031 4.08049 2.36176 3.72314 3.69543L0.444815 15.9303C0.0874636 17.264 0.878901 18.6348 2.21255 18.9922L5.37495 19.8396V7.66664C5.37495 6.40099 6.40096 5.37498 7.66661 5.37498H19.4723C19.3299 5.30548 19.1788 5.24858 19.0201 5.20604L6.785 1.92766Z" stroke="none"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M8.44161 7.4C7.86632 7.4 7.39995 7.86637 7.39995 8.44167V22.1081C7.39995 22.6834 7.86631 23.1498 8.4416 23.1498L22.1083 23.15C22.6836 23.15 23.1499 22.6836 23.1499 22.1083V8.44167C23.1499 7.86637 22.6836 7.4 22.1083 7.4H8.44161ZM10.3999 9.65C9.84766 9.65 9.39995 10.0977 9.39995 10.65C9.39995 11.2023 9.84766 11.65 10.3999 11.65H18.3999C18.9522 11.65 19.3999 11.2023 19.3999 10.65C19.3999 10.0977 18.9522 9.65 18.3999 9.65H10.3999ZM10.3999 14.15C9.84766 14.15 9.39995 14.5977 9.39995 15.15C9.39995 15.7023 9.84766 16.15 10.3999 16.15H15.3999C15.9522 16.15 16.3999 15.7023 16.3999 15.15C16.3999 14.5977 15.9522 14.15 15.3999 14.15H10.3999Z" stroke="none"></path></g></svg></div><div class="pencraft pc-reset _color-secondary_1k90y_186 _line-height-20_1k90y_95 _font-text_1k90y_121 _size-13_1k90y_45 _weight-regular_1k90y_159 _reset_1k90y_1">Note</div></button><button tabIndex="0" id="trigger388871" aria-expanded="false" aria-haspopup="dialog" aria-controls="dialog388872" ariaLabel="View more" type="button" class="button share-action"><div class="action-icon"><svg role="img" width="100" height="100" viewBox="0 0 100 100" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><circle cx="23" cy="50" r="9"></circle><circle cx="50" cy="50" r="9"></circle><circle cx="77" cy="50" r="9"></circle></g></svg></div><div translated class="pencraft pc-reset _color-secondary_1k90y_186 _line-height-20_1k90y_95 _font-text_1k90y_121 _size-13_1k90y_45 _weight-regular_1k90y_159 _reset_1k90y_1">Other</div></button></div></div></div></div></div></div></div></div></div><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><a role="button" href="javascript:void(0)" class="post-ufi-button style-button no-icon has-label with-border"><div class="label">Share</div></a></div></div></div></div></article></div></div><div class="single-post-section"><div class="container"><div class="visibility-check"></div><div class="pencraft pc-display-contents pc-reset _pubTheme_1lb4s_1"><div class="pencraft pc-paddingTop-24 pc-paddingBottom-24 pc-reset"><div class="portable-archive empty-list"><div class="pencraft pc-display-flex pc-paddingLeft-8 pc-paddingRight-8 pc-paddingBottom-16 pc-justifyContent-space-between pc-alignItems-center pc-reset"><div class="pencraft pc-display-flex pc-gap-8 pc-padding-4 pc-position-relative pc-reset _bg-secondary_1w60r_172 pc-borderRadius-full _segments_lgnd1_56"><button tabIndex="0" type="button" class="pencraft pc-display-flex pc-height-32 pc-paddingLeft-12 pc-paddingRight-12 pc-justifyContent-center pc-alignItems-center pc-cursor-pointer pc-reset _bg-unset_1w60r_166 _border-unset_1w60r_21 _sizing-border-box_1w60r_274 pencraft _segment_lgnd1_56 _active_lgnd1_26"><div class="pencraft pc-reset _line-height-20_1k90y_95 _font-text_1k90y_121 _size-14_1k90y_50 _weight-semibold_1k90y_165 _reset_1k90y_1 _segmentText_lgnd1_66 _active_lgnd1_26">Top</div></button><button tabIndex="0" type="button" class="pencraft pc-display-flex pc-height-32 pc-paddingLeft-12 pc-paddingRight-12 pc-justifyContent-center pc-alignItems-center pc-cursor-pointer pc-reset _bg-unset_1w60r_166 _border-unset_1w60r_21 _sizing-border-box_1w60r_274 pencraft _segment_lgnd1_56"><div class="pencraft pc-reset _line-height-20_1k90y_95 _font-text_1k90y_121 _size-14_1k90y_50 _weight-semibold_1k90y_165 _reset_1k90y_1 _segmentText_lgnd1_66">Latest</div></button><div class="pencraft pc-display-flex pc-height-32 pc-boxShadow-sm pc-position-absolute pc-reset _bg-primary_1w60r_169 pc-borderRadius-full _segmentPill_lgnd1_81"></div></div><button tabIndex="0" type="button" class="pencraft pc-reset pencraft _iconButton2_kqk6u_628 _iconButtonBase_kqk6u_145 _buttonBase_kqk6u_1 _buttonNew_kqk6u_83 _size_md_kqk6u_127 _priority_tertiary_kqk6u_69"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search "><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></svg></button></div><div class="portable-archive-list"><p class="portable-archive-empty">No posts</p></div></div></div></div></div></div><div class="visibility-check"></div><div class="subscribe-footer"><div class="container"><p>Ready for more?</p><div class="pencraft pc-display-flex pc-justifyContent-center pc-reset"><div><div class="_container_1mxvn_1"><form action="/api/v1/free?nojs=true" method="post" noValidate class="form _form_1mxvn_6"><input type="hidden" name="first_url" /><input type="hidden" name="first_referrer" /><input type="hidden" name="current_url" /><input type="hidden" name="current_referrer" /><input type="hidden" name="referral_code" /><input type="hidden" name="source" value="subscribe_footer" /><input type="hidden" name="referring_pub_id" /><input type="hidden" name="additional_referring_pub_ids" /><div class="_sideBySideWrap_1mxvn_10"><div class="_emailInputWrapper_1mxvn_57"><input type="email" name="email" placeholder="Type your email..." class="pencraft _emailInput_1mxvn_23 _emailInputOnAccentBackground_1mxvn_49" /></div><button tabIndex="0" type="submit" class="button rightButton primary subscribe-btn _button_1mxvn_76 _buttonOnAccentBackground_1mxvn_89"><span class="button-text ">Subscribe</span></button></div><div id="error-container"></div></form></div></div></div></div></div></div></div><div class="footer-wrap publication-footer"><div class="visibility-check"></div><div class="footer themed-background"><div class="container"><div class="footer-blurbs"><div class="footer-copyright-blurb">© 2024 City Storage Systems</div><div class="footer-terms-blurb"><a href="https://substack.com/privacy" target="_blank" rel="noopener noreferrer">Privacy</a><span> ∙ </span><a href="https://substack.com/tos" target="_blank" rel="noopener noreferrer">Terms</a><span> ∙ </span><a href="https://substack.com/ccpa#personal-data-collected" target="_blank" rel="noopener noreferrer">Collection notice</a></div></div><div class="footer-buttons"><a native href="https://substack.com/signup?utm_source=substack&amp;utm_medium=web&amp;utm_content=footer" class="footer-substack-cta start-publishing"><svg role="img" width="1000" height="1000" viewBox="0 0 1000 1000" fill="#FF6719" stroke-width="1.8" stroke="none" xmlns="http://www.w3.org/2000/svg"><g><title></title><path d="M764.166 348.371H236.319V419.402H764.166V348.371Z"></path><path d="M236.319 483.752V813.999L500.231 666.512L764.19 813.999V483.752H236.319Z"></path><path d="M764.166 213H236.319V284.019H764.166V213Z"></path></g></svg> Start Writing</a><a native href="https://substack.com/app/app-store-redirect?utm_campaign=app-marketing&amp;utm_content=web-footer-button" class="footer-substack-cta get-the-app no-icon">Get the app</a></div><div translated class="pencraft pc-reset _reset_1k90y_1 footer-slogan-blurb"><a href="https://substack.com" native>Substack</a> is the home for great culture</div></div></div></div></div><div inert role="dialog" class="modal typography out gone share-dialog popup"><div class="modal-table"><div class="modal-row"><div class="modal-cell modal-content no-fullscreen"><div class="container"><button tabIndex="0" type="button" data-testid="close-modal" class="pencraft pc-reset pencraft modal-btn modal-exit-btn no-margin _iconButton_kqk6u_145 _iconButtonBase_kqk6u_145 _buttonBase_kqk6u_1 _buttonOldColors_kqk6u_56 _size_40_kqk6u_175 _priority_secondary_kqk6u_63 _fill_empty_kqk6u_316 _rounded_kqk6u_155"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="secondary" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x "><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg></button><div class="share-dialog-title">Share</div><div class="pencraft pc-display-flex pc-flexDirection-column pc-gap-32 pc-paddingLeft-24 pc-paddingRight-24 pc-paddingTop-32 pc-paddingBottom-48 pc-reset"><div class="pencraft pc-display-flex pc-gap-8 pc-justifyContent-space-between pc-reset share-dialog-buttons-wrapper"><button tabIndex="0" type="button" class="button share-action"><div class="action-icon"><svg role="img" width="20" height="16" viewBox="0 0 20 16" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><path fill-rule="evenodd" clip-rule="evenodd" d="M12.1303 0.000379039C10.9833 -0.00959082 9.87819 0.431464 9.05309 1.22855L9.04556 1.23593L7.79145 2.48303C7.50587 2.767 7.50453 3.22877 7.78844 3.51441C8.07235 3.80004 8.53401 3.80139 8.81959 3.51741L10.0698 2.27423C10.6194 1.74503 11.3546 1.45229 12.1177 1.45892C12.8824 1.46556 13.6139 1.77236 14.1546 2.31323C14.6954 2.8541 15.0021 3.58577 15.0087 4.35065C15.0154 5.11353 14.7229 5.84857 14.1943 6.39829L12.0116 8.58145L12.0115 8.58155C11.7159 8.87739 11.36 9.10617 10.9682 9.25237C10.5764 9.39857 10.1577 9.45878 9.74051 9.42889C9.32337 9.39901 8.91752 9.27975 8.55051 9.07918C8.1835 8.87862 7.8639 8.60146 7.6134 8.26649C7.3722 7.94396 6.91526 7.87807 6.5928 8.11933C6.27034 8.36059 6.20447 8.81763 6.44567 9.14016C6.82142 9.64261 7.30082 10.0584 7.85134 10.3592C8.40186 10.66 9.01062 10.8389 9.63634 10.8838C10.2621 10.9286 10.8901 10.8383 11.4779 10.619C12.0656 10.3997 12.5994 10.0565 13.0429 9.61274L15.2302 7.42494L15.2391 7.4159C16.036 6.59062 16.4769 5.48529 16.467 4.33797C16.457 3.19066 15.9969 2.09316 15.1858 1.28185C14.3746 0.470545 13.2774 0.0103489 12.1303 0.000379039ZM7.29806 5.11625C6.67234 5.07142 6.0443 5.16173 5.45654 5.38103C4.86882 5.60031 4.33502 5.94355 3.89153 6.38727L1.70423 8.57506L1.69534 8.5841C0.898438 9.40939 0.457483 10.5147 0.467451 11.662C0.477418 12.8094 0.937512 13.9069 1.74864 14.7182C2.55976 15.5295 3.65701 15.9897 4.80407 15.9996C5.95113 16.0096 7.05622 15.5685 7.88132 14.7715L7.89035 14.7626L9.13717 13.5155C9.42192 13.2307 9.42192 12.7689 9.13717 12.4841C8.85243 12.1993 8.39077 12.1993 8.10602 12.4841L6.86392 13.7265C6.31432 14.2552 5.57945 14.5477 4.81675 14.5411C4.05204 14.5344 3.32054 14.2276 2.77979 13.6868C2.23904 13.1459 1.93231 12.4142 1.92566 11.6494C1.91904 10.8865 2.21146 10.1514 2.74011 9.60172L4.92287 7.41846C5.21854 7.12262 5.57437 6.89384 5.96621 6.74763C6.35805 6.60143 6.77674 6.54123 7.19389 6.57111C7.61104 6.601 8.01688 6.72026 8.38389 6.92082C8.75091 7.12138 9.0705 7.39855 9.32101 7.73352C9.56221 8.05605 10.0191 8.12194 10.3416 7.88068C10.6641 7.63942 10.7299 7.18238 10.4887 6.85985C10.113 6.3574 9.63359 5.94165 9.08307 5.64081C8.53255 5.33997 7.92378 5.16107 7.29806 5.11625Z"></path></g></svg></div><div translated class="pencraft pc-reset _color-secondary_1k90y_186 _line-height-20_1k90y_95 _font-text_1k90y_121 _size-13_1k90y_45 _weight-regular_1k90y_159 _reset_1k90y_1">Copy link</div></button><button tabIndex="0" type="button" class="button share-action"><div class="action-icon"><svg role="img" width="16" height="17" viewBox="0 0 16 17" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><path d="M10.6543 1.38723C10.3533 0.960814 9.95383 0.61341 9.48976 0.374567C9.02902 0.137956 8.51908 0.0130716 8.00115 0.0100098C7.86087 0.0101844 7.72354 0.0502687 7.60519 0.125581C7.48684 0.200893 7.39237 0.308324 7.3328 0.435326L5.00368 5.67077H3.029C2.72335 5.66964 2.42059 5.73003 2.13876 5.84833C1.85692 5.96663 1.60177 6.14043 1.38849 6.35938C1.16707 6.57502 0.991841 6.83346 0.873459 7.11897C0.755078 7.40447 0.696022 7.71108 0.699885 8.02014V13.691C0.699885 14.3087 0.945273 14.9012 1.38207 15.338C1.81886 15.7747 2.41128 16.0201 3.029 16.0201H13.348C13.8951 16.021 14.425 15.8283 14.8438 15.4762C15.2626 15.1241 15.5434 14.6352 15.6366 14.0961L16.6493 8.4252C16.7252 8.09192 16.7252 7.74582 16.6493 7.41254C16.566 7.08205 16.4104 6.7742 16.1936 6.51128C15.9746 6.25 15.7017 6.03926 15.3936 5.89355C15.0762 5.7467 14.7306 5.67068 14.3809 5.67077H10.5328L11.0391 4.37457C11.2397 3.88784 11.3162 3.35894 11.2619 2.83533C11.1853 2.30894 10.9763 1.81065 10.6543 1.38723ZM4.75052 14.5518H3.029C2.91049 14.5525 2.79303 14.5296 2.68349 14.4844C2.57394 14.4392 2.47452 14.3726 2.39102 14.2885C2.23609 14.1199 2.14945 13.8997 2.14799 13.6708V8.02014C2.14913 7.901 2.17389 7.78328 2.22082 7.67377C2.26775 7.56427 2.33592 7.46515 2.4214 7.38216C2.50369 7.29576 2.60267 7.22698 2.71233 7.17998C2.822 7.13298 2.94007 7.10874 3.05938 7.10874H4.7809L4.75052 14.5518ZM10.6746 7.05811H14.3809C14.5145 7.05821 14.6462 7.08942 14.7657 7.14925C14.8875 7.20532 14.9948 7.28845 15.0796 7.39229C15.1675 7.49052 15.2301 7.60871 15.2619 7.73659C15.2922 7.8665 15.2922 8.00162 15.2619 8.13153L14.2493 13.8024C14.2087 14.017 14.094 14.2106 13.9252 14.3492C13.7619 14.4812 13.558 14.5528 13.348 14.5518H6.19862V6.45052L8.43659 1.38723H8.52773C8.9042 1.50037 9.23304 1.73413 9.4636 2.05252C9.69416 2.37092 9.81365 2.75627 9.80368 3.14925C9.8181 3.39741 9.78015 3.64583 9.69229 3.87836L9.23659 5.04292C9.15397 5.273 9.12623 5.51921 9.15558 5.76191C9.1877 6.00427 9.27425 6.23623 9.40875 6.44039C9.5535 6.6376 9.74028 6.80017 9.95558 6.91634C10.1774 7.03206 10.4244 7.0912 10.6746 7.08849V7.05811Z"></path></g></svg></div><div translated class="pencraft pc-reset _color-secondary_1k90y_186 _line-height-20_1k90y_95 _font-text_1k90y_121 _size-13_1k90y_45 _weight-regular_1k90y_159 _reset_1k90y_1">Facebook</div></button><button tabIndex="0" type="button" class="button share-action"><div class="action-icon"><svg role="img" width="21" height="16" viewBox="0 0 21 16" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><path fill-rule="evenodd" clip-rule="evenodd" d="M2.22192 2.20503C2.36754 1.77115 2.78269 1.45455 3.26639 1.45455H17.9332C18.4169 1.45455 18.8321 1.77118 18.9777 2.2051L10.5999 8.02107L2.22192 2.20503ZM2.16639 3.94198V13.4545C2.16639 14.0529 2.66307 14.5455 3.26639 14.5455H17.9332C18.5365 14.5455 19.0332 14.0529 19.0332 13.4545V3.94206L11.0204 9.50462C10.7679 9.67991 10.4318 9.67991 10.1793 9.50462L2.16639 3.94198ZM20.4999 2.55809V13.4545C20.4999 14.8562 19.3465 16 17.9332 16H3.26639C1.85304 16 0.699707 14.8562 0.699707 13.4545V2.54545C0.699707 1.14379 1.85304 0 3.26639 0H17.9332C19.3407 0 20.4904 1.13441 20.4998 2.52818C20.5 2.53816 20.5001 2.54813 20.4999 2.55809Z"></path></g></svg></div><div translated class="pencraft pc-reset _color-secondary_1k90y_186 _line-height-20_1k90y_95 _font-text_1k90y_121 _size-13_1k90y_45 _weight-regular_1k90y_159 _reset_1k90y_1">Email</div></button><button tabIndex="0" type="button" class="button share-action"><div class="action-icon"><svg role="img" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><path d="M6.785 1.92766C5.45134 1.57031 4.08049 2.36176 3.72314 3.69543L0.444815 15.9303C0.0874636 17.264 0.878901 18.6348 2.21255 18.9922L5.37495 19.8396V7.66664C5.37495 6.40099 6.40096 5.37498 7.66661 5.37498H19.4723C19.3299 5.30548 19.1788 5.24858 19.0201 5.20604L6.785 1.92766Z" stroke="none"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M8.44161 7.4C7.86632 7.4 7.39995 7.86637 7.39995 8.44167V22.1081C7.39995 22.6834 7.86631 23.1498 8.4416 23.1498L22.1083 23.15C22.6836 23.15 23.1499 22.6836 23.1499 22.1083V8.44167C23.1499 7.86637 22.6836 7.4 22.1083 7.4H8.44161ZM10.3999 9.65C9.84766 9.65 9.39995 10.0977 9.39995 10.65C9.39995 11.2023 9.84766 11.65 10.3999 11.65H18.3999C18.9522 11.65 19.3999 11.2023 19.3999 10.65C19.3999 10.0977 18.9522 9.65 18.3999 9.65H10.3999ZM10.3999 14.15C9.84766 14.15 9.39995 14.5977 9.39995 15.15C9.39995 15.7023 9.84766 16.15 10.3999 16.15H15.3999C15.9522 16.15 16.3999 15.7023 16.3999 15.15C16.3999 14.5977 15.9522 14.15 15.3999 14.15H10.3999Z" stroke="none"></path></g></svg></div><div class="pencraft pc-reset _color-secondary_1k90y_186 _line-height-20_1k90y_95 _font-text_1k90y_121 _size-13_1k90y_45 _weight-regular_1k90y_159 _reset_1k90y_1">Note</div></button><button tabIndex="0" id="trigger388875" aria-expanded="false" aria-haspopup="dialog" aria-controls="dialog388876" ariaLabel="View more" type="button" class="button share-action"><div class="action-icon"><svg role="img" width="100" height="100" viewBox="0 0 100 100" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><circle cx="23" cy="50" r="9"></circle><circle cx="50" cy="50" r="9"></circle><circle cx="77" cy="50" r="9"></circle></g></svg></div><div translated class="pencraft pc-reset _color-secondary_1k90y_186 _line-height-20_1k90y_95 _font-text_1k90y_121 _size-13_1k90y_45 _weight-regular_1k90y_159 _reset_1k90y_1">Other</div></button></div></div></div></div></div></div></div><div style="transform: translateY(0px);" class="tw-fixed tw-bottom-2.5 tw-right-2.5 tw-left-2.5 md:tw-left-auto md:tw-bottom-5 md:tw-right-5 md:tw-pl-4 tw-z-40"></div><div></div>
        </div>

        
            <script src="https://js.sentry-cdn.com/6c2ff3e3828e4017b7faf7b63e24cdf8.min.js" crossorigin="anonymous"></script>
            <script>
                window.Sentry && window.Sentry.onLoad(function() {
                    window.Sentry.init({
                        environment: window._preloads.sentry_environment,
                        dsn: window._preloads.sentry_dsn,
                    })
                })
            </script>
        


        
        
        
        <script>window._preloads        = JSON.parse("{\"isEU\":true,\"language\":\"en\",\"country\":\"GB\",\"base_url\":\"https://techblog.citystoragesystems.com\",\"stripe_publishable_key\":\"pk_live_vNnuGHOFnt4mM7V9PuCAAPJz\",\"captcha_site_key\":\"6LdYbsYZAAAAAIFIRh8X_16GoFRLIReh-e-q6qSa\",\"pub\":{\"apple_pay_disabled\":false,\"apex_domain\":null,\"author_id\":197494688,\"byline_images_enabled\":false,\"bylines_enabled\":true,\"chartable_token\":null,\"community_enabled\":true,\"copyright\":\"City Storage Systems\",\"cover_photo_url\":\"https://substack-post-media.s3.amazonaws.com/public/images/ad185372-66a9-4417-83c0-9f9168b011fa_1280x907.png\",\"created_at\":\"2024-01-14T22:18:26.338Z\",\"custom_domain_optional\":false,\"custom_domain\":\"techblog.citystoragesystems.com\",\"custom_publication_theme_id\":null,\"default_comment_sort\":\"best_first\",\"default_coupon\":null,\"default_group_coupon\":null,\"default_show_guest_bios\":true,\"email_banner_url\":null,\"email_from_name\":\"CityStorageSystems Engineering\",\"email_from\":null,\"embed_tracking_disabled\":false,\"explicit\":false,\"expose_paywall_content_to_search_engines\":true,\"fb_pixel_id\":null,\"fb_site_verification_token\":null,\"flagged_as_spam\":false,\"founding_subscription_benefits\":null,\"free_subscription_benefits\":null,\"ga_pixel_id\":null,\"google_site_verification_token\":null,\"google_tag_manager_token\":null,\"hero_image\":null,\"hero_text\":\"Engineering the future of food at Otter & CloudKitchens\",\"hide_intro_subtitle\":null,\"hide_intro_title\":null,\"hide_podcast_feed_link\":false,\"homepage_type\":\"newspaper\",\"id\":2259056,\"image_thumbnails_always_enabled\":false,\"invite_only\":false,\"language\":\"en\",\"logo_url_wide\":\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F494bd983-fb57-4ec0-ac8e-d62647802192_2688x512.jpeg\",\"logo_url\":\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00427a51-29da-4fd7-b0ea-75bf09b879c5_512x512.png\",\"minimum_group_size\":2,\"moderation_enabled\":true,\"name\":\"City Storage Systems\",\"paid_subscription_benefits\":null,\"parsely_pixel_id\":null,\"payments_state\":\"disabled\",\"paywall_free_trial_enabled\":false,\"podcast_art_url\":null,\"paid_podcast_episode_art_url\":null,\"podcast_byline\":null,\"podcast_description\":null,\"podcast_enabled\":false,\"podcast_feed_url\":null,\"podcast_title\":null,\"post_preview_limit\":null,\"require_clickthrough\":false,\"rss_feed_url\":null,\"rss_website_url\":null,\"show_pub_podcast_tab\":false,\"show_recs_on_homepage\":true,\"subdomain\":\"engineering4citystoragesystems\",\"subscriber_invites\":0,\"support_email\":null,\"theme_var_background_pop\":\"#6B26FF\",\"theme_var_color_links\":true,\"theme_var_cover_bg_color\":null,\"trial_end_override\":null,\"twitter_pixel_id\":null,\"type\":\"newsletter\",\"post_reaction_faces_enabled\":false,\"is_personal_mode\":false,\"plans\":null,\"stripe_user_id\":null,\"stripe_country\":null,\"stripe_publishable_key\":null,\"automatic_tax_enabled\":null,\"author_name\":\"CSS Engineering\",\"author_handle\":\"cssengineering\",\"author_photo_url\":\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F42a24716-8732-4073-a0a0-b3934a52c775_512x512.png\",\"author_bio\":\"Engineering behind products such as Otter and CloudKitchens\",\"has_custom_tos\":false,\"has_custom_privacy\":false,\"theme\":{\"background_pop_color\":\"#464EE7\",\"web_bg_color\":\"#151513\",\"cover_bg_color\":\"#151513\",\"publication_id\":2259056,\"color_links\":null,\"font_preset_heading\":\"heavy_sans\",\"font_preset_body\":\"sans\",\"font_family_headings\":null,\"font_family_body\":null,\"font_family_ui\":null,\"font_size_body_desktop\":null,\"print_secondary\":null,\"custom_css_web\":null,\"custom_css_email\":null,\"home_hero\":\"newspaper\",\"home_posts\":\"list\",\"home_show_top_posts\":false,\"hide_images_from_list\":false,\"home_hero_alignment\":\"left\",\"home_hero_show_podcast_links\":true},\"threads_v2_settings\":null,\"default_group_coupon_percent_off\":null,\"pause_return_date\":null,\"has_posts\":true,\"has_recommendations\":false,\"first_post_date\":\"2024-03-15T11:46:02.982Z\",\"has_podcast\":false,\"has_free_podcast\":false,\"has_subscriber_only_podcast\":false,\"has_community_content\":false,\"twitter_share_on_publish_opt_in\":null,\"twitter_permissions\":\"none\",\"rankingDetail\":\"Launched 3 months ago\",\"rankingDetailFreeIncluded\":\"Hundreds of subscribers\",\"rankingDetailOrderOfMagnitude\":0,\"rankingDetailFreeIncludedOrderOfMagnitude\":100,\"rankingDetailFreeSubscriberCount\":null,\"rankingDetailByLanguage\":{\"de\":{\"rankingDetail\":\"Vor vor 3 Monaten gelauncht\",\"rankingDetailFreeIncluded\":\"Hunderte von Abonnenten\",\"rankingDetailOrderOfMagnitude\":0,\"rankingDetailFreeIncludedOrderOfMagnitude\":100,\"rankingDetailFreeSubscriberCount\":null,\"freeSubscriberCount\":null,\"freeSubscriberCountOrderOfMagnitude\":\"200\"},\"es\":{\"rankingDetail\":\"Lanzado hace 3 meses\",\"rankingDetailFreeIncluded\":\"Cientos de suscriptores\",\"rankingDetailOrderOfMagnitude\":0,\"rankingDetailFreeIncludedOrderOfMagnitude\":100,\"rankingDetailFreeSubscriberCount\":null,\"freeSubscriberCount\":null,\"freeSubscriberCountOrderOfMagnitude\":\"200\"},\"fr\":{\"rankingDetail\":\"Lanc\u00E9 il y a 3 mois\",\"rankingDetailFreeIncluded\":\"Des centaines d'abonn\u00E9s\",\"rankingDetailOrderOfMagnitude\":0,\"rankingDetailFreeIncludedOrderOfMagnitude\":100,\"rankingDetailFreeSubscriberCount\":null,\"freeSubscriberCount\":null,\"freeSubscriberCountOrderOfMagnitude\":\"200\"},\"pt\":{\"rankingDetail\":\"Lan\u00E7ado 3 meses\",\"rankingDetailFreeIncluded\":\"Centenas de subscritores\",\"rankingDetailOrderOfMagnitude\":0,\"rankingDetailFreeIncludedOrderOfMagnitude\":100,\"rankingDetailFreeSubscriberCount\":null,\"freeSubscriberCount\":null,\"freeSubscriberCountOrderOfMagnitude\":\"200\"},\"pt-br\":{\"rankingDetail\":\"Lan\u00E7ado 3 meses\",\"rankingDetailFreeIncluded\":\"Centenas de assinantes\",\"rankingDetailOrderOfMagnitude\":0,\"rankingDetailFreeIncludedOrderOfMagnitude\":100,\"rankingDetailFreeSubscriberCount\":null,\"freeSubscriberCount\":null,\"freeSubscriberCountOrderOfMagnitude\":\"200\"},\"it\":{\"rankingDetail\":\"Lanciato 3 mesi\",\"rankingDetailFreeIncluded\":\"Centinaia di abbonati\",\"rankingDetailOrderOfMagnitude\":0,\"rankingDetailFreeIncludedOrderOfMagnitude\":100,\"rankingDetailFreeSubscriberCount\":null,\"freeSubscriberCount\":null,\"freeSubscriberCountOrderOfMagnitude\":\"200\"},\"en\":{\"rankingDetail\":\"Launched 3 months ago\",\"rankingDetailFreeIncluded\":\"Hundreds of subscribers\",\"rankingDetailOrderOfMagnitude\":0,\"rankingDetailFreeIncludedOrderOfMagnitude\":100,\"rankingDetailFreeSubscriberCount\":null,\"freeSubscriberCount\":null,\"freeSubscriberCountOrderOfMagnitude\":\"200\"}},\"freeSubscriberCount\":null,\"freeSubscriberCountOrderOfMagnitude\":\"200\",\"author_bestseller_tier\":0,\"disable_monthly_subscriptions\":false,\"disable_annual_subscriptions\":false,\"hide_post_restacks\":false,\"notes_feed_enabled\":false,\"paywall_chat\":\"free\",\"sections\":[],\"multipub_migration\":null,\"navigationBarItems\":[{\"id\":\"efee49d9-a23d-46a1-aac4-6fb78aa07db7\",\"publication_id\":2259056,\"sibling_rank\":0,\"link_title\":null,\"link_url\":null,\"section_id\":null,\"post_id\":null,\"is_hidden\":true,\"standard_key\":\"archive\",\"post_tag_id\":null,\"post\":null,\"section\":null,\"postTag\":null}],\"contributors\":[],\"threads_v2_enabled\":false,\"viralGiftsConfig\":null,\"tier\":2,\"no_follow\":false,\"no_index\":false,\"can_set_google_site_verification\":true,\"can_have_sitemap\":true,\"founding_plan_name_english\":\"Founding Member\",\"draft_plans\":null,\"base_url\":\"https://techblog.citystoragesystems.com\",\"hostname\":\"techblog.citystoragesystems.com\",\"is_on_substack\":false,\"spotify_podcast_settings\":null,\"podcastPalette\":{\"Vibrant\":{\"rgb\":[244.1949152542373,162.0762711864407,10.805084745762711],\"population\":0},\"DarkVibrant\":{\"rgb\":[126.9813559322034,84.27966101694916,5.618644067796606],\"population\":0},\"LightVibrant\":{\"rgb\":[250,212,142],\"population\":31},\"Muted\":{\"rgb\":[92,158,148],\"population\":4},\"DarkMuted\":{\"rgb\":[146.51694915254237,97.24576271186443,6.483050847457638],\"population\":0},\"LightMuted\":{\"rgb\":[164,204,196],\"population\":3}},\"pageThemes\":{\"podcast\":null},\"live_subscriber_counts\":false,\"subscribeCardVersionHash\":\"b1c39afaca7d90e145c2e972279e9d20\"},\"confirmedLogin\":false,\"hide_intro_popup\":false,\"block_auto_login\":false,\"domainInfo\":{\"isSubstack\":false,\"customDomain\":\"techblog.citystoragesystems.com\"},\"experimentFeatures\":{},\"experimentExposures\":{},\"siteConfigs\":{\"score_upsell_email\":\"control\",\"first_chat_email_enabled\":true,\"notes_video_max_duration_minutes\":5,\"reader-onboarding-promoted-pub\":737237,\"pub_creation_captcha_behavior\":\"risky_pubs\",\"new_commenter_approval\":false,\"pub_update_opennode_api_key\":false,\"add_list_unsubscribe_post_header\":false,\"zendesk_automation_cancellations\":false,\"hide_book_a_meeting_button\":false,\"first_month_upsell_enabled\":false,\"substack_credits_enabled\":false,\"publication_max_bylines\":35,\"no_contest_charge_disputes\":false,\"new_subscription_management\":false,\"recommendations_announcement_url\":\"https://on.substack.com/p/recommendations\",\"comp_expiry_email_new_copy\":\"NONE\",\"free_unlock_required\":false,\"traffic_rule_check_enabled\":false,\"amp_emails_enabled\":false,\"enable_post_summarization\":false,\"image_deep_link_enabled\":false,\"bitcoin_enabled\":false,\"public_podcast_rss_feed_only_free_visible\":false,\"show_entire_square_image\":false,\"hide_subscriber_count\":false,\"editor_v2\":false,\"publication_author_display_override\":\"\",\"enable_android_recs_v2\":true,\"generate_pdf_tax_report\":false,\"side_by_side_transcription_viewer\":true,\"show_generic_post_importer\":false,\"enable_pledges_modal\":true,\"include_pdf_invoice\":false,\"hide_pub_from_subscription_recommendation\":false,\"platform_searcher_enabled\":false,\"use_featured_pub_recommendations\":false,\"meetings_v1\":false,\"custom_target_origin\":\"\",\"exempt_from_gtm_filter\":false,\"group_sections_and_podcasts_in_menu\":false,\"boost_optin_modal_enabled\":true,\"post_blogspot_importer\":false,\"paywall_chat\":true,\"pub_tts_override\":\"default\",\"disable_monthly_subscriptions\":false,\"skip_welcome_email\":false,\"chat_reader_thread_notification_default\":false,\"scheduled_pinned_posts\":false,\"disable_redirect_outbound_utm_params\":false,\"reader_gift_referrals_enabled\":true,\"enable_bestseller_survey_modal\":false,\"dont_show_guest_byline\":false,\"like_comments_enabled\":true,\"extended_podcast_episode_metadata\":false,\"use_richer_html_for_editing_podcast_description\":false,\"default_to_editor_v2\":false,\"enable_author_note_email_toggle\":false,\"meetings_embed_publication_name\":false,\"no_auto_renewal_notice\":false,\"live_stream_noitifications_enabled\":false,\"people_you_may_know_algorithm\":\"experiment\",\"welcome_screen_blurb_override\":\"\",\"post_recipients_batch_limit\":1000,\"like_posts_enabled\":true,\"notes_publication_mentions_enabled\":false,\"twitter_player_card_enabled\":true,\"feed_promoted_user\":false,\"allow_renew_email_footer\":true,\"enable_android_chat_paywall\":true,\"section_specific_csv_imports_enabled\":false,\"improved_tts_voiceover\":false,\"bypass_profile_substack_logo_detection\":false,\"use_preloaded_player_sources\":false,\"generate_twitter_card_with_lamda\":false,\"list_pruning_enabled\":false,\"facebook_connect\":false,\"opt_in_to_sections_during_subscribe\":false,\"main_aurora_reads_percent\":5,\"underlined_colored_links\":false,\"max_image_upload_mb\":32,\"modal_rec_variant_user\":\"control\",\"extract_stripe_receipt_url\":false,\"enable_android_dms_writer_beta\":false,\"enable_chat_inbox_pins\":false,\"threads_suggested_ios_version\":null,\"pledges_disabled\":false,\"threads_minimum_ios_version\":812,\"hide_podcast_email_setup_link\":false,\"subscribe_captcha_behavior\":\"default\",\"publication_ban_sample_rate\":0,\"allow_moderation_sampling_mode\":false,\"gift_post_unlocks_recipient\":\"experiment\",\"round_square_images\":false,\"reader_referrals_feature_enabled\":false,\"continue_support_cta_in_newsletter_emails\":false,\"bloomberg_syndication_enabled\":false,\"custom_publication_theme\":false,\"lists_enabled\":false,\"show_writer_referral_box\":false,\"generated_database_maintenance_mode\":false,\"allow_document_freeze\":false,\"podcast_main_feed_is_firehose\":false,\"video_post_sticky\":true,\"no_embed_redirect\":false,\"enable_android_chat_founding_tier\":true,\"spotify_open_access_sandbox_mode\":false,\"enable_seen_inbox\":true,\"use_text_notes_search\":false,\"fullstory_enabled\":false,\"chat_reply_poll_interval\":3,\"enable_reader_marketing_page\":false,\"force_pub_links_to_use_subdomain\":false,\"email_existing_users_on_import\":false,\"always_show_cookie_banner\":false,\"hide_media_download_option\":false,\"review_incoming_email\":\"default\",\"use_stripe_link\":\"control\",\"twitter_figures_enabled\":false,\"hide_post_restacks\":false,\"feed_item_source_debug_mode\":false,\"global_search_bestseller_tier\":\"NONE\",\"spotify_open_access\":true,\"daily_promoted_notes_enabled\":true,\"publication_homepage_title_display_override\":\"\",\"pub_banned_word_list\":\"\",\"post_preview_highlight_byline\":false,\"credit_token_publication_suggested\":false,\"bypass_unlock_token_limit\":false,\"live_streams_enabled\":false,\"notifications_disabled\":\"\",\"cross_post_notification_threshold\":1000,\"facebook_connect_prod_app\":true,\"gift_referrals_allow_reups\":true,\"messages_inbox_page_size\":50,\"minimum_android_version\":756,\"feed_main_disabled\":false,\"use_mobile_app_post_unlock_flow\":true,\"feed_polling_disabled\":false,\"use_og_image_as_twitter_image_for_post_previews\":false,\"enable_ai_generated_clips\":false,\"cookie_preference_middleware_enabled\":false,\"custy_reads_percent\":100,\"seo_tier_override\":\"NONE\",\"cancellation_flow_experiment\":\"experiment\",\"publisher_api_enabled\":false,\"zendesk_support_priority\":\"default\",\"enable_subscriber_referrals_awards\":true,\"use_zync_for_pubchat_updates\":true,\"homepage_overlap_ufi\":false,\"photo_dna_enabled\":false,\"stripe_link_in_payment_element\":\"control\",\"mobile_subscription_app_takeover_screen_v2\":\"experiment\",\"post_management_search_engine\":\"elasticsearch\",\"android_chat_video\":true,\"live_stream_creation_enabled\":false,\"embeds_enabled\":true,\"enable_web_typing_indicators\":false,\"web_vitals_sample_rate\":0,\"blocked_email_domains\":\"laafd.com,vjuum.com,txcct.com,rteet.com,dpptd.com\",\"skip_twitter_step_in_writer_onboarding\":true,\"android_suggestion_categories_onboarding_tabs\":false,\"enable_video_in_notes_web\":true,\"enable_android_chat_navigation\":true,\"spam_post_titles\":\"Notice: Your Substack Account Information Has Been Modified,Join the PancakeSwap V4 Airdrop and grab your share of $CAKE tokens!\",\"enable_video_in_chat_comments\":false,\"section_specific_welcome_pages\":false,\"local_payment_methods\":\"control\",\"get_feed_comment_items_mode\":\"bulk\",\"posts_in_rss_feed\":20,\"post_rec_endpoint\":\"\",\"publisher_dashboard_section_selector\":false,\"reader_surveys_platform_question_order\":\"36,1,4,2,3,5,6,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35\",\"show_email_cutoff_cta\":\"experiment\",\"ios_chat_video\":true,\"enable_video_in_chat_posts\":true,\"modal_rec_variant_content\":\"control\",\"monthly_sub_is_one_off\":false,\"unread_notes_activity_digest\":\"control\",\"display_cookie_settings\":false,\"welcome_page_query_params\":false,\"mobile_post_editor_enabled\":false,\"enable_free_podcast_urls\":false,\"phone_verification_banned_countries\":\"\",\"enable_handle_subdomain_redirect_cookies\":false,\"use_microlink_for_instagram_embeds\":false,\"use_whisper\":false,\"enable_personal_substack_presentation\":false,\"ios_post_stats_for_admins\":false,\"section_specific_preambles\":false,\"enable_android_chat_realtime\":true,\"show_menu_on_posts\":false,\"app_upsell_follow_prompt\":\"control\",\"free_signup_confirmation_behavior\":\"with_email_validation\",\"show_note_preview_small_og_image\":true,\"ios_writer_stats_public_launch_v2\":false,\"phone_verification_fallback_to_twilio\":false,\"ios_chat_revamp_enabled\":false,\"sql_feed_fallback_percent\":0,\"show_phone_banner\":false,\"publisher_banner\":\"\",\"chat_founding_tier\":true,\"enable_decagon_chat\":true,\"first_month_upsell\":\"control\",\"twitter_connect_flows_enabled\":false,\"android_google_sign_in\":false,\"enable_user_contacts\":true,\"enable_android_dms_realtime\":true,\"enable_upload_seperate_audio\":true,\"welcome_page_update_desktop_visuals_limited\":\"experiment\",\"app_mode\":false,\"rss_verification_code\":\"\",\"notification_post_emails\":\"experiment\",\"enable_upload_transcript\":true,\"get_app_bottom_sheet_with_backoff\":\"experiment\",\"export_hooks_enabled\":false,\"audio_encoding_bitrate\":null,\"bestseller_pub_override\":false,\"extra_seats_coupon_type\":false,\"post_subdomain_universal_links\":false,\"post_import_max_file_size\":26214400,\"credit_tokens_enabled\":true,\"custy_writes_percent\":100,\"show_email_cutoff_cta_top\":\"control\",\"minimum_ios_version\":2200,\"disable_annual_subscriptions\":false,\"enable_bestseller_survey_modal_override\":false,\"ios_publication_screen_swiftui\":false,\"enable_android_dms\":false,\"non_mfa_password_login_guard\":\"block_suspicious\",\"use_substrate_sdxl\":false,\"activity_item_inline_feedback\":\"treatment\",\"activity_item_filters\":true,\"enable_crm_publisher_agreement_agree_wall\":\"none\",\"recipes_enabled\":false,\"disable_deletion\":false,\"android_live_streams_enabled\":false,\"onboarding_category_selection\":\"min3\"},\"publicationSettings\":{\"block_ai_crawlers\":false,\"credit_token_enabled\":false,\"custom_tos_and_privacy\":false,\"did_identity\":null,\"disable_optimistic_bank_payments\":false,\"display_welcome_page_details\":true,\"enable_meetings\":false,\"payment_pledges_enabled\":false,\"enable_post_page_conversion\":true,\"enable_prev_next_nav\":false,\"enable_restacking\":true,\"google_analytics_4_token\":null,\"group_sections_and_podcasts_in_menu_enabled\":false,\"medium_length_description\":\"\",\"notes_feed_enabled\":false,\"paywall_unlock_tokens\":false,\"post_preview_crop_gravity\":\"auto\",\"reader_referrals_enabled\":false,\"reader_referrals_leaderboard_enabled\":false,\"seen_coming_soon_explainer\":false,\"seen_google_analytics_migration_modal\":false,\"local_currency_modal_seen\":false,\"local_payment_methods_modal_seen\":false,\"twitter_pixel_signup_event_id\":null,\"twitter_pixel_subscribe_event_id\":null,\"use_local_currency\":false,\"use_local_payment_methods\":true,\"welcome_page_opt_out_text\":\"No thanks\",\"cookie_settings\":\"\"},\"publicationUserSettings\":null,\"userSettings\":{\"user_id\":null,\"activity_likes_enabled\":true,\"hasDismissedSectionToNewsletterRename\":false,\"is_guest_post_enabled\":true,\"feed_web_nux_seen_at\":null,\"has_seen_select_to_restack_tooltip_nux\":false,\"invite_friends_nux_dismissed_at\":null,\"suggestions_feed_item_last_shown_at\":null,\"has_seen_select_to_restack_modal\":false,\"last_home_tab\":null,\"last_notification_alert_shown_at\":null,\"disable_reply_hiding\":false,\"newest_seen_chat_item_published_at\":null,\"explicitContentEnabled\":false,\"contactMatchingEnabled\":false,\"messageRequestLevel\":\"everyone\",\"creditTokensTreatmentExposed\":false,\"appBadgeIncludesChat\":false,\"autoPlayVideo\":true},\"subscriberCountDetails\":\"hundreds of subscribers\",\"mux_env_key\":\"u42pci814i6011qg3segrcpp9\",\"sentry_environment\":\"production\",\"launchWelcomePage\":false,\"noIndex\":false,\"post\":{\"id\":145625273,\"editor_v2\":false,\"publication_id\":2259056,\"type\":\"newsletter\",\"title\":\"From Fragile to Faultless: Kubernetes Self-Healing In Practice\",\"social_title\":null,\"section_id\":null,\"search_engine_title\":null,\"search_engine_description\":null,\"subtitle\":\"Overcoming imperfections of managed Kubernetes with early self-healing.\",\"slug\":\"kubernetes-self-healing\",\"post_date\":\"2024-06-15T14:01:47.654Z\",\"podcast_url\":\"\",\"podcast_art_url\":null,\"podcast_duration\":null,\"video_upload_id\":null,\"podcast_upload_id\":null,\"podcast_preview_upload_id\":null,\"audience\":\"everyone\",\"should_send_free_preview\":false,\"write_comment_permissions\":\"none\",\"show_guest_bios\":true,\"free_unlock_required\":false,\"default_comment_sort\":null,\"canonical_url\":\"https://techblog.citystoragesystems.com/p/kubernetes-self-healing\",\"audience_before_archived\":null,\"exempt_from_archive_paywall\":false,\"teaser_post_eligible\":true,\"restacks\":0,\"reactions\":{\"\u2764\":0},\"top_exclusions\":[],\"pins\":[],\"section_pins\":[],\"previous_post_slug\":\"reliable-order-processing\",\"next_post_slug\":null,\"cover_image\":\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F11e401f2-cdd8-440b-89eb-7f6eaeeb3aae_1689x990.png\",\"cover_image_is_square\":false,\"cover_image_is_explicit\":false,\"videoUpload\":null,\"podcastFields\":{\"post_id\":145625273,\"podcast_episode_number\":null,\"podcast_season_number\":null,\"podcast_episode_type\":null,\"should_syndicate_to_other_feed\":null,\"syndicate_to_section_id\":null,\"hide_from_feed\":false,\"free_podcast_url\":null,\"free_podcast_duration\":null},\"podcastUpload\":null,\"podcastPreviewUpload\":null,\"voiceover_upload_id\":null,\"voiceoverUpload\":null,\"has_voiceover\":false,\"description\":\"Overcoming imperfections of managed Kubernetes with early self-healing.\",\"body_html\":\"<div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link is-viewable-img image2\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F11e401f2-cdd8-440b-89eb-7f6eaeeb3aae_1689x990.png\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F11e401f2-cdd8-440b-89eb-7f6eaeeb3aae_1689x990.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F11e401f2-cdd8-440b-89eb-7f6eaeeb3aae_1689x990.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F11e401f2-cdd8-440b-89eb-7f6eaeeb3aae_1689x990.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F11e401f2-cdd8-440b-89eb-7f6eaeeb3aae_1689x990.png 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F11e401f2-cdd8-440b-89eb-7f6eaeeb3aae_1689x990.png\\\" width=\\\"1456\\\" height=\\\"853\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/11e401f2-cdd8-440b-89eb-7f6eaeeb3aae_1689x990.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:853,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:274179,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:false,&quot;topImage&quot;:true,&quot;internalRedirect&quot;:null}\\\" class=\\\"sizing-normal\\\" alt=\\\"\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F11e401f2-cdd8-440b-89eb-7f6eaeeb3aae_1689x990.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F11e401f2-cdd8-440b-89eb-7f6eaeeb3aae_1689x990.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F11e401f2-cdd8-440b-89eb-7f6eaeeb3aae_1689x990.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F11e401f2-cdd8-440b-89eb-7f6eaeeb3aae_1689x990.png 1456w\\\" sizes=\\\"100vw\\\" fetchpriority=\\\"high\\\"></picture><div class=\\\"image-link-expand\\\"><svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"20\\\" height=\\\"20\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"currentColor\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" class=\\\"lucide lucide-maximize2 \\\"><polyline points=\\\"15 3 21 3 21 9\\\"></polyline><polyline points=\\\"9 21 3 21 3 15\\\"></polyline><line x1=\\\"21\\\" x2=\\\"14\\\" y1=\\\"3\\\" y2=\\\"10\\\"></line><line x1=\\\"3\\\" x2=\\\"10\\\" y1=\\\"21\\\" y2=\\\"14\\\"></line></svg></div></div></a></figure></div><p><em>Written by Grzegorz G\u0142\u0105b and Nibir Bora, members of the engineering teams that work on core infrastructure.</em></p><p>Many organizations opt for managed Kubernetes distributions like Azure Kubernetes Service (AKS) to get up and running quickly without needing a large engineering team to operate Kubernetes clusters. This is a core design principle of the Core Infrastructure team at City Storage Systems. However, over the years, we\u2019ve learned that the true operating cost of managed Kubernetes distributions is not in fact zero.</p><p>Even public cloud experiences occasional failures. Hardware faults, kernel misconfigurations, network bottlenecks, problematic rollouts, resource scarcity, security vulnerability, etc. leads to complications lasting for minutes, or in some cases, weeks. In this blog we share our experience illustrating how minor glitches, if left unattended, could quickly escalate and impact business continuity.</p><p>Rather than engaging in constant firefighting we designed a self-healing framework, often implementing automations with a turnaround time of as little as 1 day. These automations were sometimes temporary fixes until resolved by the cloud provider, and at other times, they became permanent enhancements to our platform\u2019s reliability. While our journey began with a focus on AKS, this framework is a general-purpose pattern to improve resilience of any Kubernetes platform.</p><h1>The Self-Healing Framework</h1><p>The first self-healing use case was implemented as a monolithic program. But, as we added new use cases, we identified several reusable libraries that nudged us to organize it into a framework. The framework today consists of <em>Automation</em>s that each address a specific failure mode. Automations are implemented as an independent <em>Detector</em> and a <em>Fixer</em>, which are either a <a href=\\\"https://kubernetes.io/docs/concepts/architecture/controller/\\\">controller</a> or a <a href=\\\"https://go.dev/\\\">Go</a> program.</p><p><em>Detectors</em> are responsible for collecting signals and flagging failure conditions. There are two types of detectors - Cluster level (Deployment) and Node level (DaemonSet). Cluster level detectors monitor for cluster-wide failure events and have permissions to watch or create API server resources. Node level detectors monitor for node level failures (e.g. misconfigured OS flags, image pull issues, missing systemd services, etc.) and have privileged host access.</p><p><em>Fixers</em> complement detectors by executing remediation steps to rectify or cleanup failure states. Similar to Detectors, there are two types of fixers - Cluster level (Deployment) and Node level (DaemonSet). Cluster level fixers execute remediation actions that operate on cluster-level resources and have permissions to watch API server resources. Node level fixers execute remediation action at node level, or operations that require privileged host access.</p><div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link is-viewable-img image2\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbed218a4-bc4e-4a4d-be5e-458df638bde0_1600x830.png\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbed218a4-bc4e-4a4d-be5e-458df638bde0_1600x830.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbed218a4-bc4e-4a4d-be5e-458df638bde0_1600x830.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbed218a4-bc4e-4a4d-be5e-458df638bde0_1600x830.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbed218a4-bc4e-4a4d-be5e-458df638bde0_1600x830.png 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbed218a4-bc4e-4a4d-be5e-458df638bde0_1600x830.png\\\" width=\\\"1456\\\" height=\\\"755\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/bed218a4-bc4e-4a4d-be5e-458df638bde0_1600x830.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:755,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:null,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}\\\" class=\\\"sizing-normal\\\" alt=\\\"\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbed218a4-bc4e-4a4d-be5e-458df638bde0_1600x830.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbed218a4-bc4e-4a4d-be5e-458df638bde0_1600x830.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbed218a4-bc4e-4a4d-be5e-458df638bde0_1600x830.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbed218a4-bc4e-4a4d-be5e-458df638bde0_1600x830.png 1456w\\\" sizes=\\\"100vw\\\" loading=\\\"lazy\\\"></picture><div class=\\\"image-link-expand\\\"><svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"20\\\" height=\\\"20\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"currentColor\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" class=\\\"lucide lucide-maximize2 \\\"><polyline points=\\\"15 3 21 3 21 9\\\"></polyline><polyline points=\\\"9 21 3 21 3 15\\\"></polyline><line x1=\\\"21\\\" x2=\\\"14\\\" y1=\\\"3\\\" y2=\\\"10\\\"></line><line x1=\\\"3\\\" x2=\\\"10\\\" y1=\\\"21\\\" y2=\\\"14\\\"></line></svg></div></div></a><figcaption class=\\\"image-caption\\\">Figure 1: Diagram showing architecture of the self-healing framework operating in a Kubernetes cluster.</figcaption></figure></div><p>Generalizing as such allows us to keep the framework simple and appropriately isolate permissions. This was key to swiftly adding new automations when needed. Whenever we identify a new degradation, we implement and deploy the corresponding detector and fixer across all our clusters. The following automations are a few examples that shielded our internal developers and applications from potential impact, and also significantly reduced our team\u2019s support toil - cutting it in half from 30% of engineering time.</p><div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link is-viewable-img image2\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f1cacbd-c468-46ca-a8fd-928b02eb2362_2290x1169.png\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f1cacbd-c468-46ca-a8fd-928b02eb2362_2290x1169.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f1cacbd-c468-46ca-a8fd-928b02eb2362_2290x1169.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f1cacbd-c468-46ca-a8fd-928b02eb2362_2290x1169.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f1cacbd-c468-46ca-a8fd-928b02eb2362_2290x1169.png 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f1cacbd-c468-46ca-a8fd-928b02eb2362_2290x1169.png\\\" width=\\\"1456\\\" height=\\\"743\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/3f1cacbd-c468-46ca-a8fd-928b02eb2362_2290x1169.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:743,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:154548,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}\\\" class=\\\"sizing-normal\\\" alt=\\\"\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f1cacbd-c468-46ca-a8fd-928b02eb2362_2290x1169.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f1cacbd-c468-46ca-a8fd-928b02eb2362_2290x1169.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f1cacbd-c468-46ca-a8fd-928b02eb2362_2290x1169.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f1cacbd-c468-46ca-a8fd-928b02eb2362_2290x1169.png 1456w\\\" sizes=\\\"100vw\\\" loading=\\\"lazy\\\"></picture><div class=\\\"image-link-expand\\\"><svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"20\\\" height=\\\"20\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"currentColor\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" class=\\\"lucide lucide-maximize2 \\\"><polyline points=\\\"15 3 21 3 21 9\\\"></polyline><polyline points=\\\"9 21 3 21 3 15\\\"></polyline><line x1=\\\"21\\\" x2=\\\"14\\\" y1=\\\"3\\\" y2=\\\"10\\\"></line><line x1=\\\"3\\\" x2=\\\"10\\\" y1=\\\"21\\\" y2=\\\"14\\\"></line></svg></div></div></a><figcaption class=\\\"image-caption\\\">Figure 2: List of self-healing automations that are currently active on our Kubernetes platform.</figcaption></figure></div><p>Building these automations over the last year and a half has taught us some key lessons:</p><ol><li><p><strong>Kubernetes is not the end product</strong>. It is a framework for building platforms. Managed Kubernetes still greatly benefits from business specific customizations that create leverage for developers.</p></li><li><p><strong>Abstractions don\u2019t erase underlying layers</strong>. Kubernetes, while powerful, still requires us to dive into the host VM or kernel layer for deep debugging - a skill set we've honed through experience.</p></li><li><p><strong>Cost optimization has a reliability tax</strong>. Optimizing cost needs to be counterbalanced with increased vigilance on reliability. For example, running stateful workloads on Spot nodes required us to invest further in automation.</p></li><li><p><strong>Cloud bugs cannot be predicted</strong>. Instead of anticipating imaginary failure scenarios, it\u2019s better to optimize for speed of diagnosing unforeseen issues and implementing automation for them. For example, we consolidated all node malfunction signals on a single \u201Cnode inspector\u201D dashboard empowering our developers to respond swiftly when paged.</p></li></ol><p>In the following sections we describe a few of the automations in detail, covering how each failure mode was identified and how we automated its self-healing.</p><h1>Handling Abrupt Spot Node Preemptions</h1><p>We use Spot nodes extensively on our Kubernetes platform to optimize resource costs, running both stateless and less critical stateful workloads. However, Spot nodes on AKS <a href=\\\"https://learn.microsoft.com/en-us/azure/aks/spot-node-pool\\\">lack any SLA</a>, which can lead to potential abrupt preemptions. We experienced an incident where a large number of Spot node preemptions caused multiple stateful workloads to fail, causing cascading application failures resulting in downtime.</p><p>When Spot nodes on AKS are preempted, a <em>scheduled preemption</em> event is emitted 30 seconds before the underlying VM is abruptly removed. The node isn\u2019t cordoned, workloads aren\u2019t gracefully shut down, and the Node isn\u2019t deregistered from the Kubernetes API server. The Node object remains without a physical VM (see issue <a href=\\\"https://github.com/Azure/AKS/issues/3528\\\">#3528</a>) until cleaned up after 5 minutes due to failed heartbeats. When this happens, stateless workload pods (controlled by Deployment and ReplicaSet) are automatically rescheduled, but not StatefulSet pods. StatefulSet pods leave behind \u201Cphantom\u201D pod objects (with <code>.status.phase: Unknown</code>) in the API server, which is not an acceptable behavior for our stateful workloads.</p><p>To address this, we implemented a self-healing automation that intercepts Spot node preemption signals and gracefully evicts all pods on the affected node. A detector watches for <code>VMEventScheduled</code> node conditions (example below) and creates a <code>SpotNodePreemption</code> <a href=\\\"https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/\\\">Custom Resource</a> (CR) with details for the fixer. The fixer then evicts the pods with a 10-second grace period.</p><pre><code>.status.conditions: [\\n    {\\n        status: \\\"True\\\",\\n        type: \\\"VMEventScheduled\\\",\\n        reason: \\\"VMEventScheduled\\\",\\n        message: \\\"Preempt Scheduled : Tue, 14 May 2024 12:57:00 GMT\\\",\\n        lastHeartbeatTime: \\\"2024-05-14T12:56:43Z\\\",\\n        lastTransitionTime: \\\"2024-05-14T12:56:42Z\\\"\\n    }\\n]</code></pre><div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link image2\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3194da73-7ca8-46be-9e44-cfc97b9dc784_1496x226.png\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3194da73-7ca8-46be-9e44-cfc97b9dc784_1496x226.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3194da73-7ca8-46be-9e44-cfc97b9dc784_1496x226.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3194da73-7ca8-46be-9e44-cfc97b9dc784_1496x226.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3194da73-7ca8-46be-9e44-cfc97b9dc784_1496x226.png 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3194da73-7ca8-46be-9e44-cfc97b9dc784_1496x226.png\\\" width=\\\"1456\\\" height=\\\"220\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/3194da73-7ca8-46be-9e44-cfc97b9dc784_1496x226.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:220,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:null,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}\\\" class=\\\"sizing-normal\\\" alt=\\\"\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3194da73-7ca8-46be-9e44-cfc97b9dc784_1496x226.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3194da73-7ca8-46be-9e44-cfc97b9dc784_1496x226.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3194da73-7ca8-46be-9e44-cfc97b9dc784_1496x226.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3194da73-7ca8-46be-9e44-cfc97b9dc784_1496x226.png 1456w\\\" sizes=\\\"100vw\\\" loading=\\\"lazy\\\"></picture><div></div></div></a><figcaption class=\\\"image-caption\\\">Figure 3: Example timeline of Kubernetes events for a pod that was scheduled on a preempted Spot node.</figcaption></figure></div><div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link is-viewable-img image2\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52b40c32-cf98-4ee8-99e1-1f8d2ec37929_938x292.png\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52b40c32-cf98-4ee8-99e1-1f8d2ec37929_938x292.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52b40c32-cf98-4ee8-99e1-1f8d2ec37929_938x292.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52b40c32-cf98-4ee8-99e1-1f8d2ec37929_938x292.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52b40c32-cf98-4ee8-99e1-1f8d2ec37929_938x292.png 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52b40c32-cf98-4ee8-99e1-1f8d2ec37929_938x292.png\\\" width=\\\"938\\\" height=\\\"292\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/52b40c32-cf98-4ee8-99e1-1f8d2ec37929_938x292.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:292,&quot;width&quot;:938,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:null,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}\\\" class=\\\"sizing-normal\\\" alt=\\\"\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52b40c32-cf98-4ee8-99e1-1f8d2ec37929_938x292.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52b40c32-cf98-4ee8-99e1-1f8d2ec37929_938x292.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52b40c32-cf98-4ee8-99e1-1f8d2ec37929_938x292.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52b40c32-cf98-4ee8-99e1-1f8d2ec37929_938x292.png 1456w\\\" sizes=\\\"100vw\\\" loading=\\\"lazy\\\"></picture><div class=\\\"image-link-expand\\\"><svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"20\\\" height=\\\"20\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"currentColor\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" class=\\\"lucide lucide-maximize2 \\\"><polyline points=\\\"15 3 21 3 21 9\\\"></polyline><polyline points=\\\"9 21 3 21 3 15\\\"></polyline><line x1=\\\"21\\\" x2=\\\"14\\\" y1=\\\"3\\\" y2=\\\"10\\\"></line><line x1=\\\"3\\\" x2=\\\"10\\\" y1=\\\"21\\\" y2=\\\"14\\\"></line></svg></div></div></a><figcaption class=\\\"image-caption\\\">Figure 4: High volume of spot node preemption around November 2023.</figcaption></figure></div><p>Once this automation was operationalized, we noticed that some Spot nodes were still terminated without a scheduled <em>preemption event</em>. This was because when Node Problem Detector (NPD) queries Azure Metadata Service for the <code>VMEventSchedule</code> event, the request occasionally fails resulting in a <code>NoVMEventScheduled</code> node condition (example below). To handle this, we added another self-healing automation to clean up after terminated Spot nodes when the preemption event wasn\u2019t intercepted. The detector creates a <code>SpotNodeDeletion</code> CR when a Spot Node object is deleted from the API server, and the fixer force deletes all pod objects on that node assuming they are no longer reachable.</p><pre><code>.status.conditions: [\\n    {\\n        ...\\n        type: \\\"Unknown\\\",\\n        reason: \\\"NoVMEventScheduled\\\",\\n        message: \u201CTimeout when running plugin \\\\\\\"/etc/node-problem-detector.d/plugin/check_scheduledevent_consolidated.sh\\\\\\\": state - signal: killed. output - \\\\\\\"\\\\\\\"\u201D\\n    }\\n]</code></pre><h1>Handling StatefulSet pods on Unreachable Nodes</h1><p>AKS node pools are built on Azure Virtual Machine Scale Sets (VMSS) infrastructure. We observed that VM failures in the VMSS layer often make AKS Nodes unreachable. When this happens, the node controller adds a <code>NoExecute</code> taint, and all pods on the node are evicted after 5 minutes. While stateless pods are rescheduled automatically, StatefulSet pods are not (see issue <a href=\\\"https://github.com/kubernetes/kubernetes/issues/54368\\\">#54368</a>, and <a href=\\\"https://github.com/kubernetes/design-proposals-archive/blob/main/storage/pod-safety.md#avoid-multiple-instances-of-pods\\\">design proposal</a>). This can lead to data loss caused by under-replication in stateful workloads like CockroachDB or OpenSearch.</p><p>To address this, we implemented a self-healing automation that watches the Kubernetes API server for Node objects with a <code>node.kubernetes.io/unreachable</code> taint. The detector filters nodes tainted for more than 5 minutes, and the fixer force deletes all pods (assuming they are unrecoverable) on these nodes, allowing new pods to be scheduled.</p><div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link is-viewable-img image2\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32f1641e-8000-4905-b1d4-58f265cd61f7_936x292.png\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32f1641e-8000-4905-b1d4-58f265cd61f7_936x292.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32f1641e-8000-4905-b1d4-58f265cd61f7_936x292.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32f1641e-8000-4905-b1d4-58f265cd61f7_936x292.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32f1641e-8000-4905-b1d4-58f265cd61f7_936x292.png 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32f1641e-8000-4905-b1d4-58f265cd61f7_936x292.png\\\" width=\\\"936\\\" height=\\\"292\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/32f1641e-8000-4905-b1d4-58f265cd61f7_936x292.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:292,&quot;width&quot;:936,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:null,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}\\\" class=\\\"sizing-normal\\\" alt=\\\"\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32f1641e-8000-4905-b1d4-58f265cd61f7_936x292.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32f1641e-8000-4905-b1d4-58f265cd61f7_936x292.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32f1641e-8000-4905-b1d4-58f265cd61f7_936x292.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32f1641e-8000-4905-b1d4-58f265cd61f7_936x292.png 1456w\\\" sizes=\\\"100vw\\\" loading=\\\"lazy\\\"></picture><div class=\\\"image-link-expand\\\"><svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"20\\\" height=\\\"20\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"currentColor\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" class=\\\"lucide lucide-maximize2 \\\"><polyline points=\\\"15 3 21 3 21 9\\\"></polyline><polyline points=\\\"9 21 3 21 3 15\\\"></polyline><line x1=\\\"21\\\" x2=\\\"14\\\" y1=\\\"3\\\" y2=\\\"10\\\"></line><line x1=\\\"3\\\" x2=\\\"10\\\" y1=\\\"21\\\" y2=\\\"14\\\"></line></svg></div></div></a><figcaption class=\\\"image-caption\\\">Figure 5: Daily unreachable nodes detected (last 3 months).</figcaption></figure></div><div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link is-viewable-img image2\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32872e9d-09f0-46bc-9726-069f922664c2_937x294.png\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32872e9d-09f0-46bc-9726-069f922664c2_937x294.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32872e9d-09f0-46bc-9726-069f922664c2_937x294.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32872e9d-09f0-46bc-9726-069f922664c2_937x294.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32872e9d-09f0-46bc-9726-069f922664c2_937x294.png 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32872e9d-09f0-46bc-9726-069f922664c2_937x294.png\\\" width=\\\"937\\\" height=\\\"294\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/32872e9d-09f0-46bc-9726-069f922664c2_937x294.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:294,&quot;width&quot;:937,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:null,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}\\\" class=\\\"sizing-normal\\\" alt=\\\"\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32872e9d-09f0-46bc-9726-069f922664c2_937x294.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32872e9d-09f0-46bc-9726-069f922664c2_937x294.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32872e9d-09f0-46bc-9726-069f922664c2_937x294.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F32872e9d-09f0-46bc-9726-069f922664c2_937x294.png 1456w\\\" sizes=\\\"100vw\\\" loading=\\\"lazy\\\"></picture><div class=\\\"image-link-expand\\\"><svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"20\\\" height=\\\"20\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"currentColor\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" class=\\\"lucide lucide-maximize2 \\\"><polyline points=\\\"15 3 21 3 21 9\\\"></polyline><polyline points=\\\"9 21 3 21 3 15\\\"></polyline><line x1=\\\"21\\\" x2=\\\"14\\\" y1=\\\"3\\\" y2=\\\"10\\\"></line><line x1=\\\"3\\\" x2=\\\"10\\\" y1=\\\"21\\\" y2=\\\"14\\\"></line></svg></div></div></a><figcaption class=\\\"image-caption\\\">Figure 6: Daily pods deleted by fixer for unreachable nodes (last 3 months).</figcaption></figure></div><h1>Cleaning Up Succeeded and Evicted Pods</h1><p>While investigating a cluster health degradation due to increased etcd disk size, we identified the accumulation of <code>Succeeded</code> pods as a significant factor. These were created by short lived cron jobs, pods without a controller (e.g. Flink jobs), and evicted pods. Since kube-controller-manager doesn't automatically clean up succeeded pods, this is a problem on our large multi-tenant clusters. This default behavior can be modified by configuring the <code>--terminated-pod-gc-threshold</code> flag. However, since we use managed Kubernetes the control plane is managed by the cloud provider and not user-configurable.</p><p>To address this, we implemented a self-healing automation that monitors the Kubernetes API server for pods with, either <code>status.phase = Succeeded</code>, or <code>status.phase = Failed</code> with <code>pod.Status.Reason = Evicted</code>. The detector flags pods that have remained in these phases for at least 15 minutes. This threshold is configurable per namespace. The corresponding fixer deletes these flagged pods from the API server.</p><div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link is-viewable-img image2\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fea333b69-e7d8-4cec-a760-b8a5f68a4e47_937x293.png\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fea333b69-e7d8-4cec-a760-b8a5f68a4e47_937x293.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fea333b69-e7d8-4cec-a760-b8a5f68a4e47_937x293.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fea333b69-e7d8-4cec-a760-b8a5f68a4e47_937x293.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fea333b69-e7d8-4cec-a760-b8a5f68a4e47_937x293.png 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fea333b69-e7d8-4cec-a760-b8a5f68a4e47_937x293.png\\\" width=\\\"937\\\" height=\\\"293\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/ea333b69-e7d8-4cec-a760-b8a5f68a4e47_937x293.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:293,&quot;width&quot;:937,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:null,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}\\\" class=\\\"sizing-normal\\\" alt=\\\"\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fea333b69-e7d8-4cec-a760-b8a5f68a4e47_937x293.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fea333b69-e7d8-4cec-a760-b8a5f68a4e47_937x293.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fea333b69-e7d8-4cec-a760-b8a5f68a4e47_937x293.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fea333b69-e7d8-4cec-a760-b8a5f68a4e47_937x293.png 1456w\\\" sizes=\\\"100vw\\\" loading=\\\"lazy\\\"></picture><div class=\\\"image-link-expand\\\"><svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"20\\\" height=\\\"20\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"currentColor\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" class=\\\"lucide lucide-maximize2 \\\"><polyline points=\\\"15 3 21 3 21 9\\\"></polyline><polyline points=\\\"9 21 3 21 3 15\\\"></polyline><line x1=\\\"21\\\" x2=\\\"14\\\" y1=\\\"3\\\" y2=\\\"10\\\"></line><line x1=\\\"3\\\" x2=\\\"10\\\" y1=\\\"21\\\" y2=\\\"14\\\"></line></svg></div></div></a><figcaption class=\\\"image-caption\\\">Figure 7: Daily pods cleaned up by fixer for succeeded &amp; evicted pods (last 3 months).</figcaption></figure></div><h1>Handling Network Packet Drops Due to Unbalanced IRQ</h1><p>We noticed increased packet drop rates in network IO-intensive workloads, initially thought to be application errors. However, we saw that the nodes with affected workloads had <code>VMFreezeEvents</code> (see AKS <a href=\\\"https://learn.microsoft.com/en-us/azure/virtual-machines/linux/scheduled-events#event-properties\\\">docs</a>). Investigation showed hardware interrupts from the node\u2019s network interface were unevenly handled by only 2 of 8 CPU cores, causing 100% utilization on those cores (see detailed investigation in <a href=\\\"https://zmalik.dev/posts/packet-drop\\\">blog</a>). Restarting the <code>irqbalance</code> service, which should distribute interrupts evenly, resolved the issue.</p><p>To address this, we implemented a self-healing automation that flags nodes where fewer than half of the CPU cores are configured to handle interrupts from the network interface. This is done by checking <code>/proc/irq/IRQ#/smp_affinity</code>, which denotes CPU core affinity to the interrupt request queue (IRQ). The corresponding fixer restarts the <code>irqbalance</code> systemd service on the host VM. We also expose the number of cores used for IRQ per node as a metric for continued observability. The upstream issue was later fixed in later versions of ubuntu (see bug <a href=\\\"https://bugs.launchpad.net/ubuntu/+source/irqbalance/+bug/2038573\\\">#2038573</a>).</p><div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link is-viewable-img image2\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4b76bcb6-3d32-444c-b8de-cd57d93fa7cf_936x292.png\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4b76bcb6-3d32-444c-b8de-cd57d93fa7cf_936x292.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4b76bcb6-3d32-444c-b8de-cd57d93fa7cf_936x292.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4b76bcb6-3d32-444c-b8de-cd57d93fa7cf_936x292.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4b76bcb6-3d32-444c-b8de-cd57d93fa7cf_936x292.png 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4b76bcb6-3d32-444c-b8de-cd57d93fa7cf_936x292.png\\\" width=\\\"936\\\" height=\\\"292\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/4b76bcb6-3d32-444c-b8de-cd57d93fa7cf_936x292.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:292,&quot;width&quot;:936,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:null,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}\\\" class=\\\"sizing-normal\\\" alt=\\\"\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4b76bcb6-3d32-444c-b8de-cd57d93fa7cf_936x292.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4b76bcb6-3d32-444c-b8de-cd57d93fa7cf_936x292.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4b76bcb6-3d32-444c-b8de-cd57d93fa7cf_936x292.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4b76bcb6-3d32-444c-b8de-cd57d93fa7cf_936x292.png 1456w\\\" sizes=\\\"100vw\\\" loading=\\\"lazy\\\"></picture><div class=\\\"image-link-expand\\\"><svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"20\\\" height=\\\"20\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"currentColor\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" class=\\\"lucide lucide-maximize2 \\\"><polyline points=\\\"15 3 21 3 21 9\\\"></polyline><polyline points=\\\"9 21 3 21 3 15\\\"></polyline><line x1=\\\"21\\\" x2=\\\"14\\\" y1=\\\"3\\\" y2=\\\"10\\\"></line><line x1=\\\"3\\\" x2=\\\"10\\\" y1=\\\"21\\\" y2=\\\"14\\\"></line></svg></div></div></a><figcaption class=\\\"image-caption\\\">Figure 8: A recent spike in nodes with Unbalanced IRQ (post upstream fix).</figcaption></figure></div><p>Despite this fix, some packet drops persisted. This was traced to a backlog in the network interface's receive queue. We found if the receive queue size was set to less than 10000 it caused packet drops. To address this, we implemented another automation that flags nodes where <code>net.core.netdev_max_backlog</code> is less than 10000. The corresponding fixer, resets it to 10000 on the host VM.</p><h1>Addressing Failing <code>nftables</code> During OS Image Migration</h1><p>While migrating our nodes from Ubuntu to <a href=\\\"https://learn.microsoft.com/en-us/azure/azure-linux/intro-azure-linux\\\">Azure Linux</a> OS, we noticed <a href=\\\"https://nftables.org/\\\">nftables</a> wasn\u2019t running on the migrated nodes. Kubernetes relies on <code>nftables</code> on the host VM for inter-pod routing rules on the node and egress traffic. This prevented Network Policies from being applied correctly, leading to irregular network failure on nodes. After investigation, we identified this was due to a missing newline in the <code>nftables.conf</code> file (see issues <a href=\\\"https://github.com/Azure/AKS/issues/4144\\\">#4144</a> and <a href=\\\"https://github.com/microsoft/azurelinux/issues/7301\\\">#7301</a>, and pull request <a href=\\\"https://github.com/microsoft/azurelinux/pull/8310\\\">#8310</a>).</p><p>To address this, we implemented a self-healing automation that flags nodes where the host VM isn\u2019t running <code>nftables</code>. The corresponding fixer corrects the nftables.conf file by appending a newline to the end and restarts the <code>nftables</code> systemd service.</p><div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link is-viewable-img image2\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3268575d-af8e-40ec-960f-f3e8f7c617a2_936x294.png\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3268575d-af8e-40ec-960f-f3e8f7c617a2_936x294.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3268575d-af8e-40ec-960f-f3e8f7c617a2_936x294.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3268575d-af8e-40ec-960f-f3e8f7c617a2_936x294.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3268575d-af8e-40ec-960f-f3e8f7c617a2_936x294.png 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3268575d-af8e-40ec-960f-f3e8f7c617a2_936x294.png\\\" width=\\\"936\\\" height=\\\"294\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/3268575d-af8e-40ec-960f-f3e8f7c617a2_936x294.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:294,&quot;width&quot;:936,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:null,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}\\\" class=\\\"sizing-normal\\\" alt=\\\"\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3268575d-af8e-40ec-960f-f3e8f7c617a2_936x294.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3268575d-af8e-40ec-960f-f3e8f7c617a2_936x294.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3268575d-af8e-40ec-960f-f3e8f7c617a2_936x294.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3268575d-af8e-40ec-960f-f3e8f7c617a2_936x294.png 1456w\\\" sizes=\\\"100vw\\\" loading=\\\"lazy\\\"></picture><div class=\\\"image-link-expand\\\"><svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"20\\\" height=\\\"20\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"currentColor\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" class=\\\"lucide lucide-maximize2 \\\"><polyline points=\\\"15 3 21 3 21 9\\\"></polyline><polyline points=\\\"9 21 3 21 3 15\\\"></polyline><line x1=\\\"21\\\" x2=\\\"14\\\" y1=\\\"3\\\" y2=\\\"10\\\"></line><line x1=\\\"3\\\" x2=\\\"10\\\" y1=\\\"21\\\" y2=\\\"14\\\"></line></svg></div></div></a><figcaption class=\\\"image-caption\\\">Figure 9: Number of nodes with failing <code>nftables</code> until the fixer was deployed.</figcaption></figure></div><h1>Addressing <code>node-problem-detector</code> Missing on Nodes</h1><p>AKS <a href=\\\"https://learn.microsoft.com/en-us/azure/aks/faq#what-is-the-purpose-of-the-aks-linux-extension-i-see-installed-on-my-linux-virtual-machine-scale-sets-instances\\\">runs</a> <a href=\\\"https://github.com/kubernetes/node-problem-detector\\\">node-problem-detector</a> (NPD) to monitor <a href=\\\"https://learn.microsoft.com/en-us/azure/aks/node-problem-detector\\\">node health</a> and flag for removal during malfunction. It runs 10 checks every 30 seconds and injects the output into node conditions. We integrated these conditions into our observability stack. During a workload failure investigation, we noticed a node had only 4 status conditions instead of the usual 14 (10 from NPD and 4 from kubelet). This led us to discover NPD wasn\u2019t running on the node. The workload failed because Container Runtime Interface (CRI) malfunctioned on the node preventing kubelet from verifying workload status.</p><p>We implemented a self-healing detector that flags nodes where NPD isn\u2019t running. Further analysis revealed 25% of our nodes had this issue. Automatically terminating these nodes was deemed too risky. Instead, we rolled back the node OS on all of our nodes to a previously working version and escalated the issue to the cloud provider (see issue <a href=\\\"https://github.com/Azure/AKS/issues/3988\\\">#3988</a>). This was later attributed to an upstream <a href=\\\"https://security.snyk.io/vuln/SNYK-WOLFILATEST-NODEPROBLEMDETECTOR-5862811\\\">CVE</a> that was fixed. We also set up automated alerts for nodes without NPD to prevent future issues.</p><div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link is-viewable-img image2\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52189f1e-c380-4a08-acec-21cbf643a276_1600x575.png\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52189f1e-c380-4a08-acec-21cbf643a276_1600x575.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52189f1e-c380-4a08-acec-21cbf643a276_1600x575.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52189f1e-c380-4a08-acec-21cbf643a276_1600x575.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52189f1e-c380-4a08-acec-21cbf643a276_1600x575.png 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52189f1e-c380-4a08-acec-21cbf643a276_1600x575.png\\\" width=\\\"1456\\\" height=\\\"523\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/52189f1e-c380-4a08-acec-21cbf643a276_1600x575.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:523,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:null,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}\\\" class=\\\"sizing-normal\\\" alt=\\\"\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52189f1e-c380-4a08-acec-21cbf643a276_1600x575.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52189f1e-c380-4a08-acec-21cbf643a276_1600x575.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52189f1e-c380-4a08-acec-21cbf643a276_1600x575.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52189f1e-c380-4a08-acec-21cbf643a276_1600x575.png 1456w\\\" sizes=\\\"100vw\\\" loading=\\\"lazy\\\"></picture><div class=\\\"image-link-expand\\\"><svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"20\\\" height=\\\"20\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"currentColor\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" class=\\\"lucide lucide-maximize2 \\\"><polyline points=\\\"15 3 21 3 21 9\\\"></polyline><polyline points=\\\"9 21 3 21 3 15\\\"></polyline><line x1=\\\"21\\\" x2=\\\"14\\\" y1=\\\"3\\\" y2=\\\"10\\\"></line><line x1=\\\"3\\\" x2=\\\"10\\\" y1=\\\"21\\\" y2=\\\"14\\\"></line></svg></div></div></a><figcaption class=\\\"image-caption\\\">Figure 10: Nodes without <code>node-problem-detector</code> detected.</figcaption></figure></div><h1>Mitigating <code>ImagePullBackOff</code> Errors for Large Container Images</h1><p>We faced a surge in <code>ImagePullBackOff</code> errors for workloads with large container images (7-10GB). The kubelet error messages (example below) were unhelpful, and workloads failed to start for hours. Manual eviction sometimes helped after multiple retries. An unrelated experiment benchmarking write speeds on <a href=\\\"https://learn.microsoft.com/en-us/azure/virtual-machines/disks-types\\\">Azure Managed OS disk</a> and <a href=\\\"https://learn.microsoft.com/en-us/azure/virtual-machines/ephemeral-os-disks\\\">Ephemeral OS disk</a>, led us to identify that the issues occurred exclusively on nodes with Managed OS disks.</p><pre><code>Oct 31 11:57:43 aks-nodepool0392-17898922-vmss0000LX kubelet[2874]: E1031 11:57:43.120279    2874 remote_image.go:242] \\\"PullImage from image service failed\\\" err=\\\"rpc error: code = Canceled desc = failed to pull and unpack image \\\\\\\"cssacrprod.azurecr.io/chronorepo-companion-cron:efdc4a316aebcc878c38483b09bb939524dbd94a\\\\\\\": failed to commit snapshot extract-332345855-2JgL sha256:d2bd2b7dd52900b17c2e8d2f50d94273892a45d96a760f078aeb58bc54fbc160: context canceled\\\" image=\\\"cssacrprod.azurecr.io/chronorepo-companion-cron:efdc4a316aebcc878c38483b09bb939524dbd94a\\\"</code></pre><p>We implemented a self-healing detector that flags nodes with <code>ImagePullBackOff</code> errors by parsing kubelet logs. Currently, we lack an automatic fixer. Instead, we emit a custom warning event for each affected pod. Affected workloads can either retry, or if the issue persists, set a node affinity for label <code>ephemeral-storage = true</code>. All nodes in our platform with Ephemeral OS disks have this label.</p><h1>Conclusion</h1><p>Building out a self-healing solution for Kubernetes has allowed us to enhance the reliability of our Kubernetes platform without burdening ourselves with operational and support toil. Automation proved to be the right principle for us to scale to <a href=\\\"https://techblog.citystoragesystems.com/p/managing-100s-of-kubernetes-clusters\\\">100s of clusters</a>.</p><p>So, what\u2019s next? We are constantly adding new detectors and fixers to our self-healing framework. Low level networking, noisy neighbor problems, CPU core use optimizations are few examples of areas we are actively investigating how to automatically detect and rectify problems. Furthermore, we plan on extending the framework beyond platform deficiencies to application deficiencies. We are confident the same mechanics of self-healing are widely applicable. Self-healing is the only answer to having a platform\u2019s maintenance costs scale sublinearly with business growth. So we\u2019re serious about investing in it further.</p>\",\"longer_truncated_body_json\":null,\"longer_truncated_body_html\":null,\"truncated_body_text\":\"Written by Grzegorz G\u0142\u0105b and Nibir Bora, members of the engineering teams that work on core infrastructure. Many organizations opt for managed Kubernetes distributions like Azure Kubernetes Service (AKS) to get up and running quickly without needing a large engineering team to operate Kubernetes clusters. This is a core design principle of the Core Infra\u2026\",\"wordcount\":2159,\"postTags\":[],\"publishedBylines\":[],\"reaction\":null,\"reaction_count\":0,\"comment_count\":0,\"child_comment_count\":0,\"audio_items\":[{\"post_id\":145625273,\"voice_id\":\"en-US-JennyNeural\",\"audio_url\":\"https://substack-video.s3.amazonaws.com/video_upload/post/145625273/tts/6562e51a-fae0-4a24-a4d0-3ce0d1264f8c/en-US-JennyNeural.mp3\",\"type\":\"tts\",\"status\":\"completed\"}],\"is_geoblocked\":false,\"hasCashtag\":false},\"comments\":[],\"canonicalUrl\":\"https://techblog.citystoragesystems.com/p/kubernetes-self-healing\",\"inlineComments\":false,\"readerIsSearchCrawler\":false,\"ogUrl\":\"https://techblog.citystoragesystems.com/p/kubernetes-self-healing\",\"bannedFromNotes\":false,\"themeVariables\":{\"color_theme_bg_pop\":\"#464EE7\",\"background_pop\":\"#464EE7\",\"color_theme_bg_web\":\"#151513\",\"cover_bg_color\":\"#151513\",\"background_pop_darken\":\"#2f38e4\",\"print_on_pop\":\"#ffffff\",\"color_theme_bg_pop_darken\":\"#2f38e4\",\"color_theme_print_on_pop\":\"#ffffff\",\"border_subtle\":\"rgba(68, 68, 66, 0.5)\",\"background_subtle\":\"rgba(227, 228, 251, 0.4)\",\"print_pop\":\"#464ee7\",\"color_theme_accent\":\"#464ee7\",\"cover_print_primary\":\"#ffffff\",\"cover_print_secondary\":\"#d9d9d9\",\"cover_border_color\":\"#ffffff\",\"font_family_headings_preset\":\"'SF Pro Display', -apple-system, system-ui, BlinkMacSystemFont, 'Inter', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'\",\"font_weight_headings_preset\":900,\"font_family_body_preset\":\"'SF Pro Display', -apple-system, system-ui, BlinkMacSystemFont, 'Inter', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'\",\"font_weight_body_preset\":400,\"font_preset_heading\":\"heavy_sans\",\"font_preset_body\":\"sans\",\"home_hero\":\"newspaper\",\"home_posts\":\"list\",\"web_bg_color\":\"#151513\",\"background_contrast_1\":\"#232321\",\"color_theme_bg_contrast_1\":\"#232321\",\"background_contrast_2\":\"#353533\",\"color_theme_bg_contrast_2\":\"#353533\",\"background_contrast_3\":\"#575756\",\"color_theme_bg_contrast_3\":\"#575756\",\"background_contrast_4\":\"#797977\",\"color_theme_bg_contrast_4\":\"#797977\",\"background_contrast_5\":\"#b5b5b4\",\"color_theme_bg_contrast_5\":\"#b5b5b4\",\"color_theme_detail\":\"#2c2c2b\",\"background_contrast_pop\":\"rgba(70, 78, 231, 0.4)\",\"color_theme_bg_contrast_pop\":\"rgba(70, 78, 231, 0.4)\",\"input_background\":\"#21211f\",\"cover_input_background\":\"#21211f\",\"tooltip_background\":\"#414140\",\"web_bg_color_h\":\"60\",\"web_bg_color_s\":\"5%\",\"web_bg_color_l\":\"7.8431372549019605%\",\"print_on_web_bg_color\":\"#ffffff\",\"print_secondary_on_web_bg_color\":\"#a1a1a1\",\"selected_comment_background_color\":\"#201c14\",\"background_pop_rgb\":\"70, 78, 231\",\"background_pop_rgb_pc\":\"70 78 231\",\"color_theme_bg_pop_rgb\":\"70, 78, 231\",\"color_theme_bg_pop_rgb_pc\":\"70 78 231\",\"color_theme_accent_rgb\":\"70, 78, 231\",\"color_theme_accent_rgb_pc\":\"70 78 231\"},\"recentEpisodes\":null,\"trackFrontendVisit\":true,\"isChatActive\":false,\"isMeetingsActive\":false,\"features\":{},\"showCookieBanner\":false,\"disabledCookies\":[],\"dd_env\":\"zuma-prod\",\"dd_ti\":true}")</script>
        <script>window._analyticsConfig = JSON.parse("{\"properties\":{\"subdomain\":\"engineering4citystoragesystems\",\"publication_id\":2259056,\"has_plans\":false,\"pub_community_enabled\":true,\"is_subscribed\":false,\"is_free_subscribed\":false,\"is_author\":false,\"is_contributor\":false,\"is_admin\":false,\"is_founding\":false},\"adwordsAccountId\":\"AW-316245675\",\"adwordsEventSendTo\":\"Tf76CKqcyL4DEKuN5pYB\"}")</script>
        <script type="module" src="https://substackcdn.com/bundle/assets/main-138ab290.js" charset="utf-8"  defer></script>
        <script nomodule>
            (function() {
                var message = 'Your browser does not support modern JavaScript modules. Please upgrade your browser for the best experience.';
                var warningDiv = document.createElement('div');
                warningDiv.style.color = 'red';
                warningDiv.style.padding = '10px';
                warningDiv.style.margin = '10px 0';
                warningDiv.style.border = '1px solid red';
                warningDiv.style.backgroundColor = 'lightyellow';
                warningDiv.innerText = message;
                document.body.prepend(warningDiv);
            })();
        </script>

        
            <!-- Datadog Analytics -->
            <script>
              (function(h,o,u,n,d) {
                h=h[d]=h[d]||{q:[],onReady:function(c){h.q.push(c)}}
                d=o.createElement(u);d.async=1;d.src=n
                n=o.getElementsByTagName(u)[0];n.parentNode.insertBefore(d,n)
              })(window,document,'script','https://www.datadoghq-browser-agent.com/us1/v5/datadog-rum.js','DD_RUM')
              window.DD_RUM.onReady(function() {
                window.DD_RUM.init({
                  clientToken: 'puba71073f072643721169b68f352438710',
                  applicationId: '2e321b35-c76b-4073-8d04-cc9a10461793',
                  site: 'datadoghq.com',
                  service: 'substack-web',
                  env: window._preloads.dd_env,
                  version: 'e32364cc926c69744fa7a052008f726a1d2a8bca',
                  sessionSampleRate: 1,
                  sessionReplaySampleRate: 100,
                  trackUserInteractions: window._preloads.dd_ti,
                  trackResources: true,
                  trackLongTasks: true,
                  defaultPrivacyLevel: 'mask-user-input',
                  allowedTracingUrls: [/https?:\/\/(.+\/.)?substack(cdn)?\.com/]
                });
              })
            </script>
            <!-- End Datadog Analytics -->

            <!-- Cloudflare Web Analytics -->
            <script defer src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon='{"token": "216309cffb464db4b0e02daf0b8e8060"}'></script>
            <!-- End Cloudflare Web Analytics -->
        

        <!-- Fallback tracking pixels -->
        

        

        <noscript>
    <style>
        #nojs-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            padding: 16px 16px 16px 32px;
            width: 100%;
            box-sizing: border-box;
            background: red;
            color: white;
            font-family: -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            font-size: 13px;
            line-height: 13px;
        }
        #nojs-banner a {
            color: inherit;
            text-decoration: underline;
        }
    </style>

    <div id="nojs-banner">
        This site requires JavaScript to run correctly. Please <a href="https://enable-javascript.com/" target="_blank">turn on JavaScript</a> or unblock scripts
    </div>
</noscript>


        

        

        
        
    </body>
</html>
