<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/_next/static/media/9919cdaa7472f3f1-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="preload" href="/_next/static/media/c9a5bc6a7c948fb0-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="preload" as="image" href="/images/logo.png"/><link rel="preload" as="image" href="/images/blog/background.png"/><link rel="preload" as="image" href="/images/blog/cta-banner-centralized.png"/><link rel="preload" as="image" href="https://github.com/Permify/permify/assets/34595361/94429606-c884-40af-893b-6a24903967a2"/><link rel="preload" as="image" href="https://github.com/Permify/permify/assets/34595361/7a36c62b-c5f0-4d85-9337-8856edc8f8c6"/><link rel="preload" as="image" href="https://github.com/Permify/permify/assets/34595361/6c6fb7e9-5154-45ac-86fc-bbb8cfd94b05"/><link rel="preload" as="image" href="https://github.com/Permify/permify/assets/34595361/0375c733-a4c0-4e47-b5a8-9acba6f6a338"/><link rel="preload" as="image" href="https://github.com/Permify/permify/assets/34595361/c52c8685-3925-47d8-80cc-9f12cddd00bf"/><link rel="preload" as="image" href="https://github.com/Permify/permify/assets/34595361/cd075440-698a-42f6-bc95-dbd5df76dd5a"/><link rel="stylesheet" href="/_next/static/css/f76788cadc76491e.css" crossorigin="" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/e5640627427cd2a0.css" crossorigin="" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-a9310c77abfb36b5.js" crossorigin=""/><script src="/_next/static/chunks/fd9d1056-56a5cc3ca57c0c3f.js" async="" crossorigin=""></script><script src="/_next/static/chunks/472-a6861273c17997c1.js" async="" crossorigin=""></script><script src="/_next/static/chunks/main-app-892c3dff08e9cd4c.js" async="" crossorigin=""></script><script src="/_next/static/chunks/851-7b11895491db55bb.js" async=""></script><script src="/_next/static/chunks/994-94db91d5646e676f.js" async=""></script><script src="/_next/static/chunks/518-fe2cf39afa19306e.js" async=""></script><script src="/_next/static/chunks/app/layout-b4c8d2128bdf9cb1.js" async=""></script><script src="/_next/static/chunks/413-db70f9887aee1156.js" async=""></script><script src="/_next/static/chunks/566-facb25fefea2b940.js" async=""></script><script src="/_next/static/chunks/app/(default)/page-90264e05b822f2c4.js" async=""></script><link rel="preload" href="https://plausible.io/js/script.js" as="script"/><link rel="preload" href="https://buttons.github.io/buttons.js" as="script"/><title>Opa Gatekeeper: How To Write Policies For Kubernetes Clusters</title><meta name="description" content="Learn how to leverage OPA Gatekeeper to write and enforce policies in Kubernetes clusters, ensuring security and efficient resource management in your environment."/><link rel="canonical" href="https://permify.co/post/opa-gatekeeper-kubernetes/"/><meta property="og:title" content="Opa Gatekeeper: How To Write Policies For Kubernetes Clusters"/><meta property="og:description" content="Learn how to leverage OPA Gatekeeper to write and enforce policies in Kubernetes clusters, ensuring security and efficient resource management in your environment."/><meta property="og:url" content="https://permify.co/post/opa-gatekeeper-kubernetes/"/><meta property="og:image" content="https://permify.co/images/blog/opa-gatekeeper-write-policies-kubernetes-clusters.png"/><meta property="og:image:alt" content="Opa Gatekeeper: How To Write Policies For Kubernetes Clusters"/><meta property="og:type" content="article"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="Opa Gatekeeper: How To Write Policies For Kubernetes Clusters"/><meta name="twitter:description" content="Learn how to leverage OPA Gatekeeper to write and enforce policies in Kubernetes clusters, ensuring security and efficient resource management in your environment."/><meta name="twitter:image" content="https://permify.co/images/blog/opa-gatekeeper-write-policies-kubernetes-clusters.png"/><meta name="twitter:image:alt" content="Opa Gatekeeper: How To Write Policies For Kubernetes Clusters"/><link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="16x16"/><meta name="next-size-adjust"/><script src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js" crossorigin="" noModule=""></script></head><body class="__variable_aaf875 __variable_ee1ced font-inter antialiased bg-black text-slate-100 tracking-tight overflow-x-hidden"><!--$!--><template data-dgst="NEXT_DYNAMIC_NO_SSR_CODE"></template><!--/$--><script>!function(){var d=document.documentElement,c=d.classList;c.remove('light','dark');d.style.colorScheme = 'dark';c.add('dark')}()</script><style data-emotion="css-global 1b7scut">:host,:root,[data-theme]{--chakra-ring-inset:var(--chakra-empty,/*!*/ /*!*/);--chakra-ring-offset-width:0px;--chakra-ring-offset-color:#fff;--chakra-ring-color:rgba(66, 153, 225, 0.6);--chakra-ring-offset-shadow:0 0 #0000;--chakra-ring-shadow:0 0 #0000;--chakra-space-x-reverse:0;--chakra-space-y-reverse:0;--chakra-colors-transparent:transparent;--chakra-colors-current:currentColor;--chakra-colors-black:#000000;--chakra-colors-white:#FFFFFF;--chakra-colors-whiteAlpha-50:rgba(255, 255, 255, 0.04);--chakra-colors-whiteAlpha-100:rgba(255, 255, 255, 0.06);--chakra-colors-whiteAlpha-200:rgba(255, 255, 255, 0.08);--chakra-colors-whiteAlpha-300:rgba(255, 255, 255, 0.16);--chakra-colors-whiteAlpha-400:rgba(255, 255, 255, 0.24);--chakra-colors-whiteAlpha-500:rgba(255, 255, 255, 0.36);--chakra-colors-whiteAlpha-600:rgba(255, 255, 255, 0.48);--chakra-colors-whiteAlpha-700:rgba(255, 255, 255, 0.64);--chakra-colors-whiteAlpha-800:rgba(255, 255, 255, 0.80);--chakra-colors-whiteAlpha-900:rgba(255, 255, 255, 0.92);--chakra-colors-blackAlpha-50:rgba(0, 0, 0, 0.04);--chakra-colors-blackAlpha-100:rgba(0, 0, 0, 0.06);--chakra-colors-blackAlpha-200:rgba(0, 0, 0, 0.08);--chakra-colors-blackAlpha-300:rgba(0, 0, 0, 0.16);--chakra-colors-blackAlpha-400:rgba(0, 0, 0, 0.24);--chakra-colors-blackAlpha-500:rgba(0, 0, 0, 0.36);--chakra-colors-blackAlpha-600:rgba(0, 0, 0, 0.48);--chakra-colors-blackAlpha-700:rgba(0, 0, 0, 0.64);--chakra-colors-blackAlpha-800:rgba(0, 0, 0, 0.80);--chakra-colors-blackAlpha-900:rgba(0, 0, 0, 0.92);--chakra-colors-gray-50:#F7FAFC;--chakra-colors-gray-100:#EDF2F7;--chakra-colors-gray-200:#E2E8F0;--chakra-colors-gray-300:#CBD5E0;--chakra-colors-gray-400:#A0AEC0;--chakra-colors-gray-500:#718096;--chakra-colors-gray-600:#4A5568;--chakra-colors-gray-700:#2D3748;--chakra-colors-gray-800:#1A202C;--chakra-colors-gray-900:#171923;--chakra-colors-red-50:#FFF5F5;--chakra-colors-red-100:#FED7D7;--chakra-colors-red-200:#FEB2B2;--chakra-colors-red-300:#FC8181;--chakra-colors-red-400:#F56565;--chakra-colors-red-500:#E53E3E;--chakra-colors-red-600:#C53030;--chakra-colors-red-700:#9B2C2C;--chakra-colors-red-800:#822727;--chakra-colors-red-900:#63171B;--chakra-colors-orange-50:#FFFAF0;--chakra-colors-orange-100:#FEEBC8;--chakra-colors-orange-200:#FBD38D;--chakra-colors-orange-300:#F6AD55;--chakra-colors-orange-400:#ED8936;--chakra-colors-orange-500:#DD6B20;--chakra-colors-orange-600:#C05621;--chakra-colors-orange-700:#9C4221;--chakra-colors-orange-800:#7B341E;--chakra-colors-orange-900:#652B19;--chakra-colors-yellow-50:#FFFFF0;--chakra-colors-yellow-100:#FEFCBF;--chakra-colors-yellow-200:#FAF089;--chakra-colors-yellow-300:#F6E05E;--chakra-colors-yellow-400:#ECC94B;--chakra-colors-yellow-500:#D69E2E;--chakra-colors-yellow-600:#B7791F;--chakra-colors-yellow-700:#975A16;--chakra-colors-yellow-800:#744210;--chakra-colors-yellow-900:#5F370E;--chakra-colors-green-50:#F0FFF4;--chakra-colors-green-100:#C6F6D5;--chakra-colors-green-200:#9AE6B4;--chakra-colors-green-300:#68D391;--chakra-colors-green-400:#48BB78;--chakra-colors-green-500:#38A169;--chakra-colors-green-600:#2F855A;--chakra-colors-green-700:#276749;--chakra-colors-green-800:#22543D;--chakra-colors-green-900:#1C4532;--chakra-colors-teal-50:#E6FFFA;--chakra-colors-teal-100:#B2F5EA;--chakra-colors-teal-200:#81E6D9;--chakra-colors-teal-300:#4FD1C5;--chakra-colors-teal-400:#38B2AC;--chakra-colors-teal-500:#319795;--chakra-colors-teal-600:#2C7A7B;--chakra-colors-teal-700:#285E61;--chakra-colors-teal-800:#234E52;--chakra-colors-teal-900:#1D4044;--chakra-colors-blue-50:#ebf8ff;--chakra-colors-blue-100:#bee3f8;--chakra-colors-blue-200:#90cdf4;--chakra-colors-blue-300:#63b3ed;--chakra-colors-blue-400:#4299e1;--chakra-colors-blue-500:#3182ce;--chakra-colors-blue-600:#2b6cb0;--chakra-colors-blue-700:#2c5282;--chakra-colors-blue-800:#2a4365;--chakra-colors-blue-900:#1A365D;--chakra-colors-cyan-50:#EDFDFD;--chakra-colors-cyan-100:#C4F1F9;--chakra-colors-cyan-200:#9DECF9;--chakra-colors-cyan-300:#76E4F7;--chakra-colors-cyan-400:#0BC5EA;--chakra-colors-cyan-500:#00B5D8;--chakra-colors-cyan-600:#00A3C4;--chakra-colors-cyan-700:#0987A0;--chakra-colors-cyan-800:#086F83;--chakra-colors-cyan-900:#065666;--chakra-colors-purple-50:#FAF5FF;--chakra-colors-purple-100:#E9D8FD;--chakra-colors-purple-200:#D6BCFA;--chakra-colors-purple-300:#B794F4;--chakra-colors-purple-400:#9F7AEA;--chakra-colors-purple-500:#805AD5;--chakra-colors-purple-600:#6B46C1;--chakra-colors-purple-700:#553C9A;--chakra-colors-purple-800:#44337A;--chakra-colors-purple-900:#322659;--chakra-colors-pink-50:#FFF5F7;--chakra-colors-pink-100:#FED7E2;--chakra-colors-pink-200:#FBB6CE;--chakra-colors-pink-300:#F687B3;--chakra-colors-pink-400:#ED64A6;--chakra-colors-pink-500:#D53F8C;--chakra-colors-pink-600:#B83280;--chakra-colors-pink-700:#97266D;--chakra-colors-pink-800:#702459;--chakra-colors-pink-900:#521B41;--chakra-colors-linkedin-50:#E8F4F9;--chakra-colors-linkedin-100:#CFEDFB;--chakra-colors-linkedin-200:#9BDAF3;--chakra-colors-linkedin-300:#68C7EC;--chakra-colors-linkedin-400:#34B3E4;--chakra-colors-linkedin-500:#00A0DC;--chakra-colors-linkedin-600:#008CC9;--chakra-colors-linkedin-700:#0077B5;--chakra-colors-linkedin-800:#005E93;--chakra-colors-linkedin-900:#004471;--chakra-colors-facebook-50:#E8F4F9;--chakra-colors-facebook-100:#D9DEE9;--chakra-colors-facebook-200:#B7C2DA;--chakra-colors-facebook-300:#6482C0;--chakra-colors-facebook-400:#4267B2;--chakra-colors-facebook-500:#385898;--chakra-colors-facebook-600:#314E89;--chakra-colors-facebook-700:#29487D;--chakra-colors-facebook-800:#223B67;--chakra-colors-facebook-900:#1E355B;--chakra-colors-messenger-50:#D0E6FF;--chakra-colors-messenger-100:#B9DAFF;--chakra-colors-messenger-200:#A2CDFF;--chakra-colors-messenger-300:#7AB8FF;--chakra-colors-messenger-400:#2E90FF;--chakra-colors-messenger-500:#0078FF;--chakra-colors-messenger-600:#0063D1;--chakra-colors-messenger-700:#0052AC;--chakra-colors-messenger-800:#003C7E;--chakra-colors-messenger-900:#002C5C;--chakra-colors-whatsapp-50:#dffeec;--chakra-colors-whatsapp-100:#b9f5d0;--chakra-colors-whatsapp-200:#90edb3;--chakra-colors-whatsapp-300:#65e495;--chakra-colors-whatsapp-400:#3cdd78;--chakra-colors-whatsapp-500:#22c35e;--chakra-colors-whatsapp-600:#179848;--chakra-colors-whatsapp-700:#0c6c33;--chakra-colors-whatsapp-800:#01421c;--chakra-colors-whatsapp-900:#001803;--chakra-colors-twitter-50:#E5F4FD;--chakra-colors-twitter-100:#C8E9FB;--chakra-colors-twitter-200:#A8DCFA;--chakra-colors-twitter-300:#83CDF7;--chakra-colors-twitter-400:#57BBF5;--chakra-colors-twitter-500:#1DA1F2;--chakra-colors-twitter-600:#1A94DA;--chakra-colors-twitter-700:#1681BF;--chakra-colors-twitter-800:#136B9E;--chakra-colors-twitter-900:#0D4D71;--chakra-colors-telegram-50:#E3F2F9;--chakra-colors-telegram-100:#C5E4F3;--chakra-colors-telegram-200:#A2D4EC;--chakra-colors-telegram-300:#7AC1E4;--chakra-colors-telegram-400:#47A9DA;--chakra-colors-telegram-500:#0088CC;--chakra-colors-telegram-600:#007AB8;--chakra-colors-telegram-700:#006BA1;--chakra-colors-telegram-800:#005885;--chakra-colors-telegram-900:#003F5E;--chakra-borders-none:0;--chakra-borders-1px:1px solid;--chakra-borders-2px:2px solid;--chakra-borders-4px:4px solid;--chakra-borders-8px:8px solid;--chakra-fonts-heading:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";--chakra-fonts-body:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";--chakra-fonts-mono:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--chakra-fontSizes-3xs:0.45rem;--chakra-fontSizes-2xs:0.625rem;--chakra-fontSizes-xs:0.75rem;--chakra-fontSizes-sm:0.875rem;--chakra-fontSizes-md:1rem;--chakra-fontSizes-lg:1.125rem;--chakra-fontSizes-xl:1.25rem;--chakra-fontSizes-2xl:1.5rem;--chakra-fontSizes-3xl:1.875rem;--chakra-fontSizes-4xl:2.25rem;--chakra-fontSizes-5xl:3rem;--chakra-fontSizes-6xl:3.75rem;--chakra-fontSizes-7xl:4.5rem;--chakra-fontSizes-8xl:6rem;--chakra-fontSizes-9xl:8rem;--chakra-fontWeights-hairline:100;--chakra-fontWeights-thin:200;--chakra-fontWeights-light:300;--chakra-fontWeights-normal:400;--chakra-fontWeights-medium:500;--chakra-fontWeights-semibold:600;--chakra-fontWeights-bold:700;--chakra-fontWeights-extrabold:800;--chakra-fontWeights-black:900;--chakra-letterSpacings-tighter:-0.05em;--chakra-letterSpacings-tight:-0.025em;--chakra-letterSpacings-normal:0;--chakra-letterSpacings-wide:0.025em;--chakra-letterSpacings-wider:0.05em;--chakra-letterSpacings-widest:0.1em;--chakra-lineHeights-3:.75rem;--chakra-lineHeights-4:1rem;--chakra-lineHeights-5:1.25rem;--chakra-lineHeights-6:1.5rem;--chakra-lineHeights-7:1.75rem;--chakra-lineHeights-8:2rem;--chakra-lineHeights-9:2.25rem;--chakra-lineHeights-10:2.5rem;--chakra-lineHeights-normal:normal;--chakra-lineHeights-none:1;--chakra-lineHeights-shorter:1.25;--chakra-lineHeights-short:1.375;--chakra-lineHeights-base:1.5;--chakra-lineHeights-tall:1.625;--chakra-lineHeights-taller:2;--chakra-radii-none:0;--chakra-radii-sm:0.125rem;--chakra-radii-base:0.25rem;--chakra-radii-md:0.375rem;--chakra-radii-lg:0.5rem;--chakra-radii-xl:0.75rem;--chakra-radii-2xl:1rem;--chakra-radii-3xl:1.5rem;--chakra-radii-full:9999px;--chakra-space-1:0.25rem;--chakra-space-2:0.5rem;--chakra-space-3:0.75rem;--chakra-space-4:1rem;--chakra-space-5:1.25rem;--chakra-space-6:1.5rem;--chakra-space-7:1.75rem;--chakra-space-8:2rem;--chakra-space-9:2.25rem;--chakra-space-10:2.5rem;--chakra-space-12:3rem;--chakra-space-14:3.5rem;--chakra-space-16:4rem;--chakra-space-20:5rem;--chakra-space-24:6rem;--chakra-space-28:7rem;--chakra-space-32:8rem;--chakra-space-36:9rem;--chakra-space-40:10rem;--chakra-space-44:11rem;--chakra-space-48:12rem;--chakra-space-52:13rem;--chakra-space-56:14rem;--chakra-space-60:15rem;--chakra-space-64:16rem;--chakra-space-72:18rem;--chakra-space-80:20rem;--chakra-space-96:24rem;--chakra-space-px:1px;--chakra-space-0-5:0.125rem;--chakra-space-1-5:0.375rem;--chakra-space-2-5:0.625rem;--chakra-space-3-5:0.875rem;--chakra-shadows-xs:0 0 0 1px rgba(0, 0, 0, 0.05);--chakra-shadows-sm:0 1px 2px 0 rgba(0, 0, 0, 0.05);--chakra-shadows-base:0 1px 3px 0 rgba(0, 0, 0, 0.1),0 1px 2px 0 rgba(0, 0, 0, 0.06);--chakra-shadows-md:0 4px 6px -1px rgba(0, 0, 0, 0.1),0 2px 4px -1px rgba(0, 0, 0, 0.06);--chakra-shadows-lg:0 10px 15px -3px rgba(0, 0, 0, 0.1),0 4px 6px -2px rgba(0, 0, 0, 0.05);--chakra-shadows-xl:0 20px 25px -5px rgba(0, 0, 0, 0.1),0 10px 10px -5px rgba(0, 0, 0, 0.04);--chakra-shadows-2xl:0 25px 50px -12px rgba(0, 0, 0, 0.25);--chakra-shadows-outline:0 0 0 3px rgba(66, 153, 225, 0.6);--chakra-shadows-inner:inset 0 2px 4px 0 rgba(0,0,0,0.06);--chakra-shadows-none:none;--chakra-shadows-dark-lg:rgba(0, 0, 0, 0.1) 0px 0px 0px 1px,rgba(0, 0, 0, 0.2) 0px 5px 10px,rgba(0, 0, 0, 0.4) 0px 15px 40px;--chakra-sizes-1:0.25rem;--chakra-sizes-2:0.5rem;--chakra-sizes-3:0.75rem;--chakra-sizes-4:1rem;--chakra-sizes-5:1.25rem;--chakra-sizes-6:1.5rem;--chakra-sizes-7:1.75rem;--chakra-sizes-8:2rem;--chakra-sizes-9:2.25rem;--chakra-sizes-10:2.5rem;--chakra-sizes-12:3rem;--chakra-sizes-14:3.5rem;--chakra-sizes-16:4rem;--chakra-sizes-20:5rem;--chakra-sizes-24:6rem;--chakra-sizes-28:7rem;--chakra-sizes-32:8rem;--chakra-sizes-36:9rem;--chakra-sizes-40:10rem;--chakra-sizes-44:11rem;--chakra-sizes-48:12rem;--chakra-sizes-52:13rem;--chakra-sizes-56:14rem;--chakra-sizes-60:15rem;--chakra-sizes-64:16rem;--chakra-sizes-72:18rem;--chakra-sizes-80:20rem;--chakra-sizes-96:24rem;--chakra-sizes-px:1px;--chakra-sizes-0-5:0.125rem;--chakra-sizes-1-5:0.375rem;--chakra-sizes-2-5:0.625rem;--chakra-sizes-3-5:0.875rem;--chakra-sizes-max:max-content;--chakra-sizes-min:min-content;--chakra-sizes-full:100%;--chakra-sizes-3xs:14rem;--chakra-sizes-2xs:16rem;--chakra-sizes-xs:20rem;--chakra-sizes-sm:24rem;--chakra-sizes-md:28rem;--chakra-sizes-lg:32rem;--chakra-sizes-xl:36rem;--chakra-sizes-2xl:42rem;--chakra-sizes-3xl:48rem;--chakra-sizes-4xl:56rem;--chakra-sizes-5xl:64rem;--chakra-sizes-6xl:72rem;--chakra-sizes-7xl:80rem;--chakra-sizes-8xl:90rem;--chakra-sizes-prose:60ch;--chakra-sizes-container-sm:640px;--chakra-sizes-container-md:768px;--chakra-sizes-container-lg:1024px;--chakra-sizes-container-xl:1280px;--chakra-zIndices-hide:-1;--chakra-zIndices-auto:auto;--chakra-zIndices-base:0;--chakra-zIndices-docked:10;--chakra-zIndices-dropdown:1000;--chakra-zIndices-sticky:1100;--chakra-zIndices-banner:1200;--chakra-zIndices-overlay:1300;--chakra-zIndices-modal:1400;--chakra-zIndices-popover:1500;--chakra-zIndices-skipLink:1600;--chakra-zIndices-toast:1700;--chakra-zIndices-tooltip:1800;--chakra-transition-property-common:background-color,border-color,color,fill,stroke,opacity,box-shadow,transform;--chakra-transition-property-colors:background-color,border-color,color,fill,stroke;--chakra-transition-property-dimensions:width,height;--chakra-transition-property-position:left,right,top,bottom;--chakra-transition-property-background:background-color,background-image,background-position;--chakra-transition-easing-ease-in:cubic-bezier(0.4, 0, 1, 1);--chakra-transition-easing-ease-out:cubic-bezier(0, 0, 0.2, 1);--chakra-transition-easing-ease-in-out:cubic-bezier(0.4, 0, 0.2, 1);--chakra-transition-duration-ultra-fast:50ms;--chakra-transition-duration-faster:100ms;--chakra-transition-duration-fast:150ms;--chakra-transition-duration-normal:200ms;--chakra-transition-duration-slow:300ms;--chakra-transition-duration-slower:400ms;--chakra-transition-duration-ultra-slow:500ms;--chakra-blur-none:0;--chakra-blur-sm:4px;--chakra-blur-base:8px;--chakra-blur-md:12px;--chakra-blur-lg:16px;--chakra-blur-xl:24px;--chakra-blur-2xl:40px;--chakra-blur-3xl:64px;--chakra-breakpoints-base:0em;--chakra-breakpoints-sm:30em;--chakra-breakpoints-md:48em;--chakra-breakpoints-lg:62em;--chakra-breakpoints-xl:80em;--chakra-breakpoints-2xl:96em;}.chakra-ui-light :host:not([data-theme]),.chakra-ui-light :root:not([data-theme]),.chakra-ui-light [data-theme]:not([data-theme]),[data-theme=light] :host:not([data-theme]),[data-theme=light] :root:not([data-theme]),[data-theme=light] [data-theme]:not([data-theme]),:host[data-theme=light],:root[data-theme=light],[data-theme][data-theme=light]{--chakra-colors-chakra-body-text:var(--chakra-colors-gray-800);--chakra-colors-chakra-body-bg:var(--chakra-colors-white);--chakra-colors-chakra-border-color:var(--chakra-colors-gray-200);--chakra-colors-chakra-inverse-text:var(--chakra-colors-white);--chakra-colors-chakra-subtle-bg:var(--chakra-colors-gray-100);--chakra-colors-chakra-subtle-text:var(--chakra-colors-gray-600);--chakra-colors-chakra-placeholder-color:var(--chakra-colors-gray-500);}.chakra-ui-dark :host:not([data-theme]),.chakra-ui-dark :root:not([data-theme]),.chakra-ui-dark [data-theme]:not([data-theme]),[data-theme=dark] :host:not([data-theme]),[data-theme=dark] :root:not([data-theme]),[data-theme=dark] [data-theme]:not([data-theme]),:host[data-theme=dark],:root[data-theme=dark],[data-theme][data-theme=dark]{--chakra-colors-chakra-body-text:var(--chakra-colors-whiteAlpha-900);--chakra-colors-chakra-body-bg:var(--chakra-colors-gray-800);--chakra-colors-chakra-border-color:var(--chakra-colors-whiteAlpha-300);--chakra-colors-chakra-inverse-text:var(--chakra-colors-gray-800);--chakra-colors-chakra-subtle-bg:var(--chakra-colors-gray-700);--chakra-colors-chakra-subtle-text:var(--chakra-colors-gray-400);--chakra-colors-chakra-placeholder-color:var(--chakra-colors-whiteAlpha-400);}</style><style data-emotion="css-global fubdgu">html{line-height:1.5;-webkit-text-size-adjust:100%;font-family:system-ui,sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;-moz-osx-font-smoothing:grayscale;touch-action:manipulation;}body{position:relative;min-height:100%;margin:0;font-feature-settings:"kern";}:where(*, *::before, *::after){border-width:0;border-style:solid;box-sizing:border-box;word-wrap:break-word;}main{display:block;}hr{border-top-width:1px;box-sizing:content-box;height:0;overflow:visible;}:where(pre, code, kbd,samp){font-family:SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:1em;}a{background-color:transparent;color:inherit;-webkit-text-decoration:inherit;text-decoration:inherit;}abbr[title]{border-bottom:none;-webkit-text-decoration:underline;text-decoration:underline;-webkit-text-decoration:underline dotted;-webkit-text-decoration:underline dotted;text-decoration:underline dotted;}:where(b, strong){font-weight:bold;}small{font-size:80%;}:where(sub,sup){font-size:75%;line-height:0;position:relative;vertical-align:baseline;}sub{bottom:-0.25em;}sup{top:-0.5em;}img{border-style:none;}:where(button, input, optgroup, select, textarea){font-family:inherit;font-size:100%;line-height:1.15;margin:0;}:where(button, input){overflow:visible;}:where(button, select){text-transform:none;}:where(
          button::-moz-focus-inner,
          [type="button"]::-moz-focus-inner,
          [type="reset"]::-moz-focus-inner,
          [type="submit"]::-moz-focus-inner
        ){border-style:none;padding:0;}fieldset{padding:0.35em 0.75em 0.625em;}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal;}progress{vertical-align:baseline;}textarea{overflow:auto;}:where([type="checkbox"], [type="radio"]){box-sizing:border-box;padding:0;}input[type="number"]::-webkit-inner-spin-button,input[type="number"]::-webkit-outer-spin-button{-webkit-appearance:none!important;}input[type="number"]{-moz-appearance:textfield;}input[type="search"]{-webkit-appearance:textfield;outline-offset:-2px;}input[type="search"]::-webkit-search-decoration{-webkit-appearance:none!important;}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit;}details{display:block;}summary{display:-webkit-box;display:-webkit-list-item;display:-ms-list-itembox;display:list-item;}template{display:none;}[hidden]{display:none!important;}:where(
          blockquote,
          dl,
          dd,
          h1,
          h2,
          h3,
          h4,
          h5,
          h6,
          hr,
          figure,
          p,
          pre
        ){margin:0;}button{background:transparent;padding:0;}fieldset{margin:0;padding:0;}:where(ol, ul){margin:0;padding:0;}textarea{resize:vertical;}:where(button, [role="button"]){cursor:pointer;}button::-moz-focus-inner{border:0!important;}table{border-collapse:collapse;}:where(h1, h2, h3, h4, h5, h6){font-size:inherit;font-weight:inherit;}:where(button, input, optgroup, select, textarea){padding:0;line-height:inherit;color:inherit;}:where(img, svg, video, canvas, audio, iframe, embed, object){display:block;}:where(img, video){max-width:100%;height:auto;}[data-js-focus-visible] :focus:not([data-focus-visible-added]):not(
          [data-focus-visible-disabled]
        ){outline:none;box-shadow:none;}select::-ms-expand{display:none;}:root,:host{--chakra-vh:100vh;}@supports (height: -webkit-fill-available){:root,:host{--chakra-vh:-webkit-fill-available;}}@supports (height: -moz-fill-available){:root,:host{--chakra-vh:-moz-fill-available;}}@supports (height: 100dvh){:root,:host{--chakra-vh:100dvh;}}</style><style data-emotion="css-global 1cgn62j">body{font-family:var(--chakra-fonts-body);color:var(--chakra-colors-chakra-body-text);background:var(--chakra-colors-chakra-body-bg);transition-property:background-color;transition-duration:var(--chakra-transition-duration-normal);line-height:var(--chakra-lineHeights-base);}*::-webkit-input-placeholder{color:var(--chakra-colors-chakra-placeholder-color);}*::-moz-placeholder{color:var(--chakra-colors-chakra-placeholder-color);}*:-ms-input-placeholder{color:var(--chakra-colors-chakra-placeholder-color);}*::placeholder{color:var(--chakra-colors-chakra-placeholder-color);}*,*::before,::after{border-color:var(--chakra-colors-chakra-border-color);}</style><div class="flex flex-col min-h-screen overflow-x-hidden"><header class="absolute w-full z-30"><div class="max-w-6xl mx-auto px-4 sm:px-6"><div class="flex items-center justify-between h-20"><div class="shrink-0 mr-5"><a href="/" class="block" aria-label="Cruip"><div class="block"><img src="/images/logo.png" width="139" height="39" alt="Permify"/></div></a></div><nav class="hidden md:flex md:grow"><ul class="flex grow flex-wrap items-center font-medium"><li class="relative"><a class="text-sm text-slate-600 hover:text-slate-900 dark:text-slate-300 dark:hover:text-slate-100 px-5 py-2 flex items-center transition duration-150 ease-in-out" href="#0" aria-expanded="false">Learn<svg class="w-3 h-3 fill-current text-slate-400 cursor-pointer ml-1 shrink-0" viewBox="0 0 12 12" xmlns="http://www.w3.org/2000/svg"><path d="M10.28 4.305L5.989 8.598 1.695 4.305A1 1 0 00.28 5.72l5 5a1 1 0 001.414 0l5-5a1 1 0 10-1.414-1.414z"></path></svg></a></li><li><a href="https://permify.co/#usecases" class="text-sm text-slate-600 hover:text-slate-900 dark:text-slate-300 dark:hover:text-slate-100 px-5 py-2 flex items-center transition duration-150 ease-in-out">Use Cases</a></li><li><a href="/pricing/" class="text-sm text-slate-600 hover:text-slate-900 dark:text-slate-300 dark:hover:text-slate-100 px-5 py-2 flex items-center transition duration-150 ease-in-out">Pricing</a></li><li><a href="/company/career/" class="text-sm text-slate-600 hover:text-slate-900 dark:text-slate-300 dark:hover:text-slate-100 px-5 py-2 flex items-center transition duration-150 ease-in-out">Career</a></li><li><a href="/changelog/" class="text-sm text-slate-600 hover:text-slate-900 dark:text-slate-300 dark:hover:text-slate-100 px-5 py-2 flex items-center transition duration-150 ease-in-out">Changelog</a></li></ul><ul class="flex justify-end flex-wrap items-center"><li class="github-button-wrapper"><a class="hidden github-button" href="https://github.com/Permify/permify" data-color-scheme="no-preference: dark_dimmed; light: dark; dark: dark;" data-size="large" data-show-count="true" aria-label="Star Permify/permify on GitHub">Star</a></li><li class="ml-6"><button class="relative p-[1px] overflow-hidden" style="border-radius:0.25rem"><div style="border-radius:0.25rem"><svg xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none" class="absolute h-full w-full" width="100%" height="100%"><rect fill="none" width="100%" height="100%"></rect></svg><div style="position:absolute;top:0;left:0;display:inline-block;transform:translateX(undefinedpx) translateY(undefinedpx) translateX(-50%) translateY(-50%)"><div class="h-20 w-20 opacity-[0.8] bg-[radial-gradient(var(--purple-800)_40%,transparent_60%)]"></div></div></div><div class="relative border backdrop-blur-xl flex items-center justify-center h-full antialiased btn-sm text-sm bg-black text-white border-slate-800 hover:text-white w-full group" style="border-radius:0.25rem">Try Permify<!-- --> <span class="tracking-normal text-purple-800 group-hover:translate-x-0.5 transition-transform duration-150 ease-in-out ml-1">-&gt;</span></div></button></li></ul></nav><div class="inline-flex md:hidden"><button class="hamburger false" aria-controls="mobile-nav" aria-expanded="false"><span class="sr-only">Menu</span><svg class="w-6 h-6 fill-current text-gray-900 hover:text-gray-900 dark:text-gray-300 dark:hover:text-gray-100 transition duration-150 ease-in-out" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><rect y="4" width="24" height="2" rx="1"></rect><rect y="11" width="24" height="2" rx="1"></rect><rect y="18" width="24" height="2" rx="1"></rect></svg></button><div></div></div></div></div></header><main class="grow"><section class="relative"><div class="absolute inset-0 h-128 pt-16 box-content"><img class="absolute inset-0 w-full h-full object-cover opacity-25" src="/images/blog/background.png" width="1440" height="577" alt="Opa Gatekeeper: How To Write Policies For Kubernetes Clusters"/><div class="absolute inset-0 bg-gradient-to-t from-white dark:from-black" aria-hidden="true"></div></div><div class="relative max-w-6xl mx-auto px-4 sm:px-6"><div class="pt-32 pb-12 md:pt-40 md:pb-20"><div class="max-w-3xl mx-auto"><article><header class="mb-8"><div class="text-center md:text-left"><h1 class="h1 font-red-hat-display mb-4" data-aos="fade-down">Opa Gatekeeper: How To Write Policies For Kubernetes Clusters</h1><p class="text-xl text-gray-600 dark:text-gray-400" data-aos="fade-down" data-aos-delay="150">Learn how to leverage OPA Gatekeeper to write and enforce policies in Kubernetes clusters, ensuring security and efficient resource management in your environment.</p></div><div class="md:flex md:items-center md:justify-between mt-5"><div class="flex items-center justify-center" data-aos="fade-down" data-aos-delay="300"><a href="#0"></a><div><span class="text-gray-600 dark:text-gray-400">By<!-- --> </span><a class="font-medium text-gray-800 dark:text-gray-300 hover:underline" href="#0">Vanessa Osuka</a><span class="text-gray-600 dark:text-gray-400"> <!-- -->· <time dateTime="2024-06-08T00:00:00.000Z">Jun 8, 2024</time></span></div></div></div></header><hr class="w-5 h-px pt-px bg-gray-400 dark:bg-gray-500 border-0 mb-8" data-aos="fade-down" data-aos-delay="450"/><div class="mb-8" data-aos="fade-up" data-aos-delay="450"><article class="prose text-lg text-gray-600 dark:text-gray-400 max-w-none prose-lg prose-p:leading-normal prose-headings:text-gray-900 dark:prose-headings:text-gray-100 prose-a:text-teal-500 prose-a:no-underline hover:prose-a:underline prose-a:font-medium prose-strong:font-medium prose-strong:text-gray-900 dark:prose-strong:text-gray-100 prose-blockquote:italic prose-blockquote:pl-4 prose-blockquote:border-l-2 prose-blockquote:border-teal-500 dark:prose-blockquote:border-gray-400 prose-blockquote:font-normal prose-blockquote:text-inherit"><h3>Table Of Contents</h3>
<ul>
<li>
<a href="#what-is-open-policy-agent-opa">What is Open Policy Agent (OPA)?</a>
</li>
<li>
<a href="#how-opa-and-kubernetes-work-together">How OPA And Kubernetes Work Together?</a>
</li>
<li>
<a href="#what-is-opa-gatekeeper">What is OPA Gatekeeper?</a>
</li>
<li>
<a href="#what-is-opa-gatekeeper">Writing Policies In Kubernetes Clusters With OPA Gateway</a>
<ul>
<li>
<a href="#defining-namespaces-policies">1. Defining namespaces policies</a>
</li>
<li>
<a href="#allocating-resources-quotas">2. Allocating resources quotas</a>
</li>
<li>
<a href="#writing-a-custom-controller">3. Writing a custom controller</a>
</li>
</ul>
</li>
<li>
<a href="#summary-and-conclusion">Summary and Conclusion</a>
</li>
</ul>
<p>Due to the presence of tools like kubernetes, it is easier to manage and automate the daily working processes of a microservices environment.</p>
<p>Using policies in your kubernetes will give you maximum control and flexibility especially in areas such as:</p>
<ul>
<li>Improving the security of your microservices</li>
<li>Active management of limited resources in your cloud infrastructure</li>
<li>Compliance and governance with regulatory laws</li>
</ul>
<p>By reading this article you will learn:</p>
<ol>
<li>The benefits of using policies in securing kubernetes environment.</li>
<li>How to set up a system for dispensing policies; how kubernetes and OPA work behind the scenes.</li>
<li>Everything you need to get started writing and running policies within your cluster.</li>
</ol>
<h2 id="what-is-open-policy-agent-opa">What is Open Policy Agent (OPA)?</h2>
<p><a href="https://www.openpolicyagent.org/">Open Policy Agent (OPA)</a> helps us write policy as code using Rego, a declarative language designed specifically for this reason.</p>
<p>With OPA, we can define and enforce policies across various layers of the stack, from kubernetes to microservices.</p>
<p>This approach contributes to consistency, scalability, and agility in managing policies within your kubernetes clusters.</p>
<p>In addition, by using an expressive syntax you can efficiently represent access control rules and complex policy decisions that your organization reaches.</p>
<p>Altogether, this goes a long way to make sure that your kubernetes environment is compliant and secure.</p>
<p>The focus of this article is on writing policies in kubernetes setup.</p>
<p>If you are not familiar with OPA, you can quickly learn more about how it works and implementation details in <a href="https://permify.co/post/implementing-opa/">this article </a></p>
<a href="https://github.com/Permify/permify/" target="_blank"><p><img src="/images/blog/cta-banner-centralized.png" alt="Local Image"/></p></a>
<h2 id="how-opa-and-kubernetes-work-together">How OPA And Kubernetes Work Together?</h2>
<p>In this section, let us dive a bit more into how you can get Open Policy Agent (OPA) up and running.</p>
<p>Good enough, OPA provides good support for kubernetes as reflected in its documentation so we shall look into how you can integrate it into your kubernetes environment.</p>
<p>But first things first, let&#x27;s talk about some important components and understand how it works ‘behind the scenes’.</p>
<p>Kubernetes ships with what is called an admission controller. It&#x27;s a piece of code that acts like a middleman between the kubernetes API itself and any request sent.</p>
<p>Admission controllers can also be used to enforce policies and security measures, making sure that only authorized and properly configured workloads are allowed into the cluster.</p>
<p>They may alter requests to ensure that it is of valid and acceptable form before processing takes place.</p>
<p>So, admission controllers can be of two types: mutating or validating. It&#x27;s important to understand this aspect as this is where Open Policy Agent (OPA) plugs in.</p>
<p><img src="https://github.com/Permify/permify/assets/34595361/94429606-c884-40af-893b-6a24903967a2" alt="admission controllers"/></p>
<p>As to why we need admission controllers in our cluster, <a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/">the official kubernetes documentation</a> has this to say:</p>
<blockquote>
<p>&quot;...a Kubernetes API server that is not properly configured with the right set of admission controllers is an incomplete server and will not support all the features you expect...&quot;</p>
</blockquote>
<p>In essence, you may choose to use Open Policy Agent (OPA) or write your own custom admission controller, depending on the scope of customizations you are planning to achieve in your kubernetes environment.</p>
<h2 id="what-is-opa-gatekeeper">What is OPA Gatekeeper?</h2>
<p>A kubernetes setup is barely complete without an admission controller. <a href="https://github.com/open-policy-agent/gatekeeper">OPA Gatekeeper</a> is one such controller that checks any request coming into the kubernetes API. </p>
<p>Gatekeeper intercepts the request and checks with predefined policies. Based on this check, a request can be denied or granted. </p>
<p><img src="https://github.com/Permify/permify/assets/34595361/7a36c62b-c5f0-4d85-9337-8856edc8f8c6" alt="opa-gatekeeper"/></p>
<p>From the illustration above, we see the workflow of how OPA gatekeeper <strong>reviews</strong> any request that comes into the kubernetes API server.</p>
<p>It also constantly <strong>watches</strong> for any changes in the elements of the API server such as the pods and services. </p>
<p>So in essence, when you install gatekeeper on kubernetes environment, you can write policies and have them take effect in the cluster.
We will see more of this in a bit.</p>
<h2 id="tutorial-guide-writing">Writing Policies In Kubernetes Clusters With OPA Gateway</h2>
<p>To further understand the benefits and integration scope of OPA gatekeeper in kubernetes, we will cover the following use cases throughout this piece:</p>
<ul>
<li><a href="https://hackmd.io/ot-49MTSQNyOws_oFwt4sw#1-Namespace-policy">Defining namespaces policies</a></li>
<li><a href="https://hackmd.io/ot-49MTSQNyOws_oFwt4sw#2-Resource-quota-allocation">Allocating resources quotas</a> </li>
<li><a href="https://hackmd.io/ot-49MTSQNyOws_oFwt4sw#3-Custom-validation-webhook">Writing a custom controller</a></li>
</ul>
<p>This 2-part tutorial will take you step by step through the entire process of how to write and test policies using Open Policy Agent (OPA) in your kubernetes cluster.</p>
<p>In the first part, we&#x27;ll make use of OPA gatekeeper admission controller to enforce the policies we write, and then, in the second part we shall write our own custom validating controller.</p>
<p>Thus, by the end of this guide you&#x27;ll have:</p>
<ol>
<li>Gained knowledge of how OPA policies work within a kubernetes set up</li>
<li>How to write and apply your own policies</li>
<li>A better understanding of the admission controller webhook in Kubernetes; the workflow and how to implement your own validating controller.</li>
</ol>
<h3><strong>Prerequisites</strong></h3>
<p>To benefit fully from this practical guide, you need to have the following set up in your local machine:</p>
<ol>
<li>Ensure you have <a href="https://www.openpolicyagent.org/docs/latest/#1-download-opa">OPA </a>installed</li>
<li>Minikube : Ensure you have <a href="https://minikube.sigs.k8s.io/docs/start/">Minikube</a> and a running Kubernates cluster</li>
<li><a href="https://kubernetes.io/docs/tasks/tools/#kubectl">kubectl:</a> Ensure you have <code>kubectl</code> configured to interact with your cluster.</li>
<li>OPA gatekeeper : Ensure <a href="https://open-policy-agent.github.io/gatekeeper/website/docs/install#installation">OPA Gatekeeper is installed in your cluster.</a></li>
<li>Docker and <a href="https://hub.docker.com/signup">DockerHub</a> account</li>
</ol>
<p>Let&#x27;s get right into it.</p>
<h3 id="defining-namespaces-policies">1. Defining namespaces policies</h3>
<p>For this usecase, let&#x27;s write an OPA policy that states that every namespace create request should have an annotation added to it.</p>
<p><strong>Step I:</strong> Create a constraint template file
A ConstraintTemplate defines the structure and logic of the policy. This template will enforce that every namespace must have the <code>team</code> annotation.</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">templates.gatekeeper.sh/v1beta1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">ConstraintTemplate</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">k8srequiredannotations</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">crd:</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">names:</span>
        <span class="hljs-attr">kind:</span> <span class="hljs-string">K8sRequiredAnnotations</span>
  <span class="hljs-attr">targets:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">target:</span> <span class="hljs-string">admission.k8s.gatekeeper.sh</span>
      <span class="hljs-attr">rego:</span> <span class="hljs-string">|
        package k8srequiredannotations
</span>
        <span class="hljs-string">violation[{&quot;msg&quot;:</span> <span class="hljs-string">msg}]</span> {
          <span class="hljs-string">input.review.kind.kind</span> <span class="hljs-string">==</span> <span class="hljs-string">&quot;Namespace&quot;</span>
          <span class="hljs-string">not</span> <span class="hljs-string">input.review.object.metadata.annotations</span>[<span class="hljs-string">&quot;team&quot;</span>]
          <span class="hljs-string">msg</span> <span class="hljs-string">:=</span> <span class="hljs-string">&quot;Namespace must have an annotation &#x27;team&#x27;&quot;</span>
        }

</code></pre>
<p>Save this YAML to a file named <code>constrainttemplate.yaml</code> then apply it to your cluster:</p>
<p><code>kubectl apply -f constrainttemplate.yaml</code></p>
<p><strong>Step II:</strong> Create a constraint file</p>
<p>A Constraint uses the ConstraintTemplate to enforce the policy on specific resources—in this case, namespaces.</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">constraints.gatekeeper.sh/v1beta1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">K8sRequiredAnnotations</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">require-team-annotation</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">match:</span>
    <span class="hljs-attr">kinds:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>]
        <span class="hljs-attr">kinds:</span> [<span class="hljs-string">&quot;Namespace&quot;</span>]
</code></pre>
<p>Save this YAML to a file named <code>constraint.yaml</code> and also apply it to your cluster:</p>
<p><code>kubectl apply -f constraint.yaml</code></p>
<p><strong>Step III:</strong> Verify the policy</p>
<p>To verify that the policy is working, try creating a namespace without the team annotation. It should be denied.</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Namespace</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">demo-namespace</span>
</code></pre>
<p>Save this YAML to a file named <code>demo-namespace.yaml</code> and apply it:</p>
<p><code>kubectl apply -f demo-namespace.yaml</code></p>
<p>As expected, we get an error response:
<img src="https://github.com/Permify/permify/assets/34595361/6c6fb7e9-5154-45ac-86fc-bbb8cfd94b05" alt="team_annot"/></p>
<p>Now let&#x27;s comply with the policy by creating a namespace with the <code>team</code> annotation.</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Namespace</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">test-namespace</span>
  <span class="hljs-attr">annotations:</span>
    <span class="hljs-attr">team:</span> <span class="hljs-string">&quot;devops&quot;</span>
</code></pre>
<p>Save the above YAML file as <code>test-namespace-with-annotation.yaml</code> and apply it to the cluster.</p>
<p>This time, it creates the namespace successfully.
<img src="https://github.com/Permify/permify/assets/34595361/0375c733-a4c0-4e47-b5a8-9acba6f6a338" alt="test_np_with_anot"/></p>
<h3 id="allocating-resources-quotas">2. Allocating resources quotas</h3>
<p>Next, we want to write a bit more advanced policy that states that namespaces labelled with <code>env:production</code> must have a resource quota applied to them.</p>
<p>Such a policy can be helpful when you want to control or monitor usage of resources and make things more efficient. Let&#x27;s get started.</p>
<p><strong>Step I:</strong> Create the constraint template file</p>
<p>This template will check if namespaces labeled with <code>env: production</code> have a resource quota.</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">templates.gatekeeper.sh/v1beta1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">ConstraintTemplate</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">k8srequiredresourcequotas</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">crd:</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">names:</span>
        <span class="hljs-attr">kind:</span> <span class="hljs-string">K8sRequiredResourceQuotas</span>
  <span class="hljs-attr">targets:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">target:</span> <span class="hljs-string">admission.k8s.gatekeeper.sh</span>
      <span class="hljs-attr">rego:</span> <span class="hljs-string">|
        package k8srequiredresourcequotas
</span>
        <span class="hljs-string">violation[{&quot;msg&quot;:</span> <span class="hljs-string">msg}]</span> {
          <span class="hljs-string">input.review.kind.kind</span> <span class="hljs-string">==</span> <span class="hljs-string">&quot;Namespace&quot;</span>
          <span class="hljs-string">namespace</span> <span class="hljs-string">:=</span> <span class="hljs-string">input.review.object</span>

          <span class="hljs-string">some</span> <span class="hljs-string">label_key</span>
          <span class="hljs-string">namespace.metadata.labels</span>[<span class="hljs-string">label_key</span>] <span class="hljs-string">==</span> <span class="hljs-string">&quot;production&quot;</span>
          <span class="hljs-string">not</span> <span class="hljs-string">has_resource_quota(namespace.metadata.name)</span>

          <span class="hljs-string">msg</span> <span class="hljs-string">:=</span> <span class="hljs-string">sprintf(&quot;Namespace</span> <span class="hljs-string">labeled</span> <span class="hljs-string">&#x27;env: production&#x27;</span> <span class="hljs-string">must</span> <span class="hljs-string">have</span> <span class="hljs-string">a</span> <span class="hljs-string">resource</span> <span class="hljs-string">quota&quot;</span>, []<span class="hljs-string">)</span>
        }

        <span class="hljs-string">has_resource_quota(namespace_name)</span> {
          <span class="hljs-string">some</span> <span class="hljs-string">i</span>
          <span class="hljs-string">input.review.context.related</span>[<span class="hljs-string">i</span>]<span class="hljs-string">.kind</span> <span class="hljs-string">==</span> <span class="hljs-string">&quot;ResourceQuota&quot;</span>
          <span class="hljs-string">input.review.context.related</span>[<span class="hljs-string">i</span>]<span class="hljs-string">.metadata.namespace</span> <span class="hljs-string">==</span> <span class="hljs-string">namespace_name</span>
        }
</code></pre>
<p>Save this YAML to a file named <code>constrainttemplate.yaml</code> and apply it to your cluster:</p>
<p><code>kubectl apply -f constrainttemplate.yaml</code></p>
<p><strong>Step II:</strong> Create a constraint file</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">constraints.gatekeeper.sh/v1beta1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">K8sRequiredResourceQuotas</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">require-resource-quota-for-production</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">match:</span>
    <span class="hljs-attr">kinds:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>]
        <span class="hljs-attr">kinds:</span> [<span class="hljs-string">&quot;Namespace&quot;</span>]

</code></pre>
<p>Save this YAML to a file named <code>constraint.yaml</code> and apply it to your cluster:</p>
<p><code>kubectl apply -f constraint.yaml</code></p>
<p><strong>Step III:</strong> Verify the policy
To verify that the policy works, let&#x27;s create a simple test namespace with the production label but without specifying any resource quotas. It should be rejected.</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Namespace</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">test-namespace-production-no-quota</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">env:</span> <span class="hljs-string">production</span>
</code></pre>
<p>Save this YAML to a file <code>test-namespace-production-no-quota.yaml</code> and apply it:</p>
<pre><code class="hljs language-yaml"><span class="hljs-string">kubectl</span> <span class="hljs-string">apply</span> <span class="hljs-string">-f</span> <span class="hljs-string">test-namespace-production-no-quota.yaml</span>
</code></pre>
<p>As expected, we get an error response when we try to create a namespace, saying that we must assign a quota just like it is stated in our policy file:</p>
<p><img src="https://github.com/Permify/permify/assets/34595361/c52c8685-3925-47d8-80cc-9f12cddd00bf" alt="namespace_error"/></p>
<p>Awesome. Let&#x27;s go ahead and assign a quota for our namespace.</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">ResourceQuota</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">resource-quota</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">hard:</span>
    <span class="hljs-attr">requests.cpu:</span> <span class="hljs-string">&quot;1&quot;</span>
    <span class="hljs-attr">requests.memory:</span> <span class="hljs-string">1Gi</span>
    <span class="hljs-attr">limits.cpu:</span> <span class="hljs-string">&quot;2&quot;</span>
    <span class="hljs-attr">limits.memory:</span> <span class="hljs-string">2Gi</span>
</code></pre>
<p>Save this YAML to a file named <code>resource-quota.yaml</code> and apply it:</p>
<p><code>kubectl apply -f resource-quota.yaml</code></p>
<p><img src="https://github.com/Permify/permify/assets/34595361/cd075440-698a-42f6-bc95-dbd5df76dd5a" alt="resource_quota_created"/></p>
<p>After applying as shown above, the namespace creation and quota application is successful.</p>
<p>You can also go further to actually check the assigned quota for the namespace with the command:</p>
<p><code>kubectl get resourcequotas -n default</code></p>
<p>Thus far, we have seen how OPA gatekeeper acts as middleman or interceptor whenever we want to perform specific actions in kubernetes.</p>
<p>Let&#x27;s now move to the final part, which is creating our own custom validation webhook.</p>
<h3 id="writing-a-custom-controller">3. Writing a custom controller</h3>
<p>To begin, create and switch to a seperate folder specifically for this entire drill, you can call it <code>webhook_server.</code></p>
<p><strong>1</strong>. Start the Minikube cluster.
<code>minikube start</code></p>
<p><strong>2</strong>. Write the validating logic for the webhook. We&#x27;ll write this in Python but it can also be written  in any other language of choice.
Create a file <code>app.py</code> and copy the following contents.</p>
<pre><code class="hljs language-python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request, jsonify
<span class="hljs-keyword">import</span> logging

app = Flask(__name__)
logger = logging.getLogger(__name__)

<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/validate&#x27;</span>, methods=[<span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">validate_pod</span>():
    <span class="hljs-keyword">try</span>:
        admission_review = request.get_json()
        pod_spec = admission_review[<span class="hljs-string">&#x27;request&#x27;</span>][<span class="hljs-string">&#x27;object&#x27;</span>][<span class="hljs-string">&#x27;spec&#x27;</span>]
        
        <span class="hljs-comment"># Add your validation logic here</span>
        <span class="hljs-comment"># Example: Check if the pod has a specific label</span>
        labels = pod_spec.get(<span class="hljs-string">&#x27;labels&#x27;</span>, {})
        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;app&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> labels:
            logger.error(<span class="hljs-string">&quot;Pod validation failed: Missing &#x27;app&#x27; label&quot;</span>)
            <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">&quot;response&quot;</span>: {<span class="hljs-string">&quot;allowed&quot;</span>: <span class="hljs-literal">False</span>, <span class="hljs-string">&quot;status&quot;</span>: {<span class="hljs-string">&quot;reason&quot;</span>: <span class="hljs-string">&quot;MissingAppLabel&quot;</span>}}}), <span class="hljs-number">200</span>
        
        <span class="hljs-comment"># If all validation checks pass</span>
        logger.info(<span class="hljs-string">&quot;Pod validation succeeded&quot;</span>)
        <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">&quot;response&quot;</span>: {<span class="hljs-string">&quot;allowed&quot;</span>: <span class="hljs-literal">True</span>}}), <span class="hljs-number">200</span>
    
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        logger.exception(<span class="hljs-string">&quot;An error occurred during pod validation&quot;</span>)
        <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">&quot;response&quot;</span>: {<span class="hljs-string">&quot;allowed&quot;</span>: <span class="hljs-literal">False</span>, <span class="hljs-string">&quot;status&quot;</span>: {<span class="hljs-string">&quot;reason&quot;</span>: <span class="hljs-string">&quot;InternalServerError&quot;</span>}}}), <span class="hljs-number">500</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:
    <span class="hljs-comment"># Configure logging</span>
    logging.basicConfig(level=logging.INFO)
    
    <span class="hljs-comment"># Start the Flask app</span>
    app.run(host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, port=<span class="hljs-number">8080</span>, debug=<span class="hljs-literal">False</span>)

</code></pre>
<p><strong>3.</strong> We need to containerize this webhook server, build and push it to a DockerHub repository.
I. Create a repository on your Dockerhub account.
II. Create a Dockerfile in the folder with the following contents:</p>
<p><code> touch Dockerfile</code></p>
<pre><code class="hljs language-python">FROM python:<span class="hljs-number">3.9</span>-slim

WORKDIR /app

COPY requirements.txt .

RUN pip install --no-cache-<span class="hljs-built_in">dir</span> -r requirements.txt

COPY app.py .

CMD [ <span class="hljs-string">&quot;python&quot;</span>, <span class="hljs-string">&quot;app.py&quot;</span> ]

</code></pre>
<p>III. Build the image
<code>docker build -t your-username/repository-name:latest .</code></p>
<p>IV. Push it to DockerHub</p>
<p><code> docker login</code></p>
<pre><code class="hljs language-bash">docker tag &lt;repository-name&gt;:latest your-username/repository-name:latest
docker push your-username/repository-name:latest
</code></pre>
<p>Now, the image should be live on Dockerhub. This means we can now use it in our deployment yaml file.</p>
<p>💡<strong>Troubleshooting tip:</strong> if you experience request denied errors while pushing your docker image to DockerHub, ensure to login to docker on terminal, double check for any typos or mismatch in the image name, repository name and tagname.</p>
<p><strong>4</strong>. Generate TLS Certificates. This helps to secure communication between our webhook server and kubernetes. It is a crucial step to pay attention to. If not properly configured, you might end up getting TLS errors down the line.</p>
<pre><code class="hljs language-bash">openssl req -x509 -newkey rsa:4096 -keyout server.key -out server.crt -days 365 -nodes -subj <span class="hljs-string">&quot;/CN=pod-validation-webhook.default.svc&quot;</span>
</code></pre>
<pre><code class="hljs language-bash">kubectl create secret tls pod-validation-webhook-tls --cert=server.crt --key=server.key -n default
</code></pre>
<p><strong>5.</strong> Create the deployment YAML file.</p>
<p><code>touch webhook-deployment.yaml</code></p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">pod-validation-webhook</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">pod-validation-webhook</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">pod-validation-webhook</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cweb</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">cannarron/cweb:latest</span>
        <span class="hljs-attr">ports:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8080</span>
        <span class="hljs-attr">volumeMounts:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">tls-certs</span>
          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/webhook/certs</span>
          <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">tls-certs</span>
        <span class="hljs-attr">secret:</span>
          <span class="hljs-attr">secretName:</span> <span class="hljs-string">pod-validation-webhook-tls</span>
</code></pre>
<p><strong>6.</strong> Create a service
We need to create a kubectl service resource to point back to our Python webhook server
<code>touch webhook-service.yaml</code></p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">pod-validation-webhook</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">pod-validation-webhook</span>
  <span class="hljs-attr">ports:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8080</span>
</code></pre>
<p><strong>7.</strong> Create the validation configuration file.
The validation configuration file is what officially registers our webhook as part of the kubernetes API. In other words, kubernetes will be aware that there&#x27;s a new middleman that should be called whenever a pod creation request is sent.</p>
<p><code>touch validating-webhook-config.yaml</code></p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">admissionregistration.k8s.io/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">ValidatingWebhookConfiguration</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">pod-validation-webhook</span>
<span class="hljs-attr">webhooks:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">pod.validation.example.com</span>
    <span class="hljs-attr">clientConfig:</span>
      <span class="hljs-attr">service:</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">pod-validation-webhook</span>
        <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span>
        <span class="hljs-attr">path:</span> <span class="hljs-string">&quot;/validate&quot;</span>
      <span class="hljs-attr">caBundle:</span> <span class="hljs-string">&lt;base64</span> <span class="hljs-string">encoded</span> <span class="hljs-string">ca.crt&gt;</span>
    <span class="hljs-attr">admissionReviewVersions:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">v1</span>
    <span class="hljs-attr">sideEffects:</span> <span class="hljs-string">None</span>
    <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">5</span>
    <span class="hljs-attr">failurePolicy:</span> <span class="hljs-string">Fail</span>
    <span class="hljs-attr">matchPolicy:</span> <span class="hljs-string">Equivalent</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>]
        <span class="hljs-attr">apiVersions:</span> [<span class="hljs-string">&quot;v1&quot;</span>]
        <span class="hljs-attr">operations:</span> [<span class="hljs-string">&quot;CREATE&quot;</span>, <span class="hljs-string">&quot;UPDATE&quot;</span>]
        <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;pods&quot;</span>]
</code></pre>
<p><strong>8.</strong> Apply manifest files; Let&#x27;s apply the deployment, service and validation configuration files YAML we have created in the earlier steps.</p>
<pre><code class="hljs language-yaml"><span class="hljs-string">kubectl</span> <span class="hljs-string">apply</span> <span class="hljs-string">-f</span> <span class="hljs-string">webhook-deployment.yaml</span>
<span class="hljs-string">kubectl</span> <span class="hljs-string">apply</span> <span class="hljs-string">-f</span> <span class="hljs-string">webhook-service.yaml</span>
<span class="hljs-string">kubectl</span> <span class="hljs-string">apply</span> <span class="hljs-string">-f</span> <span class="hljs-string">validating-webhook-config.yaml</span>
</code></pre>
<p><strong>9.</strong> Verify.
Finally if the deployment goes well, then you should see the pod running successfully. And the validation webhook should be active as well
To verify that our validation hook is now active, based on the validation rules set in the webhook, we simply create a test pod without a label which request should be denied.</p>
<h2 id="summary-and-conclusion">Summary and Conclusion</h2>
<p>In this comprehensive guide, we have talked about using policies in kubernetes to extend its features and add custom enhancements or team preferences. We have also gone through step by step on implementing kubernetes policies with practical usecases.</p>
<p>Using policies in your kubernetes setup is a creative way to fully explore the capabilities within your containerized deployments and make it more secure.</p></article></div></article></div></div></div></section></main><footer><div class="max-w-6xl mx-auto px-4 sm:px-6"><div class="grid sm:grid-cols-12 gap-8 py-8 md:py-12"><div class="sm:col-span-12 lg:col-span-4 order-1 lg:order-none"><div class="h-full flex flex-col sm:flex-row lg:flex-col justify-between"><div class="mb-4 sm:mb-0"><div class="mb-4"><div class="block"><img src="/images/logo.png" width="139" height="39" alt="Permify"/></div></div><div class="text-sm text-slate-300">© Permify.co <span class="text-slate-500">-</span> All rights reserved.</div></div></div></div><div class="sm:col-span-6 md:col-span-3 lg:col-span-2"><h6 class="text-sm text-slate-50 font-medium mb-2">Product</h6><ul class="text-sm space-y-2"><li><a class="text-slate-400 hover:text-slate-200 transition duration-150 ease-in-out" href="https://docs.permify.co/permify-overview/intro">Documents</a></li><li><a class="text-slate-400 hover:text-slate-200 transition duration-150 ease-in-out" href="https://docs.permify.co/api-reference">API</a></li><li><a class="text-slate-400 hover:text-slate-200 transition duration-150 ease-in-out" href="https://play.permify.co/">Playground</a></li><li><a class="text-slate-400 hover:text-slate-200 transition duration-150 ease-in-out" href="https://docs.permify.co/getting-started/examples/intro">Examples</a></li></ul></div><div class="sm:col-span-6 md:col-span-3 lg:col-span-2"><h6 class="text-sm text-slate-50 font-medium mb-2">Community</h6><ul class="text-sm space-y-2"><li><a class="text-slate-400 hover:text-slate-200 transition duration-150 ease-in-out" href="https://discord.com/invite/MJbUjwskdH">Discord</a></li><li><a class="text-slate-400 hover:text-slate-200 transition duration-150 ease-in-out" href="https://twitter.com/GetPermify">Twitter</a></li><li><a class="text-slate-400 hover:text-slate-200 transition duration-150 ease-in-out" href="https://github.com/Permify/permify">Github</a></li><li><a class="text-slate-400 hover:text-slate-200 transition duration-150 ease-in-out" href="https://www.linkedin.com/company/permifyco/">Linkedin</a></li></ul></div><div class="sm:col-span-6 md:col-span-3 lg:col-span-2"><h6 class="text-sm text-slate-50 font-medium mb-2">Resources</h6><ul class="text-sm space-y-2"><li><a class="text-slate-400 hover:text-slate-200 transition duration-150 ease-in-out" href="/post/">Blog</a></li><li><a class="text-slate-400 hover:text-slate-200 transition duration-150 ease-in-out" href="https://dev.to/permify">Dev.to</a></li><li><a class="text-slate-400 hover:text-slate-200 transition duration-150 ease-in-out" href="https://medium.com/permify-tech-blog">Medium</a></li></ul></div><div class="sm:col-span-6 md:col-span-3 lg:col-span-2"><h6 class="text-sm text-slate-50 font-medium mb-2">Contact</h6><ul class="text-sm space-y-2"><li><a class="text-slate-400 hover:text-slate-200 transition duration-150 ease-in-out" href="#0">support@permify.co</a></li><li><a class="text-slate-400 hover:text-slate-200 transition duration-150 ease-in-out" href="#0">+1 (415) 941-3794</a></li><li><a class="text-slate-400 hover:text-slate-200 transition duration-150 ease-in-out" href="#0">Lewes Georgetown HighwayGeorgetown, DE 19947</a></li></ul></div></div></div></footer></div><span></span><span id="__chakra_env" hidden=""></span><script src="/_next/static/chunks/webpack-a9310c77abfb36b5.js" crossorigin="" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/media/9919cdaa7472f3f1-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n2:HL[\"/_next/static/media/c9a5bc6a7c948fb0-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n3:HL[\"/_next/static/css/f76788cadc76491e.css\",\"style\",{\"crossOrigin\":\"\"}]\n4:HL[\"/_next/static/css/e5640627427cd2a0.css\",\"style\",{\"crossOrigin\":\"\"}]\n0:\"$L5\"\n"])</script><script>self.__next_f.push([1,"6:I[3728,[],\"\"]\n8:I[9928,[],\"\"]\n9:I[8412,[\"851\",\"static/chunks/851-7b11895491db55bb.js\",\"994\",\"static/chunks/994-94db91d5646e676f.js\",\"518\",\"static/chunks/518-fe2cf39afa19306e.js\",\"185\",\"static/chunks/app/layout-b4c8d2128bdf9cb1.js\"],\"\"]\na:I[6954,[],\"\"]\nb:I[7264,[],\"\"]\nc:I[6060,[\"413\",\"static/chunks/413-db70f9887aee1156.js\",\"566\",\"static/chunks/566-facb25fefea2b940.js\",\"772\",\"static/chunks/app/(default)/page-90264e05b822f2c4.js\"],\"\"]\n"])</script><script>self.__next_f.push([1,"5:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/f76788cadc76491e.css\",\"precedence\":\"next\",\"crossOrigin\":\"\"}],[\"$\",\"link\",\"1\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/e5640627427cd2a0.css\",\"precedence\":\"next\",\"crossOrigin\":\"\"}]],[\"$\",\"$L6\",null,{\"buildId\":\"pVNsrYIXIZ-FBglRvpBMo\",\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/post/opa-gatekeeper-kubernetes/\",\"initialTree\":[\"\",{\"children\":[\"(pages)\",{\"children\":[\"post\",{\"children\":[[\"slug\",\"opa-gatekeeper-kubernetes\",\"d\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":\\\"opa-gatekeeper-kubernetes\\\"}\",{}]}]}]}]},\"$undefined\",\"$undefined\",true],\"initialHead\":[false,\"$L7\"],\"globalErrorComponent\":\"$8\",\"children\":[null,[\"$\",\"$L9\",null,{\"children\":[\"$\",\"$La\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"template\":[\"$\",\"$Lb\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":[\"$\",\"section\",null,{\"children\":[\"$\",\"div\",null,{\"className\":\"relative max-w-6xl mx-auto px-4 sm:px-6\",\"children\":[[\"$\",\"$Lc\",null,{\"className\":\"absolute inset-0 -z-10\"}],[\"$\",\"main\",null,{\"className\":\"grid min-h-full place-items-center bg-black px-6 py-24 sm:py-32 lg:px-8\",\"children\":[\"$\",\"div\",null,{\"className\":\"text-center\",\"children\":[[\"$\",\"p\",null,{\"className\":\"text-base font-semibold text-purple-600\",\"children\":\"404\"}],[\"$\",\"h1\",null,{\"className\":\"mt-4 text-3xl font-bold tracking-tight text-white sm:text-5xl\",\"children\":\"Page not found\"}],[\"$\",\"p\",null,{\"className\":\"mt-6 text-base leading-7 text-slate-300\",\"children\":\"Sorry, we couldn’t find the page you’re looking for.\"}],[\"$\",\"div\",null,{\"className\":\"mt-10 flex items-center justify-center gap-x-6\",\"children\":[\"$\",\"a\",null,{\"className\":\"btn text-slate-900 bg-gradient-to-r from-white/80 via-white to-white/80 hover:bg-white w-full transition duration-150 ease-in-out group\",\"href\":\"https://permify.co/\",\"children\":[\"Go back home\",\" \",[\"$\",\"span\",null,{\"className\":\"tracking-normal text-purple-500 group-hover:translate-x-0.5 transition-transform duration-150 ease-in-out ml-1\"}]]}]}]]}]}]]}]}],\"notFoundStyles\":[],\"childProp\":{\"current\":[\"$\",\"$La\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"(pages)\",\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"template\":[\"$\",\"$Lb\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":[\"$\",\"section\",null,{\"children\":[\"$\",\"div\",null,{\"className\":\"relative max-w-6xl mx-auto px-4 sm:px-6\",\"children\":[[\"$\",\"$Lc\",null,{\"className\":\"absolute inset-0 -z-10\"}],[\"$\",\"main\",null,{\"className\":\"grid min-h-full place-items-center bg-black px-6 py-24 sm:py-32 lg:px-8\",\"children\":[\"$\",\"div\",null,{\"className\":\"text-center\",\"children\":[[\"$\",\"p\",null,{\"className\":\"text-base font-semibold text-purple-600\",\"children\":\"404\"}],[\"$\",\"h1\",null,{\"className\":\"mt-4 text-3xl font-bold tracking-tight text-white sm:text-5xl\",\"children\":\"Page not found\"}],[\"$\",\"p\",null,{\"className\":\"mt-6 text-base leading-7 text-slate-300\",\"children\":\"Sorry, we couldn’t find the page you’re looking for.\"}],[\"$\",\"div\",null,{\"className\":\"mt-10 flex items-center justify-center gap-x-6\",\"children\":[\"$\",\"a\",null,{\"className\":\"btn text-slate-900 bg-gradient-to-r from-white/80 via-white to-white/80 hover:bg-white w-full transition duration-150 ease-in-out group\",\"href\":\"https://permify.co/\",\"children\":[\"Go back home\",\" \",[\"$\",\"span\",null,{\"className\":\"tracking-normal text-purple-500 group-hover:translate-x-0.5 transition-transform duration-150 ease-in-out ml-1\"}]]}]}]]}]}]]}]}],\"notFoundStyles\":[],\"childProp\":{\"current\":[\"$\",\"$La\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"(pages)\",\"children\",\"post\",\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"template\":[\"$\",\"$Lb\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$\",\"$La\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"(pages)\",\"children\",\"post\",\"children\",[\"slug\",\"opa-gatekeeper-kubernetes\",\"d\"],\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"template\":[\"$\",\"$Lb\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$Ld\",[\"$\",\"section\",null,{\"className\":\"relative\",\"children\":[[\"$\",\"div\",null,{\"className\":\"absolute inset-0 h-128 pt-16 box-content\",\"children\":[[\"$\",\"img\",null,{\"className\":\"absolute inset-0 w-full h-full object-cover opacity-25\",\"src\":\"/images/blog/background.png\",\"width\":1440,\"height\":577,\"alt\":\"Opa Gatekeeper: How To Write Policies For Kubernetes Clusters\"}],[\"$\",\"div\",null,{\"className\":\"absolute inset-0 bg-gradient-to-t from-white dark:from-black\",\"aria-hidden\":\"true\"}]]}],[\"$\",\"div\",null,{\"className\":\"relative max-w-6xl mx-auto px-4 sm:px-6\",\"children\":[\"$\",\"div\",null,{\"className\":\"pt-32 pb-12 md:pt-40 md:pb-20\",\"children\":[\"$\",\"div\",null,{\"className\":\"max-w-3xl mx-auto\",\"children\":[\"$\",\"article\",null,{\"children\":[[\"$\",\"header\",null,{\"className\":\"mb-8\",\"children\":[[\"$\",\"div\",null,{\"className\":\"text-center md:text-left\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"h1 font-red-hat-display mb-4\",\"data-aos\":\"fade-down\",\"children\":\"Opa Gatekeeper: How To Write Policies For Kubernetes Clusters\"}],[\"$\",\"p\",null,{\"className\":\"text-xl text-gray-600 dark:text-gray-400\",\"data-aos\":\"fade-down\",\"data-aos-delay\":\"150\",\"children\":\"Learn how to leverage OPA Gatekeeper to write and enforce policies in Kubernetes clusters, ensuring security and efficient resource management in your environment.\"}]]}],[\"$\",\"div\",null,{\"className\":\"md:flex md:items-center md:justify-between mt-5\",\"children\":[\"$\",\"div\",null,{\"className\":\"flex items-center justify-center\",\"data-aos\":\"fade-down\",\"data-aos-delay\":\"300\",\"children\":[[\"$\",\"a\",null,{\"href\":\"#0\"}],[\"$\",\"div\",null,{\"children\":[[\"$\",\"span\",null,{\"className\":\"text-gray-600 dark:text-gray-400\",\"children\":[\"By\",\" \"]}],[\"$\",\"a\",null,{\"className\":\"font-medium text-gray-800 dark:text-gray-300 hover:underline\",\"href\":\"#0\",\"children\":\"Vanessa Osuka\"}],[\"$\",\"span\",null,{\"className\":\"text-gray-600 dark:text-gray-400\",\"children\":[\" \",\"· \",[\"$\",\"time\",null,{\"dateTime\":\"2024-06-08T00:00:00.000Z\",\"children\":\"Jun 8, 2024\"}]]}]]}]]}]}]]}],[\"$\",\"hr\",null,{\"className\":\"w-5 h-px pt-px bg-gray-400 dark:bg-gray-500 border-0 mb-8\",\"data-aos\":\"fade-down\",\"data-aos-delay\":\"450\"}],[\"$\",\"div\",null,{\"className\":\"mb-8\",\"data-aos\":\"fade-up\",\"data-aos-delay\":\"450\",\"children\":[\"$\",\"article\",null,{\"className\":\"prose text-lg text-gray-600 dark:text-gray-400 max-w-none prose-lg prose-p:leading-normal prose-headings:text-gray-900 dark:prose-headings:text-gray-100 prose-a:text-teal-500 prose-a:no-underline hover:prose-a:underline prose-a:font-medium prose-strong:font-medium prose-strong:text-gray-900 dark:prose-strong:text-gray-100 prose-blockquote:italic prose-blockquote:pl-4 prose-blockquote:border-l-2 prose-blockquote:border-teal-500 dark:prose-blockquote:border-gray-400 prose-blockquote:font-normal prose-blockquote:text-inherit\",\"children\":[[\"$\",\"h3\",null,{\"children\":\"Table Of Contents\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"\\n\",[\"$\",\"a\",null,{\"href\":\"#what-is-open-policy-agent-opa\",\"children\":\"What is Open Policy Agent (OPA)?\"}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"\\n\",[\"$\",\"a\",null,{\"href\":\"#how-opa-and-kubernetes-work-together\",\"children\":\"How OPA And Kubernetes Work Together?\"}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"\\n\",[\"$\",\"a\",null,{\"href\":\"#what-is-opa-gatekeeper\",\"children\":\"What is OPA Gatekeeper?\"}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"\\n\",[\"$\",\"a\",null,{\"href\":\"#what-is-opa-gatekeeper\",\"children\":\"Writing Policies In Kubernetes Clusters With OPA Gateway\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"\\n\",[\"$\",\"a\",null,{\"href\":\"#defining-namespaces-policies\",\"children\":\"1. Defining namespaces policies\"}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"\\n\",[\"$\",\"a\",null,{\"href\":\"#allocating-resources-quotas\",\"children\":\"2. Allocating resources quotas\"}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"\\n\",[\"$\",\"a\",null,{\"href\":\"#writing-a-custom-controller\",\"children\":\"3. Writing a custom controller\"}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"\\n\",[\"$\",\"a\",null,{\"href\":\"#summary-and-conclusion\",\"children\":\"Summary and Conclusion\"}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Due to the presence of tools like kubernetes, it is easier to manage and automate the daily working processes of a microservices environment.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Using policies in your kubernetes will give you maximum control and flexibility especially in areas such as:\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"Improving the security of your microservices\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"Active management of limited resources in your cloud infrastructure\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"Compliance and governance with regulatory laws\"}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"By reading this article you will learn:\"}],\"\\n\",[\"$\",\"ol\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"The benefits of using policies in securing kubernetes environment.\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"How to set up a system for dispensing policies; how kubernetes and OPA work behind the scenes.\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"Everything you need to get started writing and running policies within your cluster.\"}],\"\\n\"]}],\"\\n\",[\"$\",\"h2\",null,{\"id\":\"what-is-open-policy-agent-opa\",\"children\":\"What is Open Policy Agent (OPA)?\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"a\",null,{\"href\":\"https://www.openpolicyagent.org/\",\"children\":\"Open Policy Agent (OPA)\"}],\" helps us write policy as code using Rego, a declarative language designed specifically for this reason.\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"With OPA, we can define and enforce policies across various layers of the stack, from kubernetes to microservices.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"This approach contributes to consistency, scalability, and agility in managing policies within your kubernetes clusters.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"In addition, by using an expressive syntax you can efficiently represent access control rules and complex policy decisions that your organization reaches.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Altogether, this goes a long way to make sure that your kubernetes environment is compliant and secure.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"The focus of this article is on writing policies in kubernetes setup.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"If you are not familiar with OPA, you can quickly learn more about how it works and implementation details in \",[\"$\",\"a\",null,{\"href\":\"https://permify.co/post/implementing-opa/\",\"children\":\"this article \"}]]}],\"\\n\",[\"$\",\"a\",null,{\"href\":\"https://github.com/Permify/permify/\",\"target\":\"_blank\",\"children\":[\"$\",\"p\",null,{\"children\":[\"$\",\"img\",null,{\"src\":\"/images/blog/cta-banner-centralized.png\",\"alt\":\"Local Image\"}]}]}],\"\\n\",[\"$\",\"h2\",null,{\"id\":\"how-opa-and-kubernetes-work-together\",\"children\":\"How OPA And Kubernetes Work Together?\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"In this section, let us dive a bit more into how you can get Open Policy Agent (OPA) up and running.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Good enough, OPA provides good support for kubernetes as reflected in its documentation so we shall look into how you can integrate it into your kubernetes environment.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"But first things first, let's talk about some important components and understand how it works ‘behind the scenes’.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Kubernetes ships with what is called an admission controller. It's a piece of code that acts like a middleman between the kubernetes API itself and any request sent.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Admission controllers can also be used to enforce policies and security measures, making sure that only authorized and properly configured workloads are allowed into the cluster.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"They may alter requests to ensure that it is of valid and acceptable form before processing takes place.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"So, admission controllers can be of two types: mutating or validating. It's important to understand this aspect as this is where Open Policy Agent (OPA) plugs in.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"img\",null,{\"src\":\"https://github.com/Permify/permify/assets/34595361/94429606-c884-40af-893b-6a24903967a2\",\"alt\":\"admission controllers\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"As to why we need admission controllers in our cluster, \",[\"$\",\"a\",null,{\"href\":\"https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/\",\"children\":\"the official kubernetes documentation\"}],\" has this to say:\"]}],\"\\n\",[\"$\",\"blockquote\",null,{\"children\":[\"\\n\",[\"$\",\"p\",null,{\"children\":\"\\\"...a Kubernetes API server that is not properly configured with the right set of admission controllers is an incomplete server and will not support all the features you expect...\\\"\"}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"In essence, you may choose to use Open Policy Agent (OPA) or write your own custom admission controller, depending on the scope of customizations you are planning to achieve in your kubernetes environment.\"}],\"\\n\",[\"$\",\"h2\",null,{\"id\":\"what-is-opa-gatekeeper\",\"children\":\"What is OPA Gatekeeper?\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"A kubernetes setup is barely complete without an admission controller. \",[\"$\",\"a\",null,{\"href\":\"https://github.com/open-policy-agent/gatekeeper\",\"children\":\"OPA Gatekeeper\"}],\" is one such controller that checks any request coming into the kubernetes API. \"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Gatekeeper intercepts the request and checks with predefined policies. Based on this check, a request can be denied or granted. \"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"img\",null,{\"src\":\"https://github.com/Permify/permify/assets/34595361/7a36c62b-c5f0-4d85-9337-8856edc8f8c6\",\"alt\":\"opa-gatekeeper\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"From the illustration above, we see the workflow of how OPA gatekeeper \",[\"$\",\"strong\",null,{\"children\":\"reviews\"}],\" any request that comes into the kubernetes API server.\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"It also constantly \",[\"$\",\"strong\",null,{\"children\":\"watches\"}],\" for any changes in the elements of the API server such as the pods and services. \"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"So in essence, when you install gatekeeper on kubernetes environment, you can write policies and have them take effect in the cluster.\\nWe will see more of this in a bit.\"}],\"\\n\",[\"$\",\"h2\",null,{\"id\":\"tutorial-guide-writing\",\"children\":\"Writing Policies In Kubernetes Clusters With OPA Gateway\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"To further understand the benefits and integration scope of OPA gatekeeper in kubernetes, we will cover the following use cases throughout this piece:\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"https://hackmd.io/ot-49MTSQNyOws_oFwt4sw#1-Namespace-policy\",\"children\":\"Defining namespaces policies\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"a\",null,{\"href\":\"https://hackmd.io/ot-49MTSQNyOws_oFwt4sw#2-Resource-quota-allocation\",\"children\":\"Allocating resources quotas\"}],\" \"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"https://hackmd.io/ot-49MTSQNyOws_oFwt4sw#3-Custom-validation-webhook\",\"children\":\"Writing a custom controller\"}]}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"This 2-part tutorial will take you step by step through the entire process of how to write and test policies using Open Policy Agent (OPA) in your kubernetes cluster.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"In the first part, we'll make use of OPA gatekeeper admission controller to enforce the policies we write, and then, in the second part we shall write our own custom validating controller.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Thus, by the end of this guide you'll have:\"}],\"\\n\",[\"$\",\"ol\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"Gained knowledge of how OPA policies work within a kubernetes set up\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"How to write and apply your own policies\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"A better understanding of the admission controller webhook in Kubernetes; the workflow and how to implement your own validating controller.\"}],\"\\n\"]}],\"\\n\",[\"$\",\"h3\",null,{\"children\":[\"$\",\"strong\",null,{\"children\":\"Prerequisites\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"To benefit fully from this practical guide, you need to have the following set up in your local machine:\"}],\"\\n\",[\"$\",\"ol\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"Ensure you have \",[\"$\",\"a\",null,{\"href\":\"https://www.openpolicyagent.org/docs/latest/#1-download-opa\",\"children\":\"OPA \"}],\"installed\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"Minikube : Ensure you have \",[\"$\",\"a\",null,{\"href\":\"https://minikube.sigs.k8s.io/docs/start/\",\"children\":\"Minikube\"}],\" and a running Kubernates cluster\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"a\",null,{\"href\":\"https://kubernetes.io/docs/tasks/tools/#kubectl\",\"children\":\"kubectl:\"}],\" Ensure you have \",[\"$\",\"code\",null,{\"children\":\"kubectl\"}],\" configured to interact with your cluster.\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"OPA gatekeeper : Ensure \",[\"$\",\"a\",null,{\"href\":\"https://open-policy-agent.github.io/gatekeeper/website/docs/install#installation\",\"children\":\"OPA Gatekeeper is installed in your cluster.\"}]]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"Docker and \",[\"$\",\"a\",null,{\"href\":\"https://hub.docker.com/signup\",\"children\":\"DockerHub\"}],\" account\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Let's get right into it.\"}],\"\\n\",[\"$\",\"h3\",null,{\"id\":\"defining-namespaces-policies\",\"children\":\"1. Defining namespaces policies\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"For this usecase, let's write an OPA policy that states that every namespace create request should have an annotation added to it.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"Step I:\"}],\" Create a constraint template file\\nA ConstraintTemplate defines the structure and logic of the policy. This template will enforce that every namespace must have the \",[\"$\",\"code\",null,{\"children\":\"team\"}],\" annotation.\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-yaml\",\"children\":[[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"apiVersion:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"templates.gatekeeper.sh/v1beta1\"}],\"\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"kind:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"ConstraintTemplate\"}],\"\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"metadata:\"}],\"\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"name:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"k8srequiredannotations\"}],\"\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"spec:\"}],\"\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"crd:\"}],\"\\n    \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"spec:\"}],\"\\n      \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"names:\"}],\"\\n        \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"kind:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"K8sRequiredAnnotations\"}],\"\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"targets:\"}],\"\\n    \",[\"$\",\"span\",null,{\"className\":\"hljs-bullet\",\"children\":\"-\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"target:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"admission.k8s.gatekeeper.sh\"}],\"\\n      \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"rego:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"|\\n        package k8srequiredannotations\\n\"}],\"\\n        \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"violation[{\\\"msg\\\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"msg}]\"}],\" {\\n          \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"input.review.kind.kind\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"==\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"Namespace\\\"\"}],\"\\n          \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"not\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"input.review.object.metadata.annotations\"}],\"[\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"team\\\"\"}],\"]\\n          \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"msg\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\":=\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"Namespace must have an annotation 'team'\\\"\"}],\"\\n        }\\n\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"Save this YAML to a file named \",[\"$\",\"code\",null,{\"children\":\"constrainttemplate.yaml\"}],\" then apply it to your cluster:\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"kubectl apply -f constrainttemplate.yaml\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"Step II:\"}],\" Create a constraint file\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"A Constraint uses the ConstraintTemplate to enforce the policy on specific resources—in this case, namespaces.\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-yaml\",\"children\":[[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"apiVersion:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"constraints.gatekeeper.sh/v1beta1\"}],\"\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"kind:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"K8sRequiredAnnotations\"}],\"\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"metadata:\"}],\"\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"name:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"require-team-annotation\"}],\"\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"spec:\"}],\"\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"match:\"}],\"\\n    \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"kinds:\"}],\"\\n      \",[\"$\",\"span\",null,{\"className\":\"hljs-bullet\",\"children\":\"-\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"apiGroups:\"}],\" [\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"\\\"\"}],\"]\\n        \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"kinds:\"}],\" [\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"Namespace\\\"\"}],\"]\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"Save this YAML to a file named \",[\"$\",\"code\",null,{\"children\":\"constraint.yaml\"}],\" and also apply it to your cluster:\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"kubectl apply -f constraint.yaml\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"Step III:\"}],\" Verify the policy\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"To verify that the policy is working, try creating a namespace without the team annotation. It should be denied.\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-yaml\",\"children\":[[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"apiVersion:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"v1\"}],\"\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"kind:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"Namespace\"}],\"\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"metadata:\"}],\"\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"name:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"demo-namespace\"}],\"\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"Save this YAML to a file named \",[\"$\",\"code\",null,{\"children\":\"demo-namespace.yaml\"}],\" and apply it:\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"kubectl apply -f demo-namespace.yaml\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"As expected, we get an error response:\\n\",[\"$\",\"img\",null,{\"src\":\"https://github.com/Permify/permify/assets/34595361/6c6fb7e9-5154-45ac-86fc-bbb8cfd94b05\",\"alt\":\"team_annot\"}]]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"Now let's comply with the policy by creating a namespace with the \",[\"$\",\"code\",null,{\"children\":\"team\"}],\" annotation.\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-yaml\",\"children\":[[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"apiVersion:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"v1\"}],\"\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"kind:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"Namespace\"}],\"\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"metadata:\"}],\"\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"name:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"test-namespace\"}],\"\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"annotations:\"}],\"\\n    \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"team:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"devops\\\"\"}],\"\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"Save the above YAML file as \",[\"$\",\"code\",null,{\"children\":\"test-namespace-with-annotation.yaml\"}],\" and apply it to the cluster.\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"This time, it creates the namespace successfully.\\n\",[\"$\",\"img\",null,{\"src\":\"https://github.com/Permify/permify/assets/34595361/0375c733-a4c0-4e47-b5a8-9acba6f6a338\",\"alt\":\"test_np_with_anot\"}]]}],\"\\n\",[\"$\",\"h3\",null,{\"id\":\"allocating-resources-quotas\",\"children\":\"2. Allocating resources quotas\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"Next, we want to write a bit more advanced policy that states that namespaces labelled with \",[\"$\",\"code\",null,{\"children\":\"env:production\"}],\" must have a resource quota applied to them.\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Such a policy can be helpful when you want to control or monitor usage of resources and make things more efficient. Let's get started.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"Step I:\"}],\" Create the constraint template file\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"This template will check if namespaces labeled with \",[\"$\",\"code\",null,{\"children\":\"env: production\"}],\" have a resource quota.\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-yaml\",\"children\":[[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"apiVersion:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"templates.gatekeeper.sh/v1beta1\"}],\"\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"kind:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"ConstraintTemplate\"}],\"\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"metadata:\"}],\"\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"name:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"k8srequiredresourcequotas\"}],\"\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"spec:\"}],\"\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"crd:\"}],\"\\n    \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"spec:\"}],\"\\n      \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"names:\"}],\"\\n        \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"kind:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"K8sRequiredResourceQuotas\"}],\"\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"targets:\"}],\"\\n    \",[\"$\",\"span\",null,{\"className\":\"hljs-bullet\",\"children\":\"-\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"target:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"admission.k8s.gatekeeper.sh\"}],\"\\n      \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"rego:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"|\\n        package k8srequiredresourcequotas\\n\"}],\"\\n        \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"violation[{\\\"msg\\\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"msg}]\"}],\" {\\n          \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"input.review.kind.kind\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"==\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"Namespace\\\"\"}],\"\\n          \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"namespace\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\":=\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"input.review.object\"}],\"\\n\\n          \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"some\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"label_key\"}],\"\\n          \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"namespace.metadata.labels\"}],\"[\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"label_key\"}],\"] \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"==\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"production\\\"\"}],\"\\n          \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"not\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"has_resource_quota(namespace.metadata.name)\"}],\"\\n\\n          \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"msg\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\":=\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"sprintf(\\\"Namespace\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"labeled\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"'env: production'\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"must\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"have\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"a\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"resource\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"quota\\\"\"}],\", []\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\")\"}],\"\\n        }\\n\\n        \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"has_resource_quota(namespace_name)\"}],\" {\\n          \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"some\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"i\"}],\"\\n          \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"input.review.context.related\"}],\"[\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"i\"}],\"]\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\".kind\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"==\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"ResourceQuota\\\"\"}],\"\\n          \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"input.review.context.related\"}],\"[\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"i\"}],\"]\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\".metadata.namespace\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"==\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"namespace_name\"}],\"\\n        }\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"Save this YAML to a file named \",[\"$\",\"code\",null,{\"children\":\"constrainttemplate.yaml\"}],\" and apply it to your cluster:\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"kubectl apply -f constrainttemplate.yaml\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"Step II:\"}],\" Create a constraint file\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-yaml\",\"children\":[[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"apiVersion:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"constraints.gatekeeper.sh/v1beta1\"}],\"\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"kind:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"K8sRequiredResourceQuotas\"}],\"\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"metadata:\"}],\"\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"name:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"require-resource-quota-for-production\"}],\"\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"spec:\"}],\"\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"match:\"}],\"\\n    \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"kinds:\"}],\"\\n      \",[\"$\",\"span\",null,{\"className\":\"hljs-bullet\",\"children\":\"-\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"apiGroups:\"}],\" [\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"\\\"\"}],\"]\\n        \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"kinds:\"}],\" [\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"Namespace\\\"\"}],\"]\\n\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"Save this YAML to a file named \",[\"$\",\"code\",null,{\"children\":\"constraint.yaml\"}],\" and apply it to your cluster:\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"kubectl apply -f constraint.yaml\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"Step III:\"}],\" Verify the policy\\nTo verify that the policy works, let's create a simple test namespace with the production label but without specifying any resource quotas. It should be rejected.\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-yaml\",\"children\":[[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"apiVersion:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"v1\"}],\"\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"kind:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"Namespace\"}],\"\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"metadata:\"}],\"\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"name:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"test-namespace-production-no-quota\"}],\"\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"labels:\"}],\"\\n    \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"env:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"production\"}],\"\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"Save this YAML to a file \",[\"$\",\"code\",null,{\"children\":\"test-namespace-production-no-quota.yaml\"}],\" and apply it:\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-yaml\",\"children\":[[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"kubectl\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"apply\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"-f\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"test-namespace-production-no-quota.yaml\"}],\"\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"As expected, we get an error response when we try to create a namespace, saying that we must assign a quota just like it is stated in our policy file:\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"img\",null,{\"src\":\"https://github.com/Permify/permify/assets/34595361/c52c8685-3925-47d8-80cc-9f12cddd00bf\",\"alt\":\"namespace_error\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Awesome. Let's go ahead and assign a quota for our namespace.\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-yaml\",\"children\":[[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"apiVersion:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"v1\"}],\"\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"kind:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"ResourceQuota\"}],\"\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"metadata:\"}],\"\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"name:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"resource-quota\"}],\"\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"namespace:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"default\"}],\"\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"spec:\"}],\"\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"hard:\"}],\"\\n    \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"requests.cpu:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"1\\\"\"}],\"\\n    \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"requests.memory:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"1Gi\"}],\"\\n    \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"limits.cpu:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"2\\\"\"}],\"\\n    \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"limits.memory:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"2Gi\"}],\"\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"Save this YAML to a file named \",[\"$\",\"code\",null,{\"children\":\"resource-quota.yaml\"}],\" and apply it:\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"kubectl apply -f resource-quota.yaml\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"img\",null,{\"src\":\"https://github.com/Permify/permify/assets/34595361/cd075440-698a-42f6-bc95-dbd5df76dd5a\",\"alt\":\"resource_quota_created\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"After applying as shown above, the namespace creation and quota application is successful.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"You can also go further to actually check the assigned quota for the namespace with the command:\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"kubectl get resourcequotas -n default\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Thus far, we have seen how OPA gatekeeper acts as middleman or interceptor whenever we want to perform specific actions in kubernetes.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Let's now move to the final part, which is creating our own custom validation webhook.\"}],\"\\n\",[\"$\",\"h3\",null,{\"id\":\"writing-a-custom-controller\",\"children\":\"3. Writing a custom controller\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"To begin, create and switch to a seperate folder specifically for this entire drill, you can call it \",[\"$\",\"code\",null,{\"children\":\"webhook_server.\"}]]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"1\"}],\". Start the Minikube cluster.\\n\",[\"$\",\"code\",null,{\"children\":\"minikube start\"}]]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"2\"}],\". Write the validating logic for the webhook. We'll write this in Python but it can also be written  in any other language of choice.\\nCreate a file \",[\"$\",\"code\",null,{\"children\":\"app.py\"}],\" and copy the following contents.\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-python\",\"children\":[[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"from\"}],\" flask \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"import\"}],\" Flask, request, jsonify\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"import\"}],\" logging\\n\\napp = Flask(__name__)\\nlogger = logging.getLogger(__name__)\\n\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-meta\",\"children\":[\"@app.route(\",[\"$\",\"span\",null,{\"className\":\"hljs-params\",\"children\":[[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"'/validate'\"}],\", methods=[\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"'POST'\"}],\"]\"]}],\")\"]}],\"\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"def\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-title function_\",\"children\":\"validate_pod\"}],\"():\\n    \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"try\"}],\":\\n        admission_review = request.get_json()\\n        pod_spec = admission_review[\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"'request'\"}],\"][\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"'object'\"}],\"][\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"'spec'\"}],\"]\\n        \\n        \",[\"$\",\"span\",null,{\"className\":\"hljs-comment\",\"children\":\"# Add your validation logic here\"}],\"\\n        \",[\"$\",\"span\",null,{\"className\":\"hljs-comment\",\"children\":\"# Example: Check if the pod has a specific label\"}],\"\\n        labels = pod_spec.get(\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"'labels'\"}],\", {})\\n        \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"if\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"'app'\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"not\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"in\"}],\" labels:\\n            logger.error(\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"Pod validation failed: Missing 'app' label\\\"\"}],\")\\n            \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"return\"}],\" jsonify({\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"response\\\"\"}],\": {\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"allowed\\\"\"}],\": \",[\"$\",\"span\",null,{\"className\":\"hljs-literal\",\"children\":\"False\"}],\", \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"status\\\"\"}],\": {\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"reason\\\"\"}],\": \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"MissingAppLabel\\\"\"}],\"}}}), \",[\"$\",\"span\",null,{\"className\":\"hljs-number\",\"children\":\"200\"}],\"\\n        \\n        \",[\"$\",\"span\",null,{\"className\":\"hljs-comment\",\"children\":\"# If all validation checks pass\"}],\"\\n        logger.info(\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"Pod validation succeeded\\\"\"}],\")\\n        \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"return\"}],\" jsonify({\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"response\\\"\"}],\": {\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"allowed\\\"\"}],\": \",[\"$\",\"span\",null,{\"className\":\"hljs-literal\",\"children\":\"True\"}],\"}}), \",[\"$\",\"span\",null,{\"className\":\"hljs-number\",\"children\":\"200\"}],\"\\n    \\n    \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"except\"}],\" Exception \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"as\"}],\" e:\\n        logger.exception(\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"An error occurred during pod validation\\\"\"}],\")\\n        \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"return\"}],\" jsonify({\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"response\\\"\"}],\": {\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"allowed\\\"\"}],\": \",[\"$\",\"span\",null,{\"className\":\"hljs-literal\",\"children\":\"False\"}],\", \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"status\\\"\"}],\": {\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"reason\\\"\"}],\": \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"InternalServerError\\\"\"}],\"}}}), \",[\"$\",\"span\",null,{\"className\":\"hljs-number\",\"children\":\"500\"}],\"\\n\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"if\"}],\" __name__ == \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"'__main__'\"}],\":\\n    \",[\"$\",\"span\",null,{\"className\":\"hljs-comment\",\"children\":\"# Configure logging\"}],\"\\n    logging.basicConfig(level=logging.INFO)\\n    \\n    \",[\"$\",\"span\",null,{\"className\":\"hljs-comment\",\"children\":\"# Start the Flask app\"}],\"\\n    app.run(host=\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"'0.0.0.0'\"}],\", port=\",[\"$\",\"span\",null,{\"className\":\"hljs-number\",\"children\":\"8080\"}],\", debug=\",[\"$\",\"span\",null,{\"className\":\"hljs-literal\",\"children\":\"False\"}],\")\\n\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"3.\"}],\" We need to containerize this webhook server, build and push it to a DockerHub repository.\\nI. Create a repository on your Dockerhub account.\\nII. Create a Dockerfile in the folder with the following contents:\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\" touch Dockerfile\"}]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-python\",\"children\":[\"FROM python:\",[\"$\",\"span\",null,{\"className\":\"hljs-number\",\"children\":\"3.9\"}],\"-slim\\n\\nWORKDIR /app\\n\\nCOPY requirements.txt .\\n\\nRUN pip install --no-cache-\",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"dir\"}],\" -r requirements.txt\\n\\nCOPY app.py .\\n\\nCMD [ \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"python\\\"\"}],\", \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"app.py\\\"\"}],\" ]\\n\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"III. Build the image\\n\",[\"$\",\"code\",null,{\"children\":\"docker build -t your-username/repository-name:latest .\"}]]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"IV. Push it to DockerHub\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\" docker login\"}]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-bash\",\"children\":\"docker tag \u003crepository-name\u003e:latest your-username/repository-name:latest\\ndocker push your-username/repository-name:latest\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Now, the image should be live on Dockerhub. This means we can now use it in our deployment yaml file.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"💡\",[\"$\",\"strong\",null,{\"children\":\"Troubleshooting tip:\"}],\" if you experience request denied errors while pushing your docker image to DockerHub, ensure to login to docker on terminal, double check for any typos or mismatch in the image name, repository name and tagname.\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"4\"}],\". Generate TLS Certificates. This helps to secure communication between our webhook server and kubernetes. It is a crucial step to pay attention to. If not properly configured, you might end up getting TLS errors down the line.\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-bash\",\"children\":[\"openssl req -x509 -newkey rsa:4096 -keyout server.key -out server.crt -days 365 -nodes -subj \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"/CN=pod-validation-webhook.default.svc\\\"\"}],\"\\n\"]}]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-bash\",\"children\":\"kubectl create secret tls pod-validation-webhook-tls --cert=server.crt --key=server.key -n default\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"5.\"}],\" Create the deployment YAML file.\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"touch webhook-deployment.yaml\"}]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-yaml\",\"children\":[[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"apiVersion:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"apps/v1\"}],\"\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"kind:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"Deployment\"}],\"\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"metadata:\"}],\"\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"name:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"pod-validation-webhook\"}],\"\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"namespace:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"default\"}],\"\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"spec:\"}],\"\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"replicas:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-number\",\"children\":\"1\"}],\"\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"selector:\"}],\"\\n    \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"matchLabels:\"}],\"\\n      \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"app:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"pod-validation-webhook\"}],\"\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"template:\"}],\"\\n    \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"metadata:\"}],\"\\n      \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"labels:\"}],\"\\n        \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"app:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"pod-validation-webhook\"}],\"\\n    \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"spec:\"}],\"\\n      \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"containers:\"}],\"\\n      \",[\"$\",\"span\",null,{\"className\":\"hljs-bullet\",\"children\":\"-\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"name:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"cweb\"}],\"\\n        \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"image:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"cannarron/cweb:latest\"}],\"\\n        \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"ports:\"}],\"\\n        \",[\"$\",\"span\",null,{\"className\":\"hljs-bullet\",\"children\":\"-\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"containerPort:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-number\",\"children\":\"8080\"}],\"\\n        \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"volumeMounts:\"}],\"\\n        \",[\"$\",\"span\",null,{\"className\":\"hljs-bullet\",\"children\":\"-\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"name:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"tls-certs\"}],\"\\n          \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"mountPath:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"/etc/webhook/certs\"}],\"\\n          \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"readOnly:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-literal\",\"children\":\"true\"}],\"\\n      \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"volumes:\"}],\"\\n      \",[\"$\",\"span\",null,{\"className\":\"hljs-bullet\",\"children\":\"-\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"name:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"tls-certs\"}],\"\\n        \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"secret:\"}],\"\\n          \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"secretName:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"pod-validation-webhook-tls\"}],\"\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"6.\"}],\" Create a service\\nWe need to create a kubectl service resource to point back to our Python webhook server\\n\",[\"$\",\"code\",null,{\"children\":\"touch webhook-service.yaml\"}]]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-yaml\",\"children\":[[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"apiVersion:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"v1\"}],\"\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"kind:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"Service\"}],\"\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"metadata:\"}],\"\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"name:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"pod-validation-webhook\"}],\"\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"spec:\"}],\"\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"selector:\"}],\"\\n    \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"app:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"pod-validation-webhook\"}],\"\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"ports:\"}],\"\\n    \",[\"$\",\"span\",null,{\"className\":\"hljs-bullet\",\"children\":\"-\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"protocol:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"TCP\"}],\"\\n      \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"port:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-number\",\"children\":\"8080\"}],\"\\n      \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"targetPort:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-number\",\"children\":\"8080\"}],\"\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"7.\"}],\" Create the validation configuration file.\\nThe validation configuration file is what officially registers our webhook as part of the kubernetes API. In other words, kubernetes will be aware that there's a new middleman that should be called whenever a pod creation request is sent.\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"touch validating-webhook-config.yaml\"}]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-yaml\",\"children\":[[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"apiVersion:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"admissionregistration.k8s.io/v1\"}],\"\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"kind:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"ValidatingWebhookConfiguration\"}],\"\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"metadata:\"}],\"\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"name:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"pod-validation-webhook\"}],\"\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"webhooks:\"}],\"\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-bullet\",\"children\":\"-\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"name:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"pod.validation.example.com\"}],\"\\n    \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"clientConfig:\"}],\"\\n      \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"service:\"}],\"\\n        \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"name:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"pod-validation-webhook\"}],\"\\n        \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"namespace:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"default\"}],\"\\n        \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"path:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"/validate\\\"\"}],\"\\n      \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"caBundle:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\u003cbase64\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"encoded\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"ca.crt\u003e\"}],\"\\n    \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"admissionReviewVersions:\"}],\"\\n      \",[\"$\",\"span\",null,{\"className\":\"hljs-bullet\",\"children\":\"-\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"v1\"}],\"\\n    \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"sideEffects:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"None\"}],\"\\n    \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"timeoutSeconds:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-number\",\"children\":\"5\"}],\"\\n    \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"failurePolicy:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"Fail\"}],\"\\n    \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"matchPolicy:\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"Equivalent\"}],\"\\n    \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"rules:\"}],\"\\n      \",[\"$\",\"span\",null,{\"className\":\"hljs-bullet\",\"children\":\"-\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"apiGroups:\"}],\" [\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"\\\"\"}],\"]\\n        \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"apiVersions:\"}],\" [\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"v1\\\"\"}],\"]\\n        \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"operations:\"}],\" [\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"CREATE\\\"\"}],\", \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"UPDATE\\\"\"}],\"]\\n        \",[\"$\",\"span\",null,{\"className\":\"hljs-attr\",\"children\":\"resources:\"}],\" [\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"pods\\\"\"}],\"]\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"8.\"}],\" Apply manifest files; Let's apply the deployment, service and validation configuration files YAML we have created in the earlier steps.\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-yaml\",\"children\":[[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"kubectl\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"apply\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"-f\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"webhook-deployment.yaml\"}],\"\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"kubectl\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"apply\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"-f\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"webhook-service.yaml\"}],\"\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"kubectl\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"apply\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"-f\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"validating-webhook-config.yaml\"}],\"\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"9.\"}],\" Verify.\\nFinally if the deployment goes well, then you should see the pod running successfully. And the validation webhook should be active as well\\nTo verify that our validation hook is now active, based on the validation rules set in the webhook, we simply create a test pod without a label which request should be denied.\"]}],\"\\n\",[\"$\",\"h2\",null,{\"id\":\"summary-and-conclusion\",\"children\":\"Summary and Conclusion\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"In this comprehensive guide, we have talked about using policies in kubernetes to extend its features and add custom enhancements or team preferences. We have also gone through step by step on implementing kubernetes policies with practical usecases.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Using policies in your kubernetes setup is a creative way to fully explore the capabilities within your containerized deployments and make it more secure.\"}]]}]}]]}]}]}]}]]}],null],\"segment\":\"__PAGE__?{\\\"slug\\\":\\\"opa-gatekeeper-kubernetes\\\"}\"},\"styles\":[]}],\"segment\":[\"slug\",\"opa-gatekeeper-kubernetes\",\"d\"]},\"styles\":[]}],\"segment\":\"post\"},\"styles\":[]}],\"segment\":\"(pages)\"},\"styles\":[]}],\"params\":{}}],null]}]]\n"])</script><script>self.__next_f.push([1,"7:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"1\",{\"children\":\"Opa Gatekeeper: How To Write Policies For Kubernetes Clusters\"}],[\"$\",\"meta\",\"2\",{\"name\":\"description\",\"content\":\"Learn how to leverage OPA Gatekeeper to write and enforce policies in Kubernetes clusters, ensuring security and efficient resource management in your environment.\"}],[\"$\",\"meta\",\"3\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"link\",\"4\",{\"rel\":\"canonical\",\"href\":\"https://permify.co/post/opa-gatekeeper-kubernetes/\"}],[\"$\",\"meta\",\"5\",{\"property\":\"og:title\",\"content\":\"Opa Gatekeeper: How To Write Policies For Kubernetes Clusters\"}],[\"$\",\"meta\",\"6\",{\"property\":\"og:description\",\"content\":\"Learn how to leverage OPA Gatekeeper to write and enforce policies in Kubernetes clusters, ensuring security and efficient resource management in your environment.\"}],[\"$\",\"meta\",\"7\",{\"property\":\"og:url\",\"content\":\"https://permify.co/post/opa-gatekeeper-kubernetes/\"}],[\"$\",\"meta\",\"8\",{\"property\":\"og:image\",\"content\":\"https://permify.co/images/blog/opa-gatekeeper-write-policies-kubernetes-clusters.png\"}],[\"$\",\"meta\",\"9\",{\"property\":\"og:image:alt\",\"content\":\"Opa Gatekeeper: How To Write Policies For Kubernetes Clusters\"}],[\"$\",\"meta\",\"10\",{\"property\":\"og:type\",\"content\":\"article\"}],[\"$\",\"meta\",\"11\",{\"name\":\"twitter:card\",\"content\":\"summary_large_image\"}],[\"$\",\"meta\",\"12\",{\"name\":\"twitter:title\",\"content\":\"Opa Gatekeeper: How To Write Policies For Kubernetes Clusters\"}],[\"$\",\"meta\",\"13\",{\"name\":\"twitter:description\",\"content\":\"Learn how to leverage OPA Gatekeeper to write and enforce policies in Kubernetes clusters, ensuring security and efficient resource management in your environment.\"}],[\"$\",\"meta\",\"14\",{\"name\":\"twitter:image\",\"content\":\"https://permify.co/images/blog/opa-gatekeeper-write-policies-kubernetes-clusters.png\"}],[\"$\",\"meta\",\"15\",{\"name\":\"twitter:image:alt\",\"content\":\"Opa Gatekeeper: How To Write Policies For Kubernetes Clusters\"}],[\"$\",\"link\",\"16\",{\"rel\":\"icon\",\"href\":\"/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"16x16\"}],[\"$\",\"meta\",\"17\",{\"name\":\"next-size-adjust\"}]]\n"])</script><script>self.__next_f.push([1,"d:null\n"])</script></body></html>