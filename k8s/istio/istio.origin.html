<!doctype html><html lang=en data-theme=dark><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=preload as=font type=font/woff2 href=https://a-cup-of.coffee/fonts/roboto-slab-latin-400.woff2 crossorigin=anonymous><link rel=preload as=font type=font/woff2 href=https://a-cup-of.coffee/fonts/roboto-slab-latin-700.woff2 crossorigin=anonymous><link rel=preload as=font type=font/woff2 href=https://a-cup-of.coffee/fonts/fira-code-latin-300.woff2 crossorigin=anonymous><link rel=preload as=font type=font/woff2 href=https://a-cup-of.coffee/fonts/fira-code-latin-400.woff2 crossorigin=anonymous><link rel=preload as=font type=font/woff2 href=https://a-cup-of.coffee/fonts/fira-code-latin-700.woff2 crossorigin=anonymous><meta name=robots content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>Istio from A to Y</title><meta name=description content="Istio is an open-source service mesh that allows you to connect, secure, control, and observe the services of an application. We will see how to install Istio, and how to use it to secure and monitor our services."><link rel=canonical href=https://a-cup-of.coffee/blog/istio/><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://a-cup-of.coffee/blog/istio/cover.png"><meta name=twitter:title content="Istio from A to Y"><meta name=twitter:description content="Istio is an open-source service mesh that allows you to connect, secure, control, and observe the services of an application. We will see how to install Istio, and how to use it to secure and monitor our services."><meta property="og:title" content="Istio from A to Y"><meta property="og:description" content="Istio is an open-source service mesh that allows you to connect, secure, control, and observe the services of an application. We will see how to install Istio, and how to use it to secure and monitor our services."><meta property="og:type" content="article"><meta property="og:url" content="https://a-cup-of.coffee/blog/istio/"><meta property="og:image" content="https://a-cup-of.coffee/blog/istio/cover.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2024-07-09T01:16:18+02:00"><meta property="article:modified_time" content="2024-07-18T17:55:15+02:00"><meta itemprop=name content="Istio from A to Y"><meta itemprop=description content="Istio is an open-source service mesh that allows you to connect, secure, control, and observe the services of an application. We will see how to install Istio, and how to use it to secure and monitor our services."><meta itemprop=datePublished content="2024-07-09T01:16:18+02:00"><meta itemprop=dateModified content="2024-07-18T17:55:15+02:00"><meta itemprop=wordCount content="10088"><meta itemprop=image content="https://a-cup-of.coffee/blog/istio/cover.png"><meta itemprop=keywords content="Kubernetes,Istio,Service Mesh,Envoy,Kiali,Grafana,Prometheus,"><style>@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:100;src:local("Roboto Slab Thin "),local("Roboto Slab-Thin"),url(/fonts/roboto-slab-latin-100.woff2) format("woff2"),url(/fonts/roboto-slab-latin-100.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:200;src:local("Roboto Slab Extra Light "),local("Roboto Slab-Extra Light"),url(/fonts/roboto-slab-latin-200.woff2) format("woff2"),url(/fonts/roboto-slab-latin-200.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:300;src:local("Roboto Slab Light "),local("Roboto Slab-Light"),url(/fonts/roboto-slab-latin-300.woff2) format("woff2"),url(/fonts/roboto-slab-latin-300.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:400;src:local("Roboto Slab Regular "),local("Roboto Slab-Regular"),url(/fonts/roboto-slab-latin-400.woff2) format("woff2"),url(/fonts/roboto-slab-latin-400.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:500;src:local("Roboto Slab Medium "),local("Roboto Slab-Medium"),url(/fonts/roboto-slab-latin-500.woff2) format("woff2"),url(/fonts/roboto-slab-latin-500.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:600;src:local("Roboto Slab SemiBold "),local("Roboto Slab-SemiBold"),url(/fonts/roboto-slab-latin-600.woff2) format("woff2"),url(/fonts/roboto-slab-latin-600.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:700;src:local("Roboto Slab Bold "),local("Roboto Slab-Bold"),url(/fonts/roboto-slab-latin-700.woff2) format("woff2"),url(/fonts/roboto-slab-latin-700.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:800;src:local("Roboto Slab ExtraBold "),local("Roboto Slab-ExtraBold"),url(/fonts/roboto-slab-latin-800.woff2) format("woff2"),url(/fonts/roboto-slab-latin-800.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:900;src:local("Roboto Slab Black "),local("Roboto Slab-Black"),url(/fonts/roboto-slab-latin-900.woff2) format("woff2"),url(/fonts/roboto-slab-latin-900.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:300;src:local("Fira Code Light "),local("Fira Code-Light"),url(/fonts/fira-code-latin-300.woff2) format("woff2"),url(/fonts/fira-code-latin-300.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:400;src:local("Fira Code Regular "),local("Fira Code-Regular"),url(/fonts/fira-code-latin-400.woff2) format("woff2"),url(/fonts/fira-code-latin-400.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:500;src:local("Fira Code Medium "),local("Fira Code-Medium"),url(/fonts/fira-code-latin-500.woff2) format("woff2"),url(/fonts/fira-code-latin-500.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:600;src:local("Fira Code SemiBold "),local("Fira Code-SemiBold"),url(/fonts/fira-code-latin-600.woff2) format("woff2"),url(/fonts/fira-code-latin-600.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:700;src:local("Fira Code Bold "),local("Fira Code-Bold"),url(/fonts/fira-code-latin-700.woff2) format("woff2"),url(/fonts/fira-code-latin-700.woff) format("woff")}

/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{-webkit-text-size-adjust:100%;line-height:1.15}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;-webkit-text-decoration:underline;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}[hidden],template{display:none}

/*! CC BY-SA 3.0 License | https://stackoverflow.com/a/36118384/1154965 */@keyframes blink{50%{opacity:0}to{opacity:1}}

/*! MIT License | github.com/schnerring/hugo-theme-gruvbox */:root[data-theme=light]{--bg:var(--bg0);--bg0:#fbf1c7;--bg0_h:#f9f5d7;--bg0_s:#f2e5bc;--bg1:#ebdbb2;--bg2:#d5c4a1;--bg3:#bdae93;--bg4:#a89984;--fg:var(--fg1);--fg0:#282828;--fg1:#3c3836;--fg2:#504945;--fg3:#665c54;--fg4:#7c6f64;--gray1:var(--fg4);--gray2:#928374;--red1:#cc241d;--red2:#9d0006;--green1:#98971a;--green2:#797403;--yellow1:#d79921;--yellow2:#b57614;--blue1:#458588;--blue2:#076678;--purple1:#b16286;--purple2:#8f3f71;--aqua1:#689d6a;--aqua2:#427b58;--orange1:#d65d0e;--orange2:#af3a03}[data-theme=light]:root .light--hidden{display:none}:root[data-theme=dark]{--bg:var(--bg0);--bg0:#282828;--bg0_h:#1d2021;--bg0_s:#32302f;--bg1:#3c3836;--bg2:#504945;--bg3:#665c54;--bg4:#7c6f64;--fg:var(--fg1);--fg0:#fbf1c7;--fg1:#ebdbb2;--fg2:#d5c4a1;--fg3:#bdae93;--fg4:#a89984;--gray1:var(--fg4);--gray2:#928374;--red1:#cc241d;--red2:#fb4934;--green1:#98971a;--green2:#b8bb26;--yellow1:#d79921;--yellow2:#fabd2f;--blue1:#458588;--blue2:#83a598;--purple1:#b16286;--purple2:#d3869b;--aqua1:#689d6a;--aqua2:#8ec07c;--orange1:#d65d0e;--orange2:#fe8019}[data-theme=dark]:root .dark--hidden{display:none}:root{--primary:var(--blue1);--primary-alt:var(--blue2);--font-monospace:"Fira Code","Lucida Console",Monaco,monospace;--font-sans-serif:Verdana,Helvetica,sans-serif;--font-serif:"Roboto Slab",Georgia,serif}html{font-family:Roboto Slab,Georgia,serif;font-family:var(--font-serif);font-size:1rem;scroll-behavior:smooth}body{word-wrap:break-word;background:var(--bg);color:var(--fg);line-height:1.675}strong{letter-spacing:.35px}a{color:inherit;-webkit-text-decoration:none;text-decoration:none}a.link--external:after{content:"\2009â"}img{border:2px solid var(--bg1);height:auto;max-width:100%}::-moz-selection{background:var(--bg4);color:var(--fg0)}::selection{background:var(--bg4);color:var(--fg0)}h1,h2,h3,h4,h5{color:var(--fg0);font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace);font-weight:300;line-height:1.4}h1 code,h2 code,h3 code,h4 code,h5 code{font-size:1em}h2,h3,h4,h5{border-bottom:1px solid var(--bg1)}h1,h2{font-weight:400}h1{font-size:1.875rem}h2{font-size:1.75rem}h3{font-size:1.625rem}@media (min-width:768px){h1{font-size:2.375rem}h2{font-size:2rem}h3{font-size:1.75rem}}h4{font-size:1.5rem}h5{font-size:1.375rem}table{border-collapse:collapse;margin:2rem 0;table-layout:fixed;width:100%}table,td,th{border:1px solid var(--bg1);padding:.5rem}hr{background:var(--bg1);border:none;height:1px;margin:3rem auto;width:80%}blockquote,code,pre{border-radius:.2rem;padding:0 .2em}pre code{padding:0}blockquote,code,pre,th{background:var(--bg1)}.notice blockquote,.notice p code,.notice ul li code{background:#3c3638;color:#f8f8f2}code,pre,th{font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace)}code code{background:var(--bg2)}blockquote,pre{padding:1rem}pre{background:var(--bg1)!important;overflow:auto}pre code{background:none}blockquote{border-left:5px solid var(--primary-alt);margin:.5rem 0}blockquote:not(.does-not-exist) code{background:var(--bg2)}blockquote:not(.does-not-exist) p:first-of-type{margin-top:0}blockquote:not(.does-not-exist) p:last-of-type{margin-bottom:0}pre::-webkit-scrollbar{height:.5rem;scrollbar-width:auto}pre::-webkit-scrollbar-track{background:var(--bg2);border-radius:.2rem}pre::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:.2rem}.layout{display:grid;grid-template-areas:"header" "main" "footer";grid-template-rows:auto 1fr auto;height:100vh}main{align-items:start;display:grid;grid-area:main;grid-template-areas:"empty content sidebar";grid-template-columns:1fr minmax(0,1000px) 4fr}header{background:var(--bg1);grid-area:header}footer{grid-area:footer}footer,main{margin:.5em 1.1em}.content{grid-area:content;width:100%}.sidebar{display:none;flex-direction:column;grid-area:sidebar;margin-top:3rem;position:sticky;top:2rem}@media (min-width:992px){.sidebar{display:flex}}header{display:grid;font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace);font-size:1.125rem;grid-template-areas:"heading search nav theme-toggle";grid-template-columns:auto auto 1fr auto;padding:.75rem}.logo{color:var(--fg0);display:flex;font-weight:700;grid-area:heading}.logo:hover .logo__cursor{animation:blink 1s infinite;opacity:1}.logo__chevron,.logo__cursor{margin-left:.5rem}.logo__cursor{opacity:0}.logo__text{display:none}@media (min-width:768px){.logo__text{display:block}}.search{display:flex;grid-area:search;margin:0 1rem}#search__text{background:var(--bg2);border:1px solid var(--bg2);border-radius:.2rem;caret-color:var(--fg);color:var(--fg);outline:none;padding:0 .5rem;width:100%}#search__text:hover{border-color:var(--bg3)}#search__text:focus{border-color:var(--bg4)}#search__text::-moz-placeholder{color:var(--fg3)}#search__text::placeholder{color:var(--fg3)}#search__text[type=search]::-webkit-search-cancel-button{-webkit-appearance:none;appearance:none}#search__suggestions{background:var(--bg);border-radius:.2rem;box-shadow:0 .5rem 1rem var(--bg1);font-family:Roboto Slab,Georgia,serif;font-family:var(--font-serif);left:0;margin-top:2rem;position:absolute;width:95vw;z-index:1000}@media (min-width:768px){.search{position:relative}#search__suggestions{width:60vw}}.search__suggestions--hidden{display:none}.search__suggestion-item{border-bottom:1px dashed var(--bg2);display:grid;grid-template-columns:1fr 2fr}.search__suggestion-item:focus,.search__suggestion-item:focus-visible,.search__suggestion-item:hover{background:var(--bg1);cursor:pointer;outline:none}.search__suggestion-item:last-child{border:none}.search__suggestion-description,.search__suggestion-title{margin:1rem 0;padding:0 1rem}.search__suggestion-title{font-weight:700}.search__suggestion-description{border-left:1px solid var(--bg2)}.search__no-results{padding:.75rem}.theme__toggle{align-items:center;background:none;border:none;color:var(--yellow1);cursor:pointer;display:flex;grid-area:theme-toggle;margin:0 1rem}.theme__toggle:hover{color:var(--yellow2)}.theme__toggle svg{height:28px;width:28px}nav#menu{align-items:center;display:flex;grid-area:nav;justify-content:flex-end}nav#menu .menu__item{color:var(--fg)}nav#menu .menu__item:hover{color:var(--fg3);cursor:pointer}nav#menu ul{list-style:none;margin:0;padding:0}nav#menu ul.menu--horizontal{align-items:center;display:none}nav#menu ul.menu--horizontal li{display:inline-block;margin:0 .75rem}@media (min-width:768px){nav#menu ul.menu--horizontal{display:flex}}nav#menu ul.menu--vertical{background:var(--fg0);bottom:0;margin:0;padding:3rem;position:fixed;right:0;top:0;transform:translate(100%);transition:transform .5s cubic-bezier(.9,0,.1,1);width:50%;z-index:10}nav#menu ul.menu--vertical .menu__item{color:var(--bg1)}nav#menu ul.menu--vertical .menu__item:hover{color:var(--bg4)}nav#menu .menu__burger{display:flex;height:24px;width:24px}nav#menu .menu__burger>*{position:absolute}nav#menu .menu__burger svg{height:inherit;width:inherit;z-index:20}nav#menu .menu__burger input{height:inherit;opacity:0;width:inherit;z-index:30}nav#menu .menu__burger input:checked~ul.menu--vertical{transform:none}nav#menu .menu__burger input:checked~svg{stroke:var(--bg1)}@media (min-width:768px){nav#menu .menu__burger{display:none}}.sidebar{font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace);margin-left:auto;margin-right:auto;max-width:350px;padding-left:2.5rem}.sidebar svg{fill:var(--fg)}.sidebar__heading{font-size:1.3rem}aside.toc a{color:var(--blue2);color:var(--primary-alt)}aside.toc a:hover{color:var(--blue1);color:var(--primary)}aside.toc ul{list-style:none;margin:0;padding:0}aside.toc ul ul{font-size:.9rem;margin-left:.5rem}aside.toc ul li{line-height:1.1}aside.toc ul li a{display:block;padding:.2rem 0}.jr-basics__image{background:var(--bg1);border:2px solid var(--bg2)}.jr-basics__summary{color:var(--fg3);font-family:Roboto Slab,Georgia,serif;font-family:var(--font-serif);margin:.75rem 0}.jr-basics__profile a:hover{color:var(--fg3)}.jr-basics__profile a:hover svg{fill:var(--fg3)}.content-section,.post{border-bottom:2px dotted var(--bg1);padding:2rem 0}.post img:not(figure img){box-sizing:border-box;margin:.5rem 0}.post-header{font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace)}.post-meta__author{font-weight:700}.post-content{margin:1.3rem 0}.post-content a,.post-header a{color:var(--blue2);color:var(--primary-alt)}.post-content a:hover,.post-header a:hover{color:var(--blue1);color:var(--primary)}.post-tags{align-items:center;display:flex;flex-wrap:wrap;gap:.9rem;margin:1rem 0}.post-tag{font-size:.9rem;line-height:1}.post-tag:before{content:"#"}.post-heading__anchor{display:none}h1:hover .post-heading__anchor,h2:hover .post-heading__anchor,h3:hover .post-heading__anchor,h4:hover .post-heading__anchor,h5:hover .post-heading__anchor{display:inline-block}.jr__item-meta{flex-direction:column}.jr-basics__image,.jr-basics__item,.jr-basics__profile-icon,.jr-basics__profile-item,.jr__item-meta{align-items:center;display:flex}.jr-basics__name,.jr-education__area,.jr-publications__name,.jr-volunteer__position,.jr-work__position{font-size:1.125rem;font-weight:700}.jr-basics__item{flex-direction:column;text-align:center}.jr-basics__item hr{margin:1.5rem auto}.jr-basics__image{border-radius:50%;height:250px;justify-content:center;overflow:hidden;width:250px}.jr-basics__label,.jr-basics__name,.jr-basics__summary{margin-top:.75rem}.jr-basics__profile svg{height:24px;width:24px}.jr-basics__profile,.jr-basics__profile-item{display:flex}.jr-basics__profile-item{display:flex;padding:.2rem}.jr-basics__profile--col{flex-direction:column}.jr-basics__profile--row{flex-wrap:wrap;justify-content:space-evenly}.jr-basics__profile-icon{padding:0 .75rem}.jr__item-meta{align-items:start;flex-flow:column;font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace)}@media (min-width:768px){.jr__item-meta{align-items:center;flex-flow:row wrap}.jr__date-range{width:90%}.jr-work__location,.jr__date,.jr__date-range{flex-grow:1;text-align:right}.jr-education__institution,.jr-publications__publisher,.jr-volunteer__organization{flex-basis:100%}}.social-share{align-items:center;border-top:2px dotted var(--bg1);display:flex;flex-wrap:wrap;gap:.9rem;margin:3rem 0;padding-top:3rem}.social-share svg{fill:var(--fg);height:24px;width:24px}.social-share svg.icon-tabler{fill:none;stroke:var(--fg)}.social-share__item{background:var(--bg1);display:flex;padding:.5rem}.button{--c:#b37b27;--_g:linear-gradient(var(--c) 0,var(--c) 0) no-repeat;background:linear-gradient(#b37b27,#b37b27 0) no-repeat -100% 0,linear-gradient(#b37b27,#b37b27 0) no-repeat 200% 0,linear-gradient(#b37b27,#b37b27 0) no-repeat -100% 100%,linear-gradient(#b37b27,#b37b27 0) no-repeat 200% 100%;background:linear-gradient(#b37b27 0 0) no-repeat -100% 0,linear-gradient(#b37b27 0 0) no-repeat 200% 0,linear-gradient(#b37b27 0 0) no-repeat -100% 100%,linear-gradient(#b37b27 0 0) no-repeat 200% 100%;background:var(--_g) calc(var(--_p, 0%) - 100%) 0,var(--_g) calc(200% - var(--_p, 0%)) 0,var(--_g) calc(var(--_p, 0%) - 100%) 100%,var(--_g) calc(200% - var(--_p, 0%)) 100%;background-size:50.5% .5%;background-size:50.5% calc(var(--_p, 0%)/2 + .5%);box-shadow:inset 0 0 0 .1em #b37b27;box-shadow:0 0 0 .1em inset var(--c);color:var(--fg);outline-offset:.1em;transition:background-size .4s,background-position 0s .4s}@supports (background:linear-gradient(red 0%,red 0% 1%,red 2%)) and (top:var(--f )){.button{--_g:linear-gradient(var(--c) 0 0) no-repeat}}.button:hover{--_p:100%;transition:background-position .4s,background-size 0s}.button:active{background-color:var(--c);box-shadow:inset 0 0 9000000000q rgba(0,0,0,.6);color:#fff}.button{border:none;cursor:pointer;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;font-size:2.8rem;font-weight:700;padding:.1em .6em}@media (min-width:768px){.content{width:100%}}:root[data-theme=dark] .invert-dark{filter:invert(1) hue-rotate(180deg)}</style><link rel=preload href="/css/non-critical.fab11ef2f6f58bdaed0c84bb5fab84627f0cb7b899af4dff365ee6c2ba5eaf48b088782e93bbbbae4214f0e5c789bd9963a6fa3fc3d240ef7b2a8f66abf4f79b.css" as=style onload='this.onload=null,this.rel="stylesheet"' integrity="sha512-+rEe8vb1i9rtDIS7X6uEYn8Mt7iZr03/Nl7mwrper0iwiHguk7u7rkIU8OXHib2ZY6b6P8PSQO97Ko9mq/T3mw=="><link id=prism-dark rel=preload href=https://a-cup-of.coffee/prism-themes/prism-gruvbox-dark.min.54aecc64074623a4f9898544dcbdab9e804f1560ef0b38f4cf8e10fcaaf72264e798cb407c601aca6ecd833ec4eb93d66535581f18d45ba202cf848b70dbc332.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity="sha512-VK7MZAdGI6T5iYVE3L2rnoBPFWDvCzj0z44Q/Kr3ImTnmMtAfGAaym7Ngz7E65PWZTVYHxjUW6ICz4SLcNvDMg=="><link id=prism-light rel=preload href=https://a-cup-of.coffee/prism-themes/prism-gruvbox-light.min.42a221741efe997fcc94187c39d63c555560678789ac9ca856c74a5f0ddb2aa6c50d38b2ffbecc7a99038cbbd2efa99746e862267f781c559e0cfec10b88a5fc.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity="sha512-QqIhdB7+mX/MlBh8OdY8VVVgZ4eJrJyoVsdKXw3bKqbFDTiy/77MepkDjLvS76mXRuhiJn94HFWeDP7BC4il/A==" disabled><noscript><link rel=stylesheet href=https://a-cup-of.coffee/prism-themes/prism-gruvbox-dark.min.54aecc64074623a4f9898544dcbdab9e804f1560ef0b38f4cf8e10fcaaf72264e798cb407c601aca6ecd833ec4eb93d66535581f18d45ba202cf848b70dbc332.css integrity="sha512-VK7MZAdGI6T5iYVE3L2rnoBPFWDvCzj0z44Q/Kr3ImTnmMtAfGAaym7Ngz7E65PWZTVYHxjUW6ICz4SLcNvDMg=="><link rel=stylesheet href="/css/non-critical.fab11ef2f6f58bdaed0c84bb5fab84627f0cb7b899af4dff365ee6c2ba5eaf48b088782e93bbbbae4214f0e5c789bd9963a6fa3fc3d240ef7b2a8f66abf4f79b.css" integrity="sha512-+rEe8vb1i9rtDIS7X6uEYn8Mt7iZr03/Nl7mwrper0iwiHguk7u7rkIU8OXHib2ZY6b6P8PSQO97Ko9mq/T3mw=="></noscript><script>(()=>{function n(){if(localStorage&&localStorage.getItem("theme"))return localStorage.getItem("theme");if(window.matchMedia)return window.matchMedia("(prefers-color-scheme: light)").matches?"light":"dark"}function e(e){document.documentElement.setAttribute("data-theme",e);let t=document.getElementById("prism-dark"),n=document.getElementById("prism-light");t.toggleAttribute("disabled",e==="light"),n.toggleAttribute("disabled",e==="dark"),localStorage.setItem("theme",e)}var t=n();t&&e(t);function s(t){let n=t.currentTarget.classList.contains("light--hidden")?"light":"dark";e(n)}document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll(".theme__toggle").forEach(e=>{e.addEventListener("click",s)})})})()</script><link rel=apple-touch-icon sizes=180x180 href=https://a-cup-of.coffee/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://a-cup-of.coffee/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://a-cup-of.coffee/favicon-16x16.png><link rel=manifest href=https://a-cup-of.coffee/site.webmanifest><link rel=mask-icon href=https://a-cup-of.coffee/safari-pinned-tab.svg color=#282828><meta name=msapplication-TileColor content="#282828"><meta name=theme-color content="#282828"></head><body><div class=layout><header><script>var _paq=window._paq=window._paq||[];_paq.push(["setDoNotTrack",!0]),_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){e="//mat.une-tasse-de.cafe/",_paq.push(["setTrackerUrl",e+"matomo.php"]),_paq.push(["setSiteId","4"]);var e,n=document,t=n.createElement("script"),s=n.getElementsByTagName("script")[0];t.async=!0,t.src=e+"matomo.js",s.parentNode.insertBefore(t,s)}()</script><noscript><p><img src="//mat.une-tasse-de.cafe/matomo.php?idsite=1&amp;rec=1" style=border:0 alt></p></noscript><a class=logo href=https://a-cup-of.coffee/><div class=logo__text>A cup of coffee</div><div class=logo__chevron>></div><div class=logo__cursor>â</div></a><div class=search><input id=search__text type=search placeholder=Search... aria-label=Search autocomplete=off><div id=search__suggestions class=search__suggestions--hidden></div></div><nav id=menu><ul class=menu--horizontal><li class=menu__item><a href=https://une-tasse-de.cafe>ð«ð·</a></li><li class=menu__item><a href=https://a-cup-of.coffee/index.xml>RSS</a></li><li class=menu__item><a href=https://a-cup-of.coffee/archives>Archives</a></li><li class=menu__item><a href=https://ko-fi.com/thebidouilleur>Support me â¤ï¸</a></li></ul><div class=menu__burger><input class=menu__item type=checkbox aria-label="Open main menu"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-menu-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 6h16"/><path d="M4 12h16"/><path d="M4 18h16"/></svg><ul class=menu--vertical><li><a class=menu__item href=https://une-tasse-de.cafe>ð«ð·</a></li><li><a class=menu__item href=https://a-cup-of.coffee/index.xml>RSS</a></li><li><a class=menu__item href=https://a-cup-of.coffee/archives>Archives</a></li><li><a class=menu__item href=https://ko-fi.com/thebidouilleur>Support me â¤ï¸</a></li></ul></div></nav><button class="theme__toggle light--hidden" aria-label="Toggle light mode"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-sun" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-4 0a4 4 0 108 0 4 4 0 10-8 0"/><path d="M3 12h1m8-9v1m8 8h1m-9 8v1M5.6 5.6l.7.7m12.1-.7-.7.7m0 11.4.7.7m-12.1-.7-.7.7"/></svg></button>
<button class="theme__toggle dark--hidden" aria-label="Toggle dark mode"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-moon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3c.132.0.263.0.393.0a7.5 7.5.0 007.92 12.446A9 9 0 1112 2.992z"/></svg></button></header><main><div class=content><article class=post><div class=post-header><h1>Istio from A to Y</h1><div class=post-meta><span>2024-07-09</span><span> by </span><span class=post-meta__author>Quentin JOLY</span><span> (updated: 2024-07-18)</span><div class=post-tags><a class=post-tag href=https://a-cup-of.coffee/tags/kubernetes>kubernetes</a><a class=post-tag href=https://a-cup-of.coffee/tags/istio>istio</a><a class=post-tag href=https://a-cup-of.coffee/tags/service-mesh>service&#8209;mesh</a><a class=post-tag href=https://a-cup-of.coffee/tags/envoy>envoy</a><a class=post-tag href=https://a-cup-of.coffee/tags/kiali>kiali</a><a class=post-tag href=https://a-cup-of.coffee/tags/grafana>grafana</a><a class=post-tag href=https://a-cup-of.coffee/tags/prometheus>prometheus</a></div><a href=https://a-cup-of.coffee/blog/istio/><img src=https://a-cup-of.coffee/blog/istio/cover.png alt="Article cover."></a></div></div><aside class=toc><nav><p class=sidebar__heading>Summary</p><nav id=TableOfContents><ul><li><a href=#what-is-a-service-mesh>What is a service mesh?</a></li><li><a href=#why-use-a-service-mesh>Why use a service mesh?</a></li><li><a href=#and-what-about-istio>And what about Istio?</a></li><li><a href=#my-lab-environment>My lab environment</a></li><li><a href=#installing-istioctl>Installing Istioctl</a></li><li><a href=#istio-profiles>Istio Profiles</a></li><li><a href=#installing-istio>Installing Istio</a></li><li><a href=#our-test-application-bookinfo>Our test application: Bookinfo</a></li><li><a href=#our-observability-suite>Our Observability Suite</a><ul><li><a href=#kiali>Kiali</a></li><li><a href=#jaeger--zipkin>Jaeger & Zipkin</a></li><li><a href=#prometheus--grafana>Prometheus & Grafana</a></li></ul></li><li><a href=#exposing-our-application>Exposing our application</a><ul><li><a href=#gateway>Gateway</a></li><li><a href=#version-management-with-destinationrules>Version Management with DestinationRules</a></li></ul></li><li><a href=#traffic-management-with-istio>Traffic Management with Istio</a><ul><li><a href=#traffic-shifting>Traffic-Shifting</a></li><li><a href=#ab-testing>A/B Testing</a></li><li><a href=#dark-launch-mirroring>Dark Launch (Mirroring)</a></li><li><a href=#fault-injection>Fault Injection</a><ul><li><a href=#delay-injection>Delay Injection</a></li></ul></li><li><a href=#circuit-breaker>Circuit Breaker</a></li></ul></li><li><a href=#security-in-istio>Security in Istio</a><ul><li><a href=#mtls>mTLS</a></li><li><a href=#acls>ACLs</a><ul><li><a href=#authentication-by-sa>Authentication by SA</a></li><li><a href=#jwt-authentication>JWT Authentication</a></li></ul></li><li><a href=#managing-external-access>Managing External Access</a></li></ul></li><li><a href=#tired-of-sidecars>Tired of sidecars?</a></li><li><a href=#performance-benchmark>Performance Benchmark</a><ul><li><a href=#http-benchmark>HTTP Benchmark</a><ul><li><a href=#without-istio>Without Istio</a></li><li><a href=#with-istio-sidecar>With Istio sidecar</a></li><li><a href=#with-istio-ambient>With Istio Ambient</a></li></ul></li><li><a href=#tcp-benchmark>TCP Benchmark</a></li></ul></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></nav></aside><hr><div class=post-content><p>When you start working with Kubernetes, you quickly realize that managing communications between services is not so simple. As soon as traffic passes through an ingress, the only thing you can do to observe what is happening is to check the pod logs, which is neither practical nor efficient.</p><p>This is why service meshes were created. They allow you to manage communications between services, secure and monitor exchanges, and control traffic. The goal of this page is to introduce you to Istio, an open-source service mesh.</p><p>Let&rsquo;s discover Istio together, how to install it, and how to use it with a good cup of coffee â.</p><p>But before we start, let&rsquo;s first explain what a service mesh is.</p><h1 id=what-is-a-service-mesh>What is a service mesh?<a href=#what-is-a-service-mesh class=post-heading__anchor aria-hidden=true>#</a></h1><p>A service mesh is an infrastructure layer that allows you to manage communications between the services of an application.</p><p>In short: the service mesh integrates into the infrastructure of an application composed of several sub-applications (microservices, for example) to add functionalities.</p><p>In a previous article, I presented <a href=https://a-cup-of.coffee/blog/consul/>Consul</a> which can be used as a service mesh with a sidecar based on <a href=https://www.envoyproxy.io/ class=link--external target=_blank rel=noreferrer>Envoy</a>.</p><img srcset=./_resources/ServiceMeshdrawio.drawio.png alt='Service Mesh avec Proxy' class=invert-dark><p>In the example above, each program needs to access another, the UI to authentication and the backend, the backend to storage and the queuing service, and finally: the consumers to the queuing service.</p><p>With this scheme, a few questions arise:</p><ul><li>How to allow/deny exchanges between two services?</li><li>How to secure exchanges between services?</li><li>What about observability?</li></ul><p>For example, if we want the UI to access the backend but not the storage, how do we do it? Or if we want the backend to access the storage but not the UI?</p><p>One possibility is to use NetworkPolicies if our CNI is capable, but this does not allow managing layer 7 interactions (HTTP, gRPC, etc.) <em>except with Cilium</em>. Specifically, I cannot limit access to a specific route (<code>/api</code>, <code>/endpoint/v3/ping</code>) or by request type (GET, POST, etc).</p><p>This is where a service mesh like Istio (or Consul) comes into play.</p><blockquote><p>How does a service mesh manage exchanges between services?</p></blockquote><p>A service mesh uses proxies to intercept requests between services. They act as intermediaries by adding a layer of control over communications.</p><p>It&rsquo;s a bit like a WAF (Web Application Firewall) for web applications. Each application will have its own &ldquo;router&rdquo; that will redirect incoming AND outgoing requests to the proxy of the destination service.</p><p>Thus, here is our diagram with a service mesh:</p><img srcset=./_resources/ServiceMeshdrawioEnvoy.drawio.png alt='Service Mesh avec Proxy' class=invert-dark><p>Each time the application tries to communicate with another service, the proxy intercepts the request and redirects it to the proxy of the destination service.</p><h1 id=why-use-a-service-mesh>Why use a service mesh?<a href=#why-use-a-service-mesh class=post-heading__anchor aria-hidden=true>#</a></h1><p>When you only have 2-3 applications, a service mesh may seem unnecessary. But as soon as you start having multiple services, multiple teams, multiple clusters, a service mesh quickly becomes practical.</p><p>You can allow different services to communicate with each other in a secure and controlled manner by trusting the identity of the services and not IP addresses or DNS names (which can be easily spoofed).</p><h1 id=and-what-about-istio>And what about Istio?<a href=#and-what-about-istio class=post-heading__anchor aria-hidden=true>#</a></h1><p>Istio can be used as a service mesh in a Kubernetes cluster. Indeed, it meets the needs mentioned above: securing exchanges, controlling traffic, and monitoring exchanges.</p><p>It is a completely open-source project that joined the CNCF (Cloud Native Computing Foundation) on September 30, 2022, and became an incubated project on July 12, 2023.</p><p>We will have the opportunity to talk more about Istio&rsquo;s architecture, its components, and its features later in this article.</p><h1 id=my-lab-environment>My lab environment<a href=#my-lab-environment class=post-heading__anchor aria-hidden=true>#</a></h1><p>For this lab, I used a Kubernetes cluster with 3 nodes (1 master, 2 workers) installed with Talos and <strong>Flannel</strong> as the CNI (usually, I prefer Cilium, but I had incompatibilities with a certain Istio feature that I will talk about later).</p><p>Here is the configuration used for my cluster with <a href=https://a-cup-of.coffee/blog/talos/#using-talhelper>talhelper</a>. Feel free to check out <a href=https://a-cup-of.coffee/blog/talos/>my article on Talos</a> for more information on its installation.</p><details><summary>Talhelper Configuration</summary><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>clusterName</span>: <span style=color:#ae81ff>istio-cluster</span>
</span></span><span style=display:flex><span><span style=color:#f92672>talosVersion</span>: <span style=color:#ae81ff>v1.7.4</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kubernetesVersion</span>: <span style=color:#ae81ff>v1.29.1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>endpoint</span>: <span style=color:#ae81ff>https://192.168.128.27:6443</span>
</span></span><span style=display:flex><span><span style=color:#f92672>allowSchedulingOnMasters</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span><span style=color:#f92672>cniConfig</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>flannel</span>
</span></span><span style=display:flex><span><span style=color:#f92672>patches</span>:
</span></span><span style=display:flex><span>  - |-<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - op: add
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      path: /cluster/discovery/enabled
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      value: false
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - op: replace
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      path: /machine/network/kubespan
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      value:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        enabled: false
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - op: add
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      path: /machine/kubelet/extraArgs
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      value:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        rotate-server-certificates: true
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - op: add
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      path: /machine/files
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      value:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      - content: |
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          [metrics]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            address = &#34;0.0.0.0:11234&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        path: /var/cri/conf.d/metrics.toml
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        op: create</span>    
</span></span><span style=display:flex><span><span style=color:#f92672>nodes</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>hostname</span>: <span style=color:#ae81ff>controlplane</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ipAddress</span>: <span style=color:#ae81ff>192.168.128.27</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>controlPlane</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>arch</span>: <span style=color:#ae81ff>amd64</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>installDisk</span>: <span style=color:#ae81ff>/dev/sda</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>hostname</span>: <span style=color:#ae81ff>worker-1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ipAddress</span>: <span style=color:#ae81ff>192.168.128.28</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>controlPlane</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>arch</span>: <span style=color:#ae81ff>amd64</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>installDisk</span>: <span style=color:#ae81ff>/dev/sda</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>hostname</span>: <span style=color:#ae81ff>worker-2</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ipAddress</span>: <span style=color:#ae81ff>192.168.128.30</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>controlPlane</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>arch</span>: <span style=color:#ae81ff>amd64</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>installDisk</span>: <span style=color:#ae81ff>/dev/sda</span>
</span></span><span style=display:flex><span><span style=color:#f92672>controlPlane</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>schematic</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>customization</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>systemExtensions</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>officialExtensions</span>:
</span></span><span style=display:flex><span>         - <span style=color:#ae81ff>siderolabs/qemu-guest-agent</span>
</span></span><span style=display:flex><span>         - <span style=color:#ae81ff>siderolabs/iscsi-tools</span>
</span></span><span style=display:flex><span><span style=color:#f92672>worker</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>schematic</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>customization</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>systemExtensions</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>officialExtensions</span>:
</span></span><span style=display:flex><span>         - <span style=color:#ae81ff>siderolabs/qemu-guest-agent</span>
</span></span><span style=display:flex><span>         - <span style=color:#ae81ff>siderolabs/iscsi-tools</span>
</span></span></code></pre></div></details><p>We will also need a metrics-server for Istio&rsquo;s HPAs (Horizontal Pod Autoscaler) to function correctly. For this, I have deployed the following manifests to respectively deploy the metrics-server and the certificates-approver for the kubelet.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ae81ff>kubectl apply -f https://raw.githubusercontent.com/alex1989hu/kubelet-serving-cert-approver/main/deploy/standalone-install.yaml</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml</span>
</span></span></code></pre></div><p><em>As always, be cautious of manifests applied directly from the Internet and make sure to read them before applying.</em></p><h1 id=installing-istioctl>Installing Istioctl<a href=#installing-istioctl class=post-heading__anchor aria-hidden=true>#</a></h1><p>Istioctl is the command-line tool for managing Istio. It allows you to deploy, verify the status of components, inject sidecars by manifest, and more.</p><p>The simplest way to install Istioctl is to use the script provided by Istio (which will download the latest version) or to directly retrieve the binary from the <a href=https://github.com/istio/istio/releases/ class=link--external target=_blank rel=noreferrer>Istio release page</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -L https://istio.io/downloadIstio | sh -
</span></span></code></pre></div><style type=text/css>.notice{--root-color:#444;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#c33;--warning-content:#fee;--info-title:#fb7;--info-content:#fec;--note-title:#6be;--note-content:#e7f2fa;--tip-title:#5a5;--tip-content:#efe}@media(prefers-color-scheme:dark){.notice{--root-color:#ddd;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#800;--warning-content:#400;--info-title:#a50;--info-content:#420;--note-title:#069;--note-content:#023;--tip-title:#363;--tip-content:#121}}body.dark .notice{--root-color:#ddd;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#800;--warning-content:#400;--info-title:#a50;--info-content:#420;--note-title:#069;--note-content:#023;--tip-title:#363;--tip-content:#121}.notice{padding:18px;line-height:24px;margin-bottom:24px;border-radius:4px;color:var(--root-color);background:var(--root-background)}.notice p:last-child{margin-bottom:0}.notice-title{margin:-18px -18px 12px;padding:4px 18px;border-radius:4px 4px 0 0;font-weight:700;color:var(--title-color);background:var(--title-background)}.notice.warning .notice-title{background:var(--warning-title)}.notice.warning{background:var(--warning-content)}.notice.info .notice-title{background:var(--info-title)}.notice.info{background:var(--info-content)}.notice.note .notice-title{background:var(--note-title)}.notice.note{background:var(--note-content)}.notice.tip .notice-title{background:var(--tip-title)}.notice.tip{background:var(--tip-content)}.icon-notice{display:inline-flex;align-self:center;margin-right:8px}.icon-notice img,.icon-notice svg{height:1em;width:1em;fill:currentColor}.icon-notice img,.icon-notice.baseline svg{top:.125em;position:relative}</style><div class="notice tip"><p class=notice-title><span class="icon-notice baseline"><svg xmlns="http://www.w3.org/2000/svg" viewBox="300.5 134 300 300"><path d="M551.281 252.36c0-3.32-1.172-6.641-3.515-8.985l-17.774-17.578c-2.344-2.344-5.469-3.711-8.789-3.711-3.32.0-6.445 1.367-8.789 3.71l-79.687 79.493-44.141-44.14c-2.344-2.344-5.469-3.712-8.79-3.712-3.32.0-6.444 1.368-8.788 3.711l-17.774 17.579c-2.343 2.343-3.515 5.664-3.515 8.984s1.172 6.445 3.515 8.789l70.704 70.703c2.343 2.344 5.664 3.711 8.789 3.711 3.32.0 6.64-1.367 8.984-3.71l106.055-106.056c2.343-2.343 3.515-5.468 3.515-8.789zM600.5 284c0 82.813-67.188 150-150 150-82.813.0-150-67.188-150-150 0-82.813 67.188-150 150-150 82.813.0 150 67.188 150 150z"/></svg></span>Tip</p><p>It is possible to specify the version to install by using the <code>ISTIO_VERSION</code> environment variable and the target architecture with <code>TARGET_ARCH</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -L https://istio.io/downloadIstio | ISTIO_VERSION<span style=color:#f92672>=</span>1.22.0 TARGET_ARCH<span style=color:#f92672>=</span>x86_64 sh -
</span></span></code></pre></div></div><p><em>Of course, try to avoid downloading scripts and running them without reading them. Another solution is to download the binary itself.</em></p><p>A <a href="https://search.nixos.org/packages?channel=24.05&amp;show=istioctl&amp;from=0&amp;size=50&amp;sort=relevance&amp;type=packages&amp;query=istioctl" class=link--external target=_blank rel=noreferrer>NixOS</a> package is also available to install Istioctl.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nix-env -iA nixpkgs.istioctl <span style=color:#75715e># via nixpkgs</span>
</span></span><span style=display:flex><span>nix-env -iA nixos.istioctl <span style=color:#75715e># via nixos</span>
</span></span></code></pre></div><p>We now have everything needed to install Istio on our Kubernetes cluster.</p><h1 id=istio-profiles>Istio Profiles<a href=#istio-profiles class=post-heading__anchor aria-hidden=true>#</a></h1><p>Before installing Istio on our cluster, it&rsquo;s important to choose a profile. A profile is a pre-defined Istio configuration that will determine the components to install, the default configurations, and the enabled features.</p><p>There are several Istio profiles, each with its own characteristics:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ istioctl profile list
</span></span><span style=display:flex><span>Istio configuration profiles:
</span></span><span style=display:flex><span>    ambient
</span></span><span style=display:flex><span>    default
</span></span><span style=display:flex><span>    demo
</span></span><span style=display:flex><span>    empty
</span></span><span style=display:flex><span>    minimal
</span></span><span style=display:flex><span>    openshift
</span></span><span style=display:flex><span>    openshift-ambient
</span></span><span style=display:flex><span>    preview
</span></span><span style=display:flex><span>    remote
</span></span><span style=display:flex><span>    stable
</span></span></code></pre></div><p>To view the configuration of a profile, you can use the command <code>istioctl profile dump &lt;profile></code>.</p><p>For example, the configuration of the <code>default</code> profile is visible with the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>istioctl profile dump default
</span></span></code></pre></div><p>Here is its value :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>install.istio.io/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>IstioOperator</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>components</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>base</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>egressGateways</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>istio-egressgateway</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ingressGateways</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>istio-ingressgateway</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>pilot</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hub</span>: <span style=color:#ae81ff>docker.io/istio</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>profile</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tag</span>: <span style=color:#ae81ff>1.22.1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>values</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>defaultRevision</span>: <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>gateways</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>istio-egressgateway</span>: {}
</span></span><span style=display:flex><span>      <span style=color:#f92672>istio-ingressgateway</span>: {}
</span></span><span style=display:flex><span>    <span style=color:#f92672>global</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>configValidation</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>istioNamespace</span>: <span style=color:#ae81ff>istio-system</span>
</span></span></code></pre></div><hr><p>To compare two profiles, you can use the command <code>istioctl profile diff &lt;profile1> &lt;profile2></code>.</p><p>To compare the <code>default</code> and <code>demo</code> profiles, you can use the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>istioctl profile diff default demo
</span></span></code></pre></div><p>This will display the differences between the two profiles:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span> <span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>install.istio.io/v1alpha1</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>IstioOperator</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>   <span style=color:#f92672>creationTimestamp</span>: <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>istio-system</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>   <span style=color:#f92672>components</span>:
</span></span><span style=display:flex><span>     <span style=color:#f92672>base</span>:
</span></span><span style=display:flex><span>       <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>     <span style=color:#f92672>egressGateways</span>:
</span></span><span style=display:flex><span>-    - <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+    - enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>       <span style=color:#f92672>name</span>: <span style=color:#ae81ff>istio-egressgateway</span>
</span></span><span style=display:flex><span>     <span style=color:#f92672>ingressGateways</span>:
</span></span><span style=display:flex><span>     - <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>       <span style=color:#f92672>name</span>: <span style=color:#ae81ff>istio-ingressgateway</span>
</span></span><span style=display:flex><span>     <span style=color:#f92672>pilot</span>:
</span></span><span style=display:flex><span>       <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>hub</span>: <span style=color:#ae81ff>docker.io/istio</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>profile</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>tag</span>: <span style=color:#ae81ff>1.22.1</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>values</span>:
</span></span><span style=display:flex><span>     <span style=color:#f92672>defaultRevision</span>: <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>     <span style=color:#f92672>gateways</span>:
</span></span><span style=display:flex><span>       <span style=color:#f92672>istio-egressgateway</span>: {}
</span></span><span style=display:flex><span>       <span style=color:#f92672>istio-ingressgateway</span>: {}
</span></span><span style=display:flex><span>     <span style=color:#f92672>global</span>:
</span></span><span style=display:flex><span>       <span style=color:#f92672>configValidation</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>       <span style=color:#f92672>istioNamespace</span>: <span style=color:#ae81ff>istio-system</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+    profile</span>: <span style=color:#ae81ff>demo</span>
</span></span></code></pre></div><p>It is possible to customize a profile by reusing an existing one with the command <code>istioctl profile dump &lt;profile> > myprofile.yaml</code> and modifying the <code>myprofile.yaml</code> file to add or remove components.</p><hr><p>In this lab, we will primarily use the <code>demo</code> profile, which is a complete profile with all stable Istio features enabled.</p><h1 id=installing-istio>Installing Istio<a href=#installing-istio class=post-heading__anchor aria-hidden=true>#</a></h1><p>To install Istio on our Kubernetes cluster, we will use the <code>istioctl install</code> command followed by a profile or a configuration file.</p><ul><li>To use a profile :</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>istioctl install --set profile<span style=color:#f92672>=</span>demo 
</span></span></code></pre></div><ul><li>To use a configuration file :</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>istioctl install -f myprofile.yaml
</span></span></code></pre></div><p>The chosen profile will generate the necessary manifests to install Istio and configure it according to the profile specifications (<a href=https://istio.io/latest/docs/setup/install/helm/ class=link--external target=_blank rel=noreferrer>it is also possible to use Helm, but this method does not seem to be the most recommended</a>).</p><blockquote><p>Is that all?</p></blockquote><p>Well, yes. Istio will then be installed on the Kubernetes cluster by creating a <code>istio-system</code> namespace and deploying the necessary components.</p><p><strong>But</strong>, it is not yet effective and no proxy has been injected into the pods. For this, we need to enable automatic Istio injection in the desired namespace. We&rsquo;ll talk about this a little later.</p><h1 id=our-test-application-bookinfo>Our test application: Bookinfo<a href=#our-test-application-bookinfo class=post-heading__anchor aria-hidden=true>#</a></h1><p>We will use the &ldquo;Bookinfo&rdquo; test application provided by Istio. It is an application composed of several microservices that will be a good example to test this service mesh.</p><p><img src=https://a-cup-of.coffee/blog/istio/_resources/bookinfo.png alt="Test app"></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl apply -n default -f https://raw.githubusercontent.com/istio/istio/release-1.22/samples/bookinfo/platform/kube/bookinfo.yaml
</span></span></code></pre></div><p>The Bookinfo application is now deployed on our Kubernetes cluster. We can check what has been deployed with the command <code>kubectl get-all -n default</code> <em>(krew plugin)</em>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get-all -n default
</span></span><span style=display:flex><span>NAME                                                                        NAMESPACE  AGE
</span></span><span style=display:flex><span>serviceaccount/bookinfo-details                                             default    4m15s
</span></span><span style=display:flex><span>serviceaccount/bookinfo-productpage                                         default    4m9s
</span></span><span style=display:flex><span>serviceaccount/bookinfo-ratings                                             default    4m14s
</span></span><span style=display:flex><span>serviceaccount/bookinfo-reviews                                             default    4m12s
</span></span><span style=display:flex><span>service/details                                                             default    4m15s
</span></span><span style=display:flex><span>service/kubernetes                                                          default    15h
</span></span><span style=display:flex><span>service/productpage                                                         default    4m10s
</span></span><span style=display:flex><span>service/ratings                                                             default    4m14s
</span></span><span style=display:flex><span>service/reviews                                                             default    4m13s
</span></span><span style=display:flex><span>deployment.apps/details-v1                                                  default    4m14s
</span></span><span style=display:flex><span>deployment.apps/productpage-v1                                              default    4m8s
</span></span><span style=display:flex><span>deployment.apps/ratings-v1                                                  default    4m13s
</span></span><span style=display:flex><span>deployment.apps/reviews-v1                                                  default    4m11s
</span></span><span style=display:flex><span>deployment.apps/reviews-v2                                                  default    4m11s
</span></span><span style=display:flex><span>deployment.apps/reviews-v3                                                  default    4m11s
</span></span></code></pre></div><p>Let&rsquo;s now try to access the Bookinfo application. To do this, we will use a port-forward to access it from our local machine.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl port-forward svc/productpage 9080:9080 -n default
</span></span></code></pre></div><p>Next, open a browser and access the URL <code>http://localhost:9080/productpage</code>.</p><p><img src=https://a-cup-of.coffee/blog/istio/_resources/index_bookinfo.png alt="Index page"></p><p>By clicking the &ldquo;Normal user&rdquo; button, a page similar to this one should appear:</p><p><img src=https://a-cup-of.coffee/blog/istio/_resources/55139e6424e5d54bbd7ea49327ae4492.png alt="Bookinfo sample"></p><blockquote><p>But, concretely, what does the Bookinfo application do? In what case is each microservice used?</p></blockquote><p>We have 4 microservices in the Bookinfo application:</p><ul><li><strong>productpage</strong> : the application&rsquo;s frontend service. It calls the details and reviews services to display the page content.</li><li><strong>details</strong> : the service that contains the book details. It does not call any other service.</li><li><strong>reviews</strong> : the service that contains the book reviews. It calls the ratings service to get the ratings.</li><li><strong>ratings</strong> : the service that contains the review ratings. It does not call any other service.</li></ul><p><img src=https://a-cup-of.coffee/blog/istio/_resources/services-on-bookinfo.png alt="Services on bookinfo"></p><p>By refreshing the page several times, we can see that the &ldquo;Reviews&rdquo; change depending on the version of the &ldquo;reviews&rdquo; service used. In fact, there are 3 versions:</p><ul><li><strong>Version 1</strong> : no ratings.</li></ul><p><img src=https://a-cup-of.coffee/blog/istio/_resources/v1.png alt="alt text"></p><ul><li><strong>Version 2</strong> : ratings with black stars.</li></ul><p><img src=https://a-cup-of.coffee/blog/istio/_resources/v2.png alt="alt text"></p><ul><li><strong>Version 3</strong> : ratings with red stars.</li></ul><p><img src=https://a-cup-of.coffee/blog/istio/_resources/v3.png alt="alt text"></p><p>So, how is the distribution of &ldquo;reviews&rdquo; versions managed?
It is done through the Kubernetes service (with a ClusterIP type service) which will redirect requests in &ldquo;round-robin&rdquo; mode to the pods of the &ldquo;reviews&rdquo; service.</p><hr><p>Now, we will enable the injection of Istio sidecars. This can be done in 3 ways:</p><ul><li>By injecting a label into the pod created by the deployment:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl patch deployment -n default productpage-v1 -p <span style=color:#e6db74>&#39;{&#34;spec&#34;: {&#34;template&#34;: {&#34;metadata&#34;: {&#34;labels&#34;: {&#34;sidecar.istio.io/inject&#34;: &#34;true&#34;}}}}}&#39;</span>
</span></span></code></pre></div><ul><li>By patching the manifest before deploying it (with <code>istioctl kube-inject</code>, which will add the sidecars to the manifest):</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wget https://raw.githubusercontent.com/istio/istio/release-1.22/samples/bookinfo/platform/kube/bookinfo.yaml
</span></span><span style=display:flex><span>istioctl kube-inject -f bookinfo.yaml | kubectl apply -n default -f -
</span></span></code></pre></div><ul><li>By enabling automatic injection in the namespace and redeploying the pods:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl label namespace default istio-injection<span style=color:#f92672>=</span>enabled
</span></span><span style=display:flex><span>kubectl rollout restart deployment -n default details-v1 productpage-v1 ratings-v1 reviews-v1 reviews-v2 reviews-v3 
</span></span></code></pre></div><hr><p>Regardless of the option chosen, Istio sidecars will be injected into the pods of the Bookinfo application. You can verify that the sidecars have been injected with the command <code>kubectl get pods -n default</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get pods
</span></span><span style=display:flex><span>NAME                              READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>details-v1-64b7b7dd99-ctqd4       2/2     Running   <span style=color:#ae81ff>0</span>          118s
</span></span><span style=display:flex><span>productpage-v1-6bc7f5c4c6-tsxdt   2/2     Running   <span style=color:#ae81ff>0</span>          114s
</span></span><span style=display:flex><span>ratings-v1-c54575675-cq8bv        2/2     Running   <span style=color:#ae81ff>0</span>          118s
</span></span><span style=display:flex><span>reviews-v1-76bf7c9d86-zbvts       2/2     Running   <span style=color:#ae81ff>0</span>          117s
</span></span><span style=display:flex><span>reviews-v2-bb7869c75-n7rb5        2/2     Running   <span style=color:#ae81ff>0</span>          116s
</span></span><span style=display:flex><span>reviews-v3-5f978f677b-2bqw5       2/2     Running   <span style=color:#ae81ff>0</span>          116s
</span></span></code></pre></div><p>Each pod now has an Istio sidecar âµ that will intercept incoming and outgoing requests.</p><p>To get more information about this, it is possible to use the <code>istioctl analyze</code> and <code>istioctl proxy-status</code> commands, which will respectively check if the Istio configuration is correct and if the proxies are active.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ istioctl analyze
</span></span><span style=display:flex><span>â No validation issues found when analyzing namespace: default.
</span></span><span style=display:flex><span>$ istioctl proxy-status     
</span></span><span style=display:flex><span>NAME                                                   CLUSTER        CDS        LDS        EDS        RDS          ECDS         ISTIOD                      VERSION
</span></span><span style=display:flex><span>details-v1-7b6fb77db6-bwv5b.default                    Kubernetes     SYNCED     SYNCED     SYNCED     SYNCED       NOT SENT     istiod-8596844f7d-z5rgl     1.21.0
</span></span><span style=display:flex><span>istio-egressgateway-b569895b5-ppk8f.istio-system       Kubernetes     SYNCED     SYNCED     SYNCED     NOT SENT     NOT SENT     istiod-8596844f7d-z5rgl     1.21.0
</span></span><span style=display:flex><span>istio-ingressgateway-694c4b4d85-78f95.istio-system     Kubernetes     SYNCED     SYNCED     SYNCED     NOT SENT     NOT SENT     istiod-8596844f7d-z5rgl     1.21.0
</span></span><span style=display:flex><span>productpage-v1-68dfd95669-qr69h.default                Kubernetes     SYNCED     SYNCED     SYNCED     SYNCED       NOT SENT     istiod-8596844f7d-z5rgl     1.21.0
</span></span><span style=display:flex><span>ratings-v1-6b47557bbb-cr6k9.default                    Kubernetes     SYNCED     SYNCED     SYNCED     SYNCED       NOT SENT     istiod-8596844f7d-z5rgl     1.21.0
</span></span><span style=display:flex><span>reviews-v1-dd46dd5f-dkkkb.default                      Kubernetes     SYNCED     SYNCED     SYNCED     SYNCED       NOT SENT     istiod-8596844f7d-z5rgl     1.21.0
</span></span><span style=display:flex><span>reviews-v2-5b65c4bdb-76pd4.default                     Kubernetes     SYNCED     SYNCED     SYNCED     SYNCED       NOT SENT     istiod-8596844f7d-z5rgl     1.21.0
</span></span><span style=display:flex><span>reviews-v3-685dd59d69-tmzlf.default                    Kubernetes     SYNCED     SYNCED     SYNCED     SYNCED       NOT SENT     istiod-8596844f7d-z5rgl     1.21.0
</span></span></code></pre></div><p><em>Do not pay attention to the <code>istio-egressgateway</code> and <code>istio-ingressgateway</code> pods, they are not related to the Bookinfo application.</em></p><p>But before we go further, let&rsquo;s arm ourselves with some tools to facilitate our work with Istio.</p><h1 id=our-observability-suite>Our Observability Suite<a href=#our-observability-suite class=post-heading__anchor aria-hidden=true>#</a></h1><p>Istio is quite unforgiving for those who refuse to equip themselves sufficiently. So, we&rsquo;re going to discover some tools that will help us understand what&rsquo;s happening in our cluster.</p><h2 id=kiali>Kiali<a href=#kiali class=post-heading__anchor aria-hidden=true>#</a></h2><p>This tool is <strong>essential</strong> for visualizing the exchanges between pods and it directly interfaces with Istio to retrieve proxy data. It will be our primary tool for verifying the proper functioning of our applications.</p><p>It is capable of:</p><ul><li>Visualizing services and the exchanges between them.</li><li>Verifying/Modifying our Istio configuration.</li><li>Having metrics on services.</li></ul><p>It&rsquo;s a real Swiss Army knife for Istio.</p><p>To install Kiali, we can use the manifest present in the Istio repository. After deploying it, we can access the Kiali web interface using a port-forward.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/istio/istio/master/samples/addons/kiali.yaml
</span></span><span style=display:flex><span>istioctl dashboard kiali
</span></span></code></pre></div><p><em>Note : <code>istioctl dashboard kiali</code> permet simplement de faire un port-forward vers le service Kiali, vous pouvez aussi utiliser <code>kubectl port-forward svc/kiali 20001:20001 -n istio-system</code>.</em></p><div class="notice tip"><p class=notice-title><span class="icon-notice baseline"><svg xmlns="http://www.w3.org/2000/svg" viewBox="300.5 134 300 300"><path d="M551.281 252.36c0-3.32-1.172-6.641-3.515-8.985l-17.774-17.578c-2.344-2.344-5.469-3.711-8.789-3.711-3.32.0-6.445 1.367-8.789 3.71l-79.687 79.493-44.141-44.14c-2.344-2.344-5.469-3.712-8.79-3.712-3.32.0-6.444 1.368-8.788 3.711l-17.774 17.579c-2.343 2.343-3.515 5.664-3.515 8.984s1.172 6.445 3.515 8.789l70.704 70.703c2.343 2.344 5.664 3.711 8.789 3.711 3.32.0 6.64-1.367 8.984-3.71l106.055-106.056c2.343-2.343 3.515-5.468 3.515-8.789zM600.5 284c0 82.813-67.188 150-150 150-82.813.0-150-67.188-150-150 0-82.813 67.188-150 150-150 82.813.0 150 67.188 150 150z"/></svg></span>Tip</p><p>Note that the manifest only deploys a demo version of Kiali (without authentication), for production use, I recommend consulting the <a href=https://kiali.io/docs/installation/ class=link--external target=_blank rel=noreferrer>official documentation</a> to configure Kiali in a more sustainable and tailored way to your needs.</p></div><p>Let&rsquo;s generate some traffic to see what Kiali can show us.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl port-forward -n default svc/productpage 9080:9080 &gt;/dev/null &amp;
</span></span><span style=display:flex><span>watch -n <span style=color:#ae81ff>1</span> curl -s http://localhost:9080/productpage -I
</span></span></code></pre></div><p>In the &ldquo;Traffic Graph&rdquo; section, we can see the exchanges between services (the &ldquo;ratings&rdquo; service is missing, but that&rsquo;s normal).</p><p><img src=https://a-cup-of.coffee/blog/istio/_resources/kiali-b4-vs.png alt="Kiali b4 VS"></p><p>This page will likely be the one you&rsquo;ll consult most often for debugging your applications. I&rsquo;ll refer to it extensively in the rest of this article.</p><h2 id=jaeger--zipkin>Jaeger & Zipkin<a href=#jaeger--zipkin class=post-heading__anchor aria-hidden=true>#</a></h2><p>Zipkin and Jaeger are tracing tools that allow you to track the path of a request through the various services. They allow you to see the response time of each service, errors, and the delay of interactions.</p><p>This is comparable to OpenTelemetry (which I have not been able to test yet) and is very useful for understanding the performance of your applications and seeing which service is the bottleneck in them.</p><p>To install Jaeger, we can use the manifest present in the Istio repository. After deploying it, we can access the Jaeger web interface using a port-forward.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/istio/istio/master/samples/addons/jaeger.yaml
</span></span><span style=display:flex><span>istioctl dashboard jaeger
</span></span></code></pre></div><p>From Jaeger, I can see the traces of my requests and see the response time of each service.</p><p><img src=https://a-cup-of.coffee/blog/istio/_resources/jaeger.png alt="alt text"></p><p>Let&rsquo;s take a trace of the &ldquo;productpage&rdquo; service (entry point of the Bookinfo application) and see the details of the trace:</p><p><img src=https://a-cup-of.coffee/blog/istio/_resources/trace-productpage.png alt="alt text">
<img src=https://a-cup-of.coffee/blog/istio/_resources/details-trace.png alt="alt text"></p><p>Of course, it is possible for me to see the details of each service and see the response time of each service.</p><p><img src=https://a-cup-of.coffee/blog/istio/_resources/trace-labels.png alt="alt text"></p><p>In short, Jaeger is a very useful tool to see the details of requests and have more information about the performance of your applications.</p><p>Kiali is more oriented towards &ldquo;overview&rdquo; while Jaeger is more oriented towards &ldquo;details&rdquo;.</p><p>Architecture diagram of our Bookinfo application:</p><p><img src=https://a-cup-of.coffee/blog/istio/_resources/Schema-jaeger.png alt="alt text"></p><p>A typical use case is to look for the traces of a failed request in order to understand why. I can thus look for the traces of the failed request and see which service returned an error.</p><p><img src=https://a-cup-of.coffee/blog/istio/_resources/404-jaeger.png alt="alt text"></p><p><img src=https://a-cup-of.coffee/blog/istio/_resources/404-trace.png alt="alt text"></p><p><em>In this case, the front just returned a 404 error, we will see more interesting cases later.</em></p><h2 id=prometheus--grafana>Prometheus & Grafana<a href=#prometheus--grafana class=post-heading__anchor aria-hidden=true>#</a></h2><p>For the question of metrics, Istio integrates perfectly with Prometheus (which is linked to Grafana for metric visualization). Using the manifests provided by Istio, we can deploy Prometheus and a pre-configured Grafana dashboard to display the metrics.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/istio/istio/master/samples/addons/grafana.yaml
</span></span><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/istio/istio/master/samples/addons/prometheus.yaml
</span></span><span style=display:flex><span>istioctl dashboard grafana
</span></span></code></pre></div><p>Thus, we have dashboards to see:</p><ul><li>the resources used by Istio.</li><li>the response time between services.</li><li>the status of requests (200, 404, etc).</li><li>the bandwidth used by the services.</li></ul><p><img src=https://a-cup-of.coffee/blog/istio/_resources/grafana-dashboard.png alt="alt text"></p><hr><p>Now that we&rsquo;re ready, we can start playing with Istio.</p><h1 id=exposing-our-application>Exposing our application<a href=#exposing-our-application class=post-heading__anchor aria-hidden=true>#</a></h1><p>For now, traffic is only passing through the sidecars without Envoy doing anything (no filtering, no control, no security). We&rsquo;re going to set it up so that Istio can do its job.</p><p>The first CRD (Custom Resource Definition) we&rsquo;re going to see is the VirtualService. A VirtualService is an Istio object that allows you to configure routing rules for a Kubernetes service.</p><p>The route created by a VirtualService will be propagated to all sidecars, which will then redirect traffic based on defined rules.</p><p>For example, I&rsquo;m going to create the first VirtualService for the &ldquo;details&rdquo; service of the Bookinfo application.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>VirtualService</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.istio.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>details-vs</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>details</span> <span style=color:#75715e># valid for details and details.default.svc.cluster.local</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>route</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>destination</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>host</span>: <span style=color:#ae81ff>details</span>
</span></span></code></pre></div><p>From Kiali, we can see that &ldquo;details&rdquo; has a new icon indicating that the service is now managed by a VirtualService.</p><p><img src=https://a-cup-of.coffee/blog/istio/_resources/vs-details.png alt="alt text"></p><p>This VirtualService adds 2 passive features:</p><ul><li>If a request fails, Envoy will automatically retry it up to 3 times.</li><li>mTLS is enabled in PERMISSIVE mode (HTTP is still possible).</li></ul><p><em>We will talk about mTLS (and explain what it is) a little later.</em></p><p>For now, let&rsquo;s just make the &ldquo;productpage&rdquo; service (the front of the Bookinfo application) accessible via a VirtualService. I will also take this opportunity to restrict access to the &ldquo;/&rdquo; route (the root of the site) which contains a page that is not intended to be viewed by the user.</p><p><img src=https://a-cup-of.coffee/blog/istio/_resources/index_bookinfo.png alt="Index page"></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.istio.io/v1alpha3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>VirtualService</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>bookinfo</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>:
</span></span><span style=display:flex><span>  - <span style=color:#e6db74>&#34;productpage&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>match</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>uri</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>exact</span>: <span style=color:#ae81ff>/productpage</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>uri</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>prefix</span>: <span style=color:#ae81ff>/static</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>uri</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>exact</span>: <span style=color:#ae81ff>/login</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>uri</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>exact</span>: <span style=color:#ae81ff>/logout</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>uri</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>prefix</span>: <span style=color:#ae81ff>/api/v1/products</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>route</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>destination</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>host</span>: <span style=color:#ae81ff>productpage</span>
</span></span></code></pre></div><p>With our <code>kubectl port-forward</code>, we cannot test the restrictions brought by the VirtualService. For this, let&rsquo;s make requests directly from a pod in the cluster.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl exec deployments/ratings-v1 -c ratings -- curl http://productpage:9080/ -I -s
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#ae81ff>404</span> Not Found
</span></span><span style=display:flex><span>date: Sat, <span style=color:#ae81ff>22</span> Jun <span style=color:#ae81ff>2024</span> 09:25:11 GMT
</span></span><span style=display:flex><span>server: envoy
</span></span><span style=display:flex><span>transfer-encoding: chunked
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl exec deployments/ratings-v1 -c ratings -- curl http://productpage:9080/productpage -I -s
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#ae81ff>200</span> OK
</span></span><span style=display:flex><span>server: envoy
</span></span><span style=display:flex><span>date: Sat, <span style=color:#ae81ff>22</span> Jun <span style=color:#ae81ff>2024</span> 09:25:55 GMT
</span></span><span style=display:flex><span>content-type: text/html; charset<span style=color:#f92672>=</span>utf-8
</span></span><span style=display:flex><span>content-length: <span style=color:#ae81ff>5293</span>
</span></span><span style=display:flex><span>vary: Cookie
</span></span><span style=display:flex><span>x-envoy-upstream-service-time: <span style=color:#ae81ff>20</span>
</span></span></code></pre></div><div class="notice note"><p class=notice-title><span class="icon-notice baseline"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 128 300 300"><path d="M150 128c82.813.0 150 67.188 150 150 0 82.813-67.188 150-150 150C67.187 428 0 360.812.0 278c0-82.813 67.188-150 150-150zm25 243.555v-37.11c0-3.515-2.734-6.445-6.055-6.445h-37.5c-3.515.0-6.445 2.93-6.445 6.445v37.11c0 3.515 2.93 6.445 6.445 6.445h37.5c3.32.0 6.055-2.93 6.055-6.445zm-.39-67.188 3.515-121.289c0-1.367-.586-2.734-1.953-3.516-1.172-.976-2.93-1.562-4.688-1.562h-42.968c-1.758.0-3.516.586-4.688 1.563-1.367.78-1.953 2.148-1.953 3.515l3.32 121.29c0 2.734 2.93 4.882 6.64 4.882h36.134c3.515.0 6.445-2.148 6.64-4.883z"/></svg></span>Note</p><p>The <code>x-envoy-upstream-service-time</code> header is a header added by Envoy that indicates the response time of the destination service.</p><p>You can remove it by modifying the VirtualService to not display it by adding the following code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>    <span style=color:#f92672>options</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>stagedTransformations</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>early</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>responseTransforms</span>:     
</span></span><span style=display:flex><span>          - <span style=color:#f92672>responseTransformation</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>transformationTemplate</span>:
</span></span><span style=display:flex><span>                <span style=color:#f92672>dynamicMetadataValues</span>:
</span></span><span style=display:flex><span>                - <span style=color:#f92672>metadataNamespace</span>: <span style=color:#ae81ff>body-logging</span>
</span></span><span style=display:flex><span>                  <span style=color:#f92672>key</span>: <span style=color:#ae81ff>upstream-service-time</span>
</span></span><span style=display:flex><span>                  <span style=color:#f92672>value</span>:
</span></span><span style=display:flex><span>                    <span style=color:#f92672>text</span>: <span style=color:#e6db74>&#39;{{ header(&#34;x-envoy-upstream-service-time&#34;) }}&#39;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>headers</span>:
</span></span><span style=display:flex><span>                  <span style=color:#f92672>x-envoy-upstream-service-time</span>:
</span></span><span style=display:flex><span>                    <span style=color:#f92672>text</span>: <span style=color:#e6db74>&#39;&#39;</span>
</span></span></code></pre></div></div><p>We can see that the route &ldquo;/&rdquo; returns a 404 error (which was not the case before the VirtualService) while the route &ldquo;/productpage&rdquo; correctly returns the home page of the Bookinfo application.</p><p>Now&mldr; it would be better if we could access the application without having to go through a port-forward, wouldn&rsquo;t it?</p><h2 id=gateway>Gateway<a href=#gateway class=post-heading__anchor aria-hidden=true>#</a></h2><p>A Gateway is equivalent to an Ingress. The difference is that an Ingress points directly to a service, while a Gateway allows for different functionalities to redirect traffic differently or with more monitoring.</p><p>A Gateway is an entry point for incoming traffic into the cluster. Just like an Ingress with an IngressController, a Gateway needs a GatewayController to function, which is managed by the pod <code>istio-ingressgateway</code> in the <code>istio-system</code> namespace.</p><div class="notice warning"><p class=notice-title><span class="icon-notice baseline"><svg xmlns="http://www.w3.org/2000/svg" viewBox="126 76.5 300 300"><path d="M297.431 324.397v-34.255c0-3.245-2.344-5.95-5.358-5.95h-32.146c-3.014.0-5.358 2.705-5.358 5.95v34.255c0 3.245 2.344 5.95 5.358 5.95h32.146c3.014.0 5.358-2.705 5.358-5.95zm-.335-67.428 3.014-82.753c0-1.081-.502-2.524-1.674-3.425-1.005-.902-2.512-1.983-4.019-1.983h-36.834c-1.507.0-3.014 1.081-4.019 1.983-1.172.901-1.674 2.704-1.674 3.786l2.846 82.392c0 2.344 2.512 4.146 5.693 4.146h30.975c3.013.0 5.525-1.803 5.692-4.146zm-2.344-168.39L423.34 342.425c3.683 7.032 3.516 15.686-.335 22.717-3.85 7.031-10.883 11.358-18.417 11.358H147.413c-7.534.0-14.566-4.327-18.417-11.358-3.85-7.031-4.018-15.685-.335-22.716L257.248 88.578C260.93 81.188 268.13 76.5 276 76.5s15.069 4.688 18.752 12.08z"/></svg></span>Warning</p><p>Note that the <code>istio-ingressgateway</code> component is not systematically installed with Istio (it is with the <code>demo</code> profile). If you use a configuration file instead of a profile, make sure the <code>istio-ingressgateway</code> component is enabled as shown in the example below:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>install.istio.io/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>IstioOperator</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>components</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>base</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ingressGateways</span>:             <span style=color:#75715e># </span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>              <span style=color:#75715e># This is the GatewayController</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>istio-ingressgateway</span> <span style=color:#75715e>#</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>pilot</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hub</span>: <span style=color:#ae81ff>docker.io/istio</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tag</span>: <span style=color:#ae81ff>1.21.0</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>values</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>defaultRevision</span>: <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>gateways</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>istio-egressgateway</span>: {}
</span></span><span style=display:flex><span>      <span style=color:#f92672>istio-ingressgateway</span>: {}
</span></span><span style=display:flex><span>    <span style=color:#f92672>global</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>configValidation</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>istioNamespace</span>: <span style=color:#ae81ff>istio-system</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>profile</span>: <span style=color:#ae81ff>a-cup-of-coffee</span>
</span></span></code></pre></div></div><p>Since I don&rsquo;t have a LoadBalancer, I will use a NodePort to access the Gateway :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl patch service istio-ingressgateway -n istio-system --type<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;json&#39;</span> -p<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;[{&#34;op&#34;: &#34;replace&#34;, &#34;path&#34;: &#34;/spec/type&#34;, &#34;value&#34;:&#34;NodePort&#34;}]&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>export INGRESS_PORT<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>kubectl -n istio-system get service istio-ingressgateway -o jsonpath<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{.spec.ports[?(@.name==&#34;http2&#34;)].nodePort}&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>export INGRESS_HOST<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>kubectl get po -l istio<span style=color:#f92672>=</span>ingressgateway -n istio-system -o jsonpath<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{.items[0].status.hostIP}&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>echo $INGRESS_HOST:$INGRESS_PORT <span style=color:#75715e># 192.168.128.30:30492</span>
</span></span></code></pre></div><p><em>Keep these variables handy, we&rsquo;ll use them a lot.</em></p><p>We now have an entry point to the Istio Gateway-Controller (ingress-gateway)! Let&rsquo;s try making a first request to the Gateway.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -s $INGRESS_HOST:$INGRESS_PORT/productpage -I -v
</span></span><span style=display:flex><span>*   Trying 192.168.128.30:30492...
</span></span><span style=display:flex><span>* connect to 192.168.128.30 port <span style=color:#ae81ff>30492</span> failed: Connexion refusÃ©e
</span></span><span style=display:flex><span>* Failed to connect to 192.168.128.30 port <span style=color:#ae81ff>30492</span> after <span style=color:#ae81ff>105</span> ms: Connexion refusÃ©e
</span></span><span style=display:flex><span>* Closing connection <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>Ah! Yet I&rsquo;m sure I&rsquo;ve properly exposed the Gateway and I&rsquo;m in the right network. Why a connection refused?</p><p>The reason: if no Gateway is linked to our Gateway-Controller, then the traffic is rejected. Let&rsquo;s start by creating our Gateway object.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.istio.io/v1alpha3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Gateway</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>bookinfo-gateway</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>istio</span>: <span style=color:#ae81ff>ingressgateway</span> <span style=color:#75715e># use istio default controller</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>servers</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>port</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>number</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>HTTP</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>hosts</span>:
</span></span><span style=display:flex><span>    - <span style=color:#e6db74>&#34;*&#34;</span> <span style=color:#75715e># It should match a domain-wildcard (ex: &#39;*.istio.a-cup-of.coffee&#39;), but in dev env, we can use a wildcard</span>
</span></span></code></pre></div><p>Let&rsquo;s try accessing the Gateway :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -s $INGRESS_HOST:$INGRESS_PORT -I
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#ae81ff>404</span> Not Found
</span></span><span style=display:flex><span>date: Sat, <span style=color:#ae81ff>22</span> Jun <span style=color:#ae81ff>2024</span> 09:20:20 GMT
</span></span><span style=display:flex><span>server: istio-envoy
</span></span><span style=display:flex><span>transfer-encoding: chunked
</span></span></code></pre></div><p>Let&rsquo;s then try accessing the Gateway via the &ldquo;/productpage&rdquo; route (used by the VirtualService &ldquo;productpage&rdquo;):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -s $INGRESS_HOST:$INGRESS_PORT/productpage -I
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#ae81ff>404</span> Not Found
</span></span><span style=display:flex><span>date: Sat, <span style=color:#ae81ff>22</span> Jun <span style=color:#ae81ff>2024</span> 09:52:17 GMT
</span></span><span style=display:flex><span>server: istio-envoy
</span></span><span style=display:flex><span>transfer-encoding: chunked
</span></span></code></pre></div><p>Why a 404? Because the VirtualService &ldquo;productpage&rdquo; is not yet linked to the Gateway. We&rsquo;ll take care of it right away.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.istio.io/v1alpha3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>VirtualService</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>bookinfo</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>:
</span></span><span style=display:flex><span>  - <span style=color:#e6db74>&#34;productpage&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gateways</span>:              <span style=color:#75715e># We add the Gateway</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>bookinfo-gateway    </span> <span style=color:#75715e>#</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>match</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>uri</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>exact</span>: <span style=color:#ae81ff>/productpage</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>uri</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>prefix</span>: <span style=color:#ae81ff>/static</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>uri</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>exact</span>: <span style=color:#ae81ff>/login</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>uri</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>exact</span>: <span style=color:#ae81ff>/logout</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>uri</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>prefix</span>: <span style=color:#ae81ff>/api/v1/products</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>route</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>destination</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>host</span>: <span style=color:#ae81ff>productpage</span>
</span></span></code></pre></div><p>Let&rsquo;s try again? This time it&rsquo;s the right one!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -s $INGRESS_HOST:$INGRESS_PORT/productpage -I
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#ae81ff>404</span> Not Found
</span></span><span style=display:flex><span>date: Sat, <span style=color:#ae81ff>22</span> Jun <span style=color:#ae81ff>2024</span> 10:29:52 GMT
</span></span><span style=display:flex><span>server: istio-envoy
</span></span><span style=display:flex><span>transfer-encoding: chunked
</span></span></code></pre></div><p>Still a 404? ð</p><ul><li>The VirtualService is properly configured and working.</li><li>The Gateway is properly configured with the correct VirtualService.</li><li>The gateway-controller is active.</li></ul><p>Some of you may have already guessed the reason for this 404. In fact, the &ldquo;productpage&rdquo; service is only accessible via the domain &ldquo;productpage.default.svc.cluster.local&rdquo;.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl  -H <span style=color:#e6db74>&#34;Host: productpage.default.svc.cluster.local&#34;</span> $INGRESS_HOST:$INGRESS_PORT/productpage -I
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#ae81ff>200</span> OK
</span></span><span style=display:flex><span>content-type: text/html; charset<span style=color:#f92672>=</span>utf-8
</span></span><span style=display:flex><span>content-length: <span style=color:#ae81ff>5290</span>
</span></span><span style=display:flex><span>vary: Cookie
</span></span><span style=display:flex><span>x-envoy-upstream-service-time: <span style=color:#ae81ff>27</span>
</span></span></code></pre></div><div class="notice tip"><p class=notice-title><span class="icon-notice baseline"><svg xmlns="http://www.w3.org/2000/svg" viewBox="300.5 134 300 300"><path d="M551.281 252.36c0-3.32-1.172-6.641-3.515-8.985l-17.774-17.578c-2.344-2.344-5.469-3.711-8.789-3.711-3.32.0-6.445 1.367-8.789 3.71l-79.687 79.493-44.141-44.14c-2.344-2.344-5.469-3.712-8.79-3.712-3.32.0-6.444 1.368-8.788 3.711l-17.774 17.579c-2.343 2.343-3.515 5.664-3.515 8.984s1.172 6.445 3.515 8.789l70.704 70.703c2.343 2.344 5.664 3.711 8.789 3.711 3.32.0 6.64-1.367 8.984-3.71l106.055-106.056c2.343-2.343 3.515-5.468 3.515-8.789zM600.5 284c0 82.813-67.188 150-150 150-82.813.0-150-67.188-150-150 0-82.813 67.188-150 150-150 82.813.0 150 67.188 150 150z"/></svg></span>Tip</p><p>In a VirtualService, the &ldquo;hosts&rdquo; field must match the domain names where the service will be accessible. When the host is not a fully qualified domain name (FQDN), Istio will automatically complete it with the namespace and the cluster domain.</p><p>For example, if I put &ldquo;productpage&rdquo; in the &ldquo;hosts&rdquo; field, Istio will automatically complete it to <code>productpage.default.svc.cluster.local</code>.</p><p>It is then preferable to specify the complete domain name (<code>productpage.default.svc.cluster.local</code>) in the &ldquo;hosts&rdquo; field to avoid any confusion.</p></div><p>Victory, we now access the Bookinfo application via the Gateway! ð</p><p>From Kiali, here&rsquo;s what we can see:</p><p><img src=https://a-cup-of.coffee/blog/istio/_resources/after-ingress-kiali.png alt="alt text"></p><div class="notice tip"><p class=notice-title><span class="icon-notice baseline"><svg xmlns="http://www.w3.org/2000/svg" viewBox="300.5 134 300 300"><path d="M551.281 252.36c0-3.32-1.172-6.641-3.515-8.985l-17.774-17.578c-2.344-2.344-5.469-3.711-8.789-3.711-3.32.0-6.445 1.367-8.789 3.71l-79.687 79.493-44.141-44.14c-2.344-2.344-5.469-3.712-8.79-3.712-3.32.0-6.444 1.368-8.788 3.711l-17.774 17.579c-2.343 2.343-3.515 5.664-3.515 8.984s1.172 6.445 3.515 8.789l70.704 70.703c2.343 2.344 5.664 3.711 8.789 3.711 3.32.0 6.64-1.367 8.984-3.71l106.055-106.056c2.343-2.343 3.515-5.468 3.515-8.789zM600.5 284c0 82.813-67.188 150-150 150-82.813.0-150-67.188-150-150 0-82.813 67.188-150 150-150 82.813.0 150 67.188 150 150z"/></svg></span>Tip</p><p>In our development environment, we can use a wildcard for the &ldquo;hosts&rdquo; field of the VirtualService. This allows incoming traffic to be redirected to the service without specifying a particular domain name.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.istio.io/v1alpha3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>VirtualService</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>bookinfo</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>:
</span></span><span style=display:flex><span>  - <span style=color:#e6db74>&#34;*&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gateways</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>bookinfo-gateway</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>match</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>uri</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>exact</span>: <span style=color:#ae81ff>/productpage</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>uri</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>prefix</span>: <span style=color:#ae81ff>/static</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>uri</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>exact</span>: <span style=color:#ae81ff>/login</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>uri</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>exact</span>: <span style=color:#ae81ff>/logout</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>uri</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>prefix</span>: <span style=color:#ae81ff>/api/v1/products</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>route</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>destination</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>host</span>: <span style=color:#ae81ff>productpage</span>
</span></span></code></pre></div></div><p>Now, let&rsquo;s tackle the &ldquo;reviews&rdquo; application, which is a bit special.</p><h2 id=version-management-with-destinationrules>Version Management with DestinationRules<a href=#version-management-with-destinationrules class=post-heading__anchor aria-hidden=true>#</a></h2><p>The &ldquo;reviews&rdquo; service is a service that has 3 different versions. Each version is accessible via a different label (app=reviews, version=v1, v2, v3).</p><p>The service <em>(in the Kubernetes way)</em> is configured to redirect traffic to applications with the label <code>app=reviews</code>. But how do we redirect traffic to a specific version?</p><p>The answer is: DestinationRules, an Istio object that allows applying a set of treatments after traffic has been routed by a VirtualService.</p><p>For example, a DestinationRule can:</p><ul><li>Modify the LoadBalancing mode.</li><li>Create a circuit breaker.</li><li>Configure mTLS.</li></ul><p>And of course, the most important thing: managing the &ldquo;subsets&rdquo; of applications to differentiate the versions of the same services.</p><p>Here&rsquo;s what our DestinationRule for the &ldquo;reviews&rdquo; service will look like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.istio.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>DestinationRule</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>reviews</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>host</span>: <span style=color:#ae81ff>reviews</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>subsets</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>version</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>v2</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>version</span>: <span style=color:#ae81ff>v2</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>v3</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>version</span>: <span style=color:#ae81ff>v3</span>
</span></span></code></pre></div><p>Each subset is given a name based on the <code>version</code> label of each pod. We can then redirect traffic to a specific version using the corresponding subset.</p><h1 id=traffic-management-with-istio>Traffic Management with Istio<a href=#traffic-management-with-istio class=post-heading__anchor aria-hidden=true>#</a></h1><p>Now that we have a Gateway and have configured the VirtualServices and DestinationRules, we can play with the Envoy proxies and discover some of Istio&rsquo;s features.</p><h2 id=traffic-shifting>Traffic-Shifting<a href=#traffic-shifting class=post-heading__anchor aria-hidden=true>#</a></h2><p>Traffic-Shifting is an Istio feature that allows redirecting traffic to a specific version of a service. This allows testing a new version of an application without impacting users.</p><p>To do this, we will use a VirtualService to redirect traffic to a specific subset of the &ldquo;reviews&rdquo; service.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.istio.io/v1alpha3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>VirtualService</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>reviews</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>reviews</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>route</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>destination</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>host</span>: <span style=color:#ae81ff>reviews</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>subset</span>: <span style=color:#ae81ff>v1</span>
</span></span></code></pre></div><p>By reloading the page several times, we can see that the &ldquo;Reviews&rdquo; are always the same (no ratings). This is normal, the VirtualService redirects traffic to version 1 of &ldquo;reviews&rdquo;.</p><p>Let&rsquo;s go a bit further and add versions 2 and 3 of &ldquo;reviews&rdquo; to the VirtualService with a new concept: weight.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.istio.io/v1alpha3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>VirtualService</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>reviews</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>reviews</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>route</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>destination</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>host</span>: <span style=color:#ae81ff>reviews</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>subset</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>weight</span>: <span style=color:#ae81ff>15</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>destination</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>host</span>: <span style=color:#ae81ff>reviews</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>subset</span>: <span style=color:#ae81ff>v2</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>weight</span>: <span style=color:#ae81ff>25</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>destination</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>host</span>: <span style=color:#ae81ff>reviews</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>subset</span>: <span style=color:#ae81ff>v3</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>weight</span>: <span style=color:#ae81ff>60</span>
</span></span></code></pre></div><p>Overall, the traffic will be distributed as follows:</p><ul><li>15% of requests will be redirected to version 1,</li><li>25% to version 2,</li><li>60% to version 3.</li></ul><p>To verify that the traffic is properly distributed, we can generate requests in a loop and inspect the results directly from Kiali.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#66d9ef>while</span> true; <span style=color:#66d9ef>do</span> curl $INGRESS_HOST:$INGRESS_PORT/productpage -s -I ; <span style=color:#66d9ef>done</span>
</span></span></code></pre></div><p><img src=https://a-cup-of.coffee/blog/istio/_resources/traffic-shifting.png alt="alt text"></p><p>Now, we can see that the traffic is well distributed among the different versions of &ldquo;reviews&rdquo;: version 3 is the most used (60% of requests) while version 1 is the least used (15% of requests).</p><p>This can be compared to a canary deployment (or &ldquo;canary deployment&rdquo;) where a new version of an application is deployed and tested on a small part of users before being deployed for everyone. We can then redirect traffic to the new version gradually and control the adoption rate of the latter based on logs and metrics (thanks to Kiali, Jaeger, and Grafana).</p><p>In our canary deployment, we redirect traffic randomly to the different versions of the &ldquo;reviews&rdquo; service, but why not redirect it based on other criteria?</p><h2 id=ab-testing>A/B Testing<a href=#ab-testing class=post-heading__anchor aria-hidden=true>#</a></h2><p>A/B Testing is a technique that consists of redirecting traffic to different versions of an application based on certain criteria (for example, the user&rsquo;s country, device type, etc.). It is extremely useful for testing a new version of an application on a specific group of users without impacting others.</p><p>For example, we will redirect traffic to version 3 of the &ldquo;reviews&rdquo; service for the user &ldquo;quentin&rdquo; and to version 2 for other users. Note that when we connect to the bookinfo application, it will create a session cookie that will contain the user&rsquo;s name. The productpage application will transmit this user name to other applications (reviews, details) via an &ldquo;end-user&rdquo; header. It&rsquo;s this header that we will use to redirect traffic.</p><p>If you want to verify this for yourself, I invite you to consult the <code>getForwardHeaders()</code> function of the Productpage application <a href=https://github.com/istio/istio/blob/master/samples/bookinfo/src/productpage/productpage.py#L133-L134 class=link--external target=_blank rel=noreferrer>here</a>.</p><p>Let&rsquo;s start by authenticating with the username &ldquo;quentin&rdquo; <em>(the password doesn&rsquo;t matter, put anything)</em> :</p><p><img src=https://a-cup-of.coffee/blog/istio/_resources/login-to-quentin.png alt="alt text"></p><p>In the page header, we can see with which username we are connected:</p><p>Let&rsquo;s then modify the VirtualService &ldquo;reviews&rdquo; as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.istio.io/v1alpha3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>VirtualService</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>reviews</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>reviews</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>match</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>headers</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>end-user</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>exact</span>: <span style=color:#ae81ff>quentin</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>route</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>destination</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>host</span>: <span style=color:#ae81ff>reviews</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>subset</span>: <span style=color:#ae81ff>v3</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>route</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>destination</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>host</span>: <span style=color:#ae81ff>reviews</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>subset</span>: <span style=color:#ae81ff>v2</span>
</span></span></code></pre></div><p>This configuration can be translated as follows:</p><ul><li>If the &ldquo;end-user&rdquo; header is equal to &ldquo;quentin&rdquo;, redirect traffic to version 3 of &ldquo;reviews&rdquo;.</li><li>Otherwise, redirect traffic to version 2.</li></ul><p>Without authenticating, we can see that traffic is redirected to version 2:
<img src=https://a-cup-of.coffee/blog/istio/_resources/review-2.png alt="alt text"></p><p>And if we authenticate with the username &ldquo;quentin&rdquo;, traffic is redirected to version 3:
<img src=https://a-cup-of.coffee/blog/istio/_resources/55139e6424e5d54bbd7ea49327ae4492.png alt=55139e6424e5d54bbd7ea49327ae4492.png></p><p>From another user (for example &ldquo;alice&rdquo;), traffic is redirected to version 2.</p><p>Let&rsquo;s now test another case of A/B Testing: redirecting traffic to a specific version based on whether the user opens the page from a mobile device or a computer.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.istio.io/v1alpha3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>VirtualService</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>reviews</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>reviews</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>match</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>headers</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>user-agent</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>regex</span>: <span style=color:#ae81ff>.*Mobile.*</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>route</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>destination</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>host</span>: <span style=color:#ae81ff>reviews</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>subset</span>: <span style=color:#ae81ff>v3</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>route</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>destination</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>host</span>: <span style=color:#ae81ff>reviews</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>subset</span>: <span style=color:#ae81ff>v2</span>
</span></span></code></pre></div><ul><li>If I do not specify an user-agent, the traffic is redirected to version 2.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl $INGRESS_HOST:$INGRESS_PORT/productpage -s | grep reviews-
</span></span><span style=display:flex><span>        &lt;u&gt;reviews-v2-5b65c4bdb-76pd4&lt;/u&gt;
</span></span></code></pre></div><ul><li>If I specify a user-agent containing &ldquo;Mobile&rdquo;, the traffic is redirected to version 3.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl $INGRESS_HOST:$INGRESS_PORT/productpage --user-agent <span style=color:#e6db74>&#34;Mozilla/5.0 (Linux; Android 14) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.6478.110 Mobile Safari/537.36&#34;</span> -s | grep reviews-
</span></span><span style=display:flex><span>        &lt;u&gt;reviews-v3-685dd59d69-tmzlf&lt;/u&gt;
</span></span></code></pre></div><p>Now let&rsquo;s look at the last feature of Istio for integrating new versions of an application: the &ldquo;Dark Launch&rdquo;.</p><h2 id=dark-launch-mirroring>Dark Launch (Mirroring)<a href=#dark-launch-mirroring class=post-heading__anchor aria-hidden=true>#</a></h2><p>The Dark Launch is a technique that allows testing a new version of an application in parallel with the old one without sending the response of the new version to the user.</p><img srcset=./_resources/Dark-launch.png alt='Dark Launch' class=invert-dark><p>So, when a user opens a page, the traffic is redirected to the current version of the application, but the new one is also called in parallel. The response of the new version is not sent to the user, but an administrator can view the logs to see if the application integrates correctly for a future deployment.</p><p>Let&rsquo;s say we&rsquo;re transitioning from version 2 to version 3 of the &ldquo;reviews&rdquo; service, we can configure a VirtualService to go into &ldquo;mirroring&rdquo; mode. This will allow us to verify that the version 3 application works correctly with current requests.</p><p><em>Of course, the performance of the &ldquo;ratings&rdquo; application will be impacted by the &ldquo;mirroring&rdquo; mode since each request will be called twice (once for version 2 and once for version 3).</em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.istio.io/v1alpha3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>VirtualService</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>reviews</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>reviews</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>route</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>destination</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>host</span>: <span style=color:#ae81ff>reviews</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>subset</span>: <span style=color:#ae81ff>v2</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>mirror</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>host</span>: <span style=color:#ae81ff>reviews</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>subset</span>: <span style=color:#ae81ff>v3</span>
</span></span></code></pre></div><p>Here is the architecture diagram from Kiali:</p><p><img src=https://a-cup-of.coffee/blog/istio/_resources/mirror.png alt="alt text"></p><p>Once the &ldquo;mirroring&rdquo; mode is enabled, we need to analyze the logs to see if the new version of the application is working correctly. To do this, we can use tracing tools (Jaeger, Zipkin) and metrics (Prometheus, Grafana).</p><h2 id=fault-injection>Fault Injection<a href=#fault-injection class=post-heading__anchor aria-hidden=true>#</a></h2><p>Now that we are able to deploy new versions with a belt and suspenders, it&rsquo;s time to see how Istio can help us test the resilience of our applications.</p><p>There is a feature that allows injecting errors into requests to see how the application reacts in case of an error. This is &ldquo;Fault Injection&rdquo;.</p><p>Let&rsquo;s target the &ldquo;ratings&rdquo; service of the Bookinfo application. We&rsquo;re going to inject 403 (Forbidden) errors on 30% of requests to see how the application reacts and how users are affected.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>VirtualService</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.istio.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ratings</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>ratings</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>fault</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>abort</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>httpStatus</span>: <span style=color:#ae81ff>403</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>percentage</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>value</span>: <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>route</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>destination</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>host</span>: <span style=color:#ae81ff>ratings</span>
</span></span></code></pre></div><div class="notice info"><p class=notice-title><span class="icon-notice baseline"><svg xmlns="http://www.w3.org/2000/svg" viewBox="92 59.5 300 300"><path d="M292 303.25V272c0-3.516-2.734-6.25-6.25-6.25H267v-1e2c0-3.516-2.734-6.25-6.25-6.25h-62.5c-3.516.0-6.25 2.734-6.25 6.25V197c0 3.516 2.734 6.25 6.25 6.25H217v62.5h-18.75c-3.516.0-6.25 2.734-6.25 6.25v31.25c0 3.516 2.734 6.25 6.25 6.25h87.5c3.516.0 6.25-2.734 6.25-6.25zm-25-175V97c0-3.516-2.734-6.25-6.25-6.25h-37.5c-3.516.0-6.25 2.734-6.25 6.25v31.25c0 3.516 2.734 6.25 6.25 6.25h37.5c3.516.0 6.25-2.734 6.25-6.25zm125 81.25c0 82.813-67.188 150-150 150-82.813.0-150-67.188-150-150 0-82.813 67.188-150 150-150 82.813.0 150 67.188 150 150z"/></svg></span>Info</p><p>To target when the 403 error will be injected, we can use the <code>match</code> field to specify the conditions. Here, the 403 error will only be injected if the &ldquo;end-user&rdquo; header is equal to &ldquo;testing-user&rdquo;.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>VirtualService</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.istio.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ratings</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>ratings</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>fault</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>abort</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>httpStatus</span>: <span style=color:#ae81ff>403</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>percentage</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>value</span>: <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>route</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>destination</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>host</span>: <span style=color:#ae81ff>ratings</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>match</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>headers</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>end-user</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>exact</span>: <span style=color:#ae81ff>testing-user</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>route</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>destination</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>host</span>: <span style=color:#ae81ff>ratings</span>
</span></span></code></pre></div></div><p>With the above configuration, 30% of requests to the &ldquo;ratings&rdquo; service will return a 403 error:</p><p><img src=https://a-cup-of.coffee/blog/istio/_resources/c17bb7d4cc0022c40e328bb3e704c959.png alt=c17bb7d4cc0022c40e328bb3e704c959.png></p><p>From Kiali, requests are thrown into a &ldquo;Black Hole&rdquo; (a black hole).</p><p><img src=https://a-cup-of.coffee/blog/istio/_resources/4db0624f7e92b4e0a251d8027287eb44.png alt=4db0624f7e92b4e0a251d8027287eb44.png></p><h3 id=delay-injection>Delay Injection<a href=#delay-injection class=post-heading__anchor aria-hidden=true>#</a></h3><p>Instead of injecting errors, we can add delays to requests to see how the application reacts in case of latency.</p><p>I will leave the &ldquo;ratings&rdquo; service alone and target the &ldquo;details&rdquo; service by injecting a 7-second delay on 50% of requests.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>VirtualService</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.istio.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>details</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>details</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>route</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>destination</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>host</span>: <span style=color:#ae81ff>details</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>fault</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>delay</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>fixedDelay</span>: <span style=color:#ae81ff>7.</span><span style=color:#ae81ff>000s</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>percent</span>: <span style=color:#ae81ff>50</span>
</span></span></code></pre></div><p>And there you have it, 50% of requests to the &ldquo;details&rdquo; service will experience a 7-second delay. Let&rsquo;s verify this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl $INGRESS_HOST:$INGRESS_PORT/productpage -s -w <span style=color:#e6db74>&#39;\n* Response time: %{time_total}s\n&#39;</span> | grep <span style=color:#e6db74>&#39;Response time&#39;</span>
</span></span><span style=display:flex><span>* Response time: 3.262570s
</span></span></code></pre></div><p>We didn&rsquo;t get 7 seconds of delay, why? Because the delay is injected between the &ldquo;productpage&rdquo; and &ldquo;details&rdquo; services, and our frontend application has a <a href=https://github.com/istio/istio/blob/master/samples/bookinfo/src/productpage/productpage.py#L337 class=link--external target=_blank rel=noreferrer>3-second timeout</a> for requests to the &ldquo;details&rdquo; service.</p><p>Let&rsquo;s then switch from 7 seconds to 2 seconds to see if the delay is taken into account.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl patch virtualservice details -n default --type<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;json&#39;</span> -p<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;[{&#34;op&#34;: &#34;replace&#34;, &#34;path&#34;: &#34;/spec/http/0/fault/delay/fixedDelay&#34;, &#34;value&#34;: &#34;2.000s&#34;}]&#39;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl $INGRESS_HOST:$INGRESS_PORT/productpage -s -w <span style=color:#e6db74>&#39;\n* Response time: %{time_total}s\n&#39;</span> | grep <span style=color:#e6db74>&#39;Response time&#39;</span>
</span></span><span style=display:flex><span>* Response time: 0.282223s
</span></span><span style=display:flex><span>$ curl $INGRESS_HOST:$INGRESS_PORT/productpage -s -w <span style=color:#e6db74>&#39;\n* Response time: %{time_total}s\n&#39;</span> | grep <span style=color:#e6db74>&#39;Response time&#39;</span>
</span></span><span style=display:flex><span>* Response time: 2.264027s
</span></span></code></pre></div><p>And there you have it, the 2-second delay is well observed ð !</p><h2 id=circuit-breaker>Circuit Breaker<a href=#circuit-breaker class=post-heading__anchor aria-hidden=true>#</a></h2><p>A Circuit Breaker is a mechanism that allows stopping requests to a service if a certain number of errors are encountered. This helps protect downstream services from an overload of requests and reduces latency times (by avoiding timeouts since requests are stopped before reaching them).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.istio.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>DestinationRule</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>productpage</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>host</span>: <span style=color:#ae81ff>productpage</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>trafficPolicy</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>connectionPool</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>tcp</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>maxConnections</span>: <span style=color:#ae81ff>1</span> <span style=color:#75715e># Maximum number of connections in http 1.1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>http2MaxRequests</span>: <span style=color:#ae81ff>3</span> <span style=color:#75715e># Maximum number of connections in http 2</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>maxRequestsPerConnection</span>: <span style=color:#ae81ff>1</span> <span style=color:#75715e># Maximum number of requests per connection</span>
</span></span></code></pre></div><p>With this configuration, if the &ldquo;productpage&rdquo; service receives more than 3 requests in HTTP/2, the Circuit Breaker will stop the ongoing requests and return a 503 error (Service Unavailable). Thus, if the server receives too many requests, the service will not crash and will handle the requests it can handle without impacting other applications.</p><p>To test this, we can use a benchmarking tool like <code>fortio</code> to send a large number of requests to the &ldquo;productpage&rdquo;. <em>(We&rsquo;ll have the opportunity to talk about <code>fortio</code> a bit later.)</em></p><p>If we launch with one access at a time :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ fortio load -c <span style=color:#ae81ff>1</span> -n <span style=color:#ae81ff>50</span> http://$INGRESS_HOST:$INGRESS_PORT/productpage
</span></span><span style=display:flex><span>Connection time histogram <span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> : count <span style=color:#ae81ff>1</span> avg 0.13487925 +/- <span style=color:#ae81ff>0</span> min 0.134879246 max 0.134879246 sum 0.134879246
</span></span><span style=display:flex><span><span style=color:#75715e># range, mid point, percentile, count</span>
</span></span><span style=display:flex><span>&gt;<span style=color:#f92672>=</span> 0.134879 &lt;<span style=color:#f92672>=</span> 0.134879 , 0.134879 , 100.00, <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#75715e># target 50% 0.134879</span>
</span></span><span style=display:flex><span><span style=color:#75715e># target 75% 0.134879</span>
</span></span><span style=display:flex><span><span style=color:#75715e># target 90% 0.134879</span>
</span></span><span style=display:flex><span><span style=color:#75715e># target 99% 0.134879</span>
</span></span><span style=display:flex><span><span style=color:#75715e># target 99.9% 0.134879</span>
</span></span><span style=display:flex><span>Sockets used: <span style=color:#ae81ff>1</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>for</span> perfect keepalive, would be 1<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Uniform: false, Jitter: false, Catchup allowed: true
</span></span><span style=display:flex><span>IP addresses distribution:
</span></span><span style=display:flex><span>192.168.128.30:30492: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>Code <span style=color:#ae81ff>200</span> : <span style=color:#ae81ff>50</span> <span style=color:#f92672>(</span>100.0 %<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Response Header Sizes : count <span style=color:#ae81ff>50</span> avg <span style=color:#ae81ff>188</span> +/- <span style=color:#ae81ff>0</span> min <span style=color:#ae81ff>188</span> max <span style=color:#ae81ff>188</span> sum <span style=color:#ae81ff>9400</span>
</span></span><span style=display:flex><span>Response Body/Total Sizes : count <span style=color:#ae81ff>50</span> avg 5399.12 +/- <span style=color:#ae81ff>271</span> min <span style=color:#ae81ff>4480</span> max <span style=color:#ae81ff>5481</span> sum <span style=color:#ae81ff>269956</span>
</span></span><span style=display:flex><span>All <span style=color:#66d9ef>done</span> <span style=color:#ae81ff>50</span> calls <span style=color:#f92672>(</span>plus <span style=color:#ae81ff>0</span> warmup<span style=color:#f92672>)</span> 162.183 ms avg, 6.2 qps
</span></span></code></pre></div><p>100% of the requests were successful. Now, let&rsquo;s run the same test with 4 concurrent requests:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ fortio load -c <span style=color:#ae81ff>4</span> -n <span style=color:#ae81ff>50</span> http://$INGRESS_HOST:$INGRESS_PORT/productpage
</span></span><span style=display:flex><span>Connection time histogram <span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> : count <span style=color:#ae81ff>7</span> avg 0.1462682 +/- 0.02803 min 0.106653371 max 0.176468802 sum 1.02387742
</span></span><span style=display:flex><span><span style=color:#75715e># range, mid point, percentile, count</span>
</span></span><span style=display:flex><span>&gt;<span style=color:#f92672>=</span> 0.106653 &lt;<span style=color:#f92672>=</span> 0.12 , 0.113327 , 28.57, <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>&gt; 0.12 &lt;<span style=color:#f92672>=</span> 0.14 , 0.13 , 42.86, <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>&gt; 0.14 &lt;<span style=color:#f92672>=</span> 0.16 , 0.15 , 57.14, <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>&gt; 0.16 &lt;<span style=color:#f92672>=</span> 0.176469 , 0.168234 , 100.00, <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span><span style=color:#75715e># target 50% 0.15</span>
</span></span><span style=display:flex><span><span style=color:#75715e># target 75% 0.166862</span>
</span></span><span style=display:flex><span><span style=color:#75715e># target 90% 0.172626</span>
</span></span><span style=display:flex><span><span style=color:#75715e># target 99% 0.176085</span>
</span></span><span style=display:flex><span><span style=color:#75715e># target 99.9% 0.17643</span>
</span></span><span style=display:flex><span>Sockets used: <span style=color:#ae81ff>7</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>for</span> perfect keepalive, would be 4<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Uniform: false, Jitter: false, Catchup allowed: true
</span></span><span style=display:flex><span>IP addresses distribution:
</span></span><span style=display:flex><span>192.168.128.30:30492: <span style=color:#ae81ff>7</span>
</span></span><span style=display:flex><span>Code <span style=color:#ae81ff>200</span> : <span style=color:#ae81ff>46</span> <span style=color:#f92672>(</span>92.0 %<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Code <span style=color:#ae81ff>503</span> : <span style=color:#ae81ff>4</span> <span style=color:#f92672>(</span>8.0 %<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Response Header Sizes : count <span style=color:#ae81ff>50</span> avg 172.96 +/- <span style=color:#ae81ff>51</span> min <span style=color:#ae81ff>0</span> max <span style=color:#ae81ff>188</span> sum <span style=color:#ae81ff>8648</span>
</span></span><span style=display:flex><span>Response Body/Total Sizes : count <span style=color:#ae81ff>50</span> avg 5000.3 +/- <span style=color:#ae81ff>1421</span> min <span style=color:#ae81ff>247</span> max <span style=color:#ae81ff>5481</span> sum <span style=color:#ae81ff>250015</span>
</span></span><span style=display:flex><span>All <span style=color:#66d9ef>done</span> <span style=color:#ae81ff>50</span> calls <span style=color:#f92672>(</span>plus <span style=color:#ae81ff>0</span> warmup<span style=color:#f92672>)</span> 195.516 ms avg, 7.0 qps
</span></span></code></pre></div><p>We can see that 8% of the requests returned a 503 error, which is the Circuit Breaker stopping these requests to prevent the &ldquo;productpage&rdquo; service from being overloaded.</p><h1 id=security-in-istio>Security in Istio<a href=#security-in-istio class=post-heading__anchor aria-hidden=true>#</a></h1><p>We&rsquo;ve talked a lot about traffic management and error handling, but what about security? Istio offers a wide range of features to secure the exchanges between services, from certificate management to service authentication.</p><p>I suggest we delve into this aspect to see how Istio can help us secure our applications.</p><p><img src=https://istio.io/latest/docs/concepts/security/arch-sec.svg alt=Im loading=lazy></p><h2 id=mtls>mTLS<a href=#mtls class=post-heading__anchor aria-hidden=true>#</a></h2><p>I briefly mentioned it at the beginning of this article, Istio supports mTLS (mutual TLS) by default to secure the exchanges between services.</p><img srcset=./_resources/citadel.mtls.drawio_black.png alt=Citadel class=invert-dark><p>Every time an Envoy communicates with a new service, it requests <strong>Istiod</strong> to obtain a certificate that authenticates the exchanges. Thus, due to the nature of mTLS, both the sender AND the receiver can mutually authenticate each other.</p><p>By default, mTLS is enabled in &ldquo;PERMISSIVE&rdquo; mode in Istio. This means that services can communicate in HTTP or HTTPS.</p><p>We can force the exchanges to be in &ldquo;STRICT&rdquo; mode so that services can only communicate in HTTPS.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>security.istio.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>PeerAuthentication</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>default-mtls</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>mtls</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>mode</span>: <span style=color:#ae81ff>STRICT</span>
</span></span></code></pre></div><div class="notice tip"><p class=notice-title><span class="icon-notice baseline"><svg xmlns="http://www.w3.org/2000/svg" viewBox="300.5 134 300 300"><path d="M551.281 252.36c0-3.32-1.172-6.641-3.515-8.985l-17.774-17.578c-2.344-2.344-5.469-3.711-8.789-3.711-3.32.0-6.445 1.367-8.789 3.71l-79.687 79.493-44.141-44.14c-2.344-2.344-5.469-3.712-8.79-3.712-3.32.0-6.444 1.368-8.788 3.711l-17.774 17.579c-2.343 2.343-3.515 5.664-3.515 8.984s1.172 6.445 3.515 8.789l70.704 70.703c2.343 2.344 5.664 3.711 8.789 3.711 3.32.0 6.64-1.367 8.984-3.71l106.055-106.056c2.343-2.343 3.515-5.468 3.515-8.789zM600.5 284c0 82.813-67.188 150-150 150-82.813.0-150-67.188-150-150 0-82.813 67.188-150 150-150 82.813.0 150 67.188 150 150z"/></svg></span>Tip</p><p>Instead of forcing mTLS for the default namespace, we can do it at the scale of the entire cluster by specifying the <code>istio-system</code> namespace.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>security.istio.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>PeerAuthentication</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>default-mtls</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>istio-system</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>mtls</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>mode</span>: <span style=color:#ae81ff>STRICT</span>
</span></span></code></pre></div></div><p>Once the &ldquo;STRICT&rdquo; mode is enabled, we can restart the services for mTLS to take effect.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl rollout restart deployment -n default details-v1 productpage-v1 ratings-v1 reviews-v1 reviews-v2 reviews-v3 
</span></span></code></pre></div><p>From Kiali, we can see that mTLS is properly enabled with the ð symbol.</p><p><img src=https://a-cup-of.coffee/blog/istio/_resources/mtls-kiali.png alt="alt text"></p><p>To test this ourselves, let&rsquo;s expose the &ldquo;productpage&rdquo; service outside the cluster using a NodePort (a ClusterIP service is not sufficient).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl patch svc productpage -n default --type<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;json&#39;</span> -p<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;[{&#34;op&#34;: &#34;replace&#34;, &#34;path&#34;: &#34;/spec/type&#34;, &#34;value&#34;: &#34;NodePort&#34;}]&#39;</span>
</span></span><span style=display:flex><span>PRODUCTPAGE_PORT<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>kubectl get svc productpage -n default -o jsonpath<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{.spec.ports[0].nodePort}&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>PRODUCTPAGE_HOST<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>kubectl get nodes -o jsonpath<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{.items[0].status.addresses[0].address}&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>echo $PRODUCTPAGE_HOST:$PRODUCTPAGE_PORT <span style=color:#75715e># 192.168.128.27:31447</span>
</span></span></code></pre></div><p>Now, let&rsquo;s try to view the &ldquo;productpage&rdquo; certificate:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ openssl s_client -connect $PRODUCTPAGE_HOST:$PRODUCTPAGE_PORT &lt; /dev/null 2&gt;/dev/null | openssl x509 -noout -text
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Certificate:
</span></span><span style=display:flex><span>    Data:
</span></span><span style=display:flex><span>        Signature Algorithm: sha256WithRSAEncryption
</span></span><span style=display:flex><span>        Issuer: O <span style=color:#f92672>=</span> cluster.local
</span></span><span style=display:flex><span>        Validity
</span></span><span style=display:flex><span>            Not Before: Jun <span style=color:#ae81ff>22</span> 06:20:33 <span style=color:#ae81ff>2024</span> GMT
</span></span><span style=display:flex><span>            Not After : Jun <span style=color:#ae81ff>23</span> 06:22:33 <span style=color:#ae81ff>2024</span> GMT
</span></span><span style=display:flex><span>        Subject:
</span></span><span style=display:flex><span>        Subject Public Key Info:
</span></span><span style=display:flex><span>            Public Key Algorithm: rsaEncryption
</span></span><span style=display:flex><span>                Public-Key: <span style=color:#f92672>(</span><span style=color:#ae81ff>2048</span> bit<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        X509v3 extensions:
</span></span><span style=display:flex><span>            X509v3 Key Usage: critical
</span></span><span style=display:flex><span>                Digital Signature, Key Encipherment
</span></span><span style=display:flex><span>            X509v3 Extended Key Usage:
</span></span><span style=display:flex><span>                TLS Web Server Authentication, TLS Web Client Authentication
</span></span><span style=display:flex><span>            X509v3 Basic Constraints: critical
</span></span><span style=display:flex><span>                CA:FALSE
</span></span><span style=display:flex><span>            X509v3 Authority Key Identifier:
</span></span><span style=display:flex><span>                E5:BD:7C:B1:C3:CE:56:30:B1:9F:59:BE:97:E5:76:BD:6C:7B:D3:02
</span></span><span style=display:flex><span>            X509v3 Subject Alternative Name: critical
</span></span><span style=display:flex><span>                URI:spiffe://cluster.local/ns/default/sa/bookinfo-productpage
</span></span><span style=display:flex><span>    Signature Algorithm: sha256WithRSAEncryption
</span></span></code></pre></div><p>We can see that the certificate is properly signed by the local cluster and has a limited duration (1 day).</p><p>Without a valid certificate, we cannot communicate with the &ldquo;productpage&rdquo; service:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl $PRODUCTPAGE_HOST:$PRODUCTPAGE_PORT -v  
</span></span><span style=display:flex><span>* Recv failure: Connection reset by peer
</span></span><span style=display:flex><span>* Closing connection <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>curl: <span style=color:#f92672>(</span>56<span style=color:#f92672>)</span> Recv failure: Connection reset by peer
</span></span></code></pre></div><h2 id=acls>ACLs<a href=#acls class=post-heading__anchor aria-hidden=true>#</a></h2><p>Let&rsquo;s now move on to creating ACLs (Access Control Lists) to allow or deny access to certain services based on certain criteria.</p><p>In general, ACLs can be based on several criteria:</p><ul><li>The namespace (input, output);</li><li>the operation (GET, POST, PUT, DELETE) and its path;</li><li>the labels of the services.</li></ul><p>The idea is to allow a certain application to expose a certain path or HTTP operation and to deny access if the conditions are not met.</p><hr><p>To see this in action, we will start by denying all exchanges in our &ldquo;default&rdquo; namespace.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>security.istio.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>AuthorizationPolicy</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span> <span style=color:#f92672>name</span>: <span style=color:#ae81ff>allow-nothing</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>: {}
</span></span></code></pre></div><p>Now, if we try to access the &ldquo;productpage&rdquo;, we will receive a 403 (Forbidden) error:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl $INGRESS_HOST:$INGRESS_PORT/productpage  -v
</span></span><span style=display:flex><span>*   Trying 192.168.128.30:30492...
</span></span><span style=display:flex><span>* Connected to 192.168.128.30 <span style=color:#f92672>(</span>192.168.128.30<span style=color:#f92672>)</span> port <span style=color:#ae81ff>30492</span> <span style=color:#f92672>(</span><span style=color:#75715e>#0)</span>
</span></span><span style=display:flex><span>&gt; GET /productpage HTTP/1.1
</span></span><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#ae81ff>403</span> Forbidden
</span></span><span style=display:flex><span>&lt; server: istio-envoy
</span></span><span style=display:flex><span>&lt; x-envoy-upstream-service-time: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>&lt;
</span></span><span style=display:flex><span>* Connection <span style=color:#75715e>#0 to host 192.168.128.30 left intact</span>
</span></span></code></pre></div><p>Kiali indicates that the traffic is indeed blocked:</p><p><img src=https://a-cup-of.coffee/blog/istio/_resources/kiali-blocked.png alt="alt text"></p><p>Jaeger also:</p><p><img src=https://a-cup-of.coffee/blog/istio/_resources/jaeger-blocked.png alt="alt text"></p><p>To re-authorize access to the &ldquo;productpage&rdquo;, we can create a new ACL rule allowing different operations on the &ldquo;productpage&rdquo; service:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>security.istio.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>AuthorizationPolicy</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>allow-productpage</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>productpage</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>action</span>: <span style=color:#ae81ff>ALLOW</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>rules</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>to</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>operation</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>methods</span>: [<span style=color:#e6db74>&#34;GET&#34;</span>]
</span></span><span style=display:flex><span>        <span style=color:#f92672>paths</span>: 
</span></span><span style=display:flex><span>          - <span style=color:#e6db74>&#34;/logout&#34;</span>
</span></span><span style=display:flex><span>          - <span style=color:#e6db74>&#34;/static/*&#34;</span>
</span></span><span style=display:flex><span>          - <span style=color:#e6db74>&#34;/productpage&#34;</span>
</span></span><span style=display:flex><span>          - <span style=color:#e6db74>&#34;/api/v1/products&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>operation</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>methods</span>: [<span style=color:#e6db74>&#34;POST&#34;</span>]
</span></span><span style=display:flex><span>        <span style=color:#f92672>paths</span>: [<span style=color:#e6db74>&#34;/login&#34;</span>]
</span></span></code></pre></div><p>Cool, we can now access the &ldquo;productpage&rdquo; again:</p><p><img src=https://a-cup-of.coffee/blog/istio/_resources/productpageOK.png alt="alt text"></p><p><img src=https://a-cup-of.coffee/blog/istio/_resources/a6e19e77fbeae1e5629f47e25c7b2044.png alt=a6e19e77fbeae1e5629f47e25c7b2044.png></p><p>On the other hand, the other services are still blocked. No choice, we&rsquo;ll have to create ACL rules for each of them.</p><p>So, let&rsquo;s take this opportunity to authenticate them to prevent any application from communicating with containers it doesn&rsquo;t need.</p><h3 id=authentication-by-sa>Authentication by SA<a href=#authentication-by-sa class=post-heading__anchor aria-hidden=true>#</a></h3><p>Let&rsquo;s move on to service authentication. The goal is to allow a service to communicate with another using a ServiceAccount as the authentication key. As a result, only those with the correct ServiceAccount will be able to communicate with those authorized.</p><p>In this case, here are the rules we&rsquo;re going to implement:</p><ul><li>&ldquo;details&rdquo; must be accessible by &ldquo;productpage&rdquo; ;</li><li>&ldquo;ratings&rdquo; must be accessible by &ldquo;reviews&rdquo; ;</li><li>&ldquo;reviews&rdquo; must be accessible by &ldquo;productpage&rdquo;.</li></ul><p>The &ldquo;bookinfo&rdquo; application has provided ServiceAccounts for each service. Here are the ones available:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get sa                       
</span></span><span style=display:flex><span>NAME                   SECRETS   AGE
</span></span><span style=display:flex><span>bookinfo-details       <span style=color:#ae81ff>0</span>         3d19h
</span></span><span style=display:flex><span>bookinfo-productpage   <span style=color:#ae81ff>0</span>         3d19h
</span></span><span style=display:flex><span>bookinfo-ratings       <span style=color:#ae81ff>0</span>         3d19h
</span></span><span style=display:flex><span>bookinfo-reviews       <span style=color:#ae81ff>0</span>         3d19h
</span></span><span style=display:flex><span>default                <span style=color:#ae81ff>0</span>         4d11h
</span></span></code></pre></div><p>Let&rsquo;s start by allowing &ldquo;details&rdquo; to be accessible by &ldquo;productpage&rdquo;.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>security.istio.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>AuthorizationPolicy</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>allow-details</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>details</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>action</span>: <span style=color:#ae81ff>ALLOW</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>rules</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>from</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>source</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>principals</span>: [<span style=color:#e6db74>&#34;cluster.local/ns/default/sa/bookinfo-productpage&#34;</span>]
</span></span><span style=display:flex><span>    <span style=color:#f92672>to</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>operation</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>methods</span>: [<span style=color:#e6db74>&#34;GET&#34;</span>]
</span></span><span style=display:flex><span>        <span style=color:#f92672>paths</span>: [<span style=color:#e6db74>&#34;/details/*&#34;</span>]
</span></span></code></pre></div><p>From ProductPage, the &ldquo;details&rdquo; information is well displayed:</p><p><img src=https://a-cup-of.coffee/blog/istio/_resources/allow-details.png alt="alt text"></p><p>But if I try to access &ldquo;details&rdquo; from &ldquo;ratings&rdquo;, I get a 403 (Forbidden) error:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl exec deployments/ratings-v1 -c ratings -- curl -s http://details:9080/details/0
</span></span><span style=display:flex><span>RBAC: access denied
</span></span></code></pre></div><p><img src=https://a-cup-of.coffee/blog/istio/_resources/kiali-allow-details.png alt="alt text"></p><p>Now, let&rsquo;s move on to the other services. Here are the ACL rules to allow &ldquo;ratings&rdquo; and &ldquo;reviews&rdquo;:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>security.istio.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>AuthorizationPolicy</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>allow-reviews</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>reviews</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>action</span>: <span style=color:#ae81ff>ALLOW</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>rules</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>from</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>source</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>principals</span>: [<span style=color:#e6db74>&#34;cluster.local/ns/default/sa/bookinfo-productpage&#34;</span>]
</span></span><span style=display:flex><span>    <span style=color:#f92672>to</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>operation</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>methods</span>: [<span style=color:#e6db74>&#34;GET&#34;</span>]
</span></span><span style=display:flex><span>        <span style=color:#f92672>paths</span>: [<span style=color:#e6db74>&#34;/reviews/*&#34;</span>]
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>security.istio.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>AuthorizationPolicy</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>allow-ratings</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>ratings</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>action</span>: <span style=color:#ae81ff>ALLOW</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>rules</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>from</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>source</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>principals</span>: [<span style=color:#e6db74>&#34;cluster.local/ns/default/sa/bookinfo-reviews&#34;</span>]
</span></span><span style=display:flex><span>    <span style=color:#f92672>to</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>operation</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>methods</span>: [<span style=color:#e6db74>&#34;GET&#34;</span>]
</span></span><span style=display:flex><span>        <span style=color:#f92672>paths</span>: [<span style=color:#e6db74>&#34;/ratings/*&#34;</span>]
</span></span></code></pre></div><p>After applying these rules, we can see that &ldquo;ratings&rdquo; and &ldquo;reviews&rdquo; are accessible again from &ldquo;productpage&rdquo;:</p><p><img src=https://a-cup-of.coffee/blog/istio/_resources/allow-all.png alt="alt text"></p><h3 id=jwt-authentication>JWT Authentication<a href=#jwt-authentication class=post-heading__anchor aria-hidden=true>#</a></h3><p>Now that we have seen how to authenticate services with ServiceAccounts, let&rsquo;s see how we can authenticate requests with JWT (JSON Web Tokens). This method is a bit more complex and requires that the applications&rsquo; requests be adapted to send a JWT <em>(Envoy won&rsquo;t do it for us)</em>.</p><div class="notice info"><p class=notice-title><span class="icon-notice baseline"><svg xmlns="http://www.w3.org/2000/svg" viewBox="92 59.5 300 300"><path d="M292 303.25V272c0-3.516-2.734-6.25-6.25-6.25H267v-1e2c0-3.516-2.734-6.25-6.25-6.25h-62.5c-3.516.0-6.25 2.734-6.25 6.25V197c0 3.516 2.734 6.25 6.25 6.25H217v62.5h-18.75c-3.516.0-6.25 2.734-6.25 6.25v31.25c0 3.516 2.734 6.25 6.25 6.25h87.5c3.516.0 6.25-2.734 6.25-6.25zm-25-175V97c0-3.516-2.734-6.25-6.25-6.25h-37.5c-3.516.0-6.25 2.734-6.25 6.25v31.25c0 3.516 2.734 6.25 6.25 6.25h37.5c3.516.0 6.25-2.734 6.25-6.25zm125 81.25c0 82.813-67.188 150-150 150-82.813.0-150-67.188-150-150 0-82.813 67.188-150 150-150 82.813.0 150 67.188 150 150z"/></svg></span>Info</p><p>JWT, or JSON Web Token, is an open standard for creating access tokens that secure the exchange of information between parties. A JWT contains information (called &ldquo;claims&rdquo;) about the user, encoded in JSON. They are digitally signed, usually with a private key, to ensure their authenticity.</p></div><p>In this part, I will <strong>strongly</strong> draw inspiration from the <a href=https://github.com/infracloudio/Python-Key-Generation class=link--external target=_blank rel=noreferrer>InfraCloud Github repository</a> without which I would not have been able to implement JWTs in Istio. Thanks to them for their work!</p><p>We will start by generating a private and public key to sign the JWTs. For this, we will use OpenSSL to generate an RSA key. A secret will be required to protect the private key.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>openssl genrsa -aes256 -out private_encrypted.pem <span style=color:#ae81ff>4096</span>
</span></span><span style=display:flex><span>openssl rsa -pubout -in private_encrypted.pem -out public.pem
</span></span><span style=display:flex><span>openssl rsa -in private_encrypted.pem -out private.pem -outform PEM
</span></span></code></pre></div><p>We get three files: <code>private.pem</code>, <code>public.pem</code>, and <code>private_encrypted.pem</code>.</p><p>Now, we&rsquo;re going to generate a JWT key using <code>private.pem</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># generatekey.py</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> authlib.jose <span style=color:#f92672>import</span> jwt
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span>JWT_ISSUER<span style=color:#f92672>=</span>os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#39;JWT_ISSUER&#39;</span>) <span style=color:#75715e># ex: qjoly@a-cup-of.coffee</span>
</span></span><span style=display:flex><span>JWT_EXPIRATION<span style=color:#f92672>=</span>int(os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#39;JWT_EXPIRATION&#39;</span>)) <span style=color:#75715e># ex: 1685505001</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>header <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#39;alg&#39;</span>: <span style=color:#e6db74>&#39;RS256&#39;</span>}
</span></span><span style=display:flex><span>payload <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#39;iss&#39;</span>: JWT_ISSUER, <span style=color:#e6db74>&#39;sub&#39;</span>: <span style=color:#e6db74>&#39;admin&#39;</span>, <span style=color:#e6db74>&#39;exp&#39;</span>: JWT_EXPIRATION}
</span></span><span style=display:flex><span>private_key <span style=color:#f92672>=</span> open(<span style=color:#e6db74>&#39;private.pem&#39;</span>, <span style=color:#e6db74>&#39;r&#39;</span>)<span style=color:#f92672>.</span>read() <span style=color:#75715e>#Provide the path to your private key</span>
</span></span><span style=display:flex><span>bytes <span style=color:#f92672>=</span> jwt<span style=color:#f92672>.</span>encode(header, payload, private_key)
</span></span><span style=display:flex><span>print(bytes<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#39;utf-8&#39;</span>))
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export JWT_EXPIRATION<span style=color:#f92672>=</span><span style=color:#ae81ff>1782191719000</span>
</span></span><span style=display:flex><span>export JWT_ISSUER<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;qjoly@a-cup-of.coffee&#34;</span>
</span></span><span style=display:flex><span>export JWT_TOKEN<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>python3 generatekey.py<span style=color:#66d9ef>)</span>
</span></span></code></pre></div><p>For the JWT_EXPIRATION variable, you can use the <a href=https://www.epochconverter.com/ class=link--external target=_blank rel=noreferrer>Epoch Converter</a> site to convert a date to a timestamp.</p><p>Let&rsquo;s now verify that the public key correctly validates the JWT:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># validatekey.py</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span>JWT_TOKEN<span style=color:#f92672>=</span>os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#39;JWT_TOKEN&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> authlib.jose <span style=color:#f92672>import</span> jwt
</span></span><span style=display:flex><span>public_key <span style=color:#f92672>=</span> open(<span style=color:#e6db74>&#39;public.pem&#39;</span>, <span style=color:#e6db74>&#39;r&#39;</span>)<span style=color:#f92672>.</span>read() <span style=color:#75715e>#Provide path to your public key</span>
</span></span><span style=display:flex><span>claims <span style=color:#f92672>=</span> jwt<span style=color:#f92672>.</span>decode(JWT_TOKEN, public_key)
</span></span><span style=display:flex><span>claims<span style=color:#f92672>.</span>validate()
</span></span><span style=display:flex><span>print(claims)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python3 validatetoken.py
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#39;iss&#39;</span>: <span style=color:#e6db74>&#39;qjoly@a-cup-of.coffee&#39;</span>, <span style=color:#e6db74>&#39;sub&#39;</span>: <span style=color:#e6db74>&#39;admin&#39;</span>, <span style=color:#e6db74>&#39;exp&#39;</span>: 1782191719000<span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Our token is well recognized and valid (and fortunately, because it&rsquo;s the same mechanism that will be used by Istio to authenticate requests).</p><p>Let&rsquo;s now generate a JWK (JSON Web Key) from our public key to configure it in Istio.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> authlib.jose <span style=color:#f92672>import</span> jwk
</span></span><span style=display:flex><span>public_key <span style=color:#f92672>=</span> open(<span style=color:#e6db74>&#39;public.pem&#39;</span>, <span style=color:#e6db74>&#39;r&#39;</span>)<span style=color:#f92672>.</span>read() <span style=color:#75715e>#Provide path to your public key</span>
</span></span><span style=display:flex><span>key <span style=color:#f92672>=</span> jwk<span style=color:#f92672>.</span>dumps(public_key, kty<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;RSA&#39;</span>)
</span></span><span style=display:flex><span>print(key)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python3 generatejwk.py
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#39;n&#39;</span>: <span style=color:#e6db74>&#39;rPbn21rfrOrjq5AZ4W6XMjfpUu0SMIAIY9zj6skWWRMEYJn4Jvj6v3olLgMd0JjJluPXxgBYalIL2Fv9mKnZIyFcaCWDkTKBj1xN9k4PN-g5pPSGtYEYHT-zfdBfH-8inea8c9XoQGwyqm7TEwmI4M43WsBoqsItBcB_rLTo8DLlRf0mzlbTeK-M0iEC8-Osfj2FV9vtHR_FdsWaLK5QN-c8aJZIAZQ_S81EvRzVYguJ2-3l05JNI0GGNdGwawvp4cXmvIlCGEuZ5fdNJTjd3pcEJqMR8Gzyd_kb32SiHDXvTdI48KHPo_EjUf_i1maufxJToqEBOPwjEdpg1D1BPQ&#39;</span>, <span style=color:#e6db74>&#39;e&#39;</span>: <span style=color:#e6db74>&#39;AQAB&#39;</span>, <span style=color:#e6db74>&#39;kty&#39;</span>: <span style=color:#e6db74>&#39;RSA&#39;</span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>We provide the JSON generated by <code>generatejwk.py</code> to Istio so it can validate the JWTs in requests to &ldquo;productpage&rdquo;.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>security.istio.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>RequestAuthentication</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span> <span style=color:#f92672>name</span>: <span style=color:#ae81ff>productpage-jwt</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>productpage</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>jwtRules</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>forwardOriginalToken</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>issuer</span>: <span style=color:#ae81ff>qjoly@a-cup-of.coffee</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>jwks</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      {&#34;keys&#34;: [{&#34;n&#34;: &#34;rPbn21rfrOrjq5AZ4W6XMjfpUu0SMIAIY9zj6skWWRMEYJn4Jvj6v3olLgMd0JjJluPXxgBYalIL2Fv9mKnZIyFcaCWDkTKBj1xN9k4PN-g5pPSGtYEYHT-zfdBfH-8inea8c9XoQGwyqm7TEwmI4M43WsBoqsItBcB_rLTo8DLlRf0mzlbTeK-M0iEC8-Osfj2FV9vtHR_FdsWaLK5QN-c8aJZIAZQ_S81EvRzVYguJ2-3l05JNI0GGNdGwawvp4cXmvIlCGEuZ5fdNJTjd3pcEJqMR8Gzyd_kb32SiHDXvTdI48KHPo_EjUf_i1maufxJToqEBOPwjEdpg1D1BPQ&#34;, &#34;e&#34;: &#34;AQAB&#34;, &#34;kty&#34;: &#34;RSA&#34;}]}</span>      
</span></span></code></pre></div><p>We can now apply an ACL rule to allow traffic on the &ldquo;productpage&rdquo; only if the JWT is signed by the issuer &ldquo;<a href=mailto:qjoly@a-cup-of.coffee>qjoly@a-cup-of.coffee</a>&rdquo;.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>security.istio.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>AuthorizationPolicy</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>productpage-jwt</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>productpage</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>action</span>: <span style=color:#ae81ff>ALLOW</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>rules</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>when</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>key</span>: <span style=color:#ae81ff>request.auth.claims[iss]</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>values</span>: [<span style=color:#e6db74>&#34;qjoly@a-cup-of.coffee&#34;</span>]
</span></span></code></pre></div><p>Now that everything is in place, let&rsquo;s delete the ACL rule created in the previous step (the one that allowed all traffic on the &ldquo;productpage&rdquo;) :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl delete authorizationpolicies.security.istio.io allow-productpage
</span></span></code></pre></div><p>In this configuration, I allow traffic on the &ldquo;productpage&rdquo; <strong>only</strong> if the JWT is signed by the issuer &ldquo;<code>qjoly@a-cup-of.coffee</code>&rdquo;. Let&rsquo;s try making a request to verify this :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl $INGRESS_HOST:$INGRESS_PORT/productpage -s -I
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#ae81ff>403</span> Forbidden
</span></span><span style=display:flex><span>server: istio-envoy
</span></span><span style=display:flex><span>date: Sun, <span style=color:#ae81ff>23</span> Jun <span style=color:#ae81ff>2024</span> 06:13:26 GMT
</span></span><span style=display:flex><span>x-envoy-upstream-service-time: <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>Now let&rsquo;s test with a valid JWT (remember, I generated the token from the command <code>export JWT_TOKEN=$(python3 generatekey.py)</code>).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl $INGRESS_HOST:$INGRESS_PORT/productpage --header <span style=color:#e6db74>&#34;Authorization: Bearer </span>$JWT_TOKEN<span style=color:#e6db74>&#34;</span> -s -I
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#ae81ff>200</span> OK
</span></span><span style=display:flex><span>server: istio-envoy
</span></span><span style=display:flex><span>date: Sun, <span style=color:#ae81ff>23</span> Jun <span style=color:#ae81ff>2024</span> 06:16:08 GMT
</span></span><span style=display:flex><span>x-envoy-upstream-service-time: <span style=color:#ae81ff>17</span>
</span></span></code></pre></div><p>And with an invalid JWT:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl $INGRESS_HOST:$INGRESS_PORT/productpage --header <span style=color:#e6db74>&#34;Authorization: Bearer a-cup</span><span style=color:#e6db74>${</span>JWT_TOKEN<span style=color:#e6db74>}</span><span style=color:#e6db74>of-coffee&#34;</span> -s -I
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#ae81ff>401</span> Unauthorized
</span></span><span style=display:flex><span>www-authenticate: Bearer realm<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://192.168.128.30:30492/productpage&#34;</span>, error<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;invalid_token&#34;</span>
</span></span><span style=display:flex><span>content-length: <span style=color:#ae81ff>42</span>
</span></span><span style=display:flex><span>content-type: text/plain
</span></span><span style=display:flex><span>date: Sun, <span style=color:#ae81ff>23</span> Jun <span style=color:#ae81ff>2024</span> 06:18:14 GMT
</span></span><span style=display:flex><span>server: istio-envoy
</span></span><span style=display:flex><span>x-envoy-upstream-service-time: <span style=color:#ae81ff>5</span>
</span></span></code></pre></div><h2 id=managing-external-access>Managing External Access<a href=#managing-external-access class=post-heading__anchor aria-hidden=true>#</a></h2><p>It is possible to ask Envoy to manage external services (i.e. services that are not in the Istio mesh). This can be useful for managing communications to third-party services while taking advantage of Istio&rsquo;s features (retries, observability, bandwidth management, etc).</p><p>To do this, you can use a <strong>ServiceEntry</strong> to declare an external service. Here is an example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.istio.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ServiceEntry</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>coffee-website</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>a-cup-of.coffee</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>une-tasse-de.cafe</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>location</span>: <span style=color:#ae81ff>MESH_EXTERNAL</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>number</span>: <span style=color:#ae81ff>443</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>https</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TLS</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>resolution</span>: <span style=color:#ae81ff>DNS</span>
</span></span></code></pre></div><p>For our tests, I will declare a pod that will allow us to make requests to external services.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Pod</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>debug-network</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>debug</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>digitalocean/doks-debug:latest</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span>: [ <span style=color:#e6db74>&#34;sleep&#34;</span>, <span style=color:#e6db74>&#34;infinity&#34;</span> ]
</span></span></code></pre></div><p>I will generate some requests via this pod to see how Istio handles requests to a registered service.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#66d9ef>while</span> true; <span style=color:#66d9ef>do</span> kubectl exec pods/debug-network -c debug exec -- curl https://a-cup-of.coffee ; <span style=color:#66d9ef>done</span>
</span></span></code></pre></div><p><img src=https://a-cup-of.coffee/blog/istio/_resources/se-blog-coffee.png alt="alt text"></p><p>We can see that Istio recognizes the ServiceEntry well.</p><p>Let&rsquo;s now try a request to a service not declared in a ServiceEntry:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl exec pods/debug-network -c debug exec -- curl https://perdu.com
</span></span></code></pre></div><p><img src=https://a-cup-of.coffee/blog/istio/_resources/854dc23b91c2fd92f6f75e6ea4bddb48.png alt=854dc23b91c2fd92f6f75e6ea4bddb48.png>
The traffic is sent to the &ldquo;PassThroughCluster&rdquo; <em>(which indicates that requests are handled normally like a classic pod (Envoy does not process the request))</em>.</p><p>Let&rsquo;s now consider the case where I want to limit the outgoing traffic from my cluster. To do this, I will modify the settings of my Istio mesh to block all outgoing traffic except that which is declared in a ServiceEntry.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>istioctl upgrade --set meshConfig.outboundTrafficPolicy.mode<span style=color:#f92672>=</span>REGISTRY_ONLY
</span></span></code></pre></div><p>Then, if I retry the request to <code>perdu.com</code>, I will get an error:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl exec pods/debug-network -c debug exec -- curl https://perdu.com/ -v
</span></span><span style=display:flex><span>Ã¹* Recv failure: Connection reset by peer
</span></span><span style=display:flex><span>* OpenSSL SSL_connect: Connection reset by peer in connection to perdu.com:443
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>0</span>     <span style=color:#ae81ff>0</span>    <span style=color:#ae81ff>0</span>     <span style=color:#ae81ff>0</span>    <span style=color:#ae81ff>0</span>     <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>0</span> --:--:-- --:--:-- --:--:--     <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>* Closing connection <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>curl: <span style=color:#f92672>(</span>35<span style=color:#f92672>)</span> Recv failure: Connection reset by peer
</span></span><span style=display:flex><span>command terminated with exit code <span style=color:#ae81ff>35</span>
</span></span></code></pre></div><p>On the other hand, if I make a request to <code>a-cup-of.coffee</code>, the request is successfully sent:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl exec pods/debug-network -c debug exec -- curl https://a-cup-of.coffee -I -s
</span></span><span style=display:flex><span>HTTP/2 <span style=color:#ae81ff>200</span>
</span></span><span style=display:flex><span>accept-ranges: bytes
</span></span><span style=display:flex><span>content-type: text/html
</span></span><span style=display:flex><span>server: lighttpd/1.4.71
</span></span></code></pre></div><div class="notice note"><p class=notice-title><span class="icon-notice baseline"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 128 300 300"><path d="M150 128c82.813.0 150 67.188 150 150 0 82.813-67.188 150-150 150C67.187 428 0 360.812.0 278c0-82.813 67.188-150 150-150zm25 243.555v-37.11c0-3.515-2.734-6.445-6.055-6.445h-37.5c-3.515.0-6.445 2.93-6.445 6.445v37.11c0 3.515 2.93 6.445 6.445 6.445h37.5c3.32.0 6.055-2.93 6.055-6.445zm-.39-67.188 3.515-121.289c0-1.367-.586-2.734-1.953-3.516-1.172-.976-2.93-1.562-4.688-1.562h-42.968c-1.758.0-3.516.586-4.688 1.563-1.367.78-1.953 2.148-1.953 3.515l3.32 121.29c0 2.734 2.93 4.882 6.64 4.882h36.134c3.515.0 6.445-2.148 6.64-4.883z"/></svg></span>Note</p><p>To return to the default mode, simply set the <code>meshConfig.outboundTrafficPolicy.mode</code> variable to <code>ALLOW_ANY</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>istioctl upgrade --set meshConfig.outboundTrafficPolicy.mode<span style=color:#f92672>=</span>ALLOW_ANY
</span></span></code></pre></div></div><p>Note that the <code>REGISTRY_ONLY</code> mode allows traffic on all services declared in a ServiceEntry for each pod. I haven&rsquo;t yet found how to limit outgoing traffic to a single application. For example, limiting outgoing traffic from &ldquo;productpage&rdquo; to &ldquo;a-cup-of.coffee&rdquo; and limiting that from &ldquo;reviews&rdquo; to &ldquo;une-tasse-de.cafe&rdquo;.</p><h1 id=tired-of-sidecars>Tired of sidecars?<a href=#tired-of-sidecars class=post-heading__anchor aria-hidden=true>#</a></h1><p>Istio offers a feature called &ldquo;Ambient&rdquo; that allows not deploying a sidecar in each pod. In this mode, Istio acts as a CNI (Container Network Interface) and intercepts incoming and outgoing network traffic from pods to apply security rules.</p><p>The primary goal of this mode is to reduce resource consumption (CPU, memory) by avoiding the deployment of a sidecar in each pod, as well as to increase the performance of the Istio mesh. We will see if this is truly the case in a dedicated section.</p><p>So, how can the &ldquo;Ambient&rdquo; mode improve the performance of the Istio mesh, you ask? Well, by reducing the number of sidecars and thus the number of L7 processing steps for each request.</p><blockquote><p>Instead the biggest culprit is the intensive L7 processing Istio needs to implement its sophisticated feature set. Unlike sidecars, which implement two L7 processing steps for each connection (one for each sidecar), ambient mesh collapses these two steps into one. In most cases, we expect this reduced processing cost to compensate for an additional network hop.
<a href=https://istio.io/latest/blog/2022/introducing-ambient-mesh/ class=link--external target=_blank rel=noreferrer>source</a></p></blockquote><p>To activate the &ldquo;Ambient&rdquo; mode, we need to install Istio with the <code>ambient</code> profile and add the Gateway API (an official Kubernetes project aiming to replace Ingress with new objects. If you&rsquo;re interested in the subject, you can consult the documentation <a href=https://istio.io/latest/docs/reference/config/networking/gateway/ class=link--external target=_blank rel=noreferrer>here</a>).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>istioctl install --set profile<span style=color:#f92672>=</span>ambient --skip-confirmation
</span></span><span style=display:flex><span>kubectl get crd gateways.gateway.networking.k8s.io &amp;&gt; /dev/null <span style=color:#f92672>||</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  <span style=color:#f92672>{</span> kubectl kustomize <span style=color:#e6db74>&#34;github.com/kubernetes-sigs/gateway-api/config/crd/experimental?ref=v1.1.0&#34;</span> | kubectl apply -f -; <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Ambient uses a new label for namespaces: <code>istio.io/dataplane-mode=ambient</code>. We can apply it to the &ldquo;coffee&rdquo; namespace to activate the &ldquo;Ambient&rdquo; mode and remove the <code>istio-injection</code> label to disable automatic sidecar injection.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl label namespace coffee istio.io/dataplane-mode<span style=color:#f92672>=</span>ambient
</span></span><span style=display:flex><span>kubectl label namespace default istio-injection- 
</span></span><span style=display:flex><span>kubectl rollout restart deployment -n default details-v1 productpage-v1 ratings-v1 reviews-v1 reviews-v2 reviews-v3 
</span></span></code></pre></div><p>Now, there is no need for the &ldquo;istio-ingressgateway&rdquo; service to manage incoming traffic, we can directly use the Gateway object..</p><p>To do this, we apply the following configuration:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>gateway.networking.k8s.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Gateway</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>bookinfo-gateway</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>gatewayClassName</span>: <span style=color:#ae81ff>istio</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>listeners</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>port</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>HTTP</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>allowedRoutes</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>namespaces</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>from</span>: <span style=color:#ae81ff>Same</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>gateway.networking.k8s.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>HTTPRoute</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>bookinfo</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>parentRefs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>bookinfo-gateway</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>rules</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>matches</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>path</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>type</span>: <span style=color:#ae81ff>Exact</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#ae81ff>/productpage</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>path</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>type</span>: <span style=color:#ae81ff>PathPrefix</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#ae81ff>/static</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>path</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>type</span>: <span style=color:#ae81ff>Exact</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#ae81ff>/login</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>path</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>type</span>: <span style=color:#ae81ff>Exact</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#ae81ff>/logout</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>path</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>type</span>: <span style=color:#ae81ff>PathPrefix</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#ae81ff>/api/v1/products</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>backendRefs</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>productpage</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>port</span>: <span style=color:#ae81ff>9080</span>
</span></span></code></pre></div><p>A &ldquo;gateway&rdquo; pod is successfully deployed:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get pods
</span></span><span style=display:flex><span>NAME                                      READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>bookinfo-gateway-istio-7c755f6876-t59dn   1/1     Running   <span style=color:#ae81ff>0</span>          14s
</span></span><span style=display:flex><span>details-v1-cf74bb974-ph5dd                1/1     Running   <span style=color:#ae81ff>0</span>          50s
</span></span><span style=display:flex><span>productpage-v1-87d54dd59-nwxgd            1/1     Running   <span style=color:#ae81ff>0</span>          49s
</span></span><span style=display:flex><span>ratings-v1-7c4bbf97db-sq475               1/1     Running   <span style=color:#ae81ff>0</span>          50s
</span></span><span style=display:flex><span>reviews-v1-5fd6d4f8f8-2r4dz               1/1     Running   <span style=color:#ae81ff>0</span>          50s
</span></span><span style=display:flex><span>reviews-v2-6f9b55c5db-4fkwb               1/1     Running   <span style=color:#ae81ff>0</span>          50s
</span></span><span style=display:flex><span>reviews-v3-7d99fd7978-nbbdr               1/1     Running   <span style=color:#ae81ff>0</span>          49s
</span></span></code></pre></div><p>Without a LoadBalancer, I will expose the &ldquo;bookinfo-gateway&rdquo; service as a NodePort to access the application from the outside.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl annotate gateway bookinfo-gateway networking.istio.io/service-type<span style=color:#f92672>=</span>NodePort --namespace<span style=color:#f92672>=</span>default
</span></span><span style=display:flex><span>$ kubectl get svc 
</span></span><span style=display:flex><span>NAME                     TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>                        AGE
</span></span><span style=display:flex><span>bookinfo-gateway-istio   NodePort    10.98.171.168   &lt;none&gt;        15021:31677/TCP,80:31334/TCP   17s
</span></span><span style=display:flex><span>details                  ClusterIP   10.105.80.56    &lt;none&gt;        9080/TCP                       51s
</span></span><span style=display:flex><span>productpage              ClusterIP   10.109.221.79   &lt;none&gt;        9080/TCP                       51s
</span></span><span style=display:flex><span>ratings                  ClusterIP   10.102.161.80   &lt;none&gt;        9080/TCP                       51s
</span></span><span style=display:flex><span>reviews                  ClusterIP   10.100.182.23   &lt;none&gt;        9080/TCP                       51s
</span></span></code></pre></div><p>The following commands are used to find the port of our gateway service:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export INGRESS_PORT<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>kubectl get service bookinfo-gateway-istio -o jsonpath<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{.spec.ports[?(@.name==&#34;http&#34;)].nodePort}&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>export INGRESS_HOST<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>kubectl get nodes -o jsonpath<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{.items[0].status.addresses[?(@.type==&#34;InternalIP&#34;)].address}&#39;</span><span style=color:#66d9ef>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl $INGRESS_HOST:$INGRESS_PORT/productpage -I
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#ae81ff>200</span> OK
</span></span><span style=display:flex><span>server: istio-envoy
</span></span><span style=display:flex><span>date: Tue, <span style=color:#ae81ff>25</span> Jun <span style=color:#ae81ff>2024</span> 20:55:31 GMT
</span></span><span style=display:flex><span>content-type: text/html; charset<span style=color:#f92672>=</span>utf-8
</span></span><span style=display:flex><span>content-length: <span style=color:#ae81ff>4294</span>
</span></span><span style=display:flex><span>vary: Cookie
</span></span><span style=display:flex><span>x-envoy-upstream-service-time: <span style=color:#ae81ff>28</span>
</span></span></code></pre></div><p><img src=https://a-cup-of.coffee/blog/istio/_resources/ambient-kiali.png alt="alt text"></p><p>In this case, traffic is only managed at L4 (and no longer at L7 as was the case with sidecars). This allows for reducing the load on pods and improving the performance of the Istio mesh. However, some features like HTTP traffic management (retries, circuit breaker, etc.) are lost. It is possible to mitigate this issue by using Gateways (or &ldquo;Waypoint&rdquo; in Istio terminology) to manage HTTP traffic.</p><p>I will continue to explore the &ldquo;Ambient&rdquo; mode in a future article to clarify these areas of uncertainty.</p><h1 id=performance-benchmark>Performance Benchmark<a href=#performance-benchmark class=post-heading__anchor aria-hidden=true>#</a></h1><p>Finally, I will perform a performance benchmark to see how Istio impacts the performance of my Kubernetes cluster. To do this, we will compare two communication methods (HTTP and TCP) across three different scenarios:</p><ul><li>Without Istio;</li><li>with Istio;</li><li>with Istio in &ldquo;Ambient&rdquo; mode.</li></ul><p>For this, I will use <a href=https://fortio.org/ class=link--external target=_blank rel=noreferrer>Fortio</a> which is a benchmarking tool for HTTP and TCP services developed by Istio.</p><p>The CNI used in my cluster is Flannel (I had issues between Cilium and Istio Ambient). However, I still performed a performance test with Cilium to give you an idea of the bandwidth between my pods.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ð¥ Network Performance Test Summary <span style=color:#f92672>[</span>cilium-test<span style=color:#f92672>]</span>:
</span></span><span style=display:flex><span>--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
</span></span><span style=display:flex><span>ð Scenario        | Node       | Test            | Duration        | Min             | Mean            | Max             | P50             | P90             | P99             | Transaction rate OP/s
</span></span><span style=display:flex><span>--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
</span></span><span style=display:flex><span>ð pod-to-pod      | same-node  | TCP_RR          | 10s             | 27Âµs            | 75.32Âµs         | 8.115ms         | 69Âµs            | 108Âµs           | 211Âµs           | 13149.99
</span></span><span style=display:flex><span>ð pod-to-pod      | same-node  | UDP_RR          | 10s             | 29Âµs            | 81.06Âµs         | 23.993ms        | 67Âµs            | 113Âµs           | 308Âµs           | 12222.58
</span></span><span style=display:flex><span>ð pod-to-pod      | same-node  | TCP_CRR         | 10s             | 143Âµs           | 320.87Âµs        | 14.373ms        | 284Âµs           | 411Âµs           | 1.068ms         | 3106.70
</span></span><span style=display:flex><span>ð pod-to-pod      | other-node | TCP_RR          | 10s             | 129Âµs           | 298.52Âµs        | 14.168ms        | 245Âµs           | 395Âµs           | 1.197ms         | 3340.77
</span></span><span style=display:flex><span>ð pod-to-pod      | other-node | UDP_RR          | 10s             | 147Âµs           | 382.21Âµs        | 37.771ms        | 309Âµs           | 573Âµs           | 1.534ms         | 2609.31
</span></span><span style=display:flex><span>ð pod-to-pod      | other-node | TCP_CRR         | 10s             | 440Âµs           | 1.21346ms       | 17.531ms        | 1.061ms         | 1.797ms         | 4.255ms         | 823.03
</span></span><span style=display:flex><span>--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
</span></span><span style=display:flex><span>-------------------------------------------------------------------------------------
</span></span><span style=display:flex><span>ð Scenario        | Node       | Test            | Duration        | Throughput Mb/s
</span></span><span style=display:flex><span>-------------------------------------------------------------------------------------
</span></span><span style=display:flex><span>ð pod-to-pod      | same-node  | TCP_STREAM      | 10s             | 610.56
</span></span><span style=display:flex><span>ð pod-to-pod      | same-node  | UDP_STREAM      | 10s             | 272.15
</span></span><span style=display:flex><span>ð pod-to-pod      | other-node | TCP_STREAM      | 10s             | 1506.68
</span></span><span style=display:flex><span>ð pod-to-pod      | other-node | UDP_STREAM      | 10s             | 209.39
</span></span><span style=display:flex><span>-------------------------------------------------------------------------------------
</span></span></code></pre></div><p>Now that we have an idea of the maximum achievable performance, we&rsquo;re going to start our benchmark.</p><p>It will consist of two parts:</p><ul><li>An HTTP part with Fortio to test latency;</li><li>a TCP part with Iperf to test bandwidth.</li></ul><p><strong>Small disclaimer:</strong> The results I will obtain may not be the same as yours. Performance can vary depending on the configuration of your cluster, the load on it, the configuration of your application, etc. The results I will obtain are not necessarily representative of reality. They are there to give an idea of Istio&rsquo;s performance in a Kubernetes cluster for a given use case.</p><p>If you want to read a slightly more comprehensive benchmark, I invite you to consult <a href=https://github.com/livewyer-ops/poc-servicemesh2024/blob/main/docs/test-report.md#network-tests class=link--external target=_blank rel=noreferrer>this Github repository</a> offering very complete and interesting results.</p><h2 id=http-benchmark>HTTP Benchmark<a href=#http-benchmark class=post-heading__anchor aria-hidden=true>#</a></h2><p>As I mentioned earlier, I will use Fortio to test the latency of my services. To do this, I will deploy a Fortio pod in my cluster and make requests to one of the services of the &ldquo;bookinfo&rdquo; application: &ldquo;details&rdquo;.</p><p>To install Fortio, I first deployed <a href=https://github.com/verfio/fortio-operator class=link--external target=_blank rel=noreferrer>the Fortio operator</a> before preferring a classic deployment (KISS).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>fortio-debug</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>port</span>: <span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>http-debug</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>fortio-debug</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>fortio-debug-deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span> 
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>fortio-debug</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>: 
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>fortio-debug</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>fortio-debug</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>fortio/fortio:latest_release</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>Always</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>8080</span>
</span></span></code></pre></div><p>To launch and configure the tests, I simply did a port-forward on the Fortio pod:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl port-forward svc/fortio-debug 8080:8080
</span></span></code></pre></div><p>The rest of the configuration is done directly on the Fortio web interface at <code>http://localhost:8080/fortio/</code>. I chose to perform latency tests with 10 simultaneous connections each making 100 requests per second. Of course, I made sure the tests were always between two different nodes.</p><p><img src=https://a-cup-of.coffee/blog/istio/_resources/fortio-web.png alt="alt text"></p><p>Here are the results obtained for the three scenarios:</p><h3 id=without-istio>Without Istio<a href=#without-istio class=post-heading__anchor aria-hidden=true>#</a></h3><p><img src=https://a-cup-of.coffee/blog/istio/_resources/6f25496656b67355c3149d7b819b8def.png alt=6f25496656b67355c3149d7b819b8def.png></p><h3 id=with-istio-sidecar>With Istio sidecar<a href=#with-istio-sidecar class=post-heading__anchor aria-hidden=true>#</a></h3><p><img src=https://a-cup-of.coffee/blog/istio/_resources/f1b75ffbb034f1aadbcedad63815c95a.png alt=f1b75ffbb034f1aadbcedad63815c95a.png></p><h3 id=with-istio-ambient>With Istio Ambient<a href=#with-istio-ambient class=post-heading__anchor aria-hidden=true>#</a></h3><p><img src=https://a-cup-of.coffee/blog/istio/_resources/1141abfb3858c60718eefbe6e3125d98.png alt=1141abfb3858c60718eefbe6e3125d98.png></p><p>What&rsquo;s cool is that we have very different results. In terms of latency, here&rsquo;s what it gives:</p><ol><li>Istio Ambient: 2.35ms latency;</li><li>Without Istio: 2.8ms latency;</li><li>Istio Sidecar: 39.3ms latency.</li></ol><p>I note that there were connection errors that I don&rsquo;t explain with Istio Ambient (even after performing several tests).</p><p>It&rsquo;s quite amazing that Istio Ambient manages to reduce latency compared to a cluster without Istio (I even checked the results several times to be sure). This shows that the &ldquo;Ambient&rdquo; mode is a viable solution that can potentially improve the performance of your Kubernetes cluster.</p><h2 id=tcp-benchmark>TCP Benchmark<a href=#tcp-benchmark class=post-heading__anchor aria-hidden=true>#</a></h2><p>For this benchmark, I will use Iperf to test the bandwidth between my services. I will then deploy an Iperf pod as a server and use a &ldquo;tcp-iperf-client&rdquo; pod to make requests to the Iperf server.</p><details><summary>Manifests IPerf</summary><p><strong>Client Iperf</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Pod</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tcp-iperf-client</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>debug</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>digitalocean/doks-debug:latest</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span>: [ <span style=color:#e6db74>&#34;sleep&#34;</span>, <span style=color:#e6db74>&#34;infinity&#34;</span> ]
</span></span></code></pre></div><p><strong>Serveur Iperf</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tcp-iperf</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>tcp-iperf</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>version</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>tcp-iperf</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>version</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>args</span>:
</span></span><span style=display:flex><span>        - -<span style=color:#ae81ff>s</span>
</span></span><span style=display:flex><span>        - --<span style=color:#ae81ff>port</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;5201&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>mlabbe/iperf</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>IfNotPresent</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tcp-iperf</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>5201</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tcp-app</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>tcp-iperf</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>service</span>: <span style=color:#ae81ff>tcp-iperf</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tcp-iperf</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tcp-iperf</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>port</span>: <span style=color:#ae81ff>5201</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>tcp-iperf</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>ClusterIP</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.istio.io/v1alpha3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>VirtualService</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tcp-iperf</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>:
</span></span><span style=display:flex><span>  - <span style=color:#e6db74>&#34;*&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gateways</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>tcp-iperf</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tcp</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>match</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>port</span>: <span style=color:#ae81ff>5201</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>route</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>destination</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>host</span>: <span style=color:#ae81ff>tcp-iperf</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>port</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>number</span>: <span style=color:#ae81ff>5201</span>
</span></span></code></pre></div></details><p>I will also enforce mTLS to be in a more realistic use case.</p><img src=./_resources/5e90e32fe249e74763f9760e8ddcfd81.png alt="MTLS Benchmark" style=width:50%><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Without Istio (no sidecar, no ambient)</span>
</span></span><span style=display:flex><span>iperf -c tcp-iperf --port <span style=color:#ae81ff>5201</span>
</span></span><span style=display:flex><span>------------------------------------------------------------
</span></span><span style=display:flex><span>Client connecting to tcp-iperf, TCP port <span style=color:#ae81ff>5201</span>
</span></span><span style=display:flex><span>TCP window size: 16.0 KByte <span style=color:#f92672>(</span>default<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>------------------------------------------------------------
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>  1<span style=color:#f92672>]</span> local 10.244.2.4 port <span style=color:#ae81ff>56286</span> connected with 10.102.184.216 port <span style=color:#ae81ff>5201</span> <span style=color:#f92672>(</span>icwnd/mss/irtt<span style=color:#f92672>=</span>13/1398/585<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span> ID<span style=color:#f92672>]</span> Interval       Transfer     Bandwidth
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>  1<span style=color:#f92672>]</span> 0.0000-10.0207 sec  4.22 GBytes  3.62 Gbits/sec
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># With Istio Sidecar</span>
</span></span><span style=display:flex><span>iperf -c tcp-iperf --port <span style=color:#ae81ff>5201</span>
</span></span><span style=display:flex><span>------------------------------------------------------------
</span></span><span style=display:flex><span>Client connecting to tcp-iperf, TCP port <span style=color:#ae81ff>5201</span>
</span></span><span style=display:flex><span>TCP window size: 2.50 MByte <span style=color:#f92672>(</span>default<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>------------------------------------------------------------
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>  1<span style=color:#f92672>]</span> local 10.244.2.215 port <span style=color:#ae81ff>41158</span> connected with 10.106.115.53 port <span style=color:#ae81ff>31400</span> <span style=color:#f92672>(</span>icwnd/mss/irtt<span style=color:#f92672>=</span>13/1398/34<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span> ID<span style=color:#f92672>]</span> Interval       Transfer     Bandwidth
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>  1<span style=color:#f92672>]</span> 0.0000-10.1227 sec  2.22 GBytes  1.88 Gbits/sec
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># With Istio Ambient</span>
</span></span><span style=display:flex><span> iperf -c tcp-iperf --port <span style=color:#ae81ff>5201</span>
</span></span><span style=display:flex><span>------------------------------------------------------------
</span></span><span style=display:flex><span>Client connecting to tcp-iperf, TCP port <span style=color:#ae81ff>5201</span>
</span></span><span style=display:flex><span>TCP window size: 2.50 MByte <span style=color:#f92672>(</span>default<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>------------------------------------------------------------
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>  1<span style=color:#f92672>]</span> local 10.244.1.9 port <span style=color:#ae81ff>54814</span> connected with 10.110.166.223 port <span style=color:#ae81ff>5201</span> <span style=color:#f92672>(</span>icwnd/mss/irtt<span style=color:#f92672>=</span>13/1398/50<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span> ID<span style=color:#f92672>]</span> Interval       Transfer     Bandwidth
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>  1<span style=color:#f92672>]</span> 0.0000-10.0806 sec  2.48 GBytes  2.12 Gbits/sec
</span></span></code></pre></div><p>In contrast to the latency for which Istio Ambient was the most performant, it&rsquo;s the &ldquo;no Istio&rdquo; mode that outperforms the other two modes in terms of bandwidth.</p><ol><li>No Istio : 3.62 Gbits/sec;</li><li>Istio Ambient : 2.12 Gbits/sec;</li><li>Istio Sidecar : 1.88 Gbits/sec.</li></ol><h1 id=conclusion>Conclusion<a href=#conclusion class=post-heading__anchor aria-hidden=true>#</a></h1><p>Istio is an incredibly powerful and complete product, but it&rsquo;s not without its flaws. It&rsquo;s very easy to get lost in Istio&rsquo;s configuration and end up with a mesh that doesn&rsquo;t work as expected (plus, the logs are not always very explicit). That&rsquo;s why it&rsquo;s important to understand Istio&rsquo;s concepts well before diving into the configuration of your mesh.</p><p>Despite the time I&rsquo;ve spent learning Istio, I don&rsquo;t feel comfortable enough for production use, there&rsquo;s still a lot to learn from this solution. I hope reading this article will be useful for those who want to start learning Istio.</p><p>If you want to encourage me to write this kind of article (and fund my sleepless nights), don&rsquo;t hesitate to make a small donation on <a href=https://ko-fi.com/thebidouilleur class=link--external target=_blank rel=noreferrer>my Kofi page</a>, you can also give me a little shoutout on the social networks below:</p><ul><li><a href=https://twitter.com/thebidouilleur class=link--external target=_blank rel=noreferrer>Twitter</a></li><li><a href=https://www.linkedin.com/in/quentin-joly-it/ class=link--external target=_blank rel=noreferrer>LinkedIn</a></li></ul><p>Until then, I wish you a good day and good luck in your Istio adventure !</p></div></article></div><div class=sidebar><aside class=bio><div class="jr__item jr-basics__item"><div class=jr-basics__image><img src=https://a-cup-of.coffee/img/moi.jpg alt="Picture of Quentin JOLY" width=250 height=250></div><div class=jr-basics__name>Quentin JOLY</div><div class=jr-basics__label>Site Reliability Engineer</div><div class=jr-basics__email>quentinj@une-pause-cafe.fr</div><div class=jr-basics__summary>Quentin, passionate about IT and new technologies.</div><div class=jr-basics__location-city>Lyon, France</div><hr><div class="jr-basics__profile jr-basics__profile--col"><a href=https://github.com/RubxKube/charts target=_blank rel="noreferrer me"><div class=jr-basics__profile-item><div class=jr-basics__profile-icon><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Helm</title><path d="M12.337.0c-.475.0-.861 1.016-.861 2.269.0.527.069 1.011.183 1.396a8.514 8.514.0 00-3.961 1.22 5.229 5.229.0 00-.595-1.093c-.606-.866-1.34-1.436-1.79-1.43a.381.381.0 00-.217.066c-.39.273-.123 1.326.596 2.353.267.381.559.705.84.948A8.683 8.683.0 005.004 7.445h1.734a7.179 7.179.0 015.381-2.421 7.18 7.18.0 015.382 2.42h1.733a8.687 8.687.0 00-1.32-1.53c.35-.249.735-.643 1.078-1.133.719-1.027.986-2.08.596-2.353a.382.382.0 00-.217-.065c-.45-.007-1.184.563-1.79 1.43a4.897 4.897.0 00-.676 1.325 8.52 8.52.0 00-3.899-1.42c.12-.39.193-.887.193-1.429.0-1.253-.386-2.269-.862-2.269zM1.624 9.443v5.162h1.358v-1.968h1.64v1.968h1.357V9.443H4.62v1.838H2.98V9.443zm5.912.0v5.162h3.21v-1.108H8.893v-.95h1.64v-1.142h-1.64v-.84h1.853V9.443zm4.698.0v5.162h3.218v-1.362h-1.86v-3.8zm4.706.0v5.162h1.364v-2.643l1.357 1.225 1.35-1.232v2.65h1.365V9.443h-.614l-2.1 1.914-2.109-1.914zm-11.82 7.28a8.688 8.688.0 001.412 1.548 5.206 5.206.0 00-.841.948c-.719 1.027-.985 2.08-.596 2.353.39.273 1.289-.338 2.007-1.364a5.23 5.23.0 00.595-1.092 8.514 8.514.0 003.961 1.219 5.01 5.01.0 00-.183 1.396c0 1.253.386 2.269.861 2.269.476.0.862-1.016.862-2.269.0-.542-.072-1.04-.193-1.43a8.52 8.52.0 003.9-1.42c.121.4.352.865.675 1.327.719 1.026 1.617 1.637 2.007 1.364s.123-1.326-.596-2.353c-.343-.49-.727-.885-1.077-1.135a8.69 8.69.0 001.202-1.36h-1.771a7.174 7.174.0 01-5.227 2.252 7.174 7.174.0 01-5.226-2.252z"/></svg></div><div class=jr-basics__profile-username>RubxKube - Helm Charts</div></div></a><a href=https://github.com/qjoly/gitops target=_blank rel="noreferrer me"><div class=jr-basics__profile-item><div class=jr-basics__profile-icon><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Git</title><path d="M23.546 10.93 13.067.452c-.604-.603-1.582-.603-2.188.0L8.708 2.627l2.76 2.76c.645-.215 1.379-.07 1.889.441.516.515.658 1.258.438 1.9l2.658 2.66c.645-.223 1.387-.078 1.9.435.721.72.721 1.884.0 2.604-.719.719-1.881.719-2.6.0-.539-.541-.674-1.337-.404-1.996L12.86 8.955v6.525c.176.086.342.203.488.348.713.721.713 1.883.0 2.6-.719.721-1.889.721-2.609.0-.719-.719-.719-1.879.0-2.598.182-.18.387-.316.605-.406V8.835c-.217-.091-.424-.222-.6-.401-.545-.545-.676-1.342-.396-2.009L7.636 3.7.45 10.881c-.6.605-.6 1.584.0 2.189l10.48 10.477c.604.604 1.582.604 2.186.0l10.43-10.43c.605-.603.605-1.582.0-2.187"/></svg></div><div class=jr-basics__profile-username>GitOps Project</div></div></a><a href=https://github.com/qjoly.gpg target=_blank rel="noreferrer me"><div class=jr-basics__profile-item><div class=jr-basics__profile-icon><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GNU social</title><path d="M4.217.0C2.474.0 1.06 1.413 1.06 3.156V15.77c0 1.744 1.414 3.158 3.157 3.158h9.367C13.567 22.498 8.756 24 8.756 24s8.138-.038 9.305-5.072h1.72c1.744.0 3.157-1.414 3.157-3.157V3.157C22.938 1.413 21.524.0 19.782.0H4.218zm4.527 2.53c.073-.013.132-.003.174.034.335.3-.556.593-.484 2.063.032.646-.16 1.146 1.076 1.146.826.0.483-.734 1.523-.734.656.0.86.435.934.767.072-.33.274-.768.93-.768 1.04.0.7.733 1.525.733 1.237.0 1.044-.5 1.076-1.146.072-1.47-.82-1.764-.484-2.063.042-.037.1-.042.172-.02.5.143 1.607 1.558 1.638 2.155.038.71.04 1.825-1.015 2.407 1.19 1.167 1.352 2.72 1.352 2.72l-2.045-.034s-.464-2.118-2.94-2.01c-2.474.108-2.796.538-2.796 3.156.0 2.617 1.147 3.517 2.905 3.585 2.76.108 2.51-1.433 2.51-1.433l-1.29.072-.718-1.937h4.41c0 2.116-.897 5.414-5.092 5.2-4.196-.216-5.128-3.515-5.164-5.74-.018-1.225.188-2.602 1.2-3.574-1.052-.58-1.033-1.7-1.033-2.414.0-.88 1.13-2.084 1.637-2.17z"/></svg></div><div class=jr-basics__profile-username>GPG</div></div></a></div><hr><div class="jr-basics__profile jr-basics__profile--row"><a href=https://github.com/qjoly/ target=_blank rel="noreferrer me"><div class=jr-basics__profile-item><div class=jr-basics__profile-icon><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63.0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.606-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></div></div></a><a href=https://twitter.com/TheBidouilleur target=_blank rel="noreferrer me"><div class=jr-basics__profile-item><div class=jr-basics__profile-icon><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Twitter</title><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958.0 002.163-2.723c-.951.555-2.005.959-3.127 1.184A4.92 4.92.0 0011.78 8.288C7.69 8.095 4.067 6.13 1.64 3.162A4.822 4.822.0 00.974 5.637c0 1.71.87 3.213 2.188 4.096A4.904 4.904.0 01.934 9.117v.06a4.923 4.923.0 003.946 4.827 4.996 4.996.0 01-2.212.085 4.936 4.936.0 004.604 3.417A9.867 9.867.0 011.17 19.611c-.39.0-.779-.023-1.17-.067a13.995 13.995.0 007.557 2.209c9.053.0 13.998-7.496 13.998-13.985.0-.21.0-.42-.015-.63A9.935 9.935.0 0024 4.59z"/></svg></div></div></a><a href=https://a-cup-of.coffee/index.xml target=_blank rel="noreferrer me"><div class=jr-basics__profile-item><div class=jr-basics__profile-icon><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>RSS</title><path d="M19.199 24C19.199 13.467 10.533 4.8.0 4.8V0c13.165.0 24 10.835 24 24h-4.801zM3.291 17.415c1.814.0 3.293 1.479 3.293 3.295.0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526.0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727.0 15.909 7.184 15.909 15.91z"/></svg></div></div></a><a href=https://www.linkedin.com/in/quentin-joly-it/ target=_blank rel="noreferrer me"><div class=jr-basics__profile-item><div class=jr-basics__profile-icon><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg></div></div></a></div></div></aside></div></main><footer><div class=copyright>Copyright Â© 2024</div></footer><script src=https://a-cup-of.coffee/js/main.0492913dc86a02326a3d85f36443214be53bec97b4d5b659dbc29405a3dee1b59d636870ad5733d4b0ddcda60b7a9ef321f7ba82e5d9b38e7d5edf9f712d9acb.js integrity="sha512-BJKRPchqAjJqPYXzZEMhS+U77Je01bZZ28KUBaPe4bWdY2hwrVcz1LDdzaYLep7zIfe6guXZs459Xt+fcS2ayw=="></script>
<script src=https://a-cup-of.coffee/js/flexsearch.a2672fa0729c98873502b8991059cd1204ffe632b5df24f46fe1343c3b3959293209dabbc94e5059d4dd61f4faed0ccfc2e3e42b8d4bf7ed535f0fff14d39ae6.js integrity="sha512-omcvoHKcmIc1AriZEFnNEgT/5jK13yT0b+E0PDs5WSkyCdq7yU5QWdTdYfT67QzPwuPkK41L9+1TXw//FNOa5g=="></script></div></body></html>