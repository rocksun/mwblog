
<!--
title: 在 Kubernetes 上安全地部署和运行多个租户
cover: https://cdn.thenewstack.io/media/2024/12/296d1d05-kubernetes.jpg
-->

多租户虽然提供了成本效益和集中化管理，但也带来了安全和运营方面的挑战。以下是三种方案。

> 译自 [Securely Deploy and Run Multiple Tenants on Kubernetes](https://thenewstack.io/securely-deploy-and-run-multiple-tenants-on-kubernetes/)，作者 Dhiraj Sehgal。

随着 Kubernetes 成为现代云原生应用程序的基石，越来越多的组织寻求通过在同一个 Kubernetes 基础设施中运行多个租户来整合工作负载和资源。这些租户可能是：

- **内部团队**：公司内部共享 Kubernetes 集群用于开发和生产的部门。
- **外部客户**：在共享基础设施上托管客户工作负载的 SaaS 提供商。

虽然多租户提供了成本效益和集中化管理，但也带来了安全和运营方面的挑战：

- 如何确保租户之间强大的隔离？
- 如何管理资源并防止一个租户影响另一个租户？
- 如何满足法规和合规性要求？

为了解决这些问题，实践者在 Kubernetes 上安全部署多个租户主要有三个选择。

## 如何在 Kubernetes 上部署多个租户

### 选项 1：基于命名空间的隔离，结合网络策略、RBAC 和安全控制

命名空间是 Kubernetes 用于逻辑隔离的内置机制。此方法使用：

- **命名空间**：用于隔离租户工作负载的逻辑边界。
- **RBAC（基于角色的访问控制）**：限制租户对其命名空间和资源的访问。
- **网络策略**：控制 Pod 和命名空间之间的入站和出站流量。
- **资源配额**：限制 CPU、内存和其他资源，以防止噪声邻居。

**优点**

- 经济高效：租户共享集群基础设施。
- 易于管理：在单个集群内进行集中化操作。

**局限性**

- 如果 RBAC 或网络策略配置错误，则存在**安全风险**。

### 选项 2：集群级隔离

此方法为每个租户分配一个专用的 Kubernetes 集群，确保完全的物理或虚拟隔离。Rancher、Google Anthos 和 AWS EKS 等工具简化了多个集群的管理。

**优点**

- 强大的隔离：租户不共享任何集群组件。
- 高安全性：没有跨租户数据泄漏或资源争用的风险。

**局限性**

- 高成本：每个集群都会产生控制平面和节点成本。
- 运营复杂性：管理、升级和监控多个集群需要大量资源。
- 可扩展性挑战：配置新集群可能会延迟租户入职。

### 选项 3：虚拟集群

虚拟集群在共享物理集群内提供特定于租户的控制平面。每个租户都获得其虚拟 Kubernetes 环境，同时共享工作节点和物理基础设施。

**优点**

- 强大的逻辑隔离：租户工作负载独立运行。
- 成本效益：共享工作节点降低了基础设施成本。
- 可扩展性：虚拟集群可以快速配置，通常只需几秒钟。

**局限性**

- 与基于命名空间的隔离相比，由于基础设施级别的隔离，**复杂性更高**。
- 如果工作节点过度使用，则会产生**性能影响**。

## 详细比较表

| 方面 | 基于命名空间的隔离 | 集群级隔离 | 虚拟集群 |
|---|---|---|---|
| 隔离级别 | 使用命名空间、RBAC 和网络策略进行逻辑隔离。依赖于正确的配置。 | 物理或虚拟隔离；没有共享的集群组件。 | 逻辑隔离：每个租户获得在共享物理集群内运行的虚拟 Kubernetes 集群。 |
| 安全性 | 高：共享组件（例如 API 服务器、etcd）中的漏洞或配置错误的策略可能导致安全漏洞。 | 非常高：一个租户的漏洞不会影响其他租户。 | 高：虚拟集群提供特定于租户的控制平面，降低了跨租户问题的风险。 |
| 资源争用 | 可能：所有租户共享集群资源，例如节点和控制平面，可能导致资源争用。 | 无：为每个租户提供专用资源，确保没有资源干扰。 | 可能：共享工作节点，但隔离的控制平面减少了对与控制平面相关的操作的争用。 |
| 可扩展性 | 高：添加新租户需要在现有集群中创建一个新的命名空间并应用策略。 | 有限：添加新租户需要配置和管理新集群。 | 高：可以在现有物理集群中快速配置新的虚拟集群。 |
| 成本 | 低：共享集群资源降低了基础设施和运营成本。 | 高：单独的集群增加了基础设施、运营和监控成本。 | 中等：与物理集群相比，共享基础设施降低了成本，但高于命名空间隔离。 |
| 运营复杂性 | 低：需要管理单个集群，但需要仔细配置命名空间、RBAC和网络策略。 | 高：管理多个集群增加了显著的操作开销，并且需要专门的工具。 | 中等：集中式管理比物理集群简化了操作，但仍涉及管理虚拟集群。 |
| 性能隔离 | 中等：租户共享控制平面和节点资源，可能在资源高峰期间影响性能。 | 高性能：由于专用集群，性能被隔离。 | 中等：控制平面是隔离的；然而，共享工作节点影响性能。 |
| 管理费用 | 低：在一个集群内对租户进行集中控制。 | 高：独立的控制平面和集群增加了管理开销。 | 适度：与物理集群相比管理更简化，但比命名空间开销更大。 |

## 你能不解决多租户问题吗？

未能实施健全的多租户策略可能会导致：

- **安全漏洞**：共享集群中的配置错误可能允许一个租户访问另一个租户的工作负载或数据。
- **资源竞争**：单个租户可以独占共享资源，降低其他人的性能。
- **不合规**：隔离不当可能导致无法满足HIPAA或PCI-DSS等法规要求。
- **运营效率低下**：设计不佳的多租户增加了管理开销，增加了集群停机的风险。

在Kubernetes中确保多租户安全对于维护Kubernetes集群的安全姿态以满足合规性和安全要求至关重要。多租户通过集中管理有效地整合工作负载和资源，节省资金，但它引入了重大的安全和运营挑战，必须通过最佳实践来解决，例如基于命名空间的隔离或安全部署虚拟集群。因为未能正确保护多租户可能导致合规违规和安全漏洞，实施健全的安全措施和隔离技术对于维护Kubernetes中安全高效的多租户环境至关重要。