<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="norton-safeweb-site-verification" content="24usqpep0ejc5w6hod3dulxwciwp0djs6c6ufp96av3t4whuxovj72wfkdjxu82yacb7430qjm8adbd5ezlt4592dq4zrvadcn9j9n-0btgdzpiojfzno16-fnsnu7xd" />
        
        <link rel="preconnect" href="https://substackcdn.com" />
        

        

        
        <link rel="preload" as="style" href="https://substackcdn.com/bundle/theme/main.5f50053b1fc3e6f2d95f.css" />
        
        <link rel="preload" as="style" href="https://substackcdn.com/bundle/theme/color_links.33eb7c3bd37d78bc2dc3.css" />
        
        
        

        
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/entry-0a24dbeb.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/index-d5abe41f.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/user-856acd57.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/FlexBox-853461a9.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/free_email_form-cda68176.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/Modal-8214dc28.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/app_install_modal-1b80d39d.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/IntroPopup-275682f1.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/Banner-e199452f.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/isArrayLike-e9841d58.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/Tooltip-d4ad588b.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/NavbarUserWidget-102943cd.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/DatePicker-dce2f22b.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/HoverCard-41ea4b50.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/user_indicator-9d97d395.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/Divider-f25512a6.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/NotificationsDropdown-1fd62d90.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/Menu-db1fc4e5.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/SegmentedButton-4796925d.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/Progress-e8f0d387.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/homepage_hooks-34f6ea51.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/Select-cd38999e.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/ProfileHoverCard-59490a3e.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/UserBadge-fb9c174e.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/PubAccentTheme-b0add910.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/ShareableImageModal-4e616c35.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/ShareAssetButtons-44463ef6.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/overflow_menu-63853454.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/newsletter_item_list-03468b3d.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/ProfileSetupToast-60e0a843.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/CommunityPostView-6ada0dc8.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/Search-7cb3a6c6.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/podcast_apps-184969d7.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/CommentBody-c55cfff6.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/mention-e43b25a5.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/Attachments-40c525c7.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/AlertDialog-d5334809.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/facepile-b843f834.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/PostPreviewCoverImage-70dddbb6.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/ChatAppUpsell-41a3562f.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/post-5edd6021.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/VideoVerticalMenu-30553239.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/Field-cea155ef.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/Tab-0cac07d2.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/autocomplete_results-58e558b6.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/Badge-6f531bff.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/FollowPrompt-a56b28dc.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/ImageViewerModal-6e193260.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/Recipe-083bf21d.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/recommend_linked_publication_modal-48ea549f.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/RewardBox-5297e7a9.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/Radio-8a0d4f75.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/Logo-f0548763.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/FilePicker-ceb0fe25.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/setup_all_podcasts-b7cd50d6.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/CookieConsentFooter-0d9aca19.css" />
            
                <link type="text/css" rel="stylesheet" href="https://substackcdn.com/bundle/assets/TabBar-05c8b61f.css" />
            
        

        
        
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
        <meta name="author" content="CSS Engineering" />
        <meta property="og:url" content="https://techblog.citystoragesystems.com/p/managing-100s-of-kubernetes-clusters" />
        <title data-preact-helmet>Managing 100s of Kubernetes Clusters using Cluster API</title>
        <meta data-preact-helmet name="theme-color" content="#151513"><meta data-preact-helmet property="og:type" content="article"><meta data-preact-helmet property="og:title" content="Managing 100s of Kubernetes Clusters using Cluster API"><meta data-preact-helmet name="twitter:title" content="Managing 100s of Kubernetes Clusters using Cluster API"><meta data-preact-helmet name="description" content="Automating every step from cluster creation to workload-ready."><meta data-preact-helmet property="og:description" content="Automating every step from cluster creation to workload-ready."><meta data-preact-helmet name="twitter:description" content="Automating every step from cluster creation to workload-ready."><meta data-preact-helmet property="og:image" content="https://substackcdn.com/image/fetch/w_1200,h_600,c_fill,f_jpg,q_auto:good,fl_progressive:steep,g_auto/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8ec528f2-0ea8-4e52-87e4-f129052c741d_2000x1361.png"><meta data-preact-helmet name="twitter:image" content="https://substackcdn.com/image/fetch/f_auto,q_auto:best,fl_progressive:steep/https%3A%2F%2Fengineering4citystoragesystems.substack.com%2Fapi%2Fv1%2Fpost_preview%2F142916610%2Ftwitter.jpg%3Fversion%3D4"><meta data-preact-helmet name="twitter:card" content="summary_large_image">
        <link rel="canonical" href="https://techblog.citystoragesystems.com/p/managing-100s-of-kubernetes-clusters" />

        

        

        
            
                <link rel="shortcut icon" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57c6bdf0-e917-4c62-a93b-73dc08f52ce5%2Ffavicon.ico">
            
        
            
                <link rel="icon" type="image/png" sizes="16x16" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57c6bdf0-e917-4c62-a93b-73dc08f52ce5%2Ffavicon-16x16.png">
            
        
            
                <link rel="icon" type="image/png" sizes="32x32" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57c6bdf0-e917-4c62-a93b-73dc08f52ce5%2Ffavicon-32x32.png">
            
        
            
                <link rel="icon" type="image/png" sizes="48x48" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57c6bdf0-e917-4c62-a93b-73dc08f52ce5%2Ffavicon-48x48.png">
            
        
            
                <link rel="apple-touch-icon" sizes="57x57" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57c6bdf0-e917-4c62-a93b-73dc08f52ce5%2Fapple-touch-icon-57x57.png">
            
        
            
                <link rel="apple-touch-icon" sizes="60x60" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57c6bdf0-e917-4c62-a93b-73dc08f52ce5%2Fapple-touch-icon-60x60.png">
            
        
            
                <link rel="apple-touch-icon" sizes="72x72" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57c6bdf0-e917-4c62-a93b-73dc08f52ce5%2Fapple-touch-icon-72x72.png">
            
        
            
                <link rel="apple-touch-icon" sizes="76x76" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57c6bdf0-e917-4c62-a93b-73dc08f52ce5%2Fapple-touch-icon-76x76.png">
            
        
            
                <link rel="apple-touch-icon" sizes="114x114" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57c6bdf0-e917-4c62-a93b-73dc08f52ce5%2Fapple-touch-icon-114x114.png">
            
        
            
                <link rel="apple-touch-icon" sizes="120x120" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57c6bdf0-e917-4c62-a93b-73dc08f52ce5%2Fapple-touch-icon-120x120.png">
            
        
            
                <link rel="apple-touch-icon" sizes="144x144" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57c6bdf0-e917-4c62-a93b-73dc08f52ce5%2Fapple-touch-icon-144x144.png">
            
        
            
                <link rel="apple-touch-icon" sizes="152x152" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57c6bdf0-e917-4c62-a93b-73dc08f52ce5%2Fapple-touch-icon-152x152.png">
            
        
            
                <link rel="apple-touch-icon" sizes="167x167" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57c6bdf0-e917-4c62-a93b-73dc08f52ce5%2Fapple-touch-icon-167x167.png">
            
        
            
                <link rel="apple-touch-icon" sizes="180x180" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57c6bdf0-e917-4c62-a93b-73dc08f52ce5%2Fapple-touch-icon-180x180.png">
            
        
            
                <link rel="apple-touch-icon" sizes="1024x1024" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57c6bdf0-e917-4c62-a93b-73dc08f52ce5%2Fapple-touch-icon-1024x1024.png">
            
        
            
        
            
        
            
        

        

        
            <link rel="alternate" type="application/rss+xml" href="/feed" title="City Storage Systems"/>
        

        
        

        <style>:root{--color_theme_bg_pop:#464EE7;--background_pop:#464EE7;--color_theme_bg_web:#151513;--cover_bg_color:#151513;--background_pop_darken:#2f38e4;--print_on_pop:#ffffff;--color_theme_bg_pop_darken:#2f38e4;--color_theme_print_on_pop:#ffffff;--border_subtle:rgba(68, 68, 66, 0.5);--background_subtle:rgba(227, 228, 251, 0.4);--print_pop:#464ee7;--color_theme_accent:#464ee7;--cover_print_primary:#ffffff;--cover_print_secondary:#d9d9d9;--cover_border_color:#ffffff;--font_family_headings_preset:'SF Pro Display', -apple-system, system-ui, BlinkMacSystemFont, 'Inter', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';--font_weight_headings_preset:900;--font_family_body_preset:'SF Pro Display', -apple-system, system-ui, BlinkMacSystemFont, 'Inter', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';--font_weight_body_preset:400;--font_preset_heading:heavy_sans;--font_preset_body:sans;--home_hero:newspaper;--home_posts:list;--web_bg_color:#151513;--background_contrast_1:#1c1c1a;--color_theme_bg_contrast_1:#1c1c1a;--background_contrast_2:#272726;--color_theme_bg_contrast_2:#272726;--background_contrast_3:#3b3b39;--color_theme_bg_contrast_3:#3b3b39;--background_contrast_4:#565655;--color_theme_bg_contrast_4:#565655;--background_contrast_5:#717170;--color_theme_bg_contrast_5:#717170;--background_contrast_pop:rgba(70, 78, 231, 0.4);--color_theme_bg_contrast_pop:rgba(70, 78, 231, 0.4);--input_background:#21211f;--cover_input_background:#21211f;--tooltip_background:#414140;--web_bg_color_h:60;--web_bg_color_s:5%;--web_bg_color_l:7.8431372549019605%;--print_on_web_bg_color:#ffffff;--print_secondary_on_web_bg_color:#a1a1a1;--selected_comment_background_color:#201c14;--background_pop_rgb:70, 78, 231;--background_pop_rgb_pc:70 78 231;--color_theme_bg_pop_rgb:70, 78, 231;--color_theme_bg_pop_rgb_pc:70 78 231;--color_theme_accent_rgb:70, 78, 231;--color_theme_accent_rgb_pc:70 78 231;}</style>

        
            <link rel="stylesheet" href="https://substackcdn.com/bundle/theme/main.5f50053b1fc3e6f2d95f.css" />
        
            <link rel="stylesheet" href="https://substackcdn.com/bundle/theme/color_links.33eb7c3bd37d78bc2dc3.css" />
        

        <style></style>

        

        

        
    </head>

    <body>
        

        

        <div id="entry">
            <div id="main" class="main typography use-theme-bg"><div data-testid="navbar" class="main-menu animated with-wordmark"><div class="main-menu-content"><div class="topbar"><div class="topbar-content"><div class="navbar-logo-container"><a href="/" native><img src="https://substackcdn.com/image/fetch/w_96,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00427a51-29da-4fd7-b0ea-75bf09b879c5_512x512.png" class="navbar-logo" /></a></div><h1 class="navbar-title left-align loading"><a href="/" native class="navbar-title-link"><img src="https://substackcdn.com/image/fetch/e_trim:10:white/e_trim:10:transparent/h_72,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F494bd983-fb57-4ec0-ac8e-d62647802192_2688x512.jpeg" alt="City Storage Systems" class="navbar-logo-wordmark" /></a></h1><div class="navbar-buttons"><div class="pencraft pc-display-contents pc-reset _pubTheme_lnwev_1"><div style="width: 40px;" id="trigger3961" aria-expanded="false" aria-haspopup="dialog" aria-controls="dialog3962" class="pencraft pc-display-flex pc-gap-4 pc-paddingLeft-0 pc-justifyContent-center pc-alignItems-center pc-reset _searchWrapper_msami_1 _marginRight_msami_22"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="_trigger_msami_41" area-hidden="true"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></svg></div><button tabIndex="0" type="button" aria-label="Share Publication" id="trigger3963" aria-expanded="false" aria-haspopup="dialog" aria-controls="dialog3964" ariaLabel="View more" class="pencraft pc-reset pencraft _trigger_tg5wo_1 _iconButton_11e9v_126 _iconButtonBase_11e9v_126 _buttonBase_11e9v_1 _buttonOldColors_11e9v_44 _size_40_11e9v_156 _priority_secondary_11e9v_51 _fill_borderless_11e9v_632 _rounded_11e9v_136"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-share "><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" x2="12" y1="2" y2="15"></line></svg></button><button tabIndex="0" data-testid="noncontributor-cta-button" type="button" class="button primary subscribe-cta subscribe-btn"><div class="pencraft pc-display-flex pc-gap-8 pc-alignItems-center pc-reset"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus "><path d="M5 12h14"></path><path d="M12 5v14"></path></svg>Subscribe</div></button><button tabIndex="0" native="true" type="button" class="button sign-in-link outline-grayscale">Sign in</button></div></div></div></div></div><div class="topbar-spacer"></div></div><div><script type="application/ld+json">{"@context":"https://schema.org","@type":"NewsArticle","url":"https://techblog.citystoragesystems.com/p/managing-100s-of-kubernetes-clusters","mainEntityOfPage":"https://techblog.citystoragesystems.com/p/managing-100s-of-kubernetes-clusters","headline":"Managing 100s of Kubernetes Clusters using Cluster API","description":"Automating every step from cluster creation to workload-ready.","image":[{"@type":"ImageObject","url":"https://substack-post-media.s3.amazonaws.com/public/images/8ec528f2-0ea8-4e52-87e4-f129052c741d_2000x1361.png"}],"datePublished":"2024-03-26T14:01:27+00:00","dateModified":"2024-03-26T14:01:27+00:00","isAccessibleForFree":true,"author":{"@type":"Organization","name":"City Storage Systems","url":"https://techblog.citystoragesystems.com","description":"Engineering the future of food at Otter & CloudKitchens","interactionStatistic":{"@type":"InteractionCounter","name":"Subscribers","interactionType":"https://schema.org/SubscribeAction","userInteractionCount":100},"identifier":"pub:2259056","logo":{"@type":"ImageObject","url":"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00427a51-29da-4fd7-b0ea-75bf09b879c5_512x512.png","contentUrl":"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00427a51-29da-4fd7-b0ea-75bf09b879c5_512x512.png","thumbnailUrl":"https://substackcdn.com/image/fetch/w_128,h_128,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00427a51-29da-4fd7-b0ea-75bf09b879c5_512x512.png"},"image":{"@type":"ImageObject","url":"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00427a51-29da-4fd7-b0ea-75bf09b879c5_512x512.png","contentUrl":"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00427a51-29da-4fd7-b0ea-75bf09b879c5_512x512.png","thumbnailUrl":"https://substackcdn.com/image/fetch/w_128,h_128,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00427a51-29da-4fd7-b0ea-75bf09b879c5_512x512.png"}},"publisher":{"@type":"Organization","name":"City Storage Systems","url":"https://techblog.citystoragesystems.com","description":"Engineering the future of food at Otter & CloudKitchens","interactionStatistic":{"@type":"InteractionCounter","name":"Subscribers","interactionType":"https://schema.org/SubscribeAction","userInteractionCount":100},"identifier":"pub:2259056","logo":{"@type":"ImageObject","url":"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00427a51-29da-4fd7-b0ea-75bf09b879c5_512x512.png","contentUrl":"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00427a51-29da-4fd7-b0ea-75bf09b879c5_512x512.png","thumbnailUrl":"https://substackcdn.com/image/fetch/w_128,h_128,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00427a51-29da-4fd7-b0ea-75bf09b879c5_512x512.png"},"image":{"@type":"ImageObject","url":"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00427a51-29da-4fd7-b0ea-75bf09b879c5_512x512.png","contentUrl":"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00427a51-29da-4fd7-b0ea-75bf09b879c5_512x512.png","thumbnailUrl":"https://substackcdn.com/image/fetch/w_128,h_128,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00427a51-29da-4fd7-b0ea-75bf09b879c5_512x512.png"}}}</script><div class="single-post-container"><div class="container"><div class="single-post"><article class="typography newsletter-post post"><div inert role="dialog" class="modal typography out gone share-dialog popup"><div class="modal-table"><div class="modal-row"><div class="modal-cell modal-content no-fullscreen"><div class="container"><button tabIndex="0" type="button" data-testid="close-modal" class="pencraft pc-reset pencraft modal-btn modal-exit-btn no-margin _iconButton_11e9v_126 _iconButtonBase_11e9v_126 _buttonBase_11e9v_1 _buttonOldColors_11e9v_44 _size_40_11e9v_156 _priority_secondary_11e9v_51 _fill_empty_11e9v_298 _rounded_11e9v_136"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="secondary" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x "><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg></button><div class="share-dialog-title">Share this post</div><div class="pencraft pc-display-flex pc-flexDirection-column pc-gap-32 pc-paddingLeft-24 pc-paddingRight-24 pc-paddingTop-32 pc-paddingBottom-48 pc-reset"><div class="pencraft pc-display-flex pc-padding-8 pc-reset _border-detail_1o6bj_25 pc-borderRadius-md social-preview-box post"><div class="social-image-box"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_120,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8ec528f2-0ea8-4e52-87e4-f129052c741d_2000x1361.png" /><img src="https://substackcdn.com/image/fetch/w_120,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8ec528f2-0ea8-4e52-87e4-f129052c741d_2000x1361.png" sizes="100vw" alt loading="lazy" width="120" class="_img_16u6n_1 social-image pencraft pc-reset" /></picture></div><div class="pencraft pc-display-flex pc-flexDirection-column pc-paddingTop-8 pc-paddingBottom-8 pc-paddingLeft-12 pc-reset"><h4 class="pencraft pc-reset _line-height-24_13a18_98 _font-display_13a18_118 _size-20_13a18_70 _weight-bold_13a18_168 _reset_13a18_1">Managing 100s of Kubernetes Clusters using Cluster API</h4><div class="pencraft pc-reset _color-secondary_13a18_186 _line-height-20_13a18_95 _font-text_13a18_121 _size-13_13a18_45 _weight-regular_13a18_159 _reset_13a18_1">techblog.citystoragesystems.com</div></div></div><div class="pencraft pc-display-flex pc-gap-8 pc-justifyContent-space-between pc-reset share-dialog-buttons-wrapper"><button tabIndex="0" type="button" class="button share-action"><div class="action-icon"><svg role="img" width="20" height="16" viewBox="0 0 20 16" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><path fill-rule="evenodd" clip-rule="evenodd" d="M12.1303 0.000379039C10.9833 -0.00959082 9.87819 0.431464 9.05309 1.22855L9.04556 1.23593L7.79145 2.48303C7.50587 2.767 7.50453 3.22877 7.78844 3.51441C8.07235 3.80004 8.53401 3.80139 8.81959 3.51741L10.0698 2.27423C10.6194 1.74503 11.3546 1.45229 12.1177 1.45892C12.8824 1.46556 13.6139 1.77236 14.1546 2.31323C14.6954 2.8541 15.0021 3.58577 15.0087 4.35065C15.0154 5.11353 14.7229 5.84857 14.1943 6.39829L12.0116 8.58145L12.0115 8.58155C11.7159 8.87739 11.36 9.10617 10.9682 9.25237C10.5764 9.39857 10.1577 9.45878 9.74051 9.42889C9.32337 9.39901 8.91752 9.27975 8.55051 9.07918C8.1835 8.87862 7.8639 8.60146 7.6134 8.26649C7.3722 7.94396 6.91526 7.87807 6.5928 8.11933C6.27034 8.36059 6.20447 8.81763 6.44567 9.14016C6.82142 9.64261 7.30082 10.0584 7.85134 10.3592C8.40186 10.66 9.01062 10.8389 9.63634 10.8838C10.2621 10.9286 10.8901 10.8383 11.4779 10.619C12.0656 10.3997 12.5994 10.0565 13.0429 9.61274L15.2302 7.42494L15.2391 7.4159C16.036 6.59062 16.4769 5.48529 16.467 4.33797C16.457 3.19066 15.9969 2.09316 15.1858 1.28185C14.3746 0.470545 13.2774 0.0103489 12.1303 0.000379039ZM7.29806 5.11625C6.67234 5.07142 6.0443 5.16173 5.45654 5.38103C4.86882 5.60031 4.33502 5.94355 3.89153 6.38727L1.70423 8.57506L1.69534 8.5841C0.898438 9.40939 0.457483 10.5147 0.467451 11.662C0.477418 12.8094 0.937512 13.9069 1.74864 14.7182C2.55976 15.5295 3.65701 15.9897 4.80407 15.9996C5.95113 16.0096 7.05622 15.5685 7.88132 14.7715L7.89035 14.7626L9.13717 13.5155C9.42192 13.2307 9.42192 12.7689 9.13717 12.4841C8.85243 12.1993 8.39077 12.1993 8.10602 12.4841L6.86392 13.7265C6.31432 14.2552 5.57945 14.5477 4.81675 14.5411C4.05204 14.5344 3.32054 14.2276 2.77979 13.6868C2.23904 13.1459 1.93231 12.4142 1.92566 11.6494C1.91904 10.8865 2.21146 10.1514 2.74011 9.60172L4.92287 7.41846C5.21854 7.12262 5.57437 6.89384 5.96621 6.74763C6.35805 6.60143 6.77674 6.54123 7.19389 6.57111C7.61104 6.601 8.01688 6.72026 8.38389 6.92082C8.75091 7.12138 9.0705 7.39855 9.32101 7.73352C9.56221 8.05605 10.0191 8.12194 10.3416 7.88068C10.6641 7.63942 10.7299 7.18238 10.4887 6.85985C10.113 6.3574 9.63359 5.94165 9.08307 5.64081C8.53255 5.33997 7.92378 5.16107 7.29806 5.11625Z"></path></g></svg></div><div translated class="pencraft pc-reset _color-secondary_13a18_186 _line-height-20_13a18_95 _font-text_13a18_121 _size-13_13a18_45 _weight-regular_13a18_159 _reset_13a18_1">Copy link</div></button><button tabIndex="0" type="button" class="button share-action"><div class="action-icon"><svg role="img" width="16" height="17" viewBox="0 0 16 17" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><path d="M10.6543 1.38723C10.3533 0.960814 9.95383 0.61341 9.48976 0.374567C9.02902 0.137956 8.51908 0.0130716 8.00115 0.0100098C7.86087 0.0101844 7.72354 0.0502687 7.60519 0.125581C7.48684 0.200893 7.39237 0.308324 7.3328 0.435326L5.00368 5.67077H3.029C2.72335 5.66964 2.42059 5.73003 2.13876 5.84833C1.85692 5.96663 1.60177 6.14043 1.38849 6.35938C1.16707 6.57502 0.991841 6.83346 0.873459 7.11897C0.755078 7.40447 0.696022 7.71108 0.699885 8.02014V13.691C0.699885 14.3087 0.945273 14.9012 1.38207 15.338C1.81886 15.7747 2.41128 16.0201 3.029 16.0201H13.348C13.8951 16.021 14.425 15.8283 14.8438 15.4762C15.2626 15.1241 15.5434 14.6352 15.6366 14.0961L16.6493 8.4252C16.7252 8.09192 16.7252 7.74582 16.6493 7.41254C16.566 7.08205 16.4104 6.7742 16.1936 6.51128C15.9746 6.25 15.7017 6.03926 15.3936 5.89355C15.0762 5.7467 14.7306 5.67068 14.3809 5.67077H10.5328L11.0391 4.37457C11.2397 3.88784 11.3162 3.35894 11.2619 2.83533C11.1853 2.30894 10.9763 1.81065 10.6543 1.38723ZM4.75052 14.5518H3.029C2.91049 14.5525 2.79303 14.5296 2.68349 14.4844C2.57394 14.4392 2.47452 14.3726 2.39102 14.2885C2.23609 14.1199 2.14945 13.8997 2.14799 13.6708V8.02014C2.14913 7.901 2.17389 7.78328 2.22082 7.67377C2.26775 7.56427 2.33592 7.46515 2.4214 7.38216C2.50369 7.29576 2.60267 7.22698 2.71233 7.17998C2.822 7.13298 2.94007 7.10874 3.05938 7.10874H4.7809L4.75052 14.5518ZM10.6746 7.05811H14.3809C14.5145 7.05821 14.6462 7.08942 14.7657 7.14925C14.8875 7.20532 14.9948 7.28845 15.0796 7.39229C15.1675 7.49052 15.2301 7.60871 15.2619 7.73659C15.2922 7.8665 15.2922 8.00162 15.2619 8.13153L14.2493 13.8024C14.2087 14.017 14.094 14.2106 13.9252 14.3492C13.7619 14.4812 13.558 14.5528 13.348 14.5518H6.19862V6.45052L8.43659 1.38723H8.52773C8.9042 1.50037 9.23304 1.73413 9.4636 2.05252C9.69416 2.37092 9.81365 2.75627 9.80368 3.14925C9.8181 3.39741 9.78015 3.64583 9.69229 3.87836L9.23659 5.04292C9.15397 5.273 9.12623 5.51921 9.15558 5.76191C9.1877 6.00427 9.27425 6.23623 9.40875 6.44039C9.5535 6.6376 9.74028 6.80017 9.95558 6.91634C10.1774 7.03206 10.4244 7.0912 10.6746 7.08849V7.05811Z"></path></g></svg></div><div translated class="pencraft pc-reset _color-secondary_13a18_186 _line-height-20_13a18_95 _font-text_13a18_121 _size-13_13a18_45 _weight-regular_13a18_159 _reset_13a18_1">Facebook</div></button><button tabIndex="0" type="button" class="button share-action"><div class="action-icon"><svg role="img" width="21" height="16" viewBox="0 0 21 16" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><path fill-rule="evenodd" clip-rule="evenodd" d="M2.22192 2.20503C2.36754 1.77115 2.78269 1.45455 3.26639 1.45455H17.9332C18.4169 1.45455 18.8321 1.77118 18.9777 2.2051L10.5999 8.02107L2.22192 2.20503ZM2.16639 3.94198V13.4545C2.16639 14.0529 2.66307 14.5455 3.26639 14.5455H17.9332C18.5365 14.5455 19.0332 14.0529 19.0332 13.4545V3.94206L11.0204 9.50462C10.7679 9.67991 10.4318 9.67991 10.1793 9.50462L2.16639 3.94198ZM20.4999 2.55809V13.4545C20.4999 14.8562 19.3465 16 17.9332 16H3.26639C1.85304 16 0.699707 14.8562 0.699707 13.4545V2.54545C0.699707 1.14379 1.85304 0 3.26639 0H17.9332C19.3407 0 20.4904 1.13441 20.4998 2.52818C20.5 2.53816 20.5001 2.54813 20.4999 2.55809Z"></path></g></svg></div><div translated class="pencraft pc-reset _color-secondary_13a18_186 _line-height-20_13a18_95 _font-text_13a18_121 _size-13_13a18_45 _weight-regular_13a18_159 _reset_13a18_1">Email</div></button><button tabIndex="0" type="button" class="button share-action"><div class="action-icon"><svg role="img" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><path d="M6.785 1.92766C5.45134 1.57031 4.08049 2.36176 3.72314 3.69543L0.444815 15.9303C0.0874636 17.264 0.878901 18.6348 2.21255 18.9922L5.37495 19.8396V7.66664C5.37495 6.40099 6.40096 5.37498 7.66661 5.37498H19.4723C19.3299 5.30548 19.1788 5.24858 19.0201 5.20604L6.785 1.92766Z" stroke="none"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M8.44161 7.4C7.86632 7.4 7.39995 7.86637 7.39995 8.44167V22.1081C7.39995 22.6834 7.86631 23.1498 8.4416 23.1498L22.1083 23.15C22.6836 23.15 23.1499 22.6836 23.1499 22.1083V8.44167C23.1499 7.86637 22.6836 7.4 22.1083 7.4H8.44161ZM10.3999 9.65C9.84766 9.65 9.39995 10.0977 9.39995 10.65C9.39995 11.2023 9.84766 11.65 10.3999 11.65H18.3999C18.9522 11.65 19.3999 11.2023 19.3999 10.65C19.3999 10.0977 18.9522 9.65 18.3999 9.65H10.3999ZM10.3999 14.15C9.84766 14.15 9.39995 14.5977 9.39995 15.15C9.39995 15.7023 9.84766 16.15 10.3999 16.15H15.3999C15.9522 16.15 16.3999 15.7023 16.3999 15.15C16.3999 14.5977 15.9522 14.15 15.3999 14.15H10.3999Z" stroke="none"></path></g></svg></div><div class="pencraft pc-reset _color-secondary_13a18_186 _line-height-20_13a18_95 _font-text_13a18_121 _size-13_13a18_45 _weight-regular_13a18_159 _reset_13a18_1">Note</div></button><button tabIndex="0" id="trigger3965" aria-expanded="false" aria-haspopup="dialog" aria-controls="dialog3966" ariaLabel="View more" type="button" class="button share-action"><div class="action-icon"><svg role="img" width="100" height="100" viewBox="0 0 100 100" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><circle cx="23" cy="50" r="9"></circle><circle cx="50" cy="50" r="9"></circle><circle cx="77" cy="50" r="9"></circle></g></svg></div><div translated class="pencraft pc-reset _color-secondary_13a18_186 _line-height-20_13a18_95 _font-text_13a18_121 _size-13_13a18_45 _weight-regular_13a18_159 _reset_13a18_1">Other</div></button></div></div></div></div></div></div></div><div class="post-header"><h1 class="post-title unpublished">Managing 100s of Kubernetes Clusters using Cluster API</h1><h3 class="subtitle">Automating every step from cluster creation to workload-ready. Turtles all the way down.</h3><div class="pencraft pc-display-flex pc-flexDirection-column pc-paddingBottom-16 pc-reset"><div class="pencraft pc-display-flex pc-flexDirection-column pc-paddingTop-16 pc-paddingBottom-16 pc-reset"><div class="pencraft pc-display-flex pc-gap-12 pc-alignItems-center pc-reset byline-wrapper"><div class="pencraft pc-display-flex pc-flexDirection-column pc-reset"><div class="pencraft pc-display-flex pc-gap-4 pc-reset"><div class="pencraft pc-reset _color-pub-secondary-text_13a18_207 _line-height-20_13a18_95 _font-meta_13a18_131 _size-11_13a18_35 _weight-medium_13a18_162 _transform-uppercase_13a18_239 _reset_13a18_1 _meta_13a18_439">Mar 26, 2024</div></div></div></div></div><div class="pencraft pc-display-flex pc-gap-16 pc-paddingTop-16 pc-paddingBottom-16 pc-justifyContent-space-between pc-alignItems-center _flexGrow_1o6bj_209 pc-reset _border-top-detail-themed_1o6bj_52 _border-bottom-detail-themed_1o6bj_55 post-ufi"><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><div class="like-button-container post-ufi-button style-button"><a role="button" class="post-ufi-button style-button has-label with-border"><svg role="img" style="height: 20px; width: 20px;" width="20" height="20" viewBox="0 0 24 24" fill="#000000" stroke-width="2" stroke="#000" xmlns="http://www.w3.org/2000/svg" class="icon"><g><title></title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-heart "><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path></svg></g></svg><div class="label">3</div></a><div inert role="dialog" class="modal typography out gone share-dialog popup"><div class="modal-table"><div class="modal-row"><div class="modal-cell modal-content no-fullscreen"><div class="container"><button tabIndex="0" type="button" data-testid="close-modal" class="pencraft pc-reset pencraft modal-btn modal-exit-btn no-margin _iconButton_11e9v_126 _iconButtonBase_11e9v_126 _buttonBase_11e9v_1 _buttonOldColors_11e9v_44 _size_40_11e9v_156 _priority_secondary_11e9v_51 _fill_empty_11e9v_298 _rounded_11e9v_136"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="secondary" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x "><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg></button><div class="share-dialog-title">Share this post</div><div class="pencraft pc-display-flex pc-flexDirection-column pc-gap-32 pc-paddingLeft-24 pc-paddingRight-24 pc-paddingTop-32 pc-paddingBottom-48 pc-reset"><div class="pencraft pc-display-flex pc-padding-8 pc-reset _border-detail_1o6bj_25 pc-borderRadius-md social-preview-box post"><div class="social-image-box"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_120,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8ec528f2-0ea8-4e52-87e4-f129052c741d_2000x1361.png" /><img src="https://substackcdn.com/image/fetch/w_120,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8ec528f2-0ea8-4e52-87e4-f129052c741d_2000x1361.png" sizes="100vw" alt loading="lazy" width="120" class="_img_16u6n_1 social-image pencraft pc-reset" /></picture></div><div class="pencraft pc-display-flex pc-flexDirection-column pc-paddingTop-8 pc-paddingBottom-8 pc-paddingLeft-12 pc-reset"><h4 class="pencraft pc-reset _line-height-24_13a18_98 _font-display_13a18_118 _size-20_13a18_70 _weight-bold_13a18_168 _reset_13a18_1">Managing 100s of Kubernetes Clusters using Cluster API</h4><div class="pencraft pc-reset _color-secondary_13a18_186 _line-height-20_13a18_95 _font-text_13a18_121 _size-13_13a18_45 _weight-regular_13a18_159 _reset_13a18_1">techblog.citystoragesystems.com</div></div></div><div class="pencraft pc-display-flex pc-gap-8 pc-justifyContent-space-between pc-reset share-dialog-buttons-wrapper"><button tabIndex="0" type="button" class="button share-action"><div class="action-icon"><svg role="img" width="20" height="16" viewBox="0 0 20 16" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><path fill-rule="evenodd" clip-rule="evenodd" d="M12.1303 0.000379039C10.9833 -0.00959082 9.87819 0.431464 9.05309 1.22855L9.04556 1.23593L7.79145 2.48303C7.50587 2.767 7.50453 3.22877 7.78844 3.51441C8.07235 3.80004 8.53401 3.80139 8.81959 3.51741L10.0698 2.27423C10.6194 1.74503 11.3546 1.45229 12.1177 1.45892C12.8824 1.46556 13.6139 1.77236 14.1546 2.31323C14.6954 2.8541 15.0021 3.58577 15.0087 4.35065C15.0154 5.11353 14.7229 5.84857 14.1943 6.39829L12.0116 8.58145L12.0115 8.58155C11.7159 8.87739 11.36 9.10617 10.9682 9.25237C10.5764 9.39857 10.1577 9.45878 9.74051 9.42889C9.32337 9.39901 8.91752 9.27975 8.55051 9.07918C8.1835 8.87862 7.8639 8.60146 7.6134 8.26649C7.3722 7.94396 6.91526 7.87807 6.5928 8.11933C6.27034 8.36059 6.20447 8.81763 6.44567 9.14016C6.82142 9.64261 7.30082 10.0584 7.85134 10.3592C8.40186 10.66 9.01062 10.8389 9.63634 10.8838C10.2621 10.9286 10.8901 10.8383 11.4779 10.619C12.0656 10.3997 12.5994 10.0565 13.0429 9.61274L15.2302 7.42494L15.2391 7.4159C16.036 6.59062 16.4769 5.48529 16.467 4.33797C16.457 3.19066 15.9969 2.09316 15.1858 1.28185C14.3746 0.470545 13.2774 0.0103489 12.1303 0.000379039ZM7.29806 5.11625C6.67234 5.07142 6.0443 5.16173 5.45654 5.38103C4.86882 5.60031 4.33502 5.94355 3.89153 6.38727L1.70423 8.57506L1.69534 8.5841C0.898438 9.40939 0.457483 10.5147 0.467451 11.662C0.477418 12.8094 0.937512 13.9069 1.74864 14.7182C2.55976 15.5295 3.65701 15.9897 4.80407 15.9996C5.95113 16.0096 7.05622 15.5685 7.88132 14.7715L7.89035 14.7626L9.13717 13.5155C9.42192 13.2307 9.42192 12.7689 9.13717 12.4841C8.85243 12.1993 8.39077 12.1993 8.10602 12.4841L6.86392 13.7265C6.31432 14.2552 5.57945 14.5477 4.81675 14.5411C4.05204 14.5344 3.32054 14.2276 2.77979 13.6868C2.23904 13.1459 1.93231 12.4142 1.92566 11.6494C1.91904 10.8865 2.21146 10.1514 2.74011 9.60172L4.92287 7.41846C5.21854 7.12262 5.57437 6.89384 5.96621 6.74763C6.35805 6.60143 6.77674 6.54123 7.19389 6.57111C7.61104 6.601 8.01688 6.72026 8.38389 6.92082C8.75091 7.12138 9.0705 7.39855 9.32101 7.73352C9.56221 8.05605 10.0191 8.12194 10.3416 7.88068C10.6641 7.63942 10.7299 7.18238 10.4887 6.85985C10.113 6.3574 9.63359 5.94165 9.08307 5.64081C8.53255 5.33997 7.92378 5.16107 7.29806 5.11625Z"></path></g></svg></div><div translated class="pencraft pc-reset _color-secondary_13a18_186 _line-height-20_13a18_95 _font-text_13a18_121 _size-13_13a18_45 _weight-regular_13a18_159 _reset_13a18_1">Copy link</div></button><button tabIndex="0" type="button" class="button share-action"><div class="action-icon"><svg role="img" width="16" height="17" viewBox="0 0 16 17" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><path d="M10.6543 1.38723C10.3533 0.960814 9.95383 0.61341 9.48976 0.374567C9.02902 0.137956 8.51908 0.0130716 8.00115 0.0100098C7.86087 0.0101844 7.72354 0.0502687 7.60519 0.125581C7.48684 0.200893 7.39237 0.308324 7.3328 0.435326L5.00368 5.67077H3.029C2.72335 5.66964 2.42059 5.73003 2.13876 5.84833C1.85692 5.96663 1.60177 6.14043 1.38849 6.35938C1.16707 6.57502 0.991841 6.83346 0.873459 7.11897C0.755078 7.40447 0.696022 7.71108 0.699885 8.02014V13.691C0.699885 14.3087 0.945273 14.9012 1.38207 15.338C1.81886 15.7747 2.41128 16.0201 3.029 16.0201H13.348C13.8951 16.021 14.425 15.8283 14.8438 15.4762C15.2626 15.1241 15.5434 14.6352 15.6366 14.0961L16.6493 8.4252C16.7252 8.09192 16.7252 7.74582 16.6493 7.41254C16.566 7.08205 16.4104 6.7742 16.1936 6.51128C15.9746 6.25 15.7017 6.03926 15.3936 5.89355C15.0762 5.7467 14.7306 5.67068 14.3809 5.67077H10.5328L11.0391 4.37457C11.2397 3.88784 11.3162 3.35894 11.2619 2.83533C11.1853 2.30894 10.9763 1.81065 10.6543 1.38723ZM4.75052 14.5518H3.029C2.91049 14.5525 2.79303 14.5296 2.68349 14.4844C2.57394 14.4392 2.47452 14.3726 2.39102 14.2885C2.23609 14.1199 2.14945 13.8997 2.14799 13.6708V8.02014C2.14913 7.901 2.17389 7.78328 2.22082 7.67377C2.26775 7.56427 2.33592 7.46515 2.4214 7.38216C2.50369 7.29576 2.60267 7.22698 2.71233 7.17998C2.822 7.13298 2.94007 7.10874 3.05938 7.10874H4.7809L4.75052 14.5518ZM10.6746 7.05811H14.3809C14.5145 7.05821 14.6462 7.08942 14.7657 7.14925C14.8875 7.20532 14.9948 7.28845 15.0796 7.39229C15.1675 7.49052 15.2301 7.60871 15.2619 7.73659C15.2922 7.8665 15.2922 8.00162 15.2619 8.13153L14.2493 13.8024C14.2087 14.017 14.094 14.2106 13.9252 14.3492C13.7619 14.4812 13.558 14.5528 13.348 14.5518H6.19862V6.45052L8.43659 1.38723H8.52773C8.9042 1.50037 9.23304 1.73413 9.4636 2.05252C9.69416 2.37092 9.81365 2.75627 9.80368 3.14925C9.8181 3.39741 9.78015 3.64583 9.69229 3.87836L9.23659 5.04292C9.15397 5.273 9.12623 5.51921 9.15558 5.76191C9.1877 6.00427 9.27425 6.23623 9.40875 6.44039C9.5535 6.6376 9.74028 6.80017 9.95558 6.91634C10.1774 7.03206 10.4244 7.0912 10.6746 7.08849V7.05811Z"></path></g></svg></div><div translated class="pencraft pc-reset _color-secondary_13a18_186 _line-height-20_13a18_95 _font-text_13a18_121 _size-13_13a18_45 _weight-regular_13a18_159 _reset_13a18_1">Facebook</div></button><button tabIndex="0" type="button" class="button share-action"><div class="action-icon"><svg role="img" width="21" height="16" viewBox="0 0 21 16" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><path fill-rule="evenodd" clip-rule="evenodd" d="M2.22192 2.20503C2.36754 1.77115 2.78269 1.45455 3.26639 1.45455H17.9332C18.4169 1.45455 18.8321 1.77118 18.9777 2.2051L10.5999 8.02107L2.22192 2.20503ZM2.16639 3.94198V13.4545C2.16639 14.0529 2.66307 14.5455 3.26639 14.5455H17.9332C18.5365 14.5455 19.0332 14.0529 19.0332 13.4545V3.94206L11.0204 9.50462C10.7679 9.67991 10.4318 9.67991 10.1793 9.50462L2.16639 3.94198ZM20.4999 2.55809V13.4545C20.4999 14.8562 19.3465 16 17.9332 16H3.26639C1.85304 16 0.699707 14.8562 0.699707 13.4545V2.54545C0.699707 1.14379 1.85304 0 3.26639 0H17.9332C19.3407 0 20.4904 1.13441 20.4998 2.52818C20.5 2.53816 20.5001 2.54813 20.4999 2.55809Z"></path></g></svg></div><div translated class="pencraft pc-reset _color-secondary_13a18_186 _line-height-20_13a18_95 _font-text_13a18_121 _size-13_13a18_45 _weight-regular_13a18_159 _reset_13a18_1">Email</div></button><button tabIndex="0" type="button" class="button share-action"><div class="action-icon"><svg role="img" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><path d="M6.785 1.92766C5.45134 1.57031 4.08049 2.36176 3.72314 3.69543L0.444815 15.9303C0.0874636 17.264 0.878901 18.6348 2.21255 18.9922L5.37495 19.8396V7.66664C5.37495 6.40099 6.40096 5.37498 7.66661 5.37498H19.4723C19.3299 5.30548 19.1788 5.24858 19.0201 5.20604L6.785 1.92766Z" stroke="none"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M8.44161 7.4C7.86632 7.4 7.39995 7.86637 7.39995 8.44167V22.1081C7.39995 22.6834 7.86631 23.1498 8.4416 23.1498L22.1083 23.15C22.6836 23.15 23.1499 22.6836 23.1499 22.1083V8.44167C23.1499 7.86637 22.6836 7.4 22.1083 7.4H8.44161ZM10.3999 9.65C9.84766 9.65 9.39995 10.0977 9.39995 10.65C9.39995 11.2023 9.84766 11.65 10.3999 11.65H18.3999C18.9522 11.65 19.3999 11.2023 19.3999 10.65C19.3999 10.0977 18.9522 9.65 18.3999 9.65H10.3999ZM10.3999 14.15C9.84766 14.15 9.39995 14.5977 9.39995 15.15C9.39995 15.7023 9.84766 16.15 10.3999 16.15H15.3999C15.9522 16.15 16.3999 15.7023 16.3999 15.15C16.3999 14.5977 15.9522 14.15 15.3999 14.15H10.3999Z" stroke="none"></path></g></svg></div><div class="pencraft pc-reset _color-secondary_13a18_186 _line-height-20_13a18_95 _font-text_13a18_121 _size-13_13a18_45 _weight-regular_13a18_159 _reset_13a18_1">Note</div></button><button tabIndex="0" id="trigger3967" aria-expanded="false" aria-haspopup="dialog" aria-controls="dialog3968" ariaLabel="View more" type="button" class="button share-action"><div class="action-icon"><svg role="img" width="100" height="100" viewBox="0 0 100 100" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><circle cx="23" cy="50" r="9"></circle><circle cx="50" cy="50" r="9"></circle><circle cx="77" cy="50" r="9"></circle></g></svg></div><div translated class="pencraft pc-reset _color-secondary_13a18_186 _line-height-20_13a18_95 _font-text_13a18_121 _size-13_13a18_45 _weight-regular_13a18_159 _reset_13a18_1">Other</div></button></div></div></div></div></div></div></div></div></div><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><a role="button" href="javascript:void(0)" class="post-ufi-button style-button no-icon has-label with-border"><div class="label">Share</div></a></div></div></div></div><div class="visibility-check"></div><div class class><div class="available-content"><div dir="auto" class="body markup"><div class="captioned-image-container"><figure><a class="image-link is-viewable-img image2" target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F41950956-1c34-4bc1-942d-a174356c2ccf_2094x1011.png" data-component-name="Image2ToDOM" rel><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F41950956-1c34-4bc1-942d-a174356c2ccf_2094x1011.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F41950956-1c34-4bc1-942d-a174356c2ccf_2094x1011.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F41950956-1c34-4bc1-942d-a174356c2ccf_2094x1011.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F41950956-1c34-4bc1-942d-a174356c2ccf_2094x1011.png 1456w" sizes="100vw" /><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F41950956-1c34-4bc1-942d-a174356c2ccf_2094x1011.png" width="1456" height="703" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/41950956-1c34-4bc1-942d-a174356c2ccf_2094x1011.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:703,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:771464,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:false,&quot;topImage&quot;:true,&quot;internalRedirect&quot;:null}" class="sizing-normal" alt srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F41950956-1c34-4bc1-942d-a174356c2ccf_2094x1011.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F41950956-1c34-4bc1-942d-a174356c2ccf_2094x1011.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F41950956-1c34-4bc1-942d-a174356c2ccf_2094x1011.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F41950956-1c34-4bc1-942d-a174356c2ccf_2094x1011.png 1456w" sizes="100vw" fetchpriority="high" /></picture><div class="image-link-expand"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 "><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></div></div></a></figure></div><p><em>Written by Zain Malik and Nibir Bora, members of the engineering teams that work on core infrastructure.</em></p><p>At City Storage Systems, our Core Infrastructure team navigates the complexities of managing over 100 multi-tenant Kubernetes clusters, each hosting up to tens of thousands of daily active pods. Our entire software stack runs on Kubernetes from mission critical microservices to stateful databases and observability solutions.</p><p>This blog delves into our journey of achieving complete automation in cluster provisioning, lifecycle management, and upgrades. With the new toolset, we slashed the time required to provision and prepare a workload-ready cluster from 1.5 weeks to under 1 day, all while maintaining a lean team of engineers. This transformation was catalyzed by our strategic decision to migrate to Microsoft Azure within a deadline of a few months. During the transition the number of clusters we operate more than doubled.</p><p><span>We present a set of Kubernetes </span><a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/" rel>custom resources</a><span> and </span><a href="https://kubernetes.io/docs/concepts/extend-kubernetes/operator/" rel>operators</a><span> that models our infrastructure and associated operations. The flexibility of the Kubernetes operator pattern makes this approach extremely powerful and we are confident it can be used to manage clusters on any public cloud provider.</span></p><div class="captioned-image-container"><figure><a class="image-link is-viewable-img image2" target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F735b07a2-b10e-4030-b8ca-4372ab3d02c6_2263x1667.png" data-component-name="Image2ToDOM" rel><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F735b07a2-b10e-4030-b8ca-4372ab3d02c6_2263x1667.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F735b07a2-b10e-4030-b8ca-4372ab3d02c6_2263x1667.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F735b07a2-b10e-4030-b8ca-4372ab3d02c6_2263x1667.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F735b07a2-b10e-4030-b8ca-4372ab3d02c6_2263x1667.png 1456w" sizes="100vw" /><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F735b07a2-b10e-4030-b8ca-4372ab3d02c6_2263x1667.png" width="1456" height="1073" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/735b07a2-b10e-4030-b8ca-4372ab3d02c6_2263x1667.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:1073,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:155776,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:false,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" class="sizing-normal" alt srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F735b07a2-b10e-4030-b8ca-4372ab3d02c6_2263x1667.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F735b07a2-b10e-4030-b8ca-4372ab3d02c6_2263x1667.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F735b07a2-b10e-4030-b8ca-4372ab3d02c6_2263x1667.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F735b07a2-b10e-4030-b8ca-4372ab3d02c6_2263x1667.png 1456w" sizes="100vw" /></picture><div class="image-link-expand"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 "><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></div></div></a></figure></div><p>Figure 1: Hierarchy of all custom resources used to manage a Kubernetes cluster and node pools.</p><h1 class="header-with-anchor-widget">Adopting Cluster API<div id="adopting-cluster-api" class="header-anchor-widget offset-top"><div class="header-anchor-widget-button-container"><div href="https://techblog.citystoragesystems.com/i/142916610/adopting-cluster-api" class="header-anchor-widget-button"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="header-anchor-widget-icon"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></div></div></div></h1><p>We initially created clusters using Terraform and thereon managed node pools using a custom homegrown Kubernetes operator. Changes, including Kubernetes version upgrades, were handled via GitOps. However, the cognitive overhead and manual intervention required made this approach unsustainable, specially to migrate 80+ clusters from one cloud provider to another.</p><p><span>This led us to explore </span><a href="https://cluster-api.sigs.k8s.io/" rel>Cluster API</a><span>, which offers declarative APIs for simplifying provisioning, upgrading, and managing multiple Kubernetes clusters. Two key factors made Cluster API particularly attractive:</span></p><ol><li><p><span>Extensibility: Cluster API's custom resources are extended by </span><a href="https://cluster-api.sigs.k8s.io/reference/providers.html" rel>provider</a><span> custom resources, which can then be extended by higher level custom resources that capture organizational needs. Since our clusters are multi-tenant, this allowed us to abstract away any details about node pools from workload developers.</span></p></li><li><p>Operator Pattern: Any extension of Cluster API and its providers are Kubernetes Operators, aligning with our Kubernetes-centric approach to infrastructure management. Leveraging our team's experience with building operators, the learning curve was minimal.</p></li></ol><p>To create a cluster using Cluster API and the Cluster API provider for Azure (CAPZ) we simply need to create objects of the following custom resources:</p><ol><li><p><code>Cluster</code><span> (from Cluster API)</span></p></li><li><p><code>AzureManagedCluster</code><span> and </span><code>AzureManagedControlPlane</code><span> (from CAPZ)</span></p></li></ol><div class="captioned-image-container"><figure><a class="image-link is-viewable-img image2" target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd0bdfa81-374f-41cb-ab43-8bcc0a54e3f0_1456x592.png" data-component-name="Image2ToDOM" rel><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd0bdfa81-374f-41cb-ab43-8bcc0a54e3f0_1456x592.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd0bdfa81-374f-41cb-ab43-8bcc0a54e3f0_1456x592.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd0bdfa81-374f-41cb-ab43-8bcc0a54e3f0_1456x592.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd0bdfa81-374f-41cb-ab43-8bcc0a54e3f0_1456x592.png 1456w" sizes="100vw" /><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd0bdfa81-374f-41cb-ab43-8bcc0a54e3f0_1456x592.png" width="1456" height="592" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/d0bdfa81-374f-41cb-ab43-8bcc0a54e3f0_1456x592.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:592,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:91650,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" class="sizing-normal" alt srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd0bdfa81-374f-41cb-ab43-8bcc0a54e3f0_1456x592.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd0bdfa81-374f-41cb-ab43-8bcc0a54e3f0_1456x592.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd0bdfa81-374f-41cb-ab43-8bcc0a54e3f0_1456x592.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd0bdfa81-374f-41cb-ab43-8bcc0a54e3f0_1456x592.png 1456w" sizes="100vw" loading="lazy" /></picture><div class="image-link-expand"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 "><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></div></div></a></figure></div><div class="captioned-image-container"><figure><a class="image-link is-viewable-img image2" target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbca26f04-8570-47f9-a972-4c0506a560dd_1456x852.png" data-component-name="Image2ToDOM" rel><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbca26f04-8570-47f9-a972-4c0506a560dd_1456x852.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbca26f04-8570-47f9-a972-4c0506a560dd_1456x852.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbca26f04-8570-47f9-a972-4c0506a560dd_1456x852.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbca26f04-8570-47f9-a972-4c0506a560dd_1456x852.png 1456w" sizes="100vw" /><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbca26f04-8570-47f9-a972-4c0506a560dd_1456x852.png" width="1456" height="852" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/bca26f04-8570-47f9-a972-4c0506a560dd_1456x852.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:852,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:182028,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" class="sizing-normal" alt srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbca26f04-8570-47f9-a972-4c0506a560dd_1456x852.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbca26f04-8570-47f9-a972-4c0506a560dd_1456x852.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbca26f04-8570-47f9-a972-4c0506a560dd_1456x852.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbca26f04-8570-47f9-a972-4c0506a560dd_1456x852.png 1456w" sizes="100vw" loading="lazy" /></picture><div class="image-link-expand"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 "><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></div></div></a></figure></div><div class="captioned-image-container"><figure><a class="image-link image2" target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F31f6ca26-159f-4da8-95ac-e8d750279794_1456x294.png" data-component-name="Image2ToDOM" rel><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F31f6ca26-159f-4da8-95ac-e8d750279794_1456x294.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F31f6ca26-159f-4da8-95ac-e8d750279794_1456x294.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F31f6ca26-159f-4da8-95ac-e8d750279794_1456x294.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F31f6ca26-159f-4da8-95ac-e8d750279794_1456x294.png 1456w" sizes="100vw" /><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F31f6ca26-159f-4da8-95ac-e8d750279794_1456x294.png" width="1456" height="294" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/31f6ca26-159f-4da8-95ac-e8d750279794_1456x294.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:294,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:57239,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" class="sizing-normal" alt srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F31f6ca26-159f-4da8-95ac-e8d750279794_1456x294.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F31f6ca26-159f-4da8-95ac-e8d750279794_1456x294.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F31f6ca26-159f-4da8-95ac-e8d750279794_1456x294.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F31f6ca26-159f-4da8-95ac-e8d750279794_1456x294.png 1456w" sizes="100vw" loading="lazy" /></picture><div></div></div></a></figure></div><p>Similarly, to create a node pool we need to create objects of the following custom resources:</p><ol><li><p><code>MachinePool</code><span> (from Cluster API)</span></p></li><li><p><code>AzureManagedMachinePool</code><span> (from CAPZ)</span></p></li></ol><div class="captioned-image-container"><figure><a class="image-link is-viewable-img image2" target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6b1993e4-d57e-43a3-ac72-b0961df74422_1456x816.png" data-component-name="Image2ToDOM" rel><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6b1993e4-d57e-43a3-ac72-b0961df74422_1456x816.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6b1993e4-d57e-43a3-ac72-b0961df74422_1456x816.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6b1993e4-d57e-43a3-ac72-b0961df74422_1456x816.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6b1993e4-d57e-43a3-ac72-b0961df74422_1456x816.png 1456w" sizes="100vw" /><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6b1993e4-d57e-43a3-ac72-b0961df74422_1456x816.png" width="1456" height="816" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/6b1993e4-d57e-43a3-ac72-b0961df74422_1456x816.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:816,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:187767,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" class="sizing-normal" alt srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6b1993e4-d57e-43a3-ac72-b0961df74422_1456x816.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6b1993e4-d57e-43a3-ac72-b0961df74422_1456x816.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6b1993e4-d57e-43a3-ac72-b0961df74422_1456x816.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6b1993e4-d57e-43a3-ac72-b0961df74422_1456x816.png 1456w" sizes="100vw" loading="lazy" /></picture><div class="image-link-expand"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 "><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></div></div></a></figure></div><div class="captioned-image-container"><figure><a class="image-link is-viewable-img image2" target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcd0478f0-121d-468d-a068-7af386804540_1456x630.png" data-component-name="Image2ToDOM" rel><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcd0478f0-121d-468d-a068-7af386804540_1456x630.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcd0478f0-121d-468d-a068-7af386804540_1456x630.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcd0478f0-121d-468d-a068-7af386804540_1456x630.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcd0478f0-121d-468d-a068-7af386804540_1456x630.png 1456w" sizes="100vw" /><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcd0478f0-121d-468d-a068-7af386804540_1456x630.png" width="1456" height="630" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/cd0478f0-121d-468d-a068-7af386804540_1456x630.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:630,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:126191,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" class="sizing-normal" alt srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcd0478f0-121d-468d-a068-7af386804540_1456x630.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcd0478f0-121d-468d-a068-7af386804540_1456x630.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcd0478f0-121d-468d-a068-7af386804540_1456x630.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcd0478f0-121d-468d-a068-7af386804540_1456x630.png 1456w" sizes="100vw" loading="lazy" /></picture><div class="image-link-expand"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 "><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></div></div></a></figure></div><p><span>We were able to seamlessly integrate these processes into our existing CI pipelines, relying fully on GitOps for cluster management. We do not use the </span><code>clusterctl</code><span> CLI provided by Cluster API.</span></p><p>However, there were three major roadblocks to adopting Cluster API immediately:</p><ol><li><p>Limited support for managed Kubernetes distributions in Cluster API. Although this was part of Cluster APIs roadmap, most of the work done was focused on self-managed Kubernetes.</p></li><li><p>CAPZs support for Azure Kubernetes Service (AKS), the managed Kubernetes distribution, was still in an experimental phase, lacking essential features required for our use case.</p></li><li><p>No major engineering organization was using Cluster API for AKS (not that we knew of at the time).</p></li></ol><p>We leaned on our partnership with Microsoft Azure to find a path forward. They suggested we collaborate on the CAPZ project in open source to achieve feature completeness. Several engineers from the Microsoft AKS team along with engineers from our Core Infrastructure team contributed to the CAPZ project prioritizing features aligned with our production use cases. This collaboration was a huge success. It enabled us to launch our first Kubernetes cluster using Cluster API and CAPZ within three months.</p><h1 class="header-with-anchor-widget">Automating Workload-Ready Clusters<div id="automating-workload-ready-clusters" class="header-anchor-widget offset-top"><div class="header-anchor-widget-button-container"><div href="https://techblog.citystoragesystems.com/i/142916610/automating-workload-ready-clusters" class="header-anchor-widget-button"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="header-anchor-widget-icon"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></div></div></div></h1><p>While Cluster API and CAPZ simplified cluster creation, these clusters werent ready for workloads yet.</p><ol><li><p>The new cluster does not have permission to access container images from Azure Container Registry (ACR). It is a reasonable design choice to leave such dependencies out of Cluster API to keep the interface generic.</p></li><li><p>An AKS cluster comes configured with a default cluster autoscaler profile. Configuring anything other than default can be done by manually running a Azure CLI command. We tune Cluster Autoscaler to achieve resource optimization and bin-packing on all of our production clusters.</p></li></ol><p><span>Using Terraform and running Azure CLI commands to configure these for every cluster wasnt aligned with our principle of minimizing human intervention. So, we decided to write a companion Kubernetes operator instead. This introduces a </span><code>AzureClusterAdditionalConfig</code><span>, an extensible custom resource intended for any additional Azure managed service configurations necessary for a cluster. For ACR permissions this resolves to a </span><code>AzureRoleAssignment</code><span> object, and a </span><code>AzureClusterAutoscaler</code><span> object for custom cluster autoscaler configuration.</span></p><div class="captioned-image-container"><figure><a class="image-link is-viewable-img image2" target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F985a5052-d642-4bd4-a649-512f03b449bf_1456x852.png" data-component-name="Image2ToDOM" rel><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F985a5052-d642-4bd4-a649-512f03b449bf_1456x852.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F985a5052-d642-4bd4-a649-512f03b449bf_1456x852.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F985a5052-d642-4bd4-a649-512f03b449bf_1456x852.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F985a5052-d642-4bd4-a649-512f03b449bf_1456x852.png 1456w" sizes="100vw" /><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F985a5052-d642-4bd4-a649-512f03b449bf_1456x852.png" width="1456" height="852" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/985a5052-d642-4bd4-a649-512f03b449bf_1456x852.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:852,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:203327,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" class="sizing-normal" alt srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F985a5052-d642-4bd4-a649-512f03b449bf_1456x852.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F985a5052-d642-4bd4-a649-512f03b449bf_1456x852.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F985a5052-d642-4bd4-a649-512f03b449bf_1456x852.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F985a5052-d642-4bd4-a649-512f03b449bf_1456x852.png 1456w" sizes="100vw" loading="lazy" /></picture><div class="image-link-expand"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 "><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></div></div></a></figure></div><div class="captioned-image-container"><figure><a class="image-link is-viewable-img image2" target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fee4c476b-d8b1-40b4-8bb2-28cd780b7019_1456x518.png" data-component-name="Image2ToDOM" rel><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fee4c476b-d8b1-40b4-8bb2-28cd780b7019_1456x518.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fee4c476b-d8b1-40b4-8bb2-28cd780b7019_1456x518.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fee4c476b-d8b1-40b4-8bb2-28cd780b7019_1456x518.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fee4c476b-d8b1-40b4-8bb2-28cd780b7019_1456x518.png 1456w" sizes="100vw" /><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fee4c476b-d8b1-40b4-8bb2-28cd780b7019_1456x518.png" width="1456" height="518" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/ee4c476b-d8b1-40b4-8bb2-28cd780b7019_1456x518.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:518,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:131708,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" class="sizing-normal" alt srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fee4c476b-d8b1-40b4-8bb2-28cd780b7019_1456x518.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fee4c476b-d8b1-40b4-8bb2-28cd780b7019_1456x518.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fee4c476b-d8b1-40b4-8bb2-28cd780b7019_1456x518.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fee4c476b-d8b1-40b4-8bb2-28cd780b7019_1456x518.png 1456w" sizes="100vw" loading="lazy" /></picture><div class="image-link-expand"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 "><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></div></div></a></figure></div><div class="captioned-image-container"><figure><a class="image-link is-viewable-img image2" target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3a8fee42-a7db-4ff8-b08a-7de297c167c0_1456x666.png" data-component-name="Image2ToDOM" rel><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3a8fee42-a7db-4ff8-b08a-7de297c167c0_1456x666.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3a8fee42-a7db-4ff8-b08a-7de297c167c0_1456x666.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3a8fee42-a7db-4ff8-b08a-7de297c167c0_1456x666.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3a8fee42-a7db-4ff8-b08a-7de297c167c0_1456x666.png 1456w" sizes="100vw" /><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3a8fee42-a7db-4ff8-b08a-7de297c167c0_1456x666.png" width="1456" height="666" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/3a8fee42-a7db-4ff8-b08a-7de297c167c0_1456x666.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:666,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:152009,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" class="sizing-normal" alt srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3a8fee42-a7db-4ff8-b08a-7de297c167c0_1456x666.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3a8fee42-a7db-4ff8-b08a-7de297c167c0_1456x666.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3a8fee42-a7db-4ff8-b08a-7de297c167c0_1456x666.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3a8fee42-a7db-4ff8-b08a-7de297c167c0_1456x666.png 1456w" sizes="100vw" loading="lazy" /></picture><div class="image-link-expand"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 "><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></div></div></a></figure></div><p>Introducing the companion operator enabled us to fully automate cluster creation and prepare them to be workload-ready by installing a single kubernetes resource using GitOps. This streamlined approach facilitated the migration of over 80 production clusters between different cloud providers.</p><h1 class="header-with-anchor-widget">Automating Node Pools<div id="automating-node-pools" class="header-anchor-widget offset-top"><div class="header-anchor-widget-button-container"><div href="https://techblog.citystoragesystems.com/i/142916610/automating-node-pools" class="header-anchor-widget-button"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="header-anchor-widget-icon"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></div></div></div></h1><p>After running production workloads on a new cloud provider for a few months, we identified two major operational pain points.</p><ol><li><p>We didnt nail the node types (instance family, disk type, etc. settings) at the first attempt. Some of these fields like machineType, diskSize, diskType, maxPod, type (spot vs regular) are immutable fields on AKS. This meant we had to replace node pools running production workloads a handful of times. Each replacement involved creating a new node pool, draining the old one, then deleting it. This process required human coordination and multiple steps in our GitOps workflow.</p></li><li><p><span>While updating Kubernetes version we learned that AKSs in-place node pool upgrade tends to enter an endless retry loop when it encounters an application with 0 disruptions allowed (PodDisruptionBudget setting). Since AKS only </span><a href="https://learn.microsoft.com/en-us/troubleshoot/azure/azure-kubernetes/operationnotallowed" rel>permits</a><span> one concurrent node pool update operation per cluster, this block operations on other node pools including manual scale up. Consequently, we had to fall back to the multi-step node pool replacement process for upgrades as well.</span></p></li></ol><p><span>We implemented a node pool Kubernetes operator, which introduces a single </span><code>Nodepool</code><span> resource encapsulating the multi-step process for replacing a node pool. Under the hood, the operator creates a new node pool, drains the old one, then deletes it in a process completely opaque from the users. From the users perspective all node pool manipulations are done in-place with a single GitOps change. This end-to-end automation is especially powerful during Kubernetes version upgrades.</span></p><div class="captioned-image-container"><figure><a class="image-link is-viewable-img image2" target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbc3bac98-3e65-43c6-867b-0e59195ecec0_1456x1188.png" data-component-name="Image2ToDOM" rel><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbc3bac98-3e65-43c6-867b-0e59195ecec0_1456x1188.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbc3bac98-3e65-43c6-867b-0e59195ecec0_1456x1188.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbc3bac98-3e65-43c6-867b-0e59195ecec0_1456x1188.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbc3bac98-3e65-43c6-867b-0e59195ecec0_1456x1188.png 1456w" sizes="100vw" /><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbc3bac98-3e65-43c6-867b-0e59195ecec0_1456x1188.png" width="1456" height="1188" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/bc3bac98-3e65-43c6-867b-0e59195ecec0_1456x1188.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:1188,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:263282,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" class="sizing-normal" alt srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbc3bac98-3e65-43c6-867b-0e59195ecec0_1456x1188.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbc3bac98-3e65-43c6-867b-0e59195ecec0_1456x1188.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbc3bac98-3e65-43c6-867b-0e59195ecec0_1456x1188.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbc3bac98-3e65-43c6-867b-0e59195ecec0_1456x1188.png 1456w" sizes="100vw" loading="lazy" /></picture><div class="image-link-expand"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 "><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></div></div></a></figure></div><p><span>The only limitation was that we couldnt link the new </span><code>Nodepool</code><span> resource to the existing hierarchy of Cluster APIs </span><code>MachinePool</code><span> or CAPZs </span><code>AzureManagedMachinePool</code><span> resource using </span><code>ownerReference</code><span>. Instead, these resources exist side by side and are linked using </span><code>objectReference</code><span>. This drawback becomes apparent when deleting a node pool entirely, as the resource hierarchy is removed using </span><a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/finalizers/" rel>finalizers</a><span>.</span></p><h1 class="header-with-anchor-widget">Conclusion<div id="conclusion" class="header-anchor-widget offset-top"><div class="header-anchor-widget-button-container"><div href="https://techblog.citystoragesystems.com/i/142916610/conclusion" class="header-anchor-widget-button"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="header-anchor-widget-icon"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></div></div></div></h1><div class="captioned-image-container"><figure><a class="image-link is-viewable-img image2" target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbbad4eef-1625-4a4a-9aae-5e7a2606a94d_1914x702.png" data-component-name="Image2ToDOM" rel><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbbad4eef-1625-4a4a-9aae-5e7a2606a94d_1914x702.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbbad4eef-1625-4a4a-9aae-5e7a2606a94d_1914x702.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbbad4eef-1625-4a4a-9aae-5e7a2606a94d_1914x702.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbbad4eef-1625-4a4a-9aae-5e7a2606a94d_1914x702.png 1456w" sizes="100vw" /><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbbad4eef-1625-4a4a-9aae-5e7a2606a94d_1914x702.png" width="1456" height="534" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/bbad4eef-1625-4a4a-9aae-5e7a2606a94d_1914x702.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:534,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:88135,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" class="sizing-normal" alt srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbbad4eef-1625-4a4a-9aae-5e7a2606a94d_1914x702.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbbad4eef-1625-4a4a-9aae-5e7a2606a94d_1914x702.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbbad4eef-1625-4a4a-9aae-5e7a2606a94d_1914x702.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbbad4eef-1625-4a4a-9aae-5e7a2606a94d_1914x702.png 1456w" sizes="100vw" loading="lazy" /></picture><div class="image-link-expand"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 "><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></div></div></a></figure></div><p>Figure 2: Complete cluster management stack.</p><p><span>Evolving our cluster management toolchain empowered us to manage twice as many clusters and applications, while sustaining the same handful of engineers on our Core Infrastructure team. This achievement marks a significant boost in operational efficiency, made possible by our steadfast commitment to GitOps principles and the elimination of human-in-the-loop processes. Along the same lines, self-healing, drift detection, etc. are first class ideas on our platform. This mindset allows us to always </span><em>prioritize organizational needs</em><span> leveraging the extensible nature of Kubernetes, while balancing efficiency, reliability and agility.</span></p><p>Reflecting on our journey, we've had some key learnings and missteps:</p><ol><li><p><strong>Big Bold Bets</strong><span>: When we explored the industry state-of-the-art for cluster management we couldnt find anything that meets the level of automation we were striving for. At such times, we leaned on our companys core value - Big Bold Bets. The bet on Cluster API was fruitful in the long run.</span></p></li><li><p><strong>Hidden cost of Open Source</strong><span>: Strategic partnership and driving appropriate community engagement was vital to making our open source collaboration a success. We did learn that a long term commitment is necessary to be able to effectively steer an open source project to continue to meet our needs. We remain committed to contributing to Cluster API for the foreseeable future.</span></p></li><li><p><strong>First Adopter Risks</strong><span>: We experienced a Sev1 incident lasting several hours where 60% of our nodes on production clusters were wiped out. We traced it to a bug in CAPZ where just the sequence number suffix was used to identify nodes instead of the full </span><code>spec.providerID</code><span>. This caused Cluster API to reference nodes from different node pools within a cluster using the same ID and in turn deleting them.</span></p></li><li><p><strong>Automation Enhances Reliability</strong><span>: Despite not being the primary focus, our automation efforts significantly improved systems reliability. Weve successfully completed 4 incident-free Kubernetes version upgrades. Previously, there used to be at least one incident per version upgrade.</span></p></li><li><p><strong>Kubernetes Operator Pattern</strong><span>: We leverage Kubernetes operators extensively in our infrastructure organization. Adhering to standard design patterns like goal state reconciliation enables us to sidestep design debates, mitigate concerns about corner cases, and minimize the learning curve. This along with using managed Kubernetes distributions exclusively was the right tradeoff for us. We remain committed to this approach even today.</span></p></li></ol><p>So, what lies ahead for us? We've already kicked off a strategic plan to get us to the next level of scale. This involves automatically partitioning workload clusters, considering factors such as API Server pressure and node size. We've also started provisioning more single-tenant clusters. Furthermore, efforts are underway to streamline the time it takes to prepare workload-ready clusters, including steps like IP address allocation and installing cluster addons. All these initiatives are guided by our commitment to minimizing human intervention and achieving full automation. With this roadmap, we aim to adeptly manage over 500 Kubernetes clusters efficiently.</p><p><em>We would like to acknowledge Ccile Robert-Michon, David Tesar, and Jack Francis at Microsoft. Each contributed during various phases of the project.</em></p></div></div><div class="visibility-check"></div><div class="post-footer"><div class="pencraft pc-display-flex pc-gap-16 pc-paddingTop-16 pc-paddingBottom-16 pc-justifyContent-space-between pc-alignItems-center _flexGrow_1o6bj_209 pc-reset _border-top-detail-themed_1o6bj_52 _border-bottom-detail-themed_1o6bj_55 post-ufi"><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><div class="like-button-container post-ufi-button style-button"><a role="button" class="post-ufi-button style-button has-label with-border"><svg role="img" style="height: 20px; width: 20px;" width="20" height="20" viewBox="0 0 24 24" fill="#000000" stroke-width="2" stroke="#000" xmlns="http://www.w3.org/2000/svg" class="icon"><g><title></title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-heart "><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path></svg></g></svg><div class="label">3</div></a><div inert role="dialog" class="modal typography out gone share-dialog popup"><div class="modal-table"><div class="modal-row"><div class="modal-cell modal-content no-fullscreen"><div class="container"><button tabIndex="0" type="button" data-testid="close-modal" class="pencraft pc-reset pencraft modal-btn modal-exit-btn no-margin _iconButton_11e9v_126 _iconButtonBase_11e9v_126 _buttonBase_11e9v_1 _buttonOldColors_11e9v_44 _size_40_11e9v_156 _priority_secondary_11e9v_51 _fill_empty_11e9v_298 _rounded_11e9v_136"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="secondary" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x "><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg></button><div class="share-dialog-title">Share this post</div><div class="pencraft pc-display-flex pc-flexDirection-column pc-gap-32 pc-paddingLeft-24 pc-paddingRight-24 pc-paddingTop-32 pc-paddingBottom-48 pc-reset"><div class="pencraft pc-display-flex pc-padding-8 pc-reset _border-detail_1o6bj_25 pc-borderRadius-md social-preview-box post"><div class="social-image-box"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_120,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8ec528f2-0ea8-4e52-87e4-f129052c741d_2000x1361.png" /><img src="https://substackcdn.com/image/fetch/w_120,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8ec528f2-0ea8-4e52-87e4-f129052c741d_2000x1361.png" sizes="100vw" alt loading="lazy" width="120" class="_img_16u6n_1 social-image pencraft pc-reset" /></picture></div><div class="pencraft pc-display-flex pc-flexDirection-column pc-paddingTop-8 pc-paddingBottom-8 pc-paddingLeft-12 pc-reset"><h4 class="pencraft pc-reset _line-height-24_13a18_98 _font-display_13a18_118 _size-20_13a18_70 _weight-bold_13a18_168 _reset_13a18_1">Managing 100s of Kubernetes Clusters using Cluster API</h4><div class="pencraft pc-reset _color-secondary_13a18_186 _line-height-20_13a18_95 _font-text_13a18_121 _size-13_13a18_45 _weight-regular_13a18_159 _reset_13a18_1">techblog.citystoragesystems.com</div></div></div><div class="pencraft pc-display-flex pc-gap-8 pc-justifyContent-space-between pc-reset share-dialog-buttons-wrapper"><button tabIndex="0" type="button" class="button share-action"><div class="action-icon"><svg role="img" width="20" height="16" viewBox="0 0 20 16" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><path fill-rule="evenodd" clip-rule="evenodd" d="M12.1303 0.000379039C10.9833 -0.00959082 9.87819 0.431464 9.05309 1.22855L9.04556 1.23593L7.79145 2.48303C7.50587 2.767 7.50453 3.22877 7.78844 3.51441C8.07235 3.80004 8.53401 3.80139 8.81959 3.51741L10.0698 2.27423C10.6194 1.74503 11.3546 1.45229 12.1177 1.45892C12.8824 1.46556 13.6139 1.77236 14.1546 2.31323C14.6954 2.8541 15.0021 3.58577 15.0087 4.35065C15.0154 5.11353 14.7229 5.84857 14.1943 6.39829L12.0116 8.58145L12.0115 8.58155C11.7159 8.87739 11.36 9.10617 10.9682 9.25237C10.5764 9.39857 10.1577 9.45878 9.74051 9.42889C9.32337 9.39901 8.91752 9.27975 8.55051 9.07918C8.1835 8.87862 7.8639 8.60146 7.6134 8.26649C7.3722 7.94396 6.91526 7.87807 6.5928 8.11933C6.27034 8.36059 6.20447 8.81763 6.44567 9.14016C6.82142 9.64261 7.30082 10.0584 7.85134 10.3592C8.40186 10.66 9.01062 10.8389 9.63634 10.8838C10.2621 10.9286 10.8901 10.8383 11.4779 10.619C12.0656 10.3997 12.5994 10.0565 13.0429 9.61274L15.2302 7.42494L15.2391 7.4159C16.036 6.59062 16.4769 5.48529 16.467 4.33797C16.457 3.19066 15.9969 2.09316 15.1858 1.28185C14.3746 0.470545 13.2774 0.0103489 12.1303 0.000379039ZM7.29806 5.11625C6.67234 5.07142 6.0443 5.16173 5.45654 5.38103C4.86882 5.60031 4.33502 5.94355 3.89153 6.38727L1.70423 8.57506L1.69534 8.5841C0.898438 9.40939 0.457483 10.5147 0.467451 11.662C0.477418 12.8094 0.937512 13.9069 1.74864 14.7182C2.55976 15.5295 3.65701 15.9897 4.80407 15.9996C5.95113 16.0096 7.05622 15.5685 7.88132 14.7715L7.89035 14.7626L9.13717 13.5155C9.42192 13.2307 9.42192 12.7689 9.13717 12.4841C8.85243 12.1993 8.39077 12.1993 8.10602 12.4841L6.86392 13.7265C6.31432 14.2552 5.57945 14.5477 4.81675 14.5411C4.05204 14.5344 3.32054 14.2276 2.77979 13.6868C2.23904 13.1459 1.93231 12.4142 1.92566 11.6494C1.91904 10.8865 2.21146 10.1514 2.74011 9.60172L4.92287 7.41846C5.21854 7.12262 5.57437 6.89384 5.96621 6.74763C6.35805 6.60143 6.77674 6.54123 7.19389 6.57111C7.61104 6.601 8.01688 6.72026 8.38389 6.92082C8.75091 7.12138 9.0705 7.39855 9.32101 7.73352C9.56221 8.05605 10.0191 8.12194 10.3416 7.88068C10.6641 7.63942 10.7299 7.18238 10.4887 6.85985C10.113 6.3574 9.63359 5.94165 9.08307 5.64081C8.53255 5.33997 7.92378 5.16107 7.29806 5.11625Z"></path></g></svg></div><div translated class="pencraft pc-reset _color-secondary_13a18_186 _line-height-20_13a18_95 _font-text_13a18_121 _size-13_13a18_45 _weight-regular_13a18_159 _reset_13a18_1">Copy link</div></button><button tabIndex="0" type="button" class="button share-action"><div class="action-icon"><svg role="img" width="16" height="17" viewBox="0 0 16 17" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><path d="M10.6543 1.38723C10.3533 0.960814 9.95383 0.61341 9.48976 0.374567C9.02902 0.137956 8.51908 0.0130716 8.00115 0.0100098C7.86087 0.0101844 7.72354 0.0502687 7.60519 0.125581C7.48684 0.200893 7.39237 0.308324 7.3328 0.435326L5.00368 5.67077H3.029C2.72335 5.66964 2.42059 5.73003 2.13876 5.84833C1.85692 5.96663 1.60177 6.14043 1.38849 6.35938C1.16707 6.57502 0.991841 6.83346 0.873459 7.11897C0.755078 7.40447 0.696022 7.71108 0.699885 8.02014V13.691C0.699885 14.3087 0.945273 14.9012 1.38207 15.338C1.81886 15.7747 2.41128 16.0201 3.029 16.0201H13.348C13.8951 16.021 14.425 15.8283 14.8438 15.4762C15.2626 15.1241 15.5434 14.6352 15.6366 14.0961L16.6493 8.4252C16.7252 8.09192 16.7252 7.74582 16.6493 7.41254C16.566 7.08205 16.4104 6.7742 16.1936 6.51128C15.9746 6.25 15.7017 6.03926 15.3936 5.89355C15.0762 5.7467 14.7306 5.67068 14.3809 5.67077H10.5328L11.0391 4.37457C11.2397 3.88784 11.3162 3.35894 11.2619 2.83533C11.1853 2.30894 10.9763 1.81065 10.6543 1.38723ZM4.75052 14.5518H3.029C2.91049 14.5525 2.79303 14.5296 2.68349 14.4844C2.57394 14.4392 2.47452 14.3726 2.39102 14.2885C2.23609 14.1199 2.14945 13.8997 2.14799 13.6708V8.02014C2.14913 7.901 2.17389 7.78328 2.22082 7.67377C2.26775 7.56427 2.33592 7.46515 2.4214 7.38216C2.50369 7.29576 2.60267 7.22698 2.71233 7.17998C2.822 7.13298 2.94007 7.10874 3.05938 7.10874H4.7809L4.75052 14.5518ZM10.6746 7.05811H14.3809C14.5145 7.05821 14.6462 7.08942 14.7657 7.14925C14.8875 7.20532 14.9948 7.28845 15.0796 7.39229C15.1675 7.49052 15.2301 7.60871 15.2619 7.73659C15.2922 7.8665 15.2922 8.00162 15.2619 8.13153L14.2493 13.8024C14.2087 14.017 14.094 14.2106 13.9252 14.3492C13.7619 14.4812 13.558 14.5528 13.348 14.5518H6.19862V6.45052L8.43659 1.38723H8.52773C8.9042 1.50037 9.23304 1.73413 9.4636 2.05252C9.69416 2.37092 9.81365 2.75627 9.80368 3.14925C9.8181 3.39741 9.78015 3.64583 9.69229 3.87836L9.23659 5.04292C9.15397 5.273 9.12623 5.51921 9.15558 5.76191C9.1877 6.00427 9.27425 6.23623 9.40875 6.44039C9.5535 6.6376 9.74028 6.80017 9.95558 6.91634C10.1774 7.03206 10.4244 7.0912 10.6746 7.08849V7.05811Z"></path></g></svg></div><div translated class="pencraft pc-reset _color-secondary_13a18_186 _line-height-20_13a18_95 _font-text_13a18_121 _size-13_13a18_45 _weight-regular_13a18_159 _reset_13a18_1">Facebook</div></button><button tabIndex="0" type="button" class="button share-action"><div class="action-icon"><svg role="img" width="21" height="16" viewBox="0 0 21 16" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><path fill-rule="evenodd" clip-rule="evenodd" d="M2.22192 2.20503C2.36754 1.77115 2.78269 1.45455 3.26639 1.45455H17.9332C18.4169 1.45455 18.8321 1.77118 18.9777 2.2051L10.5999 8.02107L2.22192 2.20503ZM2.16639 3.94198V13.4545C2.16639 14.0529 2.66307 14.5455 3.26639 14.5455H17.9332C18.5365 14.5455 19.0332 14.0529 19.0332 13.4545V3.94206L11.0204 9.50462C10.7679 9.67991 10.4318 9.67991 10.1793 9.50462L2.16639 3.94198ZM20.4999 2.55809V13.4545C20.4999 14.8562 19.3465 16 17.9332 16H3.26639C1.85304 16 0.699707 14.8562 0.699707 13.4545V2.54545C0.699707 1.14379 1.85304 0 3.26639 0H17.9332C19.3407 0 20.4904 1.13441 20.4998 2.52818C20.5 2.53816 20.5001 2.54813 20.4999 2.55809Z"></path></g></svg></div><div translated class="pencraft pc-reset _color-secondary_13a18_186 _line-height-20_13a18_95 _font-text_13a18_121 _size-13_13a18_45 _weight-regular_13a18_159 _reset_13a18_1">Email</div></button><button tabIndex="0" type="button" class="button share-action"><div class="action-icon"><svg role="img" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><path d="M6.785 1.92766C5.45134 1.57031 4.08049 2.36176 3.72314 3.69543L0.444815 15.9303C0.0874636 17.264 0.878901 18.6348 2.21255 18.9922L5.37495 19.8396V7.66664C5.37495 6.40099 6.40096 5.37498 7.66661 5.37498H19.4723C19.3299 5.30548 19.1788 5.24858 19.0201 5.20604L6.785 1.92766Z" stroke="none"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M8.44161 7.4C7.86632 7.4 7.39995 7.86637 7.39995 8.44167V22.1081C7.39995 22.6834 7.86631 23.1498 8.4416 23.1498L22.1083 23.15C22.6836 23.15 23.1499 22.6836 23.1499 22.1083V8.44167C23.1499 7.86637 22.6836 7.4 22.1083 7.4H8.44161ZM10.3999 9.65C9.84766 9.65 9.39995 10.0977 9.39995 10.65C9.39995 11.2023 9.84766 11.65 10.3999 11.65H18.3999C18.9522 11.65 19.3999 11.2023 19.3999 10.65C19.3999 10.0977 18.9522 9.65 18.3999 9.65H10.3999ZM10.3999 14.15C9.84766 14.15 9.39995 14.5977 9.39995 15.15C9.39995 15.7023 9.84766 16.15 10.3999 16.15H15.3999C15.9522 16.15 16.3999 15.7023 16.3999 15.15C16.3999 14.5977 15.9522 14.15 15.3999 14.15H10.3999Z" stroke="none"></path></g></svg></div><div class="pencraft pc-reset _color-secondary_13a18_186 _line-height-20_13a18_95 _font-text_13a18_121 _size-13_13a18_45 _weight-regular_13a18_159 _reset_13a18_1">Note</div></button><button tabIndex="0" id="trigger3971" aria-expanded="false" aria-haspopup="dialog" aria-controls="dialog3972" ariaLabel="View more" type="button" class="button share-action"><div class="action-icon"><svg role="img" width="100" height="100" viewBox="0 0 100 100" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><circle cx="23" cy="50" r="9"></circle><circle cx="50" cy="50" r="9"></circle><circle cx="77" cy="50" r="9"></circle></g></svg></div><div translated class="pencraft pc-reset _color-secondary_13a18_186 _line-height-20_13a18_95 _font-text_13a18_121 _size-13_13a18_45 _weight-regular_13a18_159 _reset_13a18_1">Other</div></button></div></div></div></div></div></div></div></div></div><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><a role="button" href="javascript:void(0)" class="post-ufi-button style-button no-icon has-label with-border"><div class="label">Share</div></a></div></div></div></div></article></div></div><div class="single-post-section"><div class="container"><div class="visibility-check"></div><div class="pencraft pc-paddingTop-24 pc-paddingBottom-24 pc-reset"><div class="portable-archive empty-list"><div class="pencraft pc-display-flex pc-paddingLeft-8 pc-paddingRight-8 pc-paddingBottom-16 pc-justifyContent-space-between pc-alignItems-center pc-reset"><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><div role="button" class="_pillTab_p4io0_1 _pillTabActive_p4io0_15">Top</div><div role="button" class="_pillTab_p4io0_1">New</div></div><button tabIndex="0" type="button" class="pencraft pc-reset pencraft _iconButton2_11e9v_668 _iconButtonBase_11e9v_126 _buttonBase_11e9v_1 _buttonNew_11e9v_71 _size_md_11e9v_108 _priority_secondary_11e9v_51 _rounded_11e9v_136"><svg role="img" style="height: 20px; width: 20px;" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><path d="M11 19C15.4183 19 19 15.4183 19 11C19 6.58172 15.4183 3 11 3C6.58172 3 3 6.58172 3 11C3 15.4183 6.58172 19 11 19Z" stroke="#555555" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M21.0004 21.0004L16.6504 16.6504" stroke="#555555" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></g></svg></button></div><div class="portable-archive-list"><p class="portable-archive-empty">No posts</p></div></div></div></div></div><div class="visibility-check"></div><div class="subscribe-footer"><div class="container"><p>Ready for more?</p><div class="pencraft pc-display-flex pc-justifyContent-center pc-reset"><div><div class="_container_1cqch_1"><form action="/api/v1/free?nojs=true" method="post" noValidate class="form _form_1cqch_6"><input type="hidden" name="first_url" /><input type="hidden" name="first_referrer" /><input type="hidden" name="current_url" /><input type="hidden" name="current_referrer" /><input type="hidden" name="referral_code" /><input type="hidden" name="source" value="subscribe_footer" /><input type="hidden" name="referring_pub_id" /><input type="hidden" name="additional_referring_pub_ids" /><div class="_sideBySideWrap_1cqch_10"><div class="_emailInputWrapper_1cqch_55"><input type="email" name="email" placeholder="Type your email..." class="pencraft _emailInput_1cqch_23 _emailInputOnAccentBackground_1cqch_47" /></div><button tabIndex="0" type="submit" class="button rightButton primary subscribe-btn _button_1cqch_74 _buttonOnAccentBackground_1cqch_87"><span class="button-text ">Subscribe</span></button></div><div id="error-container"></div></form></div></div></div></div></div></div></div><div class="footer-wrap publication-footer"><div class="visibility-check"></div><div class="footer themed-background"><div class="container"><div class="footer-blurbs"><div class="footer-copyright-blurb"> 2024 City Storage Systems</div><div class="footer-terms-blurb"><a href="https://substack.com/privacy" target="_blank" rel="noopener noreferrer">Privacy</a><span>  </span><a href="https://substack.com/tos" target="_blank" rel="noopener noreferrer">Terms</a><span>  </span><a href="https://substack.com/ccpa#personal-data-collected" target="_blank" rel="noopener noreferrer">Collection notice</a></div></div><div class="footer-buttons"><a native href="https://substack.com/signup?utm_source=substack&amp;utm_medium=web&amp;utm_content=footer" class="footer-substack-cta start-publishing"><svg role="img" width="1000" height="1000" viewBox="0 0 1000 1000" fill="#FF6719" stroke-width="1.8" stroke="none" xmlns="http://www.w3.org/2000/svg"><g><title></title><path d="M764.166 348.371H236.319V419.402H764.166V348.371Z"></path><path d="M236.319 483.752V813.999L500.231 666.512L764.19 813.999V483.752H236.319Z"></path><path d="M764.166 213H236.319V284.019H764.166V213Z"></path></g></svg> Start Writing</a><a native href="https://substack.com/app/app-store-redirect?utm_campaign=app-marketing&amp;utm_content=web-footer-button" class="footer-substack-cta get-the-app no-icon">Get the app</a></div><div translated class="pencraft pc-reset _reset_13a18_1 footer-slogan-blurb"><a href="https://substack.com" native>Substack</a> is the home for great writing</div></div></div></div></div><div style="transform: translateY(0px);" class="tw-fixed tw-bottom-2.5 tw-right-2.5 tw-left-2.5 md:tw-left-auto md:tw-bottom-5 md:tw-right-5 md:tw-pl-4 tw-z-40"></div><div></div>
        </div>

        
            <script src="https://js.sentry-cdn.com/6c2ff3e3828e4017b7faf7b63e24cdf8.min.js" crossorigin="anonymous"></script>
            <script>
                window.Sentry && window.Sentry.onLoad(function() {
                    window.Sentry.init({
                        environment: window._preloads.sentry_environment,
                        dsn: window._preloads.sentry_dsn,
                    })
                })
            </script>
        


        
        
        
        <script>window._preloads        = JSON.parse("{\"isEU\":false,\"language\":\"en\",\"country\":\"JP\",\"base_url\":\"https://techblog.citystoragesystems.com\",\"stripe_publishable_key\":\"pk_live_vNnuGHOFnt4mM7V9PuCAAPJz\",\"captcha_site_key\":\"6LdYbsYZAAAAAIFIRh8X_16GoFRLIReh-e-q6qSa\",\"pub\":{\"apple_pay_disabled\":false,\"apex_domain\":null,\"author_id\":197494688,\"byline_images_enabled\":false,\"bylines_enabled\":true,\"chartable_token\":null,\"community_enabled\":true,\"copyright\":\"City Storage Systems\",\"cover_photo_url\":\"https://substack-post-media.s3.amazonaws.com/public/images/ad185372-66a9-4417-83c0-9f9168b011fa_1280x907.png\",\"created_at\":\"2024-01-14T22:18:26.338Z\",\"custom_domain_optional\":false,\"custom_domain\":\"techblog.citystoragesystems.com\",\"custom_publication_theme_id\":null,\"default_comment_sort\":\"best_first\",\"default_coupon\":null,\"default_group_coupon\":null,\"default_show_guest_bios\":true,\"email_banner_url\":null,\"email_from_name\":\"CityStorageSystems Engineering\",\"email_from\":null,\"embed_tracking_disabled\":false,\"explicit\":false,\"expose_paywall_content_to_search_engines\":true,\"fb_pixel_id\":null,\"fb_site_verification_token\":null,\"flagged_as_spam\":false,\"founding_subscription_benefits\":null,\"free_subscription_benefits\":null,\"ga_pixel_id\":null,\"google_site_verification_token\":null,\"google_tag_manager_token\":null,\"hero_image\":null,\"hero_text\":\"Engineering the future of food at Otter & CloudKitchens\",\"hide_intro_subtitle\":null,\"hide_intro_title\":null,\"hide_podcast_feed_link\":false,\"homepage_type\":\"newspaper\",\"id\":2259056,\"image_thumbnails_always_enabled\":false,\"invite_only\":false,\"language\":\"en\",\"logo_url_wide\":\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F494bd983-fb57-4ec0-ac8e-d62647802192_2688x512.jpeg\",\"logo_url\":\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00427a51-29da-4fd7-b0ea-75bf09b879c5_512x512.png\",\"minimum_group_size\":2,\"moderation_enabled\":true,\"name\":\"City Storage Systems\",\"paid_subscription_benefits\":null,\"parsely_pixel_id\":null,\"payments_state\":\"disabled\",\"paywall_free_trial_enabled\":false,\"podcast_art_url\":null,\"paid_podcast_episode_art_url\":null,\"podcast_byline\":null,\"podcast_description\":null,\"podcast_enabled\":false,\"podcast_feed_url\":null,\"podcast_title\":null,\"post_preview_limit\":null,\"require_clickthrough\":false,\"rss_feed_url\":null,\"rss_website_url\":null,\"show_pub_podcast_tab\":false,\"show_recs_on_homepage\":true,\"subdomain\":\"engineering4citystoragesystems\",\"subscriber_invites\":0,\"support_email\":null,\"theme_var_background_pop\":\"#6B26FF\",\"theme_var_color_links\":true,\"theme_var_cover_bg_color\":null,\"trial_end_override\":null,\"twitter_pixel_id\":null,\"type\":\"newsletter\",\"post_reaction_faces_enabled\":true,\"plans\":null,\"stripe_user_id\":null,\"stripe_country\":null,\"stripe_publishable_key\":null,\"automatic_tax_enabled\":null,\"author_name\":\"CSS Engineering\",\"author_handle\":\"cssengineering\",\"author_photo_url\":\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F07bdba56-e955-4de6-8b3a-2034e51a41d2_256x256.png\",\"author_bio\":\"Engineering behind products such as Otter and CloudKitchens\",\"has_custom_tos\":false,\"has_custom_privacy\":false,\"theme\":{\"background_pop_color\":\"#464EE7\",\"web_bg_color\":\"#151513\",\"cover_bg_color\":\"#151513\",\"publication_id\":2259056,\"color_links\":null,\"font_preset_heading\":\"heavy_sans\",\"font_preset_body\":\"sans\",\"font_family_headings\":null,\"font_family_body\":null,\"font_family_ui\":null,\"font_size_body_desktop\":null,\"print_secondary\":null,\"custom_css_web\":null,\"custom_css_email\":null,\"home_hero\":\"newspaper\",\"home_posts\":\"list\",\"home_show_top_posts\":false,\"hide_images_from_list\":false},\"threads_v2_settings\":null,\"default_group_coupon_percent_off\":null,\"pause_return_date\":null,\"has_posts\":true,\"has_recommendations\":false,\"first_post_date\":\"2024-03-15T11:46:02.982Z\",\"has_podcast\":false,\"has_free_podcast\":false,\"has_subscriber_only_podcast\":false,\"has_community_content\":false,\"twitter_share_on_publish_opt_in\":null,\"twitter_permissions\":\"none\",\"rankingDetail\":\"Launched 11 days ago\",\"rankingDetailFreeIncluded\":\"Hundreds of subscribers\",\"rankingDetailOrderOfMagnitude\":0,\"rankingDetailFreeIncludedOrderOfMagnitude\":100,\"rankingDetailFreeSubscriberCount\":null,\"rankingDetailByLanguage\":{\"de\":{\"rankingDetail\":\"Vor vor 11 Tagen gelauncht\",\"rankingDetailFreeIncluded\":\"Hunderte von Abonnenten\",\"rankingDetailOrderOfMagnitude\":0,\"rankingDetailFreeIncludedOrderOfMagnitude\":100,\"rankingDetailFreeSubscriberCount\":null,\"freeSubscriberCount\":null},\"es\":{\"rankingDetail\":\"Lanzado hace 11 d\u00EDas\",\"rankingDetailFreeIncluded\":\"Cientos de suscriptores\",\"rankingDetailOrderOfMagnitude\":0,\"rankingDetailFreeIncludedOrderOfMagnitude\":100,\"rankingDetailFreeSubscriberCount\":null,\"freeSubscriberCount\":null},\"fr\":{\"rankingDetail\":\"Lanc\u00E9 il y a 11 jours\",\"rankingDetailFreeIncluded\":\"Des centaines d'abonn\u00E9s\",\"rankingDetailOrderOfMagnitude\":0,\"rankingDetailFreeIncludedOrderOfMagnitude\":100,\"rankingDetailFreeSubscriberCount\":null,\"freeSubscriberCount\":null},\"pt\":{\"rankingDetail\":\"Lan\u00E7ado 11 dias\",\"rankingDetailFreeIncluded\":\"Centenas de subscritores\",\"rankingDetailOrderOfMagnitude\":0,\"rankingDetailFreeIncludedOrderOfMagnitude\":100,\"rankingDetailFreeSubscriberCount\":null,\"freeSubscriberCount\":null},\"pt-br\":{\"rankingDetail\":\"Lan\u00E7ado 11 dias\",\"rankingDetailFreeIncluded\":\"Centenas de assinantes\",\"rankingDetailOrderOfMagnitude\":0,\"rankingDetailFreeIncludedOrderOfMagnitude\":100,\"rankingDetailFreeSubscriberCount\":null,\"freeSubscriberCount\":null},\"it\":{\"rankingDetail\":\"Lanciato 11 giorni\",\"rankingDetailFreeIncluded\":\"Centinaia di abbonati\",\"rankingDetailOrderOfMagnitude\":0,\"rankingDetailFreeIncludedOrderOfMagnitude\":100,\"rankingDetailFreeSubscriberCount\":null,\"freeSubscriberCount\":null},\"de-machine\":{\"rankingDetail\":\"Gestartet vor 11 Tagen\",\"rankingDetailFreeIncluded\":\"Hunderte von Abonnenten\",\"rankingDetailOrderOfMagnitude\":0,\"rankingDetailFreeIncludedOrderOfMagnitude\":100,\"rankingDetailFreeSubscriberCount\":null,\"freeSubscriberCount\":null},\"en\":{\"rankingDetail\":\"Launched 11 days ago\",\"rankingDetailFreeIncluded\":\"Hundreds of subscribers\",\"rankingDetailOrderOfMagnitude\":0,\"rankingDetailFreeIncludedOrderOfMagnitude\":100,\"rankingDetailFreeSubscriberCount\":null,\"freeSubscriberCount\":null}},\"freeSubscriberCount\":null,\"author_bestseller_tier\":0,\"disable_monthly_subscriptions\":false,\"disable_annual_subscriptions\":false,\"notes_feed_enabled\":false,\"sections\":[],\"multipub_migration\":null,\"navigationBarItems\":[{\"id\":\"efee49d9-a23d-46a1-aac4-6fb78aa07db7\",\"publication_id\":2259056,\"sibling_rank\":0,\"link_title\":null,\"link_url\":null,\"section_id\":null,\"post_id\":null,\"is_hidden\":true,\"standard_key\":\"archive\",\"post_tag_id\":null,\"post\":null,\"section\":null,\"postTag\":null}],\"contributors\":[],\"threads_v2_enabled\":false,\"viralGiftsConfig\":null,\"tier\":2,\"no_follow\":false,\"no_index\":false,\"can_set_google_site_verification\":true,\"can_have_sitemap\":true,\"founding_plan_name_english\":\"Founding Member\",\"draft_plans\":null,\"base_url\":\"https://techblog.citystoragesystems.com\",\"hostname\":\"techblog.citystoragesystems.com\",\"is_on_substack\":false,\"spotify_podcast_settings\":null,\"podcastPalette\":{\"Vibrant\":{\"rgb\":[244.1949152542373,162.0762711864407,10.805084745762711],\"population\":0},\"DarkVibrant\":{\"rgb\":[126.9813559322034,84.27966101694916,5.618644067796606],\"population\":0},\"LightVibrant\":{\"rgb\":[250,212,142],\"population\":31},\"Muted\":{\"rgb\":[92,158,148],\"population\":4},\"DarkMuted\":{\"rgb\":[146.51694915254237,97.24576271186443,6.483050847457638],\"population\":0},\"LightMuted\":{\"rgb\":[164,204,196],\"population\":3}},\"live_subscriber_counts\":false,\"subscribeCardVersionHash\":\"b1c39afaca7d90e145c2e972279e9d20\"},\"confirmedLogin\":false,\"hide_intro_popup\":false,\"block_auto_login\":false,\"domainInfo\":{\"isSubstack\":false,\"customDomain\":\"techblog.citystoragesystems.com\"},\"experimentFeatures\":{},\"experimentExposures\":{},\"siteConfigs\":{\"score_upsell_email\":\"control\",\"first_chat_email_enabled\":true,\"show_feature_media_hero_option\":false,\"reader-onboarding-promoted-pub\":737237,\"pub_creation_captcha_behavior\":\"risky_pubs\",\"new_commenter_approval\":false,\"pub_update_opennode_api_key\":false,\"zendesk_automation_cancellations\":false,\"hide_book_a_meeting_button\":false,\"first_month_upsell_enabled\":false,\"substack_credits_enabled\":false,\"publication_max_bylines\":35,\"no_contest_charge_disputes\":false,\"new_subscription_management\":false,\"recommendations_announcement_url\":\"https://on.substack.com/p/recommendations\",\"comp_expiry_email_new_copy\":\"NONE\",\"free_unlock_required\":false,\"traffic_rule_check_enabled\":false,\"amp_emails_enabled\":false,\"enable_post_summarization\":false,\"image_deep_link_enabled\":false,\"bitcoin_enabled\":false,\"public_podcast_rss_feed_only_free_visible\":false,\"show_entire_square_image\":false,\"hide_subscriber_count\":false,\"editor_v2\":false,\"publication_author_display_override\":\"\",\"generate_pdf_tax_report\":false,\"apex_redirects\":false,\"enable_pledges_modal\":true,\"include_pdf_invoice\":false,\"hide_pub_from_subscription_recommendation\":false,\"platform_searcher_enabled\":false,\"tax_integration_enabled\":false,\"use_featured_pub_recommendations\":false,\"meetings_v1\":false,\"custom_target_origin\":\"\",\"exempt_from_gtm_filter\":false,\"group_sections_and_podcasts_in_menu\":false,\"boost_optin_modal_enabled\":true,\"pub_tts_override\":\"default\",\"disable_monthly_subscriptions\":false,\"skip_welcome_email\":false,\"chat_reader_thread_notification_default\":false,\"scheduled_pinned_posts\":false,\"disable_redirect_outbound_utm_params\":false,\"reader_gift_referrals_enabled\":true,\"enable_bestseller_survey_modal\":false,\"dont_show_guest_byline\":false,\"like_comments_enabled\":true,\"extended_podcast_episode_metadata\":false,\"use_richer_html_for_editing_podcast_description\":false,\"default_to_editor_v2\":false,\"enable_author_note_email_toggle\":false,\"meetings_embed_publication_name\":false,\"no_auto_renewal_notice\":false,\"people_you_may_know_algorithm\":\"experiment\",\"enable_push_podcast_drawer\":false,\"welcome_screen_blurb_override\":\"\",\"post_recipients_batch_limit\":1000,\"like_posts_enabled\":true,\"notes_publication_mentions_enabled\":false,\"twitter_player_card_enabled\":true,\"enable_substack_player\":true,\"feed_promoted_user\":false,\"allow_renew_email_footer\":true,\"section_specific_csv_imports_enabled\":false,\"improved_tts_voiceover\":false,\"use_preloaded_player_sources\":false,\"generate_twitter_card_with_lamda\":false,\"list_pruning_enabled\":false,\"facebook_connect\":false,\"opt_in_to_sections_during_subscribe\":false,\"underlined_colored_links\":false,\"max_image_upload_mb\":32,\"extract_stripe_receipt_url\":false,\"enable_android_dms_writer_beta\":false,\"use_stripe_link\":\"experiment\",\"threads_suggested_ios_version\":null,\"pledges_disabled\":false,\"threads_minimum_ios_version\":812,\"hide_podcast_email_setup_link\":false,\"subscribe_captcha_behavior\":\"default\",\"publication_ban_sample_rate\":0,\"allow_moderation_sampling_mode\":false,\"rss_post_import_use_twitter_transformer\":false,\"photo_dna_enabled\":false,\"round_square_images\":false,\"reader_referrals_feature_enabled\":false,\"continue_support_cta_in_newsletter_emails\":false,\"custom_publication_theme\":false,\"lists_enabled\":false,\"show_writer_referral_box\":false,\"generated_database_maintenance_mode\":false,\"allow_document_freeze\":false,\"spotify_open_access_sandbox_mode\":true,\"podcast_main_feed_is_firehose\":false,\"video_post_sticky\":true,\"no_embed_redirect\":false,\"non_post_first_party_link_tracking_enabled\":false,\"enable_live_streaming\":false,\"fullstory_enabled\":false,\"chat_reply_poll_interval\":3,\"section_themes_enabled\":false,\"globe_enabled\":true,\"enable_pencraft_editor_menu\":false,\"enable_reader_marketing_page\":false,\"email_existing_users_on_import\":false,\"always_show_cookie_banner\":false,\"hide_media_download_option\":false,\"review_incoming_email\":\"default\",\"twitter_figures_enabled\":false,\"pub_banned_word_list\":\"\",\"credit_token_publication_suggested\":false,\"spotify_open_access\":false,\"bypass_unlock_token_limit\":false,\"enable_dm_images\":true,\"notifications_disabled\":\"\",\"cross_post_notification_threshold\":1000,\"facebook_connect_prod_app\":true,\"gift_referrals_allow_reups\":true,\"minimum_android_version\":756,\"feed_main_disabled\":false,\"use_mobile_app_post_unlock_flow\":true,\"feed_polling_disabled\":false,\"cookie_preference_middleware_enabled\":false,\"live_events\":false,\"seo_tier_override\":\"NONE\",\"cancellation_flow_experiment\":\"experiment\",\"publisher_api_enabled\":false,\"zendesk_support_priority\":\"default\",\"enable_subscriber_referrals_awards\":true,\"homepage_overlap_ufi\":false,\"enable_android_dms_public_launch\":true,\"topic_pages_enabled\":true,\"enable_editor_performance_improvements\":true,\"enable_web_typing_indicators\":false,\"section_specific_preambles\":false,\"web_vitals_sample_rate\":0,\"skip_twitter_step_in_writer_onboarding\":true,\"android_suggestion_categories_onboarding_tabs\":false,\"enable_android_unlock_post_paywalls\":true,\"thebulwark_fixed_price_founding_plan\":\"include_fixed_price_founding\",\"section_specific_welcome_pages\":false,\"local_payment_methods\":\"control\",\"dm_poll_interval\":3,\"posts_in_rss_feed\":20,\"post_rec_endpoint\":\"\",\"publisher_dashboard_section_selector\":false,\"reader_surveys_platform_question_order\":\"36,1,4,2,3,5,6,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35\",\"enable_chat_dropdown\":true,\"substack_cookie_preference_enabled_eu\":true,\"large_feed_following_threshold\":150,\"monthly_sub_is_one_off\":false,\"unread_notes_activity_digest\":\"control\",\"display_cookie_settings\":false,\"post_pingback_tracking\":true,\"welcome_page_query_params\":false,\"enable_free_podcast_urls\":false,\"dm_rate_limit_hours\":24,\"dm_rate_limit_requests\":100,\"use_microlink_for_instagram_embeds\":false,\"use_whisper\":false,\"enable_dm_realtime\":false,\"show_email_cutoff_cta\":\"experiment\",\"allow_filtering_moderation_reasons\":false,\"modal_rec_variant\":\"control\",\"show_menu_on_posts\":false,\"app_upsell_follow_prompt\":\"control\",\"free_signup_confirmation_behavior\":\"with_email_validation\",\"enable_ios_dms_peripherals\":true,\"enable_content_blocks\":true,\"embeds_enabled\":false,\"use_new_subscriber_summary_component\":true,\"ios_chat_revamp_enabled\":false,\"clipper_v2\":false,\"sql_feed_fallback_percent\":0,\"enable_chat_search\":false,\"enable_video_in_notes_web\":false,\"enable_unlock_post_deep_links\":true,\"classic_podcast_section_page\":false,\"publisher_banner\":\"\",\"onboarding_notification_flow\":\"control\",\"enable_decagon_chat\":true,\"first_month_upsell\":\"control\",\"twitter_connect_flows_enabled\":false,\"android_google_sign_in\":false,\"enable_dm_reactions\":true,\"enable_android_dms_realtime\":false,\"welcome_page_update_desktop_visuals_limited\":\"experiment\",\"activity_item_batching\":false,\"rss_verification_code\":\"\",\"chat_founding_tier\":false,\"audio_encoding_bitrate\":null,\"extra_seats_coupon_type\":false,\"post_subdomain_universal_links\":false,\"post_import_max_file_size\":26214400,\"show_recommendations_2_image_welcome_email\":true,\"credit_tokens_enabled\":true,\"dm_rate_limit_total_hours\":24,\"show_email_cutoff_cta_top\":\"control\",\"minimum_ios_version\":2200,\"dm_rate_limit_total_requests\":1000,\"disable_annual_subscriptions\":false,\"enable_bestseller_survey_modal_override\":false,\"enable_android_dms\":false,\"use_substrate_sdxl\":false,\"enable_dm_realtime_ios\":true,\"rss_post_import_use_twitter_transformer_step\":\"seed\",\"enable_upload_transcript\":false,\"insert_trading_view_charts\":false,\"enable_upload_seperate_audio\":false,\"recipes_enabled\":false,\"disable_deletion\":false,\"enable_client_publication_search_cache\":false,\"enable_dm_realtime_percentage\":100},\"publicationSettings\":{\"block_ai_crawlers\":false,\"credit_token_enabled\":false,\"custom_tos_and_privacy\":false,\"did_identity\":null,\"disable_optimistic_bank_payments\":false,\"display_welcome_page_details\":true,\"enable_meetings\":false,\"payment_pledges_enabled\":false,\"enable_post_page_conversion\":true,\"enable_prev_next_nav\":false,\"enable_restacking\":true,\"google_analytics_4_token\":null,\"group_sections_and_podcasts_in_menu_enabled\":false,\"medium_length_description\":\"\",\"notes_feed_enabled\":false,\"paywall_unlock_tokens\":false,\"post_preview_crop_gravity\":\"auto\",\"reader_referrals_enabled\":false,\"reader_referrals_leaderboard_enabled\":false,\"seen_coming_soon_explainer\":false,\"seen_google_analytics_migration_modal\":false,\"local_currency_modal_seen\":false,\"local_payment_methods_modal_seen\":false,\"twitter_pixel_signup_event_id\":null,\"twitter_pixel_subscribe_event_id\":null,\"use_local_currency\":false,\"use_local_payment_methods\":true,\"welcome_page_opt_out_text\":\"No thanks\",\"cookie_settings\":\"\"},\"publicationUserSettings\":null,\"userSettings\":{\"user_id\":null,\"activity_likes_enabled\":true,\"hasDismissedSectionToNewsletterRename\":false,\"is_guest_post_enabled\":true,\"feed_web_nux_seen_at\":null,\"has_seen_select_to_restack_tooltip_nux\":false,\"invite_friends_nux_dismissed_at\":null,\"suggestions_feed_item_last_shown_at\":null,\"has_seen_select_to_restack_modal\":false,\"last_home_tab\":null,\"last_notification_alert_shown_at\":null,\"disable_reply_hiding\":false,\"newest_seen_chat_item_published_at\":null,\"explicitContentEnabled\":false,\"contactMatchingEnabled\":false,\"messageRequestLevel\":\"everyone\",\"creditTokensTreatmentExposed\":false,\"appBadgeIncludesChat\":false},\"subscriberCountDetails\":\"hundreds of subscribers\",\"mux_env_key\":\"u42pci814i6011qg3segrcpp9\",\"sentry_environment\":\"production\",\"launchWelcomePage\":false,\"noIndex\":false,\"post\":{\"id\":142916610,\"editor_v2\":false,\"publication_id\":2259056,\"type\":\"newsletter\",\"title\":\"Managing 100s of Kubernetes Clusters using Cluster API\",\"social_title\":\"Managing 100s of Kubernetes Clusters using Cluster API\",\"section_id\":null,\"search_engine_title\":null,\"search_engine_description\":null,\"subtitle\":\"Automating every step from cluster creation to workload-ready. Turtles all the way down.\",\"slug\":\"managing-100s-of-kubernetes-clusters\",\"post_date\":\"2024-03-26T14:01:27.398Z\",\"podcast_url\":\"\",\"podcast_art_url\":null,\"podcast_duration\":null,\"video_upload_id\":null,\"podcast_upload_id\":null,\"podcast_preview_upload_id\":null,\"audience\":\"everyone\",\"should_send_free_preview\":false,\"write_comment_permissions\":\"none\",\"show_guest_bios\":true,\"free_unlock_required\":false,\"default_comment_sort\":null,\"canonical_url\":\"https://techblog.citystoragesystems.com/p/managing-100s-of-kubernetes-clusters\",\"audience_before_archived\":null,\"exempt_from_archive_paywall\":false,\"restacks\":0,\"reactions\":{\"\u2764\":3},\"top_exclusions\":[],\"pins\":[],\"section_pins\":[],\"previous_post_slug\":\"food-prep-time-prediction\",\"next_post_slug\":null,\"cover_image\":\"https://substack-post-media.s3.amazonaws.com/public/images/8ec528f2-0ea8-4e52-87e4-f129052c741d_2000x1361.png\",\"cover_image_is_square\":false,\"cover_image_is_explicit\":false,\"videoUpload\":null,\"podcastFields\":{\"post_id\":142916610,\"podcast_episode_number\":null,\"podcast_season_number\":null,\"podcast_episode_type\":null,\"should_syndicate_to_other_feed\":null,\"syndicate_to_section_id\":null,\"hide_from_feed\":false,\"free_podcast_url\":null,\"free_podcast_duration\":null},\"podcastUpload\":null,\"podcastPreviewUpload\":null,\"voiceover_upload_id\":null,\"voiceoverUpload\":null,\"has_voiceover\":false,\"description\":\"Automating every step from cluster creation to workload-ready.\",\"body_html\":\"<div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link is-viewable-img image2\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F41950956-1c34-4bc1-942d-a174356c2ccf_2094x1011.png\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F41950956-1c34-4bc1-942d-a174356c2ccf_2094x1011.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F41950956-1c34-4bc1-942d-a174356c2ccf_2094x1011.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F41950956-1c34-4bc1-942d-a174356c2ccf_2094x1011.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F41950956-1c34-4bc1-942d-a174356c2ccf_2094x1011.png 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F41950956-1c34-4bc1-942d-a174356c2ccf_2094x1011.png\\\" width=\\\"1456\\\" height=\\\"703\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/41950956-1c34-4bc1-942d-a174356c2ccf_2094x1011.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:703,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:771464,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:false,&quot;topImage&quot;:true,&quot;internalRedirect&quot;:null}\\\" class=\\\"sizing-normal\\\" alt=\\\"\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F41950956-1c34-4bc1-942d-a174356c2ccf_2094x1011.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F41950956-1c34-4bc1-942d-a174356c2ccf_2094x1011.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F41950956-1c34-4bc1-942d-a174356c2ccf_2094x1011.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F41950956-1c34-4bc1-942d-a174356c2ccf_2094x1011.png 1456w\\\" sizes=\\\"100vw\\\" fetchpriority=\\\"high\\\"></picture><div class=\\\"image-link-expand\\\"><svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"16\\\" height=\\\"16\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"#FFFFFF\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" class=\\\"lucide lucide-maximize2 \\\"><polyline points=\\\"15 3 21 3 21 9\\\"></polyline><polyline points=\\\"9 21 3 21 3 15\\\"></polyline><line x1=\\\"21\\\" x2=\\\"14\\\" y1=\\\"3\\\" y2=\\\"10\\\"></line><line x1=\\\"3\\\" x2=\\\"10\\\" y1=\\\"21\\\" y2=\\\"14\\\"></line></svg></div></div></a></figure></div><p><em>Written by Zain Malik and Nibir Bora, members of the engineering teams that work on core infrastructure.</em></p><p>At City Storage Systems, our Core Infrastructure team navigates the complexities of managing over 100 multi-tenant Kubernetes clusters, each hosting up to tens of thousands of daily active pods. Our entire software stack runs on Kubernetes from mission critical microservices to stateful databases and observability solutions.</p><p>This blog delves into our journey of achieving complete automation in cluster provisioning, lifecycle management, and upgrades. With the new toolset, we slashed the time required to provision and prepare a workload-ready cluster from 1.5 weeks to under 1 day, all while maintaining a lean team of engineers. This transformation was catalyzed by our strategic decision to migrate to Microsoft Azure within a deadline of a few months. During the transition the number of clusters we operate more than doubled.</p><p>We present a set of Kubernetes <a href=\\\"https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/\\\">custom resources</a> and <a href=\\\"https://kubernetes.io/docs/concepts/extend-kubernetes/operator/\\\">operators</a> that models our infrastructure and associated operations. The flexibility of the Kubernetes operator pattern makes this approach extremely powerful and we are confident it can be used to manage clusters on any public cloud provider.</p><div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link is-viewable-img image2\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F735b07a2-b10e-4030-b8ca-4372ab3d02c6_2263x1667.png\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F735b07a2-b10e-4030-b8ca-4372ab3d02c6_2263x1667.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F735b07a2-b10e-4030-b8ca-4372ab3d02c6_2263x1667.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F735b07a2-b10e-4030-b8ca-4372ab3d02c6_2263x1667.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F735b07a2-b10e-4030-b8ca-4372ab3d02c6_2263x1667.png 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F735b07a2-b10e-4030-b8ca-4372ab3d02c6_2263x1667.png\\\" width=\\\"1456\\\" height=\\\"1073\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/735b07a2-b10e-4030-b8ca-4372ab3d02c6_2263x1667.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:1073,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:155776,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:false,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}\\\" class=\\\"sizing-normal\\\" alt=\\\"\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F735b07a2-b10e-4030-b8ca-4372ab3d02c6_2263x1667.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F735b07a2-b10e-4030-b8ca-4372ab3d02c6_2263x1667.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F735b07a2-b10e-4030-b8ca-4372ab3d02c6_2263x1667.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F735b07a2-b10e-4030-b8ca-4372ab3d02c6_2263x1667.png 1456w\\\" sizes=\\\"100vw\\\"></picture><div class=\\\"image-link-expand\\\"><svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"16\\\" height=\\\"16\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"#FFFFFF\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" class=\\\"lucide lucide-maximize2 \\\"><polyline points=\\\"15 3 21 3 21 9\\\"></polyline><polyline points=\\\"9 21 3 21 3 15\\\"></polyline><line x1=\\\"21\\\" x2=\\\"14\\\" y1=\\\"3\\\" y2=\\\"10\\\"></line><line x1=\\\"3\\\" x2=\\\"10\\\" y1=\\\"21\\\" y2=\\\"14\\\"></line></svg></div></div></a></figure></div><p>Figure 1: Hierarchy of all custom resources used to manage a Kubernetes cluster and node pools.</p><h1>Adopting Cluster API</h1><p>We initially created clusters using Terraform and thereon managed node pools using a custom homegrown Kubernetes operator. Changes, including Kubernetes version upgrades, were handled via GitOps. However, the cognitive overhead and manual intervention required made this approach unsustainable, specially to migrate 80+ clusters from one cloud provider to another.</p><p>This led us to explore <a href=\\\"https://cluster-api.sigs.k8s.io/\\\">Cluster API</a>, which offers declarative APIs for simplifying provisioning, upgrading, and managing multiple Kubernetes clusters. Two key factors made Cluster API particularly attractive:</p><ol><li><p>Extensibility: Cluster API's custom resources are extended by <a href=\\\"https://cluster-api.sigs.k8s.io/reference/providers.html\\\">provider</a> custom resources, which can then be extended by higher level custom resources that capture organizational needs. Since our clusters are multi-tenant, this allowed us to abstract away any details about node pools from workload developers.</p></li><li><p>Operator Pattern: Any extension of Cluster API and its providers are Kubernetes Operators, aligning with our Kubernetes-centric approach to infrastructure management. Leveraging our team's experience with building operators, the learning curve was minimal.</p></li></ol><p>To create a cluster using Cluster API and the Cluster API provider for Azure (CAPZ) we simply need to create objects of the following custom resources:</p><ol><li><p><code>Cluster</code> (from Cluster API)</p></li><li><p><code>AzureManagedCluster</code> and <code>AzureManagedControlPlane</code> (from CAPZ)</p></li></ol><div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link is-viewable-img image2\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd0bdfa81-374f-41cb-ab43-8bcc0a54e3f0_1456x592.png\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd0bdfa81-374f-41cb-ab43-8bcc0a54e3f0_1456x592.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd0bdfa81-374f-41cb-ab43-8bcc0a54e3f0_1456x592.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd0bdfa81-374f-41cb-ab43-8bcc0a54e3f0_1456x592.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd0bdfa81-374f-41cb-ab43-8bcc0a54e3f0_1456x592.png 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd0bdfa81-374f-41cb-ab43-8bcc0a54e3f0_1456x592.png\\\" width=\\\"1456\\\" height=\\\"592\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/d0bdfa81-374f-41cb-ab43-8bcc0a54e3f0_1456x592.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:592,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:91650,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}\\\" class=\\\"sizing-normal\\\" alt=\\\"\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd0bdfa81-374f-41cb-ab43-8bcc0a54e3f0_1456x592.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd0bdfa81-374f-41cb-ab43-8bcc0a54e3f0_1456x592.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd0bdfa81-374f-41cb-ab43-8bcc0a54e3f0_1456x592.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd0bdfa81-374f-41cb-ab43-8bcc0a54e3f0_1456x592.png 1456w\\\" sizes=\\\"100vw\\\" loading=\\\"lazy\\\"></picture><div class=\\\"image-link-expand\\\"><svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"16\\\" height=\\\"16\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"#FFFFFF\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" class=\\\"lucide lucide-maximize2 \\\"><polyline points=\\\"15 3 21 3 21 9\\\"></polyline><polyline points=\\\"9 21 3 21 3 15\\\"></polyline><line x1=\\\"21\\\" x2=\\\"14\\\" y1=\\\"3\\\" y2=\\\"10\\\"></line><line x1=\\\"3\\\" x2=\\\"10\\\" y1=\\\"21\\\" y2=\\\"14\\\"></line></svg></div></div></a></figure></div><div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link is-viewable-img image2\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbca26f04-8570-47f9-a972-4c0506a560dd_1456x852.png\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbca26f04-8570-47f9-a972-4c0506a560dd_1456x852.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbca26f04-8570-47f9-a972-4c0506a560dd_1456x852.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbca26f04-8570-47f9-a972-4c0506a560dd_1456x852.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbca26f04-8570-47f9-a972-4c0506a560dd_1456x852.png 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbca26f04-8570-47f9-a972-4c0506a560dd_1456x852.png\\\" width=\\\"1456\\\" height=\\\"852\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/bca26f04-8570-47f9-a972-4c0506a560dd_1456x852.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:852,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:182028,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}\\\" class=\\\"sizing-normal\\\" alt=\\\"\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbca26f04-8570-47f9-a972-4c0506a560dd_1456x852.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbca26f04-8570-47f9-a972-4c0506a560dd_1456x852.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbca26f04-8570-47f9-a972-4c0506a560dd_1456x852.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbca26f04-8570-47f9-a972-4c0506a560dd_1456x852.png 1456w\\\" sizes=\\\"100vw\\\" loading=\\\"lazy\\\"></picture><div class=\\\"image-link-expand\\\"><svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"16\\\" height=\\\"16\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"#FFFFFF\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" class=\\\"lucide lucide-maximize2 \\\"><polyline points=\\\"15 3 21 3 21 9\\\"></polyline><polyline points=\\\"9 21 3 21 3 15\\\"></polyline><line x1=\\\"21\\\" x2=\\\"14\\\" y1=\\\"3\\\" y2=\\\"10\\\"></line><line x1=\\\"3\\\" x2=\\\"10\\\" y1=\\\"21\\\" y2=\\\"14\\\"></line></svg></div></div></a></figure></div><div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link image2\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F31f6ca26-159f-4da8-95ac-e8d750279794_1456x294.png\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F31f6ca26-159f-4da8-95ac-e8d750279794_1456x294.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F31f6ca26-159f-4da8-95ac-e8d750279794_1456x294.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F31f6ca26-159f-4da8-95ac-e8d750279794_1456x294.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F31f6ca26-159f-4da8-95ac-e8d750279794_1456x294.png 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F31f6ca26-159f-4da8-95ac-e8d750279794_1456x294.png\\\" width=\\\"1456\\\" height=\\\"294\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/31f6ca26-159f-4da8-95ac-e8d750279794_1456x294.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:294,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:57239,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}\\\" class=\\\"sizing-normal\\\" alt=\\\"\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F31f6ca26-159f-4da8-95ac-e8d750279794_1456x294.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F31f6ca26-159f-4da8-95ac-e8d750279794_1456x294.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F31f6ca26-159f-4da8-95ac-e8d750279794_1456x294.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F31f6ca26-159f-4da8-95ac-e8d750279794_1456x294.png 1456w\\\" sizes=\\\"100vw\\\" loading=\\\"lazy\\\"></picture><div></div></div></a></figure></div><p>Similarly, to create a node pool we need to create objects of the following custom resources:</p><ol><li><p><code>MachinePool</code> (from Cluster API)</p></li><li><p><code>AzureManagedMachinePool</code> (from CAPZ)</p></li></ol><div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link is-viewable-img image2\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6b1993e4-d57e-43a3-ac72-b0961df74422_1456x816.png\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6b1993e4-d57e-43a3-ac72-b0961df74422_1456x816.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6b1993e4-d57e-43a3-ac72-b0961df74422_1456x816.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6b1993e4-d57e-43a3-ac72-b0961df74422_1456x816.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6b1993e4-d57e-43a3-ac72-b0961df74422_1456x816.png 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6b1993e4-d57e-43a3-ac72-b0961df74422_1456x816.png\\\" width=\\\"1456\\\" height=\\\"816\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/6b1993e4-d57e-43a3-ac72-b0961df74422_1456x816.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:816,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:187767,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}\\\" class=\\\"sizing-normal\\\" alt=\\\"\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6b1993e4-d57e-43a3-ac72-b0961df74422_1456x816.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6b1993e4-d57e-43a3-ac72-b0961df74422_1456x816.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6b1993e4-d57e-43a3-ac72-b0961df74422_1456x816.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6b1993e4-d57e-43a3-ac72-b0961df74422_1456x816.png 1456w\\\" sizes=\\\"100vw\\\" loading=\\\"lazy\\\"></picture><div class=\\\"image-link-expand\\\"><svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"16\\\" height=\\\"16\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"#FFFFFF\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" class=\\\"lucide lucide-maximize2 \\\"><polyline points=\\\"15 3 21 3 21 9\\\"></polyline><polyline points=\\\"9 21 3 21 3 15\\\"></polyline><line x1=\\\"21\\\" x2=\\\"14\\\" y1=\\\"3\\\" y2=\\\"10\\\"></line><line x1=\\\"3\\\" x2=\\\"10\\\" y1=\\\"21\\\" y2=\\\"14\\\"></line></svg></div></div></a></figure></div><div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link is-viewable-img image2\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcd0478f0-121d-468d-a068-7af386804540_1456x630.png\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcd0478f0-121d-468d-a068-7af386804540_1456x630.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcd0478f0-121d-468d-a068-7af386804540_1456x630.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcd0478f0-121d-468d-a068-7af386804540_1456x630.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcd0478f0-121d-468d-a068-7af386804540_1456x630.png 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcd0478f0-121d-468d-a068-7af386804540_1456x630.png\\\" width=\\\"1456\\\" height=\\\"630\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/cd0478f0-121d-468d-a068-7af386804540_1456x630.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:630,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:126191,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}\\\" class=\\\"sizing-normal\\\" alt=\\\"\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcd0478f0-121d-468d-a068-7af386804540_1456x630.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcd0478f0-121d-468d-a068-7af386804540_1456x630.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcd0478f0-121d-468d-a068-7af386804540_1456x630.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcd0478f0-121d-468d-a068-7af386804540_1456x630.png 1456w\\\" sizes=\\\"100vw\\\" loading=\\\"lazy\\\"></picture><div class=\\\"image-link-expand\\\"><svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"16\\\" height=\\\"16\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"#FFFFFF\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" class=\\\"lucide lucide-maximize2 \\\"><polyline points=\\\"15 3 21 3 21 9\\\"></polyline><polyline points=\\\"9 21 3 21 3 15\\\"></polyline><line x1=\\\"21\\\" x2=\\\"14\\\" y1=\\\"3\\\" y2=\\\"10\\\"></line><line x1=\\\"3\\\" x2=\\\"10\\\" y1=\\\"21\\\" y2=\\\"14\\\"></line></svg></div></div></a></figure></div><p>We were able to seamlessly integrate these processes into our existing CI pipelines, relying fully on GitOps for cluster management. We do not use the <code>clusterctl</code> CLI provided by Cluster API.</p><p>However, there were three major roadblocks to adopting Cluster API immediately:</p><ol><li><p>Limited support for managed Kubernetes distributions in Cluster API. Although this was part of Cluster API\u2019s roadmap, most of the work done was focused on self-managed Kubernetes.</p></li><li><p>CAPZ\u2019s support for Azure Kubernetes Service (AKS), the managed Kubernetes distribution, was still in an experimental phase, lacking essential features required for our use case.</p></li><li><p>No major engineering organization was using Cluster API for AKS (not that we knew of at the time).</p></li></ol><p>We leaned on our partnership with Microsoft Azure to find a path forward. They suggested we collaborate on the CAPZ project in open source to achieve feature completeness. Several engineers from the Microsoft AKS team along with engineers from our Core Infrastructure team contributed to the CAPZ project prioritizing features aligned with our production use cases. This collaboration was a huge success. It enabled us to launch our first Kubernetes cluster using Cluster API and CAPZ within three months.</p><h1>Automating Workload-Ready Clusters</h1><p>While Cluster API and CAPZ simplified cluster creation, these clusters weren\u2019t ready for workloads yet.</p><ol><li><p>The new cluster does not have permission to access container images from Azure Container Registry (ACR). It is a reasonable design choice to leave such dependencies out of Cluster API to keep the interface generic.</p></li><li><p>An AKS cluster comes configured with a default cluster autoscaler profile. Configuring anything other than default can be done by manually running a Azure CLI command. We tune Cluster Autoscaler to achieve resource optimization and bin-packing on all of our production clusters.</p></li></ol><p>Using Terraform and running Azure CLI commands to configure these for every cluster wasn\u2019t aligned with our principle of minimizing human intervention. So, we decided to write a companion Kubernetes operator instead. This introduces a <code>AzureClusterAdditionalConfig</code>, an extensible custom resource intended for any additional Azure managed service configurations necessary for a cluster. For ACR permissions this resolves to a <code>AzureRoleAssignment</code> object, and a <code>AzureClusterAutoscaler</code> object for custom cluster autoscaler configuration.</p><div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link is-viewable-img image2\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F985a5052-d642-4bd4-a649-512f03b449bf_1456x852.png\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F985a5052-d642-4bd4-a649-512f03b449bf_1456x852.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F985a5052-d642-4bd4-a649-512f03b449bf_1456x852.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F985a5052-d642-4bd4-a649-512f03b449bf_1456x852.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F985a5052-d642-4bd4-a649-512f03b449bf_1456x852.png 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F985a5052-d642-4bd4-a649-512f03b449bf_1456x852.png\\\" width=\\\"1456\\\" height=\\\"852\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/985a5052-d642-4bd4-a649-512f03b449bf_1456x852.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:852,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:203327,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}\\\" class=\\\"sizing-normal\\\" alt=\\\"\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F985a5052-d642-4bd4-a649-512f03b449bf_1456x852.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F985a5052-d642-4bd4-a649-512f03b449bf_1456x852.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F985a5052-d642-4bd4-a649-512f03b449bf_1456x852.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F985a5052-d642-4bd4-a649-512f03b449bf_1456x852.png 1456w\\\" sizes=\\\"100vw\\\" loading=\\\"lazy\\\"></picture><div class=\\\"image-link-expand\\\"><svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"16\\\" height=\\\"16\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"#FFFFFF\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" class=\\\"lucide lucide-maximize2 \\\"><polyline points=\\\"15 3 21 3 21 9\\\"></polyline><polyline points=\\\"9 21 3 21 3 15\\\"></polyline><line x1=\\\"21\\\" x2=\\\"14\\\" y1=\\\"3\\\" y2=\\\"10\\\"></line><line x1=\\\"3\\\" x2=\\\"10\\\" y1=\\\"21\\\" y2=\\\"14\\\"></line></svg></div></div></a></figure></div><div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link is-viewable-img image2\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fee4c476b-d8b1-40b4-8bb2-28cd780b7019_1456x518.png\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fee4c476b-d8b1-40b4-8bb2-28cd780b7019_1456x518.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fee4c476b-d8b1-40b4-8bb2-28cd780b7019_1456x518.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fee4c476b-d8b1-40b4-8bb2-28cd780b7019_1456x518.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fee4c476b-d8b1-40b4-8bb2-28cd780b7019_1456x518.png 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fee4c476b-d8b1-40b4-8bb2-28cd780b7019_1456x518.png\\\" width=\\\"1456\\\" height=\\\"518\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/ee4c476b-d8b1-40b4-8bb2-28cd780b7019_1456x518.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:518,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:131708,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}\\\" class=\\\"sizing-normal\\\" alt=\\\"\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fee4c476b-d8b1-40b4-8bb2-28cd780b7019_1456x518.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fee4c476b-d8b1-40b4-8bb2-28cd780b7019_1456x518.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fee4c476b-d8b1-40b4-8bb2-28cd780b7019_1456x518.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fee4c476b-d8b1-40b4-8bb2-28cd780b7019_1456x518.png 1456w\\\" sizes=\\\"100vw\\\" loading=\\\"lazy\\\"></picture><div class=\\\"image-link-expand\\\"><svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"16\\\" height=\\\"16\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"#FFFFFF\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" class=\\\"lucide lucide-maximize2 \\\"><polyline points=\\\"15 3 21 3 21 9\\\"></polyline><polyline points=\\\"9 21 3 21 3 15\\\"></polyline><line x1=\\\"21\\\" x2=\\\"14\\\" y1=\\\"3\\\" y2=\\\"10\\\"></line><line x1=\\\"3\\\" x2=\\\"10\\\" y1=\\\"21\\\" y2=\\\"14\\\"></line></svg></div></div></a></figure></div><div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link is-viewable-img image2\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3a8fee42-a7db-4ff8-b08a-7de297c167c0_1456x666.png\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3a8fee42-a7db-4ff8-b08a-7de297c167c0_1456x666.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3a8fee42-a7db-4ff8-b08a-7de297c167c0_1456x666.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3a8fee42-a7db-4ff8-b08a-7de297c167c0_1456x666.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3a8fee42-a7db-4ff8-b08a-7de297c167c0_1456x666.png 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3a8fee42-a7db-4ff8-b08a-7de297c167c0_1456x666.png\\\" width=\\\"1456\\\" height=\\\"666\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/3a8fee42-a7db-4ff8-b08a-7de297c167c0_1456x666.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:666,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:152009,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}\\\" class=\\\"sizing-normal\\\" alt=\\\"\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3a8fee42-a7db-4ff8-b08a-7de297c167c0_1456x666.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3a8fee42-a7db-4ff8-b08a-7de297c167c0_1456x666.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3a8fee42-a7db-4ff8-b08a-7de297c167c0_1456x666.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3a8fee42-a7db-4ff8-b08a-7de297c167c0_1456x666.png 1456w\\\" sizes=\\\"100vw\\\" loading=\\\"lazy\\\"></picture><div class=\\\"image-link-expand\\\"><svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"16\\\" height=\\\"16\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"#FFFFFF\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" class=\\\"lucide lucide-maximize2 \\\"><polyline points=\\\"15 3 21 3 21 9\\\"></polyline><polyline points=\\\"9 21 3 21 3 15\\\"></polyline><line x1=\\\"21\\\" x2=\\\"14\\\" y1=\\\"3\\\" y2=\\\"10\\\"></line><line x1=\\\"3\\\" x2=\\\"10\\\" y1=\\\"21\\\" y2=\\\"14\\\"></line></svg></div></div></a></figure></div><p>Introducing the companion operator enabled us to fully automate cluster creation and prepare them to be workload-ready by installing a single kubernetes resource using GitOps. This streamlined approach facilitated the migration of over 80 production clusters between different cloud providers.</p><h1>Automating Node Pools</h1><p>After running production workloads on a new cloud provider for a few months, we identified two major operational pain points.</p><ol><li><p>We didn\u2019t nail the node types (instance family, disk type, etc. settings) at the first attempt. Some of these fields like machineType, diskSize, diskType, maxPod, type (spot vs regular) are immutable fields on AKS. This meant we had to replace node pools running production workloads a handful of times. Each replacement involved creating a new node pool, draining the old one, then deleting it. This process required human coordination and multiple steps in our GitOps workflow.</p></li><li><p>While updating Kubernetes version we learned that AKS\u2019s in-place node pool upgrade tends to enter an endless retry loop when it encounters an application with 0 disruptions allowed (PodDisruptionBudget setting). Since AKS only <a href=\\\"https://learn.microsoft.com/en-us/troubleshoot/azure/azure-kubernetes/operationnotallowed\\\">permits</a> one concurrent node pool update operation per cluster, this block operations on other node pools including manual scale up. Consequently, we had to fall back to the multi-step node pool replacement process for upgrades as well.</p></li></ol><p>We implemented a node pool Kubernetes operator, which introduces a single <code>Nodepool</code> resource encapsulating the multi-step process for replacing a node pool. Under the hood, the operator creates a new node pool, drains the old one, then deletes it in a process completely opaque from the users. From the user\u2019s perspective all node pool manipulations are done in-place with a single GitOps change. This end-to-end automation is especially powerful during Kubernetes version upgrades.</p><div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link is-viewable-img image2\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbc3bac98-3e65-43c6-867b-0e59195ecec0_1456x1188.png\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbc3bac98-3e65-43c6-867b-0e59195ecec0_1456x1188.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbc3bac98-3e65-43c6-867b-0e59195ecec0_1456x1188.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbc3bac98-3e65-43c6-867b-0e59195ecec0_1456x1188.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbc3bac98-3e65-43c6-867b-0e59195ecec0_1456x1188.png 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbc3bac98-3e65-43c6-867b-0e59195ecec0_1456x1188.png\\\" width=\\\"1456\\\" height=\\\"1188\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/bc3bac98-3e65-43c6-867b-0e59195ecec0_1456x1188.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:1188,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:263282,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}\\\" class=\\\"sizing-normal\\\" alt=\\\"\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbc3bac98-3e65-43c6-867b-0e59195ecec0_1456x1188.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbc3bac98-3e65-43c6-867b-0e59195ecec0_1456x1188.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbc3bac98-3e65-43c6-867b-0e59195ecec0_1456x1188.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbc3bac98-3e65-43c6-867b-0e59195ecec0_1456x1188.png 1456w\\\" sizes=\\\"100vw\\\" loading=\\\"lazy\\\"></picture><div class=\\\"image-link-expand\\\"><svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"16\\\" height=\\\"16\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"#FFFFFF\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" class=\\\"lucide lucide-maximize2 \\\"><polyline points=\\\"15 3 21 3 21 9\\\"></polyline><polyline points=\\\"9 21 3 21 3 15\\\"></polyline><line x1=\\\"21\\\" x2=\\\"14\\\" y1=\\\"3\\\" y2=\\\"10\\\"></line><line x1=\\\"3\\\" x2=\\\"10\\\" y1=\\\"21\\\" y2=\\\"14\\\"></line></svg></div></div></a></figure></div><p>The only limitation was that we couldn\u2019t link the new <code>Nodepool</code> resource to the existing hierarchy of Cluster API\u2019s <code>MachinePool</code> or CAPZ\u2019s <code>AzureManagedMachinePool</code> resource using <code>ownerReference</code>. Instead, these resources exist side by side and are linked using <code>objectReference</code>. This drawback becomes apparent when deleting a node pool entirely, as the resource hierarchy is removed using <a href=\\\"https://kubernetes.io/docs/concepts/overview/working-with-objects/finalizers/\\\">finalizers</a>.</p><h1>Conclusion</h1><div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link is-viewable-img image2\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbbad4eef-1625-4a4a-9aae-5e7a2606a94d_1914x702.png\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbbad4eef-1625-4a4a-9aae-5e7a2606a94d_1914x702.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbbad4eef-1625-4a4a-9aae-5e7a2606a94d_1914x702.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbbad4eef-1625-4a4a-9aae-5e7a2606a94d_1914x702.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbbad4eef-1625-4a4a-9aae-5e7a2606a94d_1914x702.png 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbbad4eef-1625-4a4a-9aae-5e7a2606a94d_1914x702.png\\\" width=\\\"1456\\\" height=\\\"534\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/bbad4eef-1625-4a4a-9aae-5e7a2606a94d_1914x702.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:534,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:88135,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}\\\" class=\\\"sizing-normal\\\" alt=\\\"\\\" srcset=\\\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbbad4eef-1625-4a4a-9aae-5e7a2606a94d_1914x702.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbbad4eef-1625-4a4a-9aae-5e7a2606a94d_1914x702.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbbad4eef-1625-4a4a-9aae-5e7a2606a94d_1914x702.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbbad4eef-1625-4a4a-9aae-5e7a2606a94d_1914x702.png 1456w\\\" sizes=\\\"100vw\\\" loading=\\\"lazy\\\"></picture><div class=\\\"image-link-expand\\\"><svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"16\\\" height=\\\"16\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"#FFFFFF\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" class=\\\"lucide lucide-maximize2 \\\"><polyline points=\\\"15 3 21 3 21 9\\\"></polyline><polyline points=\\\"9 21 3 21 3 15\\\"></polyline><line x1=\\\"21\\\" x2=\\\"14\\\" y1=\\\"3\\\" y2=\\\"10\\\"></line><line x1=\\\"3\\\" x2=\\\"10\\\" y1=\\\"21\\\" y2=\\\"14\\\"></line></svg></div></div></a></figure></div><p>Figure 2: Complete cluster management stack.</p><p>Evolving our cluster management toolchain empowered us to manage twice as many clusters and applications, while sustaining the same handful of engineers on our Core Infrastructure team. This achievement marks a significant boost in operational efficiency, made possible by our steadfast commitment to GitOps principles and the elimination of human-in-the-loop processes. Along the same lines, self-healing, drift detection, etc. are first class ideas on our platform. This mindset allows us to always <em>prioritize organizational needs</em> leveraging the extensible nature of Kubernetes, while balancing efficiency, reliability and agility.</p><p>Reflecting on our journey, we've had some key learnings and missteps:</p><ol><li><p><strong>Big Bold Bets</strong>: When we explored the industry state-of-the-art for cluster management we couldn\u2019t find anything that meets the level of automation we were striving for. At such times, we leaned on our company\u2019s core value - Big Bold Bets. The bet on Cluster API was fruitful in the long run.</p></li><li><p><strong>Hidden cost of Open Source</strong>: Strategic partnership and driving appropriate community engagement was vital to making our open source collaboration a success. We did learn that a long term commitment is necessary to be able to effectively steer an open source project to continue to meet our needs. We remain committed to contributing to Cluster API for the foreseeable future.</p></li><li><p><strong>First Adopter Risks</strong>: We experienced a Sev1 incident lasting several hours where 60% of our nodes on production clusters were wiped out. We traced it to a bug in CAPZ where just the sequence number suffix was used to identify nodes instead of the full <code>spec.providerID</code>. This caused Cluster API to reference nodes from different node pools within a cluster using the same ID and in turn deleting them.</p></li><li><p><strong>Automation Enhances Reliability</strong>: Despite not being the primary focus, our automation efforts significantly improved systems reliability. We\u2019ve successfully completed 4 incident-free Kubernetes version upgrades. Previously, there used to be at least one incident per version upgrade.</p></li><li><p><strong>Kubernetes Operator Pattern</strong>: We leverage Kubernetes operators extensively in our infrastructure organization. Adhering to standard design patterns like goal state reconciliation enables us to sidestep design debates, mitigate concerns about corner cases, and minimize the learning curve. This along with using managed Kubernetes distributions exclusively was the right tradeoff for us. We remain committed to this approach even today.</p></li></ol><p>So, what lies ahead for us? We've already kicked off a strategic plan to get us to the next level of scale. This involves automatically partitioning workload clusters, considering factors such as API Server pressure and node size. We've also started provisioning more single-tenant clusters. Furthermore, efforts are underway to streamline the time it takes to prepare workload-ready clusters, including steps like IP address allocation and installing cluster addons. All these initiatives are guided by our commitment to minimizing human intervention and achieving full automation. With this roadmap, we aim to adeptly manage over 500 Kubernetes clusters efficiently.</p><p><em>We would like to acknowledge C\u00E9cile Robert-Michon, David Tesar, and Jack Francis at Microsoft. Each contributed during various phases of the project.</em></p>\",\"longer_truncated_body_json\":null,\"longer_truncated_body_html\":null,\"truncated_body_text\":\"Written by Zain Malik and Nibir Bora, members of the engineering teams that work on core infrastructure. At City Storage Systems, our Core Infrastructure team navigates the complexities of managing over 100 multi-tenant Kubernetes clusters, each hosting up to tens of thousands of daily active pods. Our entire software stack runs on Kubernetes from missio\u2026\",\"wordcount\":1613,\"postTags\":[],\"publishedBylines\":[],\"reaction\":null,\"reaction_count\":3,\"comment_count\":0,\"child_comment_count\":0,\"audio_items\":[{\"post_id\":142916610,\"voice_id\":\"en-US-JennyNeural\",\"audio_url\":\"https://substack-video.s3.amazonaws.com/video_upload/post/142916610/tts/333406bb-567a-4194-939c-8404be36cfb0/en-US-JennyNeural.mp3\",\"type\":\"tts\",\"status\":\"completed\"}],\"hasCashtag\":false},\"comments\":[],\"canonicalUrl\":\"https://techblog.citystoragesystems.com/p/managing-100s-of-kubernetes-clusters\",\"inlineComments\":false,\"readerIsSearchCrawler\":false,\"ogUrl\":\"https://techblog.citystoragesystems.com/p/managing-100s-of-kubernetes-clusters\",\"bannedFromNotes\":false,\"themeVariables\":{\"color_theme_bg_pop\":\"#464EE7\",\"background_pop\":\"#464EE7\",\"color_theme_bg_web\":\"#151513\",\"cover_bg_color\":\"#151513\",\"background_pop_darken\":\"#2f38e4\",\"print_on_pop\":\"#ffffff\",\"color_theme_bg_pop_darken\":\"#2f38e4\",\"color_theme_print_on_pop\":\"#ffffff\",\"border_subtle\":\"rgba(68, 68, 66, 0.5)\",\"background_subtle\":\"rgba(227, 228, 251, 0.4)\",\"print_pop\":\"#464ee7\",\"color_theme_accent\":\"#464ee7\",\"cover_print_primary\":\"#ffffff\",\"cover_print_secondary\":\"#d9d9d9\",\"cover_border_color\":\"#ffffff\",\"font_family_headings_preset\":\"'SF Pro Display', -apple-system, system-ui, BlinkMacSystemFont, 'Inter', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'\",\"font_weight_headings_preset\":900,\"font_family_body_preset\":\"'SF Pro Display', -apple-system, system-ui, BlinkMacSystemFont, 'Inter', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'\",\"font_weight_body_preset\":400,\"font_preset_heading\":\"heavy_sans\",\"font_preset_body\":\"sans\",\"home_hero\":\"newspaper\",\"home_posts\":\"list\",\"web_bg_color\":\"#151513\",\"background_contrast_1\":\"#1c1c1a\",\"color_theme_bg_contrast_1\":\"#1c1c1a\",\"background_contrast_2\":\"#272726\",\"color_theme_bg_contrast_2\":\"#272726\",\"background_contrast_3\":\"#3b3b39\",\"color_theme_bg_contrast_3\":\"#3b3b39\",\"background_contrast_4\":\"#565655\",\"color_theme_bg_contrast_4\":\"#565655\",\"background_contrast_5\":\"#717170\",\"color_theme_bg_contrast_5\":\"#717170\",\"background_contrast_pop\":\"rgba(70, 78, 231, 0.4)\",\"color_theme_bg_contrast_pop\":\"rgba(70, 78, 231, 0.4)\",\"input_background\":\"#21211f\",\"cover_input_background\":\"#21211f\",\"tooltip_background\":\"#414140\",\"web_bg_color_h\":\"60\",\"web_bg_color_s\":\"5%\",\"web_bg_color_l\":\"7.8431372549019605%\",\"print_on_web_bg_color\":\"#ffffff\",\"print_secondary_on_web_bg_color\":\"#a1a1a1\",\"selected_comment_background_color\":\"#201c14\",\"background_pop_rgb\":\"70, 78, 231\",\"background_pop_rgb_pc\":\"70 78 231\",\"color_theme_bg_pop_rgb\":\"70, 78, 231\",\"color_theme_bg_pop_rgb_pc\":\"70 78 231\",\"color_theme_accent_rgb\":\"70, 78, 231\",\"color_theme_accent_rgb_pc\":\"70 78 231\"},\"recentEpisodes\":null,\"trackFrontendVisit\":true,\"isChatActive\":false,\"isMeetingsActive\":false,\"features\":{},\"showCookieBanner\":false,\"disabledCookies\":[],\"dd_env\":\"zuma-prod\",\"dd_ti\":true}")</script>
        <script>window._analyticsConfig = JSON.parse("{\"properties\":{\"subdomain\":\"engineering4citystoragesystems\",\"publication_id\":2259056,\"has_plans\":false,\"pub_community_enabled\":true,\"is_subscribed\":false,\"is_free_subscribed\":false,\"is_author\":false,\"is_contributor\":false,\"is_admin\":false,\"is_founding\":false},\"adwordsAccountId\":\"AW-316245675\",\"adwordsEventSendTo\":\"Tf76CKqcyL4DEKuN5pYB\"}")</script>
        
            <script type="module" src="https://substackcdn.com/bundle/assets/main-d6d04c6d.js" charset="utf-8"  defer></script>
        
        <script nomodule>
            (function() {
                var message = 'Your browser does not support modern JavaScript modules. Please upgrade your browser for the best experience.';
                var warningDiv = document.createElement('div');
                warningDiv.style.color = 'red';
                warningDiv.style.padding = '10px';
                warningDiv.style.margin = '10px 0';
                warningDiv.style.border = '1px solid red';
                warningDiv.style.backgroundColor = 'lightyellow';
                warningDiv.innerText = message;
                document.body.prepend(warningDiv);
            })();
        </script>

        
            <script>
                (function (h, o, u, n, d) {
                    h = h[d] = h[d] || { q: [], onReady: function (c) { h.q.push(c) } }
                    d = o.createElement(u); d.async = 1; d.src = n
                    n = o.getElementsByTagName(u)[0]; n.parentNode.insertBefore(d, n)
                })(window, document, 'script', 'https://www.datadoghq-browser-agent.com/datadog-rum-v4.js', 'DD_RUM')
                DD_RUM.onReady(function () {
                    DD_RUM.init({
                        clientToken: 'puba71073f072643721169b68f352438710',
                        applicationId: '2e321b35-c76b-4073-8d04-cc9a10461793',
                        site: 'datadoghq.com',
                        service: 'substack-web',
                        env: window._preloads.dd_env,
                        sampleRate: 1,
                        sessionReplaySampleRate: 0,
                        trackInteractions: window._preloads.dd_ti,
                        trackResources: true,
                        trackLongTasks: true,
                        defaultPrivacyLevel: 'mask-user-input',
                        allowedTracingUrls: [/https?:\/\/(.+\/.)?substack(cdn)?\.com/]
                    });

                    DD_RUM.startSessionReplayRecording();
                })
            </script>

            <!-- Cloudflare Web Analytics --><script defer src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon='{"token": "216309cffb464db4b0e02daf0b8e8060"}'></script><!-- End Cloudflare Web Analytics -->
        

        <!-- Fallback tracking pixels -->
        

        

        <noscript>
    <style>
        #nojs-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            padding: 16px 16px 16px 32px;
            width: 100%;
            box-sizing: border-box;
            background: red;
            color: white;
            font-family: -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            font-size: 13px;
            line-height: 13px;
        }
        #nojs-banner a {
            color: inherit;
            text-decoration: underline;
        }
    </style>

    <div id="nojs-banner">
        This site requires JavaScript to run correctly. Please <a href="https://enable-javascript.com/" target="_blank">turn on JavaScript</a> or unblock scripts
    </div>
</noscript>


        

        

        
        
    </body>
</html>
