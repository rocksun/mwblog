<!doctype html><html lang="en"><head><title data-rh="true">Building a network topology of a Kubernetes application in a non-intrusive way | by Ilya Shakhat | Apr, 2024 | Medium</title><meta data-rh="true" charset="utf-8"/><meta data-rh="true" name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1,maximum-scale=1"/><meta data-rh="true" name="theme-color" content="#000000"/><meta data-rh="true" name="twitter:app:name:iphone" content="Medium"/><meta data-rh="true" name="twitter:app:id:iphone" content="828256236"/><meta data-rh="true" property="al:ios:app_name" content="Medium"/><meta data-rh="true" property="al:ios:app_store_id" content="828256236"/><meta data-rh="true" property="al:android:package" content="com.medium.reader"/><meta data-rh="true" property="fb:app_id" content="542599432471018"/><meta data-rh="true" property="og:site_name" content="Medium"/><meta data-rh="true" property="og:type" content="article"/><meta data-rh="true" property="article:published_time" content="2024-04-26T13:02:51.799Z"/><meta data-rh="true" name="title" content="Building a network topology of a Kubernetes application in a non-intrusive way | by Ilya Shakhat | Apr, 2024 | Medium"/><meta data-rh="true" property="og:title" content="Building a network topology of a Kubernetes application in a non-intrusive way"/><meta data-rh="true" property="al:android:url" content="medium://p/c78cb88b2cb1"/><meta data-rh="true" property="al:ios:url" content="medium://p/c78cb88b2cb1"/><meta data-rh="true" property="al:android:app_name" content="Medium"/><meta data-rh="true" name="description" content="A magic eBPF code propagating peers&#x27; addresses inside TCP flows to reconstruct full network topology of applications running in Kubernetes"/><meta data-rh="true" property="og:description" content="A magic of eBPF code propagating peer address right in TCP flow to reconstruct communication topology"/><meta data-rh="true" property="og:url" content="https://medium.com/@shakhat/building-a-network-topology-of-a-kubernetes-application-in-a-non-intrusive-way-c78cb88b2cb1"/><meta data-rh="true" property="al:web:url" content="https://medium.com/@shakhat/building-a-network-topology-of-a-kubernetes-application-in-a-non-intrusive-way-c78cb88b2cb1"/><meta data-rh="true" property="og:image" content="https://miro.medium.com/v2/resize:fit:539/1*9g2pQdW-TrZRxVKGAIUojQ.png"/><meta data-rh="true" property="article:author" content="https://medium.com/@shakhat"/><meta data-rh="true" name="author" content="Ilya Shakhat"/><meta data-rh="true" name="robots" content="index,follow,max-image-preview:large"/><meta data-rh="true" name="referrer" content="unsafe-url"/><meta data-rh="true" property="twitter:title" content="Building a network topology of a Kubernetes application in a non-intrusive way"/><meta data-rh="true" name="twitter:site" content="@Medium"/><meta data-rh="true" name="twitter:app:url:iphone" content="medium://p/c78cb88b2cb1"/><meta data-rh="true" property="twitter:description" content="A magic of eBPF code propagating peer address right in TCP flow to reconstruct communication topology"/><meta data-rh="true" name="twitter:image:src" content="https://miro.medium.com/v2/resize:fit:539/1*9g2pQdW-TrZRxVKGAIUojQ.png"/><meta data-rh="true" name="twitter:card" content="summary_large_image"/><meta data-rh="true" name="twitter:label1" content="Reading time"/><meta data-rh="true" name="twitter:data1" content="13 min read"/><link data-rh="true" rel="icon" href="https://miro.medium.com/v2/1*m-R_BkNf1Qjr1YbyOIJY2w.png"/><link data-rh="true" rel="search" type="application/opensearchdescription+xml" title="Medium" href="/osd.xml"/><link data-rh="true" rel="apple-touch-icon" sizes="152x152" href="https://miro.medium.com/v2/resize:fill:152:152/1*sHhtYhaCe2Uc3IU0IgKwIQ.png"/><link data-rh="true" rel="apple-touch-icon" sizes="120x120" href="https://miro.medium.com/v2/resize:fill:120:120/1*sHhtYhaCe2Uc3IU0IgKwIQ.png"/><link data-rh="true" rel="apple-touch-icon" sizes="76x76" href="https://miro.medium.com/v2/resize:fill:76:76/1*sHhtYhaCe2Uc3IU0IgKwIQ.png"/><link data-rh="true" rel="apple-touch-icon" sizes="60x60" href="https://miro.medium.com/v2/resize:fill:60:60/1*sHhtYhaCe2Uc3IU0IgKwIQ.png"/><link data-rh="true" rel="mask-icon" href="https://cdn-static-1.medium.com/_/fp/icons/Medium-Avatar-500x500.svg" color="#171717"/><link data-rh="true" rel="preconnect" href="https://glyph.medium.com" crossOrigin=""/><link data-rh="true" id="glyph_preload_link" rel="preload" as="style" type="text/css" href="https://glyph.medium.com/css/unbound.css"/><link data-rh="true" id="glyph_link" rel="stylesheet" type="text/css" href="https://glyph.medium.com/css/unbound.css"/><link data-rh="true" rel="author" href="https://medium.com/@shakhat"/><link data-rh="true" rel="canonical" href="https://medium.com/@shakhat/building-a-network-topology-of-a-kubernetes-application-in-a-non-intrusive-way-c78cb88b2cb1"/><link data-rh="true" rel="alternate" href="android-app://com.medium.reader/https/medium.com/p/c78cb88b2cb1"/><script data-rh="true" type="application/ld+json">{"@context":"http:\u002F\u002Fschema.org","@type":"NewsArticle","image":["https:\u002F\u002Fmiro.medium.com\u002Fv2\u002Fresize:fit:1200\u002F1*9g2pQdW-TrZRxVKGAIUojQ.png"],"url":"https:\u002F\u002Fmedium.com\u002F@shakhat\u002Fbuilding-a-network-topology-of-a-kubernetes-application-in-a-non-intrusive-way-c78cb88b2cb1","dateCreated":"2024-04-26T11:05:34.654Z","datePublished":"2024-04-26T11:05:34.654Z","dateModified":"2024-04-26T13:02:57.522Z","headline":"Building a network topology of a Kubernetes application in a non-intrusive way","name":"Building a network topology of a Kubernetes application in a non-intrusive way","description":"A magic eBPF code propagating peers' addresses inside TCP flows to reconstruct full network topology of applications running in Kubernetes","identifier":"c78cb88b2cb1","author":{"@type":"Person","name":"Ilya Shakhat","url":"https:\u002F\u002Fmedium.com\u002F@shakhat"},"creator":["Ilya Shakhat"],"publisher":{"@type":"Organization","name":"Medium","url":"https:\u002F\u002Fmedium.com\u002F","logo":{"@type":"ImageObject","width":308,"height":60,"url":"https:\u002F\u002Fmiro.medium.com\u002Fv2\u002Fresize:fit:616\u002F1*OMF3fSqH8t4xBJ9-6oZDZw.png"}},"mainEntityOfPage":"https:\u002F\u002Fmedium.com\u002F@shakhat\u002Fbuilding-a-network-topology-of-a-kubernetes-application-in-a-non-intrusive-way-c78cb88b2cb1"}</script><style type="text/css" data-fela-rehydration="530" data-fela-type="STATIC">html{box-sizing:border-box;-webkit-text-size-adjust:100%}*, *:before, *:after{box-sizing:inherit}body{margin:0;padding:0;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;color:rgba(0,0,0,0.8);position:relative;min-height:100vh}h1, h2, h3, h4, h5, h6, dl, dd, ol, ul, menu, figure, blockquote, p, pre, form{margin:0}menu, ol, ul{padding:0;list-style:none;list-style-image:none}main{display:block}a{color:inherit;text-decoration:none}a, button, input{-webkit-tap-highlight-color:transparent}img, svg{vertical-align:middle}button{background:transparent;overflow:visible}button, input, optgroup, select, textarea{margin:0}:root{--reach-tabs:1;--reach-menu-button:1}#speechify-root{font-family:Sohne, sans-serif}div[data-popper-reference-hidden="true"]{visibility:hidden;pointer-events:none}.grecaptcha-badge{visibility:hidden}
/*XCode style (c) Angel Garcia <angelgarcia.mail@gmail.com>*/.hljs {background: #fff;color: black;
}/* Gray DOCTYPE selectors like WebKit */
.xml .hljs-meta {color: #c0c0c0;
}.hljs-comment,
.hljs-quote {color: #007400;
}.hljs-tag,
.hljs-attribute,
.hljs-keyword,
.hljs-selector-tag,
.hljs-literal,
.hljs-name {color: #aa0d91;
}.hljs-variable,
.hljs-template-variable {color: #3F6E74;
}.hljs-code,
.hljs-string,
.hljs-meta .hljs-string {color: #c41a16;
}.hljs-regexp,
.hljs-link {color: #0E0EFF;
}.hljs-title,
.hljs-symbol,
.hljs-bullet,
.hljs-number {color: #1c00cf;
}.hljs-section,
.hljs-meta {color: #643820;
}.hljs-title.class_,
.hljs-class .hljs-title,
.hljs-type,
.hljs-built_in,
.hljs-params {color: #5c2699;
}.hljs-attr {color: #836C28;
}.hljs-subst {color: #000;
}.hljs-formula {background-color: #eee;font-style: italic;
}.hljs-addition {background-color: #baeeba;
}.hljs-deletion {background-color: #ffc8bd;
}.hljs-selector-id,
.hljs-selector-class {color: #9b703f;
}.hljs-doctag,
.hljs-strong {font-weight: bold;
}.hljs-emphasis {font-style: italic;
}
</style><style type="text/css" data-fela-rehydration="530" data-fela-type="KEYFRAME">@-webkit-keyframes k1{0%{opacity:0.8}50%{opacity:0.5}100%{opacity:0.8}}@-moz-keyframes k1{0%{opacity:0.8}50%{opacity:0.5}100%{opacity:0.8}}@keyframes k1{0%{opacity:0.8}50%{opacity:0.5}100%{opacity:0.8}}</style><style type="text/css" data-fela-rehydration="530" data-fela-type="RULE">.a{font-family:medium-content-sans-serif-font, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif}.b{font-weight:400}.c{background-color:rgba(255, 255, 255, 1)}.l{display:block}.m{position:sticky}.n{top:0}.o{z-index:500}.p{padding:0 24px}.q{align-items:center}.r{border-bottom:solid 1px #F2F2F2}.y{height:41px}.z{line-height:20px}.ab{display:flex}.ac{height:57px}.ae{flex:1 0 auto}.af{color:inherit}.ag{fill:inherit}.ah{font-size:inherit}.ai{border:inherit}.aj{font-family:inherit}.ak{letter-spacing:inherit}.al{font-weight:inherit}.am{padding:0}.an{margin:0}.ao{cursor:pointer}.ap:disabled{cursor:not-allowed}.aq:disabled{color:#6B6B6B}.ar:disabled{fill:#6B6B6B}.au{fill:rgba(0, 0, 0, 1)}.av{height:22px}.aw{margin-left:16px}.ax{border:none}.ay{border-radius:20px}.az{width:240px}.ba{background:#F9F9F9}.bb path{fill:#6B6B6B}.bd{outline:none}.be{font-family:sohne, "Helvetica Neue", Helvetica, Arial, sans-serif}.bf{font-size:14px}.bg{width:100%}.bh{padding:10px 20px 10px 0}.bi{background-color:transparent}.bj{color:#242424}.bk::placeholder{color:#6B6B6B}.bl{display:inline-block}.bm{margin-left:12px}.bn{margin-right:12px}.bo{border-radius:4px}.bp{margin-left:24px}.bq{height:24px}.bw{background-color:#F9F9F9}.bx{border-radius:50%}.by{height:32px}.bz{width:32px}.ca{justify-content:center}.cg{max-width:680px}.ch{min-width:0}.ci{animation:k1 1.2s ease-in-out infinite}.cj{height:100vh}.ck{margin-bottom:16px}.cl{margin-top:48px}.cm{align-items:flex-start}.cn{flex-direction:column}.co{justify-content:space-between}.cp{margin-bottom:24px}.cv{width:80%}.cw{background-color:#F2F2F2}.dc{height:44px}.dd{width:44px}.de{margin:auto 0}.df{margin-bottom:4px}.dg{height:16px}.dh{width:120px}.di{width:80px}.do{margin-bottom:8px}.dp{width:96%}.dq{width:98%}.dr{width:81%}.ds{margin-left:8px}.dt{color:#6B6B6B}.du{font-size:13px}.dv{height:100%}.eo{color:#FFFFFF}.ep{fill:#FFFFFF}.eq{background:#1A8917}.er{border-color:#1A8917}.ev:disabled{cursor:inherit !important}.ew:disabled{opacity:0.3}.ex:disabled:hover{background:#1A8917}.ey:disabled:hover{border-color:#1A8917}.ez{border-radius:99em}.fa{border-width:1px}.fb{border-style:solid}.fc{box-sizing:border-box}.fd{text-decoration:none}.fe{text-align:center}.fh{margin-right:32px}.fi{position:relative}.fj{fill:#6B6B6B}.fm{background:transparent}.fn svg{margin-left:4px}.fo svg{fill:#6B6B6B}.fq{box-shadow:inset 0 0 0 1px rgba(0, 0, 0, 0.05)}.fr{position:absolute}.fy{margin:0 24px}.gc{background:rgba(255, 255, 255, 1)}.gd{border:1px solid #F2F2F2}.ge{box-shadow:0 1px 4px #F2F2F2}.gf{max-height:100vh}.gg{overflow-y:auto}.gh{left:0}.gi{top:calc(100vh + 100px)}.gj{bottom:calc(100vh + 100px)}.gk{width:10px}.gl{pointer-events:none}.gm{word-break:break-word}.gn{word-wrap:break-word}.go:after{display:block}.gp:after{content:""}.gq:after{clear:both}.gr{line-height:1.23}.gs{letter-spacing:0}.gt{font-style:normal}.gu{font-weight:700}.hu{@media all and (max-width: 551.98px):8px}.hv{@media all and (min-width: 552px) and (max-width: 727.98px):8px}.hw{@media all and (min-width: 728px) and (max-width: 903.98px):16px}.hx{@media all and (min-width: 904px) and (max-width: 1079.98px):16px}.hy{@media all and (min-width: 1080px):16px}.ie{align-items:baseline}.if{width:48px}.ig{height:48px}.ih{border:2px solid rgba(255, 255, 255, 1)}.ii{z-index:0}.ij{box-shadow:none}.ik{border:1px solid rgba(0, 0, 0, 0.05)}.il{margin-bottom:2px}.im{flex-wrap:nowrap}.in{font-size:16px}.io{line-height:24px}.iq{margin:0 8px}.ir{display:inline}.is{color:#1A8917}.it{fill:#1A8917}.iw{flex:0 0 auto}.iz{flex-wrap:wrap}.ja{padding-left:8px}.jb{padding-right:8px}.kc> *{flex-shrink:0}.kd{overflow-x:scroll}.ke::-webkit-scrollbar{display:none}.kf{scrollbar-width:none}.kg{-ms-overflow-style:none}.kh{width:74px}.ki{flex-direction:row}.kj{z-index:2}.kk{margin-right:4px}.kn{-webkit-user-select:none}.ko{border:0}.kp{fill:rgba(117, 117, 117, 1)}.ks{outline:0}.kt{user-select:none}.ku> svg{pointer-events:none}.ld{cursor:progress}.le{opacity:1}.lf{padding:4px 0}.li{margin-top:0px}.lj{width:16px}.ll{display:inline-flex}.lr{max-width:100%}.ls{padding:8px 2px}.lt svg{color:#6B6B6B}.mk{line-height:1.12}.ml{letter-spacing:-0.022em}.mm{font-weight:600}.nh{margin-bottom:-0.28em}.ni{line-height:1.58}.nj{letter-spacing:-0.004em}.nk{font-family:source-serif-pro, Georgia, Cambria, "Times New Roman", Times, serif}.of{margin-bottom:-0.46em}.og{font-style:italic}.om{text-decoration:underline}.on{margin-left:auto}.oo{margin-right:auto}.op{max-width:539px}.ov{clear:both}.ow{height:auto}.ox{margin-top:10px}.oy{max-width:728px}.pb{overflow-x:auto}.pc{font-family:source-code-pro, Menlo, Monaco, "Courier New", Courier, monospace}.pd{padding:32px}.pe{border:1px solid #E5E5E5}.pf{line-height:1.4}.pg{margin-top:-0.2em}.ph{margin-bottom:-0.2em}.pi{white-space:pre}.pj{min-width:fit-content}.pk{max-width:974px}.pm{cursor:zoom-in}.pn{z-index:auto}.pp{max-width:460px}.pq{max-width:485px}.pr{max-width:490px}.ps{list-style-type:decimal}.pt{margin-left:30px}.pu{padding-left:0px}.qa{max-width:1574px}.qb{max-width:1752px}.qc{box-shadow:inset 3px 0 0 0 #242424}.qd{padding-left:23px}.qe{margin-left:-20px}.qf{line-height:1.18}.qt{margin-bottom:-0.31em}.qu{max-width:902px}.qv{margin-bottom:26px}.qw{margin-top:6px}.qx{margin-top:8px}.qy{margin-right:8px}.qz{padding:8px 16px}.ra{border-radius:100px}.rb{transition:background 300ms ease}.rd{white-space:nowrap}.re{border-top:none}.rk{height:52px}.rl{max-height:52px}.rm{box-sizing:content-box}.rn{position:static}.ro{z-index:1}.rq{max-width:155px}.rw{margin-right:20px}.sc{align-items:flex-end}.sd{width:76px}.se{height:76px}.sf{border:2px solid #F9F9F9}.sg{height:72px}.sh{width:72px}.si{width:auto}.sj{stroke:#F2F2F2}.sk{height:36px}.sl{width:36px}.sm{color:#F2F2F2}.sn{fill:#F2F2F2}.so{background:#F2F2F2}.sp{border-color:#F2F2F2}.sv{font-weight:500}.sw{font-size:24px}.sx{line-height:30px}.sy{letter-spacing:-0.016em}.sz{margin-top:16px}.ta{height:0px}.tb{border-bottom:solid 1px #E5E5E5}.th{margin-top:72px}.ti{padding:24px 0}.tj{margin-bottom:0px}.tk{margin-right:16px}.as:hover:not(:disabled){color:rgba(25, 25, 25, 1)}.at:hover:not(:disabled){fill:rgba(25, 25, 25, 1)}.es:hover{background:#156D12}.et:hover{border-color:#156D12}.eu:hover{cursor:pointer}.fk:hover{color:#242424}.fl:hover{fill:#242424}.fp:hover svg{fill:#242424}.fs:hover{background-color:rgba(0, 0, 0, 0.1)}.ip:hover{text-decoration:underline}.iu:hover:not(:disabled){color:#156D12}.iv:hover:not(:disabled){fill:#156D12}.kr:hover{fill:rgba(8, 8, 8, 1)}.lg:hover{fill:#000000}.lh:hover p{color:#000000}.lk:hover{color:#000000}.lu:hover svg{color:#000000}.rc:hover{background-color:#F2F2F2}.sq:hover{background:#F2F2F2}.sr:hover{border-color:#F2F2F2}.ss:hover{cursor:wait}.st:hover{color:#F2F2F2}.su:hover{fill:#F2F2F2}.bc:focus-within path{fill:#242424}.kq:focus{fill:rgba(8, 8, 8, 1)}.lv:focus svg{color:#000000}.po:focus{transform:scale(1.01)}.kv:active{border-style:none}</style><style type="text/css" data-fela-rehydration="530" data-fela-type="RULE" media="all and (min-width: 1080px)">.d{display:none}.bv{width:64px}.cf{margin:0 64px}.cu{height:48px}.db{margin-bottom:52px}.dn{margin-bottom:48px}.ee{font-size:14px}.ef{line-height:20px}.el{font-size:13px}.em{padding:5px 12px}.fg{display:flex}.fx{margin-bottom:68px}.gb{max-width:680px}.hp{font-size:42px}.hq{margin-top:1.19em}.hr{margin-bottom:32px}.hs{line-height:52px}.ht{letter-spacing:-0.011em}.id{align-items:center}.jo{border-top:solid 1px #F2F2F2}.jp{border-bottom:solid 1px #F2F2F2}.jq{margin:32px 0 0}.jr{padding:3px 8px}.ka> *{margin-right:24px}.kb> :last-child{margin-right:0}.lc{margin-top:0px}.lq{margin:0}.nd{font-size:24px}.ne{margin-top:1.95em}.nf{line-height:30px}.ng{letter-spacing:-0.016em}.ob{font-size:20px}.oc{margin-top:0.94em}.od{line-height:32px}.oe{letter-spacing:-0.003em}.ol{margin-top:2.14em}.ou{margin-top:56px}.pz{margin-top:1.14em}.qq{margin-top:1.72em}.qr{line-height:24px}.qs{letter-spacing:0}.rj{margin-bottom:88px}.rv{display:inline-block}.sb{padding-top:72px}.tg{margin-top:40px}</style><style type="text/css" data-fela-rehydration="530" data-fela-type="RULE" media="all and (max-width: 1079.98px)">.e{display:none}.lb{margin-top:0px}.oz{margin-left:auto}.pa{text-align:center}.ru{display:inline-block}</style><style type="text/css" data-fela-rehydration="530" data-fela-type="RULE" media="all and (max-width: 903.98px)">.f{display:none}.la{margin-top:0px}.rt{display:inline-block}</style><style type="text/css" data-fela-rehydration="530" data-fela-type="RULE" media="all and (max-width: 727.98px)">.g{display:none}.ky{margin-top:0px}.kz{margin-right:0px}.rs{display:inline-block}</style><style type="text/css" data-fela-rehydration="530" data-fela-type="RULE" media="all and (max-width: 551.98px)">.h{display:none}.s{display:flex}.t{justify-content:space-between}.br{width:24px}.cb{margin:0 24px}.cq{height:40px}.cx{margin-bottom:44px}.dj{margin-bottom:32px}.dw{font-size:13px}.dx{line-height:20px}.eg{padding:0px 8px 1px}.ft{margin-bottom:4px}.gv{font-size:32px}.gw{margin-top:1.01em}.gx{margin-bottom:24px}.gy{line-height:38px}.gz{letter-spacing:-0.014em}.hz{align-items:flex-start}.ix{flex-direction:column}.jc{margin:24px -24px 0}.jd{padding:0}.js> *{margin-right:8px}.jt> :last-child{margin-right:24px}.kl{margin-left:0px}.kw{margin-top:0px}.kx{margin-right:0px}.lm{margin:0}.lw{border:1px solid #F2F2F2}.lx{border-radius:99em}.ly{padding:0px 16px 0px 12px}.lz{height:38px}.ma{align-items:center}.mc svg{margin-right:8px}.mn{font-size:20px}.mo{margin-top:1.2em}.mp{line-height:24px}.mq{letter-spacing:0}.nl{font-size:18px}.nm{margin-top:0.67em}.nn{line-height:28px}.no{letter-spacing:-0.003em}.oh{margin-top:1.56em}.oq{margin-top:40px}.pv{margin-top:1.34em}.qg{font-size:16px}.qh{margin-top:1.23em}.rf{margin-bottom:80px}.rr{display:inline-block}.rx{padding-top:48px}.tc{margin-top:32px}.mb:hover{border-color:#E5E5E5}</style><style type="text/css" data-fela-rehydration="530" data-fela-type="RULE" media="all and (min-width: 904px) and (max-width: 1079.98px)">.i{display:none}.bu{width:64px}.ce{margin:0 64px}.ct{height:48px}.da{margin-bottom:52px}.dm{margin-bottom:48px}.ec{font-size:14px}.ed{line-height:20px}.ej{font-size:13px}.ek{padding:5px 12px}.ff{display:flex}.fw{margin-bottom:68px}.ga{max-width:680px}.hk{font-size:42px}.hl{margin-top:1.19em}.hm{margin-bottom:32px}.hn{line-height:52px}.ho{letter-spacing:-0.011em}.ic{align-items:center}.jk{border-top:solid 1px #F2F2F2}.jl{border-bottom:solid 1px #F2F2F2}.jm{margin:32px 0 0}.jn{padding:3px 8px}.jy> *{margin-right:24px}.jz> :last-child{margin-right:0}.lp{margin:0}.mz{font-size:24px}.na{margin-top:1.95em}.nb{line-height:30px}.nc{letter-spacing:-0.016em}.nx{font-size:20px}.ny{margin-top:0.94em}.nz{line-height:32px}.oa{letter-spacing:-0.003em}.ok{margin-top:2.14em}.ot{margin-top:56px}.py{margin-top:1.14em}.qn{margin-top:1.72em}.qo{line-height:24px}.qp{letter-spacing:0}.ri{margin-bottom:88px}.sa{padding-top:72px}.tf{margin-top:40px}</style><style type="text/css" data-fela-rehydration="530" data-fela-type="RULE" media="all and (min-width: 728px) and (max-width: 903.98px)">.j{display:none}.w{display:flex}.x{justify-content:space-between}.bt{width:64px}.cd{margin:0 48px}.cs{height:48px}.cz{margin-bottom:52px}.dl{margin-bottom:48px}.ea{font-size:13px}.eb{line-height:20px}.ei{padding:0px 8px 1px}.fv{margin-bottom:68px}.fz{max-width:680px}.hf{font-size:42px}.hg{margin-top:1.19em}.hh{margin-bottom:32px}.hi{line-height:52px}.hj{letter-spacing:-0.011em}.ib{align-items:center}.jg{border-top:solid 1px #F2F2F2}.jh{border-bottom:solid 1px #F2F2F2}.ji{margin:32px 0 0}.jj{padding:3px 8px}.jw> *{margin-right:24px}.jx> :last-child{margin-right:0}.lo{margin:0}.mv{font-size:24px}.mw{margin-top:1.95em}.mx{line-height:30px}.my{letter-spacing:-0.016em}.nt{font-size:20px}.nu{margin-top:0.94em}.nv{line-height:32px}.nw{letter-spacing:-0.003em}.oj{margin-top:2.14em}.os{margin-top:56px}.px{margin-top:1.14em}.qk{margin-top:1.72em}.ql{line-height:24px}.qm{letter-spacing:0}.rh{margin-bottom:88px}.rz{padding-top:72px}.te{margin-top:40px}</style><style type="text/css" data-fela-rehydration="530" data-fela-type="RULE" media="all and (min-width: 552px) and (max-width: 727.98px)">.k{display:none}.u{display:flex}.v{justify-content:space-between}.bs{width:24px}.cc{margin:0 24px}.cr{height:40px}.cy{margin-bottom:44px}.dk{margin-bottom:32px}.dy{font-size:13px}.dz{line-height:20px}.eh{padding:0px 8px 1px}.fu{margin-bottom:4px}.ha{font-size:32px}.hb{margin-top:1.01em}.hc{margin-bottom:24px}.hd{line-height:38px}.he{letter-spacing:-0.014em}.ia{align-items:flex-start}.iy{flex-direction:column}.je{margin:24px 0 0}.jf{padding:0}.ju> *{margin-right:8px}.jv> :last-child{margin-right:8px}.km{margin-left:0px}.ln{margin:0}.md{border:1px solid #F2F2F2}.me{border-radius:99em}.mf{padding:0px 16px 0px 12px}.mg{height:38px}.mh{align-items:center}.mj svg{margin-right:8px}.mr{font-size:20px}.ms{margin-top:1.2em}.mt{line-height:24px}.mu{letter-spacing:0}.np{font-size:18px}.nq{margin-top:0.67em}.nr{line-height:28px}.ns{letter-spacing:-0.003em}.oi{margin-top:1.56em}.or{margin-top:40px}.pw{margin-top:1.34em}.qi{font-size:16px}.qj{margin-top:1.23em}.rg{margin-bottom:80px}.ry{padding-top:48px}.td{margin-top:32px}.mi:hover{border-color:#E5E5E5}</style><style type="text/css" data-fela-rehydration="530" data-fela-type="RULE" media="print">.rp{display:none}</style><style type="text/css" data-fela-rehydration="530" data-fela-type="RULE" media="(prefers-reduced-motion: no-preference)">.pl{transition:transform 300ms cubic-bezier(0.2, 0, 0.2, 1)}</style></head><body><div id="root"><div class="a b c"><div class="d e f g h i j k"></div><script>document.domain = document.domain;</script><div class="l c"><div class="l m n o c"><div class="p q r s t u v w x i d y z"><a class="dt ag du be ak b am an ao ap aq ar as at s u w i d q dv z" href="https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fc78cb88b2cb1&amp;%7Efeature=LoOpenInAppButton&amp;%7Echannel=ShowPostUnderUser&amp;source=---two_column_layout_nav----------------------------------" rel="noopener follow">Open in app<svg width="10" height="10" viewBox="0 0 10 10" fill="none" class="ds"><path d="M.98 8.48a.37.37 0 1 0 .54.54l-.54-.54zm7.77-7.23h.38c0-.2-.17-.38-.38-.38v.38zM8.37 6.5a.37.37 0 1 0 .76 0h-.76zM3.5.87a.37.37 0 1 0 0 .76V.88zM1.52 9.03l7.5-7.5-.54-.54-7.5 7.5.54.54zm6.86-7.77V6.5h.74V1.25h-.74zm-4.88.38h5.25V.88H3.5v.74z" fill="currentColor"></path></svg></a><div class="ab q"><p class="be b dw dx dy dz ea eb ec ed ee ef dt"><span><button class="be b dw dx eg dy dz eh ea eb ei ej ed ek el ef em eo ep eq er es et eu ev ew ex ey ez fa fb fc bl fd fe" data-testid="headerSignUpButton">Sign up</button></span></p><div class="aw l"><p class="be b dw dx dy dz ea eb ec ed ee ef dt"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="headerSignInButton" rel="noopener follow" href="/m/signin?operation=login&amp;redirect=https%3A%2F%2Fmedium.com%2F%40shakhat%2Fbuilding-a-network-topology-of-a-kubernetes-application-in-a-non-intrusive-way-c78cb88b2cb1&amp;source=post_page---two_column_layout_nav-----------------------global_nav-----------">Sign in</a></span></p></div></div></div><div class="p q r ab ac"><div class="ab q ae"><a class="af ag ah ai aj ak al am an ao ap aq ar as at ab" aria-label="Homepage" data-testid="headerMediumLogo" rel="noopener follow" href="/?source=---two_column_layout_nav----------------------------------"><svg viewBox="0 0 3940 610" class="au av"><path d="M594.79 308.2c0 163.76-131.85 296.52-294.5 296.52S5.8 472 5.8 308.2 137.65 11.69 300.29 11.69s294.5 132.75 294.5 296.51M917.86 308.2c0 154.16-65.93 279.12-147.25 279.12s-147.25-125-147.25-279.12S689.29 29.08 770.61 29.08s147.25 125 147.25 279.12M1050 308.2c0 138.12-23.19 250.08-51.79 250.08s-51.79-112-51.79-250.08 23.19-250.08 51.8-250.08S1050 170.09 1050 308.2M1862.77 37.4l.82-.18v-6.35h-167.48l-155.51 365.5-155.51-365.5h-180.48v6.35l.81.18c30.57 6.9 46.09 17.19 46.09 54.3v434.45c0 37.11-15.58 47.4-46.15 54.3l-.81.18V587H1327v-6.35l-.81-.18c-30.57-6.9-46.09-17.19-46.09-54.3V116.9L1479.87 587h11.33l205.59-483.21V536.9c-2.62 29.31-18 38.36-45.68 44.61l-.82.19v6.3h213.3v-6.3l-.82-.19c-27.71-6.25-43.46-15.3-46.08-44.61l-.14-445.2h.14c0-37.11 15.52-47.4 46.08-54.3m97.43 287.8c3.49-78.06 31.52-134.4 78.56-135.37 14.51.24 26.68 5 36.14 14.16 20.1 19.51 29.55 60.28 28.09 121.21zm-2.11 22h250v-1.05c-.71-59.69-18-106.12-51.34-138-28.82-27.55-71.49-42.71-116.31-42.71h-1c-23.26 0-51.79 5.64-72.09 15.86-23.11 10.7-43.49 26.7-60.45 47.7-27.3 33.83-43.84 79.55-47.86 130.93-.13 1.54-.24 3.08-.35 4.62s-.18 2.92-.25 4.39a332.64 332.64 0 0 0-.36 21.69C1860.79 507 1923.65 600 2035.3 600c98 0 155.07-71.64 169.3-167.8l-7.19-2.53c-25 51.68-69.9 83-121 79.18-69.76-5.22-123.2-75.95-118.35-161.63m532.69 157.68c-8.2 19.45-25.31 30.15-48.24 30.15s-43.89-15.74-58.78-44.34c-16-30.7-24.42-74.1-24.42-125.51 0-107 33.28-176.21 84.79-176.21 21.57 0 38.55 10.7 46.65 29.37zm165.84 76.28c-30.57-7.23-46.09-18-46.09-57V5.28L2424.77 60v6.7l1.14-.09c25.62-2.07 43 1.47 53.09 10.79 7.9 7.3 11.75 18.5 11.75 34.26v71.14c-18.31-11.69-40.09-17.38-66.52-17.38-53.6 0-102.59 22.57-137.92 63.56-36.83 42.72-56.3 101.1-56.3 168.81C2230 518.72 2289.53 600 2378.13 600c51.83 0 93.53-28.4 112.62-76.3V588h166.65v-6.66zm159.29-505.33c0-37.76-28.47-66.24-66.24-66.24-37.59 0-67 29.1-67 66.24s29.44 66.24 67 66.24c37.77 0 66.24-28.48 66.24-66.24m43.84 505.33c-30.57-7.23-46.09-18-46.09-57h-.13V166.65l-166.66 47.85v6.5l1 .09c36.06 3.21 45.93 15.63 45.93 57.77V588h166.8v-6.66zm427.05 0c-30.57-7.23-46.09-18-46.09-57V166.65L3082 212.92v6.52l.94.1c29.48 3.1 38 16.23 38 58.56v226c-9.83 19.45-28.27 31-50.61 31.78-36.23 0-56.18-24.47-56.18-68.9V166.66l-166.66 47.85V221l1 .09c36.06 3.2 45.94 15.62 45.94 57.77v191.27a214.48 214.48 0 0 0 3.47 39.82l3 13.05c14.11 50.56 51.08 77 109 77 49.06 0 92.06-30.37 111-77.89v66h166.66v-6.66zM3934.2 588v-6.67l-.81-.19c-33.17-7.65-46.09-22.07-46.09-51.43v-243.2c0-75.83-42.59-121.09-113.93-121.09-52 0-95.85 30.05-112.73 76.86-13.41-49.6-52-76.86-109.06-76.86-50.12 0-89.4 26.45-106.25 71.13v-69.87l-166.66 45.89v6.54l1 .09c35.63 3.16 45.93 15.94 45.93 57V588h155.5v-6.66l-.82-.2c-26.46-6.22-35-17.56-35-46.66V255.72c7-16.35 21.11-35.72 49-35.72 34.64 0 52.2 24 52.2 71.28V588h155.54v-6.66l-.82-.2c-26.46-6.22-35-17.56-35-46.66v-248a160.45 160.45 0 0 0-2.2-27.68c7.42-17.77 22.34-38.8 51.37-38.8 35.13 0 52.2 23.31 52.2 71.28V588z"></path></svg></a><div class="aw h"><div class="ab ax ay az ba q bb bc"><div class="bl" aria-hidden="false" aria-describedby="searchResults" aria-labelledby="searchResults"></div><div class="bm bn ab"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path fill-rule="evenodd" clip-rule="evenodd" d="M4.1 11.06a6.95 6.95 0 1 1 13.9 0 6.95 6.95 0 0 1-13.9 0zm6.94-8.05a8.05 8.05 0 1 0 5.13 14.26l3.75 3.75a.56.56 0 1 0 .8-.79l-3.74-3.73A8.05 8.05 0 0 0 11.04 3v.01z" fill="currentColor"></path></svg></div><input role="combobox" aria-controls="searchResults" aria-expanded="false" aria-label="search" data-testid="headerSearchInput" tabindex="0" class="ax bd be bf z bg bh bi bj bk" placeholder="Search" value=""/></div></div></div><div class="h k w ff fg"><div class="fh ab"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="headerWriteButton" rel="noopener follow" href="/m/signin?operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2Fnew-story&amp;source=---two_column_layout_nav-----------------------new_post_topnav-----------"><div class="be b bf z dt fi fj ab q fk fl"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" aria-label="Write"><path d="M14 4a.5.5 0 0 0 0-1v1zm7 6a.5.5 0 0 0-1 0h1zm-7-7H4v1h10V3zM3 4v16h1V4H3zm1 17h16v-1H4v1zm17-1V10h-1v10h1zm-1 1a1 1 0 0 0 1-1h-1v1zM3 20a1 1 0 0 0 1 1v-1H3zM4 3a1 1 0 0 0-1 1h1V3z" fill="currentColor"></path><path d="M17.5 4.5l-8.46 8.46a.25.25 0 0 0-.06.1l-.82 2.47c-.07.2.12.38.31.31l2.47-.82a.25.25 0 0 0 .1-.06L19.5 6.5m-2-2l2.32-2.32c.1-.1.26-.1.36 0l1.64 1.64c.1.1.1.26 0 .36L19.5 6.5m-2-2l2 2" stroke="currentColor"></path></svg><div class="ds l">Write</div></div></a></span></div></div><div class="k j i d"><div class="fh ab"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="headerSearchButton" rel="noopener follow" href="/search?source=---two_column_layout_nav----------------------------------"><div class="be b bf z dt fi fj ab q fk fl"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" aria-label="Search"><path fill-rule="evenodd" clip-rule="evenodd" d="M4.1 11.06a6.95 6.95 0 1 1 13.9 0 6.95 6.95 0 0 1-13.9 0zm6.94-8.05a8.05 8.05 0 1 0 5.13 14.26l3.75 3.75a.56.56 0 1 0 .8-.79l-3.74-3.73A8.05 8.05 0 0 0 11.04 3v.01z" fill="currentColor"></path></svg></div></a></div></div><div class="fh h k j"><div class="ab q"><p class="be b dw dx dy dz ea eb ec ed ee ef dt"><span><button class="be b dw dx eg dy dz eh ea eb ei ej ed ek el ef em eo ep eq er es et eu ev ew ex ey ez fa fb fc bl fd fe" data-testid="headerSignUpButton">Sign up</button></span></p><div class="aw l"><p class="be b dw dx dy dz ea eb ec ed ee ef dt"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="headerSignInButton" rel="noopener follow" href="/m/signin?operation=login&amp;redirect=https%3A%2F%2Fmedium.com%2F%40shakhat%2Fbuilding-a-network-topology-of-a-kubernetes-application-in-a-non-intrusive-way-c78cb88b2cb1&amp;source=post_page---two_column_layout_nav-----------------------global_nav-----------">Sign in</a></span></p></div></div></div><div class="l" aria-hidden="false"><button class="ax fm am ab q ao fn fo fp" aria-label="user options menu" data-testid="headerUserIcon"><div class="l fi"><img alt="" class="l fc bx by bz cw" src="https://miro.medium.com/v2/resize:fill:64:64/1*dmbNkD5D-u45r44go_cf0g.png" width="32" height="32" loading="lazy" role="presentation"/><div class="fq bx l by bz fr n ax fs"></div></div></button></div></div></div><div class="l"><div class="ft fu fv fw fx l"><div class="ab ca"><div class="ch bg fy fz ga gb"></div></div><article><div class="l"><div class="l"><span class="l"></span><section><div><div class="fr gh gi gj gk gl"></div><div class="gm gn go gp gq"><div class="ab ca"><div class="ch bg fy fz ga gb"><div><h1 id="b9c5" class="pw-post-title gr gs gt be gu gv gw gx gy gz ha hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq hr hs ht bj" data-testid="storyTitle">Building a network topology of a Kubernetes application in a non-intrusive way</h1><div class="hu hv hw hx hy"><div class="speechify-ignore ab co"><div class="speechify-ignore bg l"><div class="hz ia ib ic id ab"><div><div class="ab ie"><a rel="noopener follow" href="/@shakhat?source=post_page-----c78cb88b2cb1--------------------------------"><div><div class="bl" aria-hidden="false"><div class="l if ig bx ih ii"><div class="l fi"><img alt="Ilya Shakhat" class="l fc bx dc dd cw" src="https://miro.medium.com/v2/resize:fill:88:88/1*mac3LkjCysodrgS9yGsgkQ.jpeg" width="44" height="44" loading="lazy" data-testid="authorPhoto"/><div class="ij bx l dc dd fr n ik fs"></div></div></div></div></div></a></div></div><div class="bm bg l"><div class="ab"><div style="flex:1"><span class="be b bf z bj"><div class="il ab q"><div class="ab q im"><div class="ab q"><div><div class="bl" aria-hidden="false"><p class="be b in io bj"><a class="af ag ah ai aj ak al am an ao ap aq ar ip" data-testid="authorName" rel="noopener follow" href="/@shakhat?source=post_page-----c78cb88b2cb1--------------------------------">Ilya Shakhat</a></p></div></div></div><span class="iq ir" aria-hidden="true"><span class="be b bf z dt">·</span></span><p class="be b in io dt"><span><a class="is it ah ai aj ak al am an ao ap aq ar ew iu iv" rel="noopener follow" href="/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F7766bf7322ef&amp;operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2F%40shakhat%2Fbuilding-a-network-topology-of-a-kubernetes-application-in-a-non-intrusive-way-c78cb88b2cb1&amp;user=Ilya+Shakhat&amp;userId=7766bf7322ef&amp;source=post_page-7766bf7322ef----c78cb88b2cb1---------------------post_header-----------">Follow</a></span></p></div></div></span></div></div><div class="l iw"><span class="be b bf z dt"><div class="ab cm ix iy iz"><span class="be b bf z dt"><div class="ab ae"><span data-testid="storyReadTime">13 min read</span><div class="ja jb l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="be b bf z dt">·</span></span></div><span data-testid="storyPublishDate">Apr 26, 2024</span></div></span></div></span></div></div></div><div class="ab co jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr"><div class="h k w ff fg q"><div class="kh l"><div class="ab q ki kj"><div class="pw-multi-vote-icon fi kk kl km kn"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="headerClapButton" rel="noopener follow" href="/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Fp%2Fc78cb88b2cb1&amp;operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2F%40shakhat%2Fbuilding-a-network-topology-of-a-kubernetes-application-in-a-non-intrusive-way-c78cb88b2cb1&amp;user=Ilya+Shakhat&amp;userId=7766bf7322ef&amp;source=-----c78cb88b2cb1---------------------clap_footer-----------"><div><div class="bl" aria-hidden="false"><div class="ko ao kp kq kr ks am kt ku kv kn"><svg width="24" height="24" viewBox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" clip-rule="evenodd" d="M11.37.83L12 3.28l.63-2.45h-1.26zM13.92 3.95l1.52-2.1-1.18-.4-.34 2.5zM8.59 1.84l1.52 2.11-.34-2.5-1.18.4zM18.52 18.92a4.23 4.23 0 0 1-2.62 1.33l.41-.37c2.39-2.4 2.86-4.95 1.4-7.63l-.91-1.6-.8-1.67c-.25-.56-.19-.98.21-1.29a.7.7 0 0 1 .55-.13c.28.05.54.23.72.5l2.37 4.16c.97 1.62 1.14 4.23-1.33 6.7zm-11-.44l-4.15-4.15a.83.83 0 0 1 1.17-1.17l2.16 2.16a.37.37 0 0 0 .51-.52l-2.15-2.16L3.6 11.2a.83.83 0 0 1 1.17-1.17l3.43 3.44a.36.36 0 0 0 .52 0 .36.36 0 0 0 0-.52L5.29 9.51l-.97-.97a.83.83 0 0 1 0-1.16.84.84 0 0 1 1.17 0l.97.97 3.44 3.43a.36.36 0 0 0 .51 0 .37.37 0 0 0 0-.52L6.98 7.83a.82.82 0 0 1-.18-.9.82.82 0 0 1 .76-.51c.22 0 .43.09.58.24l5.8 5.79a.37.37 0 0 0 .58-.42L13.4 9.67c-.26-.56-.2-.98.2-1.29a.7.7 0 0 1 .55-.13c.28.05.55.23.73.5l2.2 3.86c1.3 2.38.87 4.59-1.29 6.75a4.65 4.65 0 0 1-4.19 1.37 7.73 7.73 0 0 1-4.07-2.25zm3.23-12.5l2.12 2.11c-.41.5-.47 1.17-.13 1.9l.22.46-3.52-3.53a.81.81 0 0 1-.1-.36c0-.23.09-.43.24-.59a.85.85 0 0 1 1.17 0zm7.36 1.7a1.86 1.86 0 0 0-1.23-.84 1.44 1.44 0 0 0-1.12.27c-.3.24-.5.55-.58.89-.25-.25-.57-.4-.91-.47-.28-.04-.56 0-.82.1l-2.18-2.18a1.56 1.56 0 0 0-2.2 0c-.2.2-.33.44-.4.7a1.56 1.56 0 0 0-2.63.75 1.6 1.6 0 0 0-2.23-.04 1.56 1.56 0 0 0 0 2.2c-.24.1-.5.24-.72.45a1.56 1.56 0 0 0 0 2.2l.52.52a1.56 1.56 0 0 0-.75 2.61L7 19a8.46 8.46 0 0 0 4.48 2.45 5.18 5.18 0 0 0 3.36-.5 4.89 4.89 0 0 0 4.2-1.51c2.75-2.77 2.54-5.74 1.43-7.59L18.1 7.68z"></path></svg></div></div></div></a></span></div><div class="pw-multi-vote-count l kw kx ky kz la lb lc"><p class="be b du z dt"><span class="ld">--</span></p></div></div></div><div><div class="bl" aria-hidden="false"><button class="ao ko le lf ab q fj lg lh" aria-label="responses"><svg width="24" height="24" viewBox="0 0 24 24" class="li"><path d="M18 16.8a7.14 7.14 0 0 0 2.24-5.32c0-4.12-3.53-7.48-8.05-7.48C7.67 4 4 7.36 4 11.48c0 4.13 3.67 7.48 8.2 7.48a8.9 8.9 0 0 0 2.38-.32c.23.2.48.39.75.56 1.06.69 2.2 1.04 3.4 1.04.22 0 .4-.11.48-.29a.5.5 0 0 0-.04-.52 6.4 6.4 0 0 1-1.16-2.65v.02zm-3.12 1.06l-.06-.22-.32.1a8 8 0 0 1-2.3.33c-4.03 0-7.3-2.96-7.3-6.59S8.17 4.9 12.2 4.9c4 0 7.1 2.96 7.1 6.6 0 1.8-.6 3.47-2.02 4.72l-.2.16v.26l.02.3a6.74 6.74 0 0 0 .88 2.4 5.27 5.27 0 0 1-2.17-.86c-.28-.17-.72-.38-.94-.59l.01-.02z"></path></svg></button></div></div></div><div class="ab q js jt ju jv jw jx jy jz ka kb kc kd ke kf kg"><div class="lj k j i d"></div><div class="h k"><div><div class="bl" aria-hidden="false"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="headerBookmarkButton" rel="noopener follow" href="/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fc78cb88b2cb1&amp;operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2F%40shakhat%2Fbuilding-a-network-topology-of-a-kubernetes-application-in-a-non-intrusive-way-c78cb88b2cb1&amp;source=-----c78cb88b2cb1---------------------bookmark_footer-----------"><svg width="25" height="25" viewBox="0 0 25 25" fill="none" class="dt lk" aria-label="Add to list bookmark button"><path d="M18 2.5a.5.5 0 0 1 1 0V5h2.5a.5.5 0 0 1 0 1H19v2.5a.5.5 0 1 1-1 0V6h-2.5a.5.5 0 0 1 0-1H18V2.5zM7 7a1 1 0 0 1 1-1h3.5a.5.5 0 0 0 0-1H8a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4V7z" fill="currentColor"></path></svg></a></span></div></div></div><div class="fc ll cm"><div class="l ae"><div class="ab ca"><div class="lm ln lo lp lq lr ch bg"><div class="ab"><div class="bl bg" aria-hidden="false"><div><div class="bl" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af fj ah ai aj ak al ls an ao ap ew lt lu lh lv lw lx ly lz s ma mb mc md me mf mg u mh mi mj"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path fill-rule="evenodd" clip-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0zm9-10a10 10 0 1 0 0 20 10 10 0 0 0 0-20zm3.38 10.42l-4.6 3.06a.5.5 0 0 1-.78-.41V8.93c0-.4.45-.63.78-.41l4.6 3.06c.3.2.3.64 0 .84z" fill="currentColor"></path></svg><div class="j i d"><p class="be b bf z dt">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bl" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bl" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af fj ah ai aj ak al ls an ao ap ew lt lu lh lv lw lx ly lz s ma mb mc md me mf mg u mh mi mj"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path fill-rule="evenodd" clip-rule="evenodd" d="M15.22 4.93a.42.42 0 0 1-.12.13h.01a.45.45 0 0 1-.29.08.52.52 0 0 1-.3-.13L12.5 3v7.07a.5.5 0 0 1-.5.5.5.5 0 0 1-.5-.5V3.02l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.8a.42.42 0 0 1 .07.5zm-.1.14zm.88 2h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11a2 2 0 0 1-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.14c.1.1.15.22.15.35a.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9V8.96c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1z" fill="currentColor"></path></svg><div class="j i d"><p class="be b bf z dt">Share</p></div></button></div></div></div></div></div></div></div></div></div><h1 id="64ec" class="mk ml gt be mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh bj">Intro</h1><p id="568b" class="pw-post-body-paragraph ni nj gt nk b nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe of gm bj">An application in Kubernetes is logically split into two distinct parts: one is a computational resource (represented by pods) and the other exposes access to the application (represented by services). Application clients can access it by an abstract name without taking care of what pods actually handle requests. And since a single service may have multiple pods as a backend, it also plays a role of a load-balancer. In the default Kubernetes deployments this load-balancing feature is implemented pretty simple using <em class="og">iptables</em> or <em class="og">Linux IPVS</em> — both work at L4 (e.g. TCP) and do a naïve random-based round-robin. Of course, cloud providers may also offer a more traditional load-balancing solutions to expose applications, but let’s start simple.</p><p id="553c" class="pw-post-body-paragraph ni nj gt nk b nl oh nn no np oi nr ns nt oj nv nw nx ok nz oa ob ol od oe of gm bj">When we think about issues that can occur in applications deployed in Kubernetes, there is one group that requires a knowledge of a specific instance that handles a client request. For example: (1) one of application pods is deployed at a host which has worse network connectivity and establishing of a new connection takes longer than for others, or (2) there is a pod which performance degrades over the time while of others stays constant or (3) there is a specific client which requests affect application performance. Distributed tracing is usually one of approaches to get insights into such issues and, obviously, to trace client requests to the backend application. Traditionally, the distributed tracing requires some sort of instrumentation — it can vary from manual code additions to a fully automatic injection into runtime. But can the same be achieved without any manipulations with client code at all?</p><p id="1864" class="pw-post-body-paragraph ni nj gt nk b nl oh nn no np oi nr ns nt oj nv nw nx ok nz oa ob ol od oe of gm bj">To debug the mentioned issues we basically need two features of a distributed tracing: (1) to collect metrics related to request latency and (2) to know exactly where every single request goes. The first feature can easily be implemented in a non-intrusive way by using one of large variety of tools powered by eBPF — a technology that allows to dynamically attach probes to kernel functions and, for example, to record which process establishes a new connection, get socket/connection related metrics, even check if there were retransmissions or evil connection resets. In <a class="af om" href="https://openeuler.org" rel="noopener ugc nofollow" target="_blank">openEuler</a> ecosystem such tool is <a class="af om" href="https://gitee.com/openeuler/gala-gopher/" rel="noopener ugc nofollow" target="_blank">gala-gopher</a> which offers a large collection of different probes, including socket, TCP and L7/HTTP(s) probes. However the second feature (knowing where a single request goes) is much harder to achieve. In distributed tracing frameworks it is implemented by injecting a span/trace id into application payload and then correlating observations with the same span id from both client and backend sides. Being a non-intrusive to application code would mean that the same information needs to be injected a generic way, but doing this into application protocols is not feasible at all as it would require to intercept outgoing traffic, parse it, inject id, serialize it back and forward. Looks like we just re-invented a service mesh!</p><p id="efec" class="pw-post-body-paragraph ni nj gt nk b nl oh nn no np oi nr ns nt oj nv nw nx ok nz oa ob ol od oe of gm bj">Before going further let’s first take a look at the data available from network monitoring. Here we assume that monitoring gets information from all nodes that host application pods and this data is then collected by e.g. Prometheus. In order to achieve this, we need some experiment environment.</p><h1 id="e37e" class="mk ml gt be mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh bj">Experiment environment</h1><p id="a1f2" class="pw-post-body-paragraph ni nj gt nk b nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe of gm bj">First of all, we need a deployed multi-node Kubernetes cluster. In Huawei Cloud the corresponding service is called <a class="af om" href="https://www.huaweicloud.com/intl/en-us/product/cce.html" rel="noopener ugc nofollow" target="_blank">Cloud Container Engine (CCE)</a>.</p><p id="1a4b" class="pw-post-body-paragraph ni nj gt nk b nl oh nn no np oi nr ns nt oj nv nw nx ok nz oa ob ol od oe of gm bj">Then we need a test application, for that purposes we will use a very simple <a class="af om" href="https://gist.github.com/shakhat/059cc629803bbfbbde0975aee64c936b.js" rel="noopener ugc nofollow" target="_blank">Python program</a> that accepts an HTTP request with ability to make outgoing HTTP requests to the address specified in the original request. That way we can chain applications easily.</p><p id="3e18" class="pw-post-body-paragraph ni nj gt nk b nl oh nn no np oi nr ns nt oj nv nw nx ok nz oa ob ol od oe of gm bj">The applications will be called by Latin letters, A, B, etc. Application A is deployed as Deployment A and Service A, and so on. The very first application is also exposed externally, so it can be called from the outside.</p><figure class="oq or os ot ou ov on oo paragraph-image"><div class="on oo op"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*9g2pQdW-TrZRxVKGAIUojQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*9g2pQdW-TrZRxVKGAIUojQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*9g2pQdW-TrZRxVKGAIUojQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*9g2pQdW-TrZRxVKGAIUojQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*9g2pQdW-TrZRxVKGAIUojQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*9g2pQdW-TrZRxVKGAIUojQ.png 1100w, https://miro.medium.com/v2/resize:fit:1078/format:webp/1*9g2pQdW-TrZRxVKGAIUojQ.png 1078w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 539px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*9g2pQdW-TrZRxVKGAIUojQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*9g2pQdW-TrZRxVKGAIUojQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*9g2pQdW-TrZRxVKGAIUojQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*9g2pQdW-TrZRxVKGAIUojQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*9g2pQdW-TrZRxVKGAIUojQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*9g2pQdW-TrZRxVKGAIUojQ.png 1100w, https://miro.medium.com/v2/resize:fit:1078/1*9g2pQdW-TrZRxVKGAIUojQ.png 1078w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 539px"/><img alt="" class="bg lr ow c" width="539" height="256" loading="lazy" role="presentation"/></picture></div><figcaption class="ox fe oy on oo oz pa be b bf z dt">A and B applications topology in Kubernetes</figcaption></figure><p id="5aaa" class="pw-post-body-paragraph ni nj gt nk b nl oh nn no np oi nr ns nt oj nv nw nx ok nz oa ob ol od oe of gm bj">Gala-gopher is deployed as a daemon set and runs on every Kubernetes node. It exposes metrics that are consumed by Prometheus and finally visualized with Grafana. Service topology is constructed based on metrics and visualized by <a class="af om" href="https://grafana.com/docs/plugins/yesoreyeram-infinity-datasource/latest/references/display-options/node-graph/" rel="noopener ugc nofollow" target="_blank">NodeGraph</a> plugin.</p><h1 id="9579" class="mk ml gt be mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh bj">Observations</h1><p id="683d" class="pw-post-body-paragraph ni nj gt nk b nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe of gm bj">Let’s send a few requests to the application A with forwarding to the application B like this:</p><pre class="oq or os ot ou pb pc pd bo pe ba bj"><span id="1de7" class="pf ml gt pc b bf pg ph l pi pj">[root@debug-7d8bdd568c-5jrmf /]# curl http://a.app:8000/b.app:8000<br/>..Hello from pod b-67b75c8557-698tr ip 10.0.0.76 at node 192.168.3.218<br/>Hello from pod a-7954c595f7-tmnx8 ip 10.0.0.148 at node 192.168.3.14<br/><br/>[root@debug-7d8bdd568c-5jrmf /]# curl http://a.app:8000/b.app:8000<br/>..Hello from pod b-67b75c8557-mzn6p ip 10.0.0.149 at node 192.168.3.14<br/>Hello from pod a-7954c595f7-tmnx8 ip 10.0.0.148 at node 192.168.3.14</span></pre><p id="d46c" class="pw-post-body-paragraph ni nj gt nk b nl oh nn no np oi nr ns nt oj nv nw nx ok nz oa ob ol od oe of gm bj">In the output we see that one of requests to the application B went to one pod and the other to the different. This is how the topology look in Grafana:</p><figure class="oq or os ot ou ov on oo paragraph-image"><div role="button" tabindex="0" class="pl pm fi pn bg po"><div class="on oo pk"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*kMpQWptLhyGjsXagdEBJRg.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*kMpQWptLhyGjsXagdEBJRg.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*kMpQWptLhyGjsXagdEBJRg.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*kMpQWptLhyGjsXagdEBJRg.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*kMpQWptLhyGjsXagdEBJRg.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*kMpQWptLhyGjsXagdEBJRg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kMpQWptLhyGjsXagdEBJRg.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*kMpQWptLhyGjsXagdEBJRg.png 640w, https://miro.medium.com/v2/resize:fit:720/1*kMpQWptLhyGjsXagdEBJRg.png 720w, https://miro.medium.com/v2/resize:fit:750/1*kMpQWptLhyGjsXagdEBJRg.png 750w, https://miro.medium.com/v2/resize:fit:786/1*kMpQWptLhyGjsXagdEBJRg.png 786w, https://miro.medium.com/v2/resize:fit:828/1*kMpQWptLhyGjsXagdEBJRg.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*kMpQWptLhyGjsXagdEBJRg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*kMpQWptLhyGjsXagdEBJRg.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bg lr ow c" width="700" height="517" loading="lazy" role="presentation"/></picture></div></div><figcaption class="ox fe oy on oo oz pa be b bf z dt">A and B application topology as reconstructed from metrics</figcaption></figure><p id="7df6" class="pw-post-body-paragraph ni nj gt nk b nl oh nn no np oi nr ns nt oj nv nw nx ok nz oa ob ol od oe of gm bj">The top and the middle rows show that something sent requests to pods of application B and the bottom part shows that a pod of A sent a request to a virtual IP of a service B. But this doesn’t look like what we expected at all, right? We only see three groups of nodes and they don’t link to each other. IP addresses from 192.168.3.0/24 subnet are node addresses from cluster private network (VPC), 10.0.0.1/24 are addresses of pods except 10.0.0.129 which is again a node address for intra-node communications.</p><p id="1921" class="pw-post-body-paragraph ni nj gt nk b nl oh nn no np oi nr ns nt oj nv nw nx ok nz oa ob ol od oe of gm bj">Now these metrics are collected at socket level, meaning that they are exactly what application processes can see. The collection is done by eBPF probes, so the first idea would be to check if OS kernel knows a bit more about application connections than is available in the sockets. The cluster is configured with the default CNI and Kubernetes services are implemented as iptables rules. Output of iptables-save reveals the configuration. Most interesting are these lines that actually configure load balancing:</p><pre class="oq or os ot ou pb pc pd bo pe ba bj"><span id="c30a" class="pf ml gt pc b bf pg ph l pi pj">-A KUBE-SERVICES -d 10.247.204.240/32 -p tcp -m comment <br/>   --comment &quot;app/b:http-port cluster IP&quot; -m tcp --dport 8000 -j KUBE-SVC-CELO6J2CXNI7KVVA<br/>-A KUBE-SVC-CELO6J2CXNI7KVVA -d 10.247.204.240/32 -p tcp -m comment <br/>   --comment &quot;app/b:http-port cluster IP&quot; -m tcp --dport 8000 -j KUBE-MARK-MASQ<br/>-A KUBE-SVC-CELO6J2CXNI7KVVA -m comment --comment &quot;app/b:http-port -&gt; 10.0.0.155:8000&quot; <br/>   -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-VFBYZLZKPEFJ3QIZ<br/>-A KUBE-SVC-CELO6J2CXNI7KVVA -m comment --comment &quot;app/b:http-port -&gt; 10.0.0.76:8000&quot; <br/>   -j KUBE-SEP-SXF6FD423VYX6VFB</span></pre><p id="c362" class="pw-post-body-paragraph ni nj gt nk b nl oh nn no np oi nr ns nt oj nv nw nx ok nz oa ob ol od oe of gm bj">Load balancing is done on the same node where the client is. So if we map pods to nodes this looks like this:</p><figure class="oq or os ot ou ov on oo paragraph-image"><div class="on oo pp"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*DUoAySaau2XK-H50JMQ3xQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*DUoAySaau2XK-H50JMQ3xQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*DUoAySaau2XK-H50JMQ3xQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*DUoAySaau2XK-H50JMQ3xQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*DUoAySaau2XK-H50JMQ3xQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*DUoAySaau2XK-H50JMQ3xQ.png 1100w, https://miro.medium.com/v2/resize:fit:920/format:webp/1*DUoAySaau2XK-H50JMQ3xQ.png 920w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 460px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*DUoAySaau2XK-H50JMQ3xQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*DUoAySaau2XK-H50JMQ3xQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*DUoAySaau2XK-H50JMQ3xQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*DUoAySaau2XK-H50JMQ3xQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*DUoAySaau2XK-H50JMQ3xQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*DUoAySaau2XK-H50JMQ3xQ.png 1100w, https://miro.medium.com/v2/resize:fit:920/1*DUoAySaau2XK-H50JMQ3xQ.png 920w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 460px"/><img alt="" class="bg lr ow c" width="460" height="283" loading="lazy" role="presentation"/></picture></div><figcaption class="ox fe oy on oo oz pa be b bf z dt">A and B application topology mapped to Kubernetes nodes</figcaption></figure><p id="0e94" class="pw-post-body-paragraph ni nj gt nk b nl oh nn no np oi nr ns nt oj nv nw nx ok nz oa ob ol od oe of gm bj">Internally iptables (actually <a class="af om" href="https://wiki.nftables.org/wiki-nftables/index.php/What_is_nftables%3F" rel="noopener ugc nofollow" target="_blank">nftables</a>) use conntrack module to understand that packets belong to the same connection and should be processed similar. Conntrack is also responsible for address translation, so the node with the client application should know where to send packets to. Let’s check this with conntrack CLI tool.</p><pre class="oq or os ot ou pb pc pd bo pe ba bj"><span id="345c" class="pf ml gt pc b bf pg ph l pi pj"># node-1<br/># conntrack -L | grep 8000<br/>tcp      6 82 TIME_WAIT src=10.0.0.164 dst=10.247.204.240 sport=51030 dport=8000 src=10.0.0.76 dst=192.168.3.14 sport=8000 dport=19554 [ASSURED] use=1<br/>tcp      6 79 TIME_WAIT src=10.0.0.164 dst=10.247.204.240 sport=51014 dport=8000 src=10.0.0.155 dst=10.0.0.129 sport=8000 dport=56734 [ASSURED] use=1<br/><br/># node-2<br/># conntrack -L | grep 8000<br/>tcp      6 249 CLOSE_WAIT src=10.0.0.76 dst=192.168.3.14 sport=8000 dport=19554 [UNREPLIED] src=192.168.3.14 dst=10.0.0.76 sport=19554 dport=8000 use=1</span></pre><p id="73d8" class="pw-post-body-paragraph ni nj gt nk b nl oh nn no np oi nr ns nt oj nv nw nx ok nz oa ob ol od oe of gm bj">Ok, we see that on the first node the address was translated from pod of application A and got address of node with some random port. At the second node the connection information is reversed because its own packets are actually a reply, but taking this into account we see that the request came from the first node and the same random port. <em class="og">Note that there are 2 requests at Node-1 because we sent 2 requests and they were handled by different pods: pod-b-1 at the same node and pod-b-2 at the other.</em></p><p id="aab9" class="pw-post-body-paragraph ni nj gt nk b nl oh nn no np oi nr ns nt oj nv nw nx ok nz oa ob ol od oe of gm bj">Good news here is that it is <em class="og">possible</em> to know the actual request recipient right at the client node, but for a server side it requires <em class="og">correlation</em> with the information collected at the client node. Like this:</p><figure class="oq or os ot ou ov on oo paragraph-image"><div class="on oo pq"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*KGVuOsLS8sDGrDalwlNciQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*KGVuOsLS8sDGrDalwlNciQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*KGVuOsLS8sDGrDalwlNciQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*KGVuOsLS8sDGrDalwlNciQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*KGVuOsLS8sDGrDalwlNciQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*KGVuOsLS8sDGrDalwlNciQ.png 1100w, https://miro.medium.com/v2/resize:fit:970/format:webp/1*KGVuOsLS8sDGrDalwlNciQ.png 970w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 485px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*KGVuOsLS8sDGrDalwlNciQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*KGVuOsLS8sDGrDalwlNciQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*KGVuOsLS8sDGrDalwlNciQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*KGVuOsLS8sDGrDalwlNciQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*KGVuOsLS8sDGrDalwlNciQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*KGVuOsLS8sDGrDalwlNciQ.png 1100w, https://miro.medium.com/v2/resize:fit:970/1*KGVuOsLS8sDGrDalwlNciQ.png 970w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 485px"/><img alt="" class="bg lr ow c" width="485" height="391" loading="lazy" role="presentation"/></picture></div><figcaption class="ox fe oy on oo oz pa be b bf z dt">Connections as tracked by conntrack module. Blue circles are local addresses as observed in sockets, violet are remote. The challenge is to correlate violet to blue.</figcaption></figure><p id="629e" class="pw-post-body-paragraph ni nj gt nk b nl oh nn no np oi nr ns nt oj nv nw nx ok nz oa ob ol od oe of gm bj">When both client and server pods are at the same node the correlation becomes even more simple, but still with some assumptions regarding which addresses are true and which should be ignored:</p><figure class="oq or os ot ou ov on oo paragraph-image"><div class="on oo pr"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*iiHSVPkHKfBnhaa2yKRoLQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*iiHSVPkHKfBnhaa2yKRoLQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*iiHSVPkHKfBnhaa2yKRoLQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*iiHSVPkHKfBnhaa2yKRoLQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*iiHSVPkHKfBnhaa2yKRoLQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*iiHSVPkHKfBnhaa2yKRoLQ.png 1100w, https://miro.medium.com/v2/resize:fit:980/format:webp/1*iiHSVPkHKfBnhaa2yKRoLQ.png 980w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 490px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*iiHSVPkHKfBnhaa2yKRoLQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*iiHSVPkHKfBnhaa2yKRoLQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*iiHSVPkHKfBnhaa2yKRoLQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*iiHSVPkHKfBnhaa2yKRoLQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*iiHSVPkHKfBnhaa2yKRoLQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*iiHSVPkHKfBnhaa2yKRoLQ.png 1100w, https://miro.medium.com/v2/resize:fit:980/1*iiHSVPkHKfBnhaa2yKRoLQ.png 980w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 490px"/><img alt="" class="bg lr ow c" width="490" height="210" loading="lazy" role="presentation"/></picture></div><figcaption class="ox fe oy on oo oz pa be b bf z dt">Connection between 2 pods located at the same node. Source addresses are true while destination ones need to be mapped</figcaption></figure><p id="e5e1" class="pw-post-body-paragraph ni nj gt nk b nl oh nn no np oi nr ns nt oj nv nw nx ok nz oa ob ol od oe of gm bj">Here OS has full view on NAT and can provide mapping between the real source and the real destination. It is <em class="og">possible</em> to reconstruct a full flow from 10.0.0.164 to 10.0.0.155.</p><p id="fc94" class="pw-post-body-paragraph ni nj gt nk b nl oh nn no np oi nr ns nt oj nv nw nx ok nz oa ob ol od oe of gm bj">To conclude this section, it should be possible to extend existing eBPF probe to include information from conntrack module about address translation. It is possible for a client to know where the request goes. But it is not always possible for a server to know who was the client <em class="og">directly without a centralized correlation</em> algorithm. To contrast, the distributed tracing approach gives both client and server information about peer <strong class="nk gu">directly and immediately</strong> from the communication data. So comes the FlowTracer!</p><h1 id="c152" class="mk ml gt be mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh bj"><strong class="al">The FlowTracer</strong></h1><p id="2edc" class="pw-post-body-paragraph ni nj gt nk b nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe of gm bj">The idea is simple — to transfer data between peers right in the connection. It is not the first time such feature is needed, for example, HTTP load balancers insert X-Forwarded-For HTTP header to let back-end server know the client. The restriction here is that we want to stay at L4 and thus support any application level protocol. Such feature exists too and some L4 load balancers (e.g. <a class="af om" href="https://www.tencentcloud.com/document/product/608/14429" rel="noopener ugc nofollow" target="_blank">this</a>) can inject original address as TCP header option and make it available to the server.</p><p id="396c" class="pw-post-body-paragraph ni nj gt nk b nl oh nn no np oi nr ns nt oj nv nw nx ok nz oa ob ol od oe of gm bj">To sum up the requirements:</p><ol class=""><li id="0caa" class="ni nj gt nk b nl oh nn no np oi nr ns nt oj nv nw nx ok nz oa ob ol od oe of ps pt pu bj">Transfer peer address at L4.</li><li id="8c3e" class="ni nj gt nk b nl pv nn no np pw nr ns nt px nv nw nx py nz oa ob pz od oe of ps pt pu bj">Be able to enable address injection dynamically (as easy as to deploy app in K8s).</li><li id="954f" class="ni nj gt nk b nl pv nn no np pw nr ns nt px nv nw nx py nz oa ob pz od oe of ps pt pu bj">Non-intrusive and fast.</li></ol><p id="4b64" class="pw-post-body-paragraph ni nj gt nk b nl oh nn no np oi nr ns nt oj nv nw nx ok nz oa ob ol od oe of gm bj">The most straight-forward approach seems to use a TCP header option (also known as TOA). The payload is IP address and port number (since they change during address translation). We can restrict to support IPv4 only since Huawei Kubernetes deployment supports only it. IPv4 address is 32 bits, plus we need 16 bits for a port number, in total this gives 6 bytes plus 1 byte for option kind and one more byte for option length. Here’s how a TCP header looks in <a class="af om" href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol" rel="noopener ugc nofollow" target="_blank">spec</a>:</p><figure class="oq or os ot ou ov on oo paragraph-image"><div role="button" tabindex="0" class="pl pm fi pn bg po"><div class="on oo qa"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*5qFdrO9_Yyk_YTqk5w0IcA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*5qFdrO9_Yyk_YTqk5w0IcA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*5qFdrO9_Yyk_YTqk5w0IcA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*5qFdrO9_Yyk_YTqk5w0IcA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*5qFdrO9_Yyk_YTqk5w0IcA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*5qFdrO9_Yyk_YTqk5w0IcA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5qFdrO9_Yyk_YTqk5w0IcA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*5qFdrO9_Yyk_YTqk5w0IcA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*5qFdrO9_Yyk_YTqk5w0IcA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*5qFdrO9_Yyk_YTqk5w0IcA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*5qFdrO9_Yyk_YTqk5w0IcA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*5qFdrO9_Yyk_YTqk5w0IcA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*5qFdrO9_Yyk_YTqk5w0IcA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*5qFdrO9_Yyk_YTqk5w0IcA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bg lr ow c" width="700" height="282" loading="lazy" role="presentation"/></picture></div></div></figure><p id="3e8e" class="pw-post-body-paragraph ni nj gt nk b nl oh nn no np oi nr ns nt oj nv nw nx ok nz oa ob ol od oe of gm bj">The header may contain multiple options of up to 40 bytes in total. Each option can have variable length and a type / kind.</p><figure class="oq or os ot ou ov on oo paragraph-image"><div role="button" tabindex="0" class="pl pm fi pn bg po"><div class="on oo qb"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*MJ_dpcekRR6fh3qum0M4dA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*MJ_dpcekRR6fh3qum0M4dA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*MJ_dpcekRR6fh3qum0M4dA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*MJ_dpcekRR6fh3qum0M4dA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*MJ_dpcekRR6fh3qum0M4dA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*MJ_dpcekRR6fh3qum0M4dA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MJ_dpcekRR6fh3qum0M4dA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*MJ_dpcekRR6fh3qum0M4dA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*MJ_dpcekRR6fh3qum0M4dA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*MJ_dpcekRR6fh3qum0M4dA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*MJ_dpcekRR6fh3qum0M4dA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*MJ_dpcekRR6fh3qum0M4dA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*MJ_dpcekRR6fh3qum0M4dA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*MJ_dpcekRR6fh3qum0M4dA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bg lr ow c" width="700" height="157" loading="lazy" role="presentation"/></picture></div></div></figure><p id="94f7" class="pw-post-body-paragraph ni nj gt nk b nl oh nn no np oi nr ns nt oj nv nw nx ok nz oa ob ol od oe of gm bj">Normally Linux TCP packets already have some options like MSS or Timestamp. But there’s still a room of approximately 20 bytes that can be used for our purposes.</p><p id="a7f0" class="pw-post-body-paragraph ni nj gt nk b nl oh nn no np oi nr ns nt oj nv nw nx ok nz oa ob ol od oe of gm bj">Now when we know where to put the data the next question is where should the code be added? We want the solution to be as much generic as possible and work for any TCP connection. The ideal place is somewhere in the kernel in the network stack operating over a so-called socket buffer — a structure that represents network connection information — available from the top level down to the packets ready to be transferred over the network. From the implementation point-of-view the code should be an eBPF code (of course!), then address injection feature can be dynamically enabled.</p><p id="c0ae" class="pw-post-body-paragraph ni nj gt nk b nl oh nn no np oi nr ns nt oj nv nw nx ok nz oa ob ol od oe of gm bj">The most obvious place for such code is TC, a traffic control module. There an eBPF program has access to already created packets, it can read and write data from packets. One of <em class="og">disadvantages</em> is the need to parse packet from scratch, i.e. even <a class="af om" href="https://ebpf-docs.dylanreimerink.nl/linux/helper-function/bpf_skb_load_bytes_relative/" rel="noopener ugc nofollow" target="_blank"><em class="og">bpf_skb_load_bytes_relative</em></a> function provides a pointer to the beginning of L3 header, but the location of L4 still needs to be calculated manually. The most problematic though is inserting operation. There are 2 functions with promising names <a class="af om" href="https://ebpf-docs.dylanreimerink.nl/linux/helper-function/bpf_skb_adjust_room/" rel="noopener ugc nofollow" target="_blank">bpf_skb_adjust_room</a> and <a class="af om" href="https://ebpf-docs.dylanreimerink.nl/linux/helper-function/bpf_skb_change_tail/" rel="noopener ugc nofollow" target="_blank">bpf_skb_change_tail</a>, but they allow to resize at most L3 packet and not L4. An alternative solution would be to check if existing TCP header contains some options and overwrite them, but let’s first check what an usual packet contains.</p><pre class="oq or os ot ou pb pc pd bo pe ba bj"><span id="5f70" class="pf ml gt pc b bf pg ph l pi pj">1514772378.301862 IP (tos 0x0, ttl 64, id 20960, offset 0, flags [DF], proto TCP (6), length 60)<br/>    192.168.3.14.28301 &gt; 10.0.0.76.8000: Flags [S], cksum 0xbc03 (correct), seq 1849406961, win 64240, options [mss 1460,sackOK,TS val 142477455 ecr 0,nop,wscale 9], length 0<br/>        0x0000:  0000 0001 0006 fa16 3e22 3096 0000 0800  ........&gt;&quot;0.....<br/>        0x0010:  4500 003c 51e0 4000 4006 1ada c0a8 030e  E..&lt;Q.@.@.......<br/>        0x0020:  0a00 004c 6e8d 1f40 6e3b b5f1 0000 0000  ...Ln..@n;......<br/>        0x0030:  a002 faf0 bc03 0000 0204 05b4 0402 080a  ................<br/>        0x0040:  087e 088f 0000 0000 0103 0309            .~..........</span></pre><p id="aa84" class="pw-post-body-paragraph ni nj gt nk b nl oh nn no np oi nr ns nt oj nv nw nx ok nz oa ob ol od oe of gm bj">This is a TCP SYN packet sent when the client establishes connection with the back-end application. The header contains multiple options: MSS used to specify maximum segment size, then selective acknowledgement, a Timestamp used in particular to ensure order of packets, a no-operation NOP probably used for word alignment and finally window scale used to tune window size. From this list the Timestamp option is the best candidate to be overwritten (the adoption is still ~40% according to Wikipedia) and that is what DeepFlow — one of leaders of non-intrusive eBPF tracing — does in their <a class="af om" href="https://zhuanlan.zhihu.com/p/641197123" rel="noopener ugc nofollow" target="_blank">platform</a>.</p><p id="4273" class="pw-post-body-paragraph ni nj gt nk b nl oh nn no np oi nr ns nt oj nv nw nx ok nz oa ob ol od oe of gm bj">While this approach seems to be working it is still not a trivial to implement. TC program has access to an already translated address, meaning that the translation mapping should be somehow retrieved from conntrack module and stored. TC program is attached to network cards, so if a node has multiple of them then the deployment needs to correctly identify where to attach. The reading module will have to parse all packets in order to find TCP and then to iterate over headers to find where our header is. Is there another way?</p><p id="9f5b" class="pw-post-body-paragraph ni nj gt nk b nl oh nn no np oi nr ns nt oj nv nw nx ok nz oa ob ol od oe of gm bj">While googling this question in August 2023, it was quite often to get to the bottom of a search result page telling no more results (hope this will change with this blog post!) The most useful reference was a link to a patch into Linux Kernel made by Facebook engineers back in 2020. This <a class="af om" href="https://lore.kernel.org/netdev/20200626175501.1459961-1-kafai@fb.com/" rel="noopener ugc nofollow" target="_blank">patch</a> reveals what we were searching for:</p><blockquote class="qc qd qe"><p id="d630" class="ni nj og nk b nl oh nn no np oi nr ns nt oj nv nw nx ok nz oa ob ol od oe of gm bj">The earlier effort in BPF-TCP-CC allows the TCP Congestion Control<br/>algorithm to be written in BPF. It opens up opportunities to allow<br/>a faster turnaround time in testing/releasing new congestion control<br/>ideas to production environment.<br/><br/>The same flexibility can be extended to writing TCP header option.<br/>It is not uncommon that people want to test new TCP header option<br/>to improve the TCP performance. Another use case is for data-center<br/>that has a more controlled environment and has more flexibility in<br/>putting header options for internal traffic only.</p></blockquote><p id="ce57" class="pw-post-body-paragraph ni nj gt nk b nl oh nn no np oi nr ns nt oj nv nw nx ok nz oa ob ol od oe of gm bj">And the grail are these functions: <a class="af om" href="https://ebpf-docs.dylanreimerink.nl/linux/helper-function/bpf_store_hdr_opt/" rel="noopener ugc nofollow" target="_blank"><em class="og">bpf_store_hdr_opt</em></a> and <a class="af om" href="https://ebpf-docs.dylanreimerink.nl/linux/helper-function/bpf_load_hdr_opt/" rel="noopener ugc nofollow" target="_blank">bpf_load_hdr_opt</a>! Both belong to a special type of <a class="af om" href="https://ebpf-docs.dylanreimerink.nl/linux/program-type/BPF_PROG_TYPE_SOCK_OPS/" rel="noopener ugc nofollow" target="_blank">sock ops</a> programs, both are available since kernel 5.10 meaning almost any distro after the year 2022. A sock ops program is a single function attached to cgroup v2, which allows to enable it only for some sockets (e.g. belonging to a specific container). The program receives a single operation, which is used to indicate current state of a socket. When we want to write a new header option we first need to enable writing for active or passive connections, then we need to tell the length of a new header and only then to write header payload. Reading is simpler, but too, we need to enable reading feature first and then to read the header option. TCP header callbacks are called when TCP packet is created. This happens <em class="og">before address translation</em>, so we can just copy socket source address into a header option. The reader can easily extract value from a header option and store in BPF map so later the consumer can read and map from the observed remote address to the real one. The BPF part of the first running code is well under 100 lines. Quite impressive!</p><h2 id="c9f5" class="qf ml gt be mm qg qh dx mq qi qj dz mu nt qk ql qm nx qn qo qp ob qq qr qs qt bj">Making the code production-ready</h2><p id="d176" class="pw-post-body-paragraph ni nj gt nk b nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe of gm bj">The evil is in details though. First of all, we need a way to delete old records from BPF map. The best time to do this is when conntrack module removes connection from its table. This <a class="af om" href="http://arthurchiao.art/blog/conntrack-design-and-implementation/" rel="noopener ugc nofollow" target="_blank">post</a> from Arthur Chiao describes very well the internals of conntrack module and connection life cycle, so it is easy to find the right function in kernel sources — <em class="og">nf_conntrack_destroy</em>. This function receives a conntrack entry right before it is removed from the internal table. And since this is the time when a connection officially ended we can also add a probe that will remove the connection from our mapping table too.</p><p id="6bcc" class="pw-post-body-paragraph ni nj gt nk b nl oh nn no np oi nr ns nt oj nv nw nx ok nz oa ob ol od oe of gm bj">In sock ops program we do not specify into which packets to inject a new header option assuming it to work for all packets. And in fact it is, but reading works only when a connection is in established/confirmed state, meaning that a server side cannot read header option from an incoming SYN packet. SYN-ACKs are also handled before a regular TCP stack and it is not possible neither to inject header options, nor to read them. Effectively the feature works on both ends only when a connection fully operational with the first PSH (data packet). This is absolutely fine for working connections, but if connection attempt fails, then the client doesn’t know where it <em class="og">tried</em> to connect. This is quite a crucial miss; this information would be useful to debug network failures. As we learned, the Kubernetes load balancing is implemented at a client node, so we can extract information from conntrack and store it in the same format as data received through a flow. Conntrack function <em class="og">__nf_conntrack_confirm</em> is here to help — it is called when a new connection is about to be confirmed, for active client (outgoing) TCP connections this happens right with the first sent SYN packet.</p><p id="f74b" class="pw-post-body-paragraph ni nj gt nk b nl oh nn no np oi nr ns nt oj nv nw nx ok nz oa ob ol od oe of gm bj">With all these additions the code becomes a bit fatter, but still well under 1000 lines in total. Full patch is available in <a class="af om" href="https://gitee.com/openeuler/gala-gopher/pulls/778" rel="noopener ugc nofollow" target="_blank">this MR</a>. Time to enable it in our experimental setup and check metrics and topology again!</p><p id="1ce9" class="pw-post-body-paragraph ni nj gt nk b nl oh nn no np oi nr ns nt oj nv nw nx ok nz oa ob ol od oe of gm bj">Et voilà:</p><figure class="oq or os ot ou ov on oo paragraph-image"><div role="button" tabindex="0" class="pl pm fi pn bg po"><div class="on oo qu"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*TyNE36F-CrXkMx6ru9aWew.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*TyNE36F-CrXkMx6ru9aWew.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*TyNE36F-CrXkMx6ru9aWew.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*TyNE36F-CrXkMx6ru9aWew.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*TyNE36F-CrXkMx6ru9aWew.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*TyNE36F-CrXkMx6ru9aWew.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TyNE36F-CrXkMx6ru9aWew.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*TyNE36F-CrXkMx6ru9aWew.png 640w, https://miro.medium.com/v2/resize:fit:720/1*TyNE36F-CrXkMx6ru9aWew.png 720w, https://miro.medium.com/v2/resize:fit:750/1*TyNE36F-CrXkMx6ru9aWew.png 750w, https://miro.medium.com/v2/resize:fit:786/1*TyNE36F-CrXkMx6ru9aWew.png 786w, https://miro.medium.com/v2/resize:fit:828/1*TyNE36F-CrXkMx6ru9aWew.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*TyNE36F-CrXkMx6ru9aWew.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*TyNE36F-CrXkMx6ru9aWew.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bg lr ow c" width="700" height="454" loading="lazy" role="presentation"/></picture></div></div><figcaption class="ox fe oy on oo oz pa be b bf z dt">A and B application topology made right</figcaption></figure></div></div></div></div></section></div></div></article><div class="ab ca"><div class="ch bg fy fz ga gb"></div></div></div><div class="ab ca"><div class="ch bg fy fz ga gb"><div class="qv qw ab iz"><div class="qx ab"><a class="qy ax am ao" rel="noopener follow" href="/tag/kubernetes?source=post_page-----c78cb88b2cb1---------------kubernetes-----------------"><div class="qz fi cw ra gd rb rc be b bf z bj rd">Kubernetes</div></a></div><div class="qx ab"><a class="qy ax am ao" rel="noopener follow" href="/tag/ebpf?source=post_page-----c78cb88b2cb1---------------ebpf-----------------"><div class="qz fi cw ra gd rb rc be b bf z bj rd">Ebpf</div></a></div><div class="qx ab"><a class="qy ax am ao" rel="noopener follow" href="/tag/distributed-tracing?source=post_page-----c78cb88b2cb1---------------distributed_tracing-----------------"><div class="qz fi cw ra gd rb rc be b bf z bj rd">Distributed Tracing</div></a></div></div></div></div><div class="l"></div><footer class="re rf rg rh ri rj rk rl rm ab q rn ro c"><div class="l ae"><div class="ab ca"><div class="ch bg fy fz ga gb"><div class="ab co rp"><div class="ab q ki"><div class="rq l"><span class="l rr rs rt e d"><div class="ab q ki kj"><div class="pw-multi-vote-icon fi kk kl km kn"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="footerClapButton" rel="noopener follow" href="/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Fp%2Fc78cb88b2cb1&amp;operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2F%40shakhat%2Fbuilding-a-network-topology-of-a-kubernetes-application-in-a-non-intrusive-way-c78cb88b2cb1&amp;user=Ilya+Shakhat&amp;userId=7766bf7322ef&amp;source=-----c78cb88b2cb1---------------------clap_footer-----------"><div><div class="bl" aria-hidden="false"><div class="ko ao kp kq kr ks am kt ku kv kn"><svg width="24" height="24" viewBox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" clip-rule="evenodd" d="M11.37.83L12 3.28l.63-2.45h-1.26zM13.92 3.95l1.52-2.1-1.18-.4-.34 2.5zM8.59 1.84l1.52 2.11-.34-2.5-1.18.4zM18.52 18.92a4.23 4.23 0 0 1-2.62 1.33l.41-.37c2.39-2.4 2.86-4.95 1.4-7.63l-.91-1.6-.8-1.67c-.25-.56-.19-.98.21-1.29a.7.7 0 0 1 .55-.13c.28.05.54.23.72.5l2.37 4.16c.97 1.62 1.14 4.23-1.33 6.7zm-11-.44l-4.15-4.15a.83.83 0 0 1 1.17-1.17l2.16 2.16a.37.37 0 0 0 .51-.52l-2.15-2.16L3.6 11.2a.83.83 0 0 1 1.17-1.17l3.43 3.44a.36.36 0 0 0 .52 0 .36.36 0 0 0 0-.52L5.29 9.51l-.97-.97a.83.83 0 0 1 0-1.16.84.84 0 0 1 1.17 0l.97.97 3.44 3.43a.36.36 0 0 0 .51 0 .37.37 0 0 0 0-.52L6.98 7.83a.82.82 0 0 1-.18-.9.82.82 0 0 1 .76-.51c.22 0 .43.09.58.24l5.8 5.79a.37.37 0 0 0 .58-.42L13.4 9.67c-.26-.56-.2-.98.2-1.29a.7.7 0 0 1 .55-.13c.28.05.55.23.73.5l2.2 3.86c1.3 2.38.87 4.59-1.29 6.75a4.65 4.65 0 0 1-4.19 1.37 7.73 7.73 0 0 1-4.07-2.25zm3.23-12.5l2.12 2.11c-.41.5-.47 1.17-.13 1.9l.22.46-3.52-3.53a.81.81 0 0 1-.1-.36c0-.23.09-.43.24-.59a.85.85 0 0 1 1.17 0zm7.36 1.7a1.86 1.86 0 0 0-1.23-.84 1.44 1.44 0 0 0-1.12.27c-.3.24-.5.55-.58.89-.25-.25-.57-.4-.91-.47-.28-.04-.56 0-.82.1l-2.18-2.18a1.56 1.56 0 0 0-2.2 0c-.2.2-.33.44-.4.7a1.56 1.56 0 0 0-2.63.75 1.6 1.6 0 0 0-2.23-.04 1.56 1.56 0 0 0 0 2.2c-.24.1-.5.24-.72.45a1.56 1.56 0 0 0 0 2.2l.52.52a1.56 1.56 0 0 0-.75 2.61L7 19a8.46 8.46 0 0 0 4.48 2.45 5.18 5.18 0 0 0 3.36-.5 4.89 4.89 0 0 0 4.2-1.51c2.75-2.77 2.54-5.74 1.43-7.59L18.1 7.68z"></path></svg></div></div></div></a></span></div><div class="pw-multi-vote-count l kw kx ky kz la lb lc"><p class="be b du z dt"><span class="ld">--</span></p></div></div></span><span class="l h g f ru rv"><div class="ab q ki kj"><div class="pw-multi-vote-icon fi kk kl km kn"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="footerClapButton" rel="noopener follow" href="/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Fp%2Fc78cb88b2cb1&amp;operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2F%40shakhat%2Fbuilding-a-network-topology-of-a-kubernetes-application-in-a-non-intrusive-way-c78cb88b2cb1&amp;user=Ilya+Shakhat&amp;userId=7766bf7322ef&amp;source=-----c78cb88b2cb1---------------------clap_footer-----------"><div><div class="bl" aria-hidden="false"><div class="ko ao kp kq kr ks am kt ku kv kn"><svg width="24" height="24" viewBox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" clip-rule="evenodd" d="M11.37.83L12 3.28l.63-2.45h-1.26zM13.92 3.95l1.52-2.1-1.18-.4-.34 2.5zM8.59 1.84l1.52 2.11-.34-2.5-1.18.4zM18.52 18.92a4.23 4.23 0 0 1-2.62 1.33l.41-.37c2.39-2.4 2.86-4.95 1.4-7.63l-.91-1.6-.8-1.67c-.25-.56-.19-.98.21-1.29a.7.7 0 0 1 .55-.13c.28.05.54.23.72.5l2.37 4.16c.97 1.62 1.14 4.23-1.33 6.7zm-11-.44l-4.15-4.15a.83.83 0 0 1 1.17-1.17l2.16 2.16a.37.37 0 0 0 .51-.52l-2.15-2.16L3.6 11.2a.83.83 0 0 1 1.17-1.17l3.43 3.44a.36.36 0 0 0 .52 0 .36.36 0 0 0 0-.52L5.29 9.51l-.97-.97a.83.83 0 0 1 0-1.16.84.84 0 0 1 1.17 0l.97.97 3.44 3.43a.36.36 0 0 0 .51 0 .37.37 0 0 0 0-.52L6.98 7.83a.82.82 0 0 1-.18-.9.82.82 0 0 1 .76-.51c.22 0 .43.09.58.24l5.8 5.79a.37.37 0 0 0 .58-.42L13.4 9.67c-.26-.56-.2-.98.2-1.29a.7.7 0 0 1 .55-.13c.28.05.55.23.73.5l2.2 3.86c1.3 2.38.87 4.59-1.29 6.75a4.65 4.65 0 0 1-4.19 1.37 7.73 7.73 0 0 1-4.07-2.25zm3.23-12.5l2.12 2.11c-.41.5-.47 1.17-.13 1.9l.22.46-3.52-3.53a.81.81 0 0 1-.1-.36c0-.23.09-.43.24-.59a.85.85 0 0 1 1.17 0zm7.36 1.7a1.86 1.86 0 0 0-1.23-.84 1.44 1.44 0 0 0-1.12.27c-.3.24-.5.55-.58.89-.25-.25-.57-.4-.91-.47-.28-.04-.56 0-.82.1l-2.18-2.18a1.56 1.56 0 0 0-2.2 0c-.2.2-.33.44-.4.7a1.56 1.56 0 0 0-2.63.75 1.6 1.6 0 0 0-2.23-.04 1.56 1.56 0 0 0 0 2.2c-.24.1-.5.24-.72.45a1.56 1.56 0 0 0 0 2.2l.52.52a1.56 1.56 0 0 0-.75 2.61L7 19a8.46 8.46 0 0 0 4.48 2.45 5.18 5.18 0 0 0 3.36-.5 4.89 4.89 0 0 0 4.2-1.51c2.75-2.77 2.54-5.74 1.43-7.59L18.1 7.68z"></path></svg></div></div></div></a></span></div><div class="pw-multi-vote-count l kw kx ky kz la lb lc"><p class="be b du z dt"><span class="ld">--</span></p></div></div></span></div><div class="bp ab"><div><div class="bl" aria-hidden="false"><button class="ao ko le lf ab q fj lg lh" aria-label="responses"><svg width="24" height="24" viewBox="0 0 24 24" class="li"><path d="M18 16.8a7.14 7.14 0 0 0 2.24-5.32c0-4.12-3.53-7.48-8.05-7.48C7.67 4 4 7.36 4 11.48c0 4.13 3.67 7.48 8.2 7.48a8.9 8.9 0 0 0 2.38-.32c.23.2.48.39.75.56 1.06.69 2.2 1.04 3.4 1.04.22 0 .4-.11.48-.29a.5.5 0 0 0-.04-.52 6.4 6.4 0 0 1-1.16-2.65v.02zm-3.12 1.06l-.06-.22-.32.1a8 8 0 0 1-2.3.33c-4.03 0-7.3-2.96-7.3-6.59S8.17 4.9 12.2 4.9c4 0 7.1 2.96 7.1 6.6 0 1.8-.6 3.47-2.02 4.72l-.2.16v.26l.02.3a6.74 6.74 0 0 0 .88 2.4 5.27 5.27 0 0 1-2.17-.86c-.28-.17-.72-.38-.94-.59l.01-.02z"></path></svg></button></div></div></div></div><div class="ab q"><div class="rw l iw"><div><div class="bl" aria-hidden="false"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="footerBookmarkButton" rel="noopener follow" href="/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fc78cb88b2cb1&amp;operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2F%40shakhat%2Fbuilding-a-network-topology-of-a-kubernetes-application-in-a-non-intrusive-way-c78cb88b2cb1&amp;source=--------------------------bookmark_footer-----------"><svg width="25" height="25" viewBox="0 0 25 25" fill="none" class="dt lk" aria-label="Add to list bookmark button"><path d="M18 2.5a.5.5 0 0 1 1 0V5h2.5a.5.5 0 0 1 0 1H19v2.5a.5.5 0 1 1-1 0V6h-2.5a.5.5 0 0 1 0-1H18V2.5zM7 7a1 1 0 0 1 1-1h3.5a.5.5 0 0 0 0-1H8a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4V7z" fill="currentColor"></path></svg></a></span></div></div></div><div class="rw l iw"><div class="bl" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bl" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="footerSocialShareButton" class="af fj ah ai aj ak al ls an ao ap ew lt lu lh lv"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path fill-rule="evenodd" clip-rule="evenodd" d="M15.22 4.93a.42.42 0 0 1-.12.13h.01a.45.45 0 0 1-.29.08.52.52 0 0 1-.3-.13L12.5 3v7.07a.5.5 0 0 1-.5.5.5.5 0 0 1-.5-.5V3.02l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.8a.42.42 0 0 1 .07.5zm-.1.14zm.88 2h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11a2 2 0 0 1-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.14c.1.1.15.22.15.35a.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9V8.96c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1z" fill="currentColor"></path></svg></button></div></div></div></div></div></div></div></div></div></footer><div class="rx ry rz sa sb l bw"><div class="ab ca"><div class="ch bg fy fz ga gb"><div class="ck ab sc co"><div class="ab ie"><a rel="noopener follow" href="/@shakhat?source=post_page-----c78cb88b2cb1--------------------------------"><div class="l sd se bx sf ii"><div class="l fi"><img alt="Ilya Shakhat" class="l fc bx sg sh cw" src="https://miro.medium.com/v2/resize:fill:144:144/1*mac3LkjCysodrgS9yGsgkQ.jpeg" width="72" height="72" loading="lazy"/><div class="ij bx l sg sh fr n ik fs"></div></div></div></a></div><div class="j i d"><div class="ab"><span><button class="be b bf z eo qz ep eq er es et eu ev ew ex ey ez si fa fb fc bl fd fe">Follow</button></span><div class="ds l"><div><div><div class="bl" aria-hidden="false"><div class="l"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" rel="noopener follow" href="/m/signin?actionUrl=%2F_%2Fapi%2Fusers%2F7766bf7322ef%2Flazily-enable-writer-subscription&amp;operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2F%40shakhat%2Fbuilding-a-network-topology-of-a-kubernetes-application-in-a-non-intrusive-way-c78cb88b2cb1&amp;user=Ilya+Shakhat&amp;userId=7766bf7322ef&amp;source=-----c78cb88b2cb1---------------------subscribe_user-----------"><button class="be b bf z sm am sn so sp sq sr ss st su ev ew ex ey ez fa fb fc bl fd fe" aria-label="Subscribe"><svg width="38" height="38" viewBox="0 0 38 38" fill="none" class="sj sk sl"><rect x="26.25" y="9.25" width="0.5" height="6.5" rx="0.25"></rect><rect x="29.75" y="12.25" width="0.5" height="6.5" rx="0.25" transform="rotate(90 29.75 12.25)"></rect><path d="M19.5 12.5h-7a1 1 0 0 0-1 1v11a1 1 0 0 0 1 1h13a1 1 0 0 0 1-1v-5"></path><path d="M11.5 14.5L19 20l4-3"></path></svg></button></a></span></div></div></div></div></div></div></div></div><div class="ab cm co"><div class="l"><div class="ab q"><a class="af ag ah ai aj ak al am an ao ap aq ar as at ab q" rel="noopener follow" href="/@shakhat?source=post_page-----c78cb88b2cb1--------------------------------"><h2 class="pw-author-name be sv sw sx sy bj"><span class="gm">Written by <!-- -->Ilya Shakhat</span></h2></a></div><div class="qx ab"><div class="l iw"><span class="pw-follower-count be b bf z bj">0 Followers</span></div></div><div class="sz l"></div></div><div class="h k"><div class="ab"><span><button class="be b bf z eo qz ep eq er es et eu ev ew ex ey ez si fa fb fc bl fd fe">Follow</button></span><div class="ds l"><div><div><div class="bl" aria-hidden="false"><div class="l"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" rel="noopener follow" href="/m/signin?actionUrl=%2F_%2Fapi%2Fusers%2F7766bf7322ef%2Flazily-enable-writer-subscription&amp;operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2F%40shakhat%2Fbuilding-a-network-topology-of-a-kubernetes-application-in-a-non-intrusive-way-c78cb88b2cb1&amp;user=Ilya+Shakhat&amp;userId=7766bf7322ef&amp;source=-----c78cb88b2cb1---------------------subscribe_user-----------"><button class="be b bf z sm am sn so sp sq sr ss st su ev ew ex ey ez fa fb fc bl fd fe" aria-label="Subscribe"><svg width="38" height="38" viewBox="0 0 38 38" fill="none" class="sj sk sl"><rect x="26.25" y="9.25" width="0.5" height="6.5" rx="0.25"></rect><rect x="29.75" y="12.25" width="0.5" height="6.5" rx="0.25" transform="rotate(90 29.75 12.25)"></rect><path d="M19.5 12.5h-7a1 1 0 0 0-1 1v11a1 1 0 0 0 1 1h13a1 1 0 0 0 1-1v-5"></path><path d="M11.5 14.5L19 20l4-3"></path></svg></button></a></span></div></div></div></div></div></div></div></div><div class="ta bg tb tc td te tf tg"></div></div></div><div class="h k j"><div class="ta bg tb th"></div><div class="ab ca"><div class="ch bg fy fz ga gb"><div class="ti ab ki iz"><div class="tj tk l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://help.medium.com/hc/en-us?source=post_page-----c78cb88b2cb1--------------------------------" rel="noopener follow"><p class="be b du z dt">Help</p></a></div><div class="tj tk l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://medium.statuspage.io/?source=post_page-----c78cb88b2cb1--------------------------------" rel="noopener follow"><p class="be b du z dt">Status</p></a></div><div class="tj tk l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" rel="noopener follow" href="/about?autoplay=1&amp;source=post_page-----c78cb88b2cb1--------------------------------"><p class="be b du z dt">About</p></a></div><div class="tj tk l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" rel="noopener follow" href="/jobs-at-medium/work-at-medium-959d1a85284e?source=post_page-----c78cb88b2cb1--------------------------------"><p class="be b du z dt">Careers</p></a></div><div class="tj tk l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://blog.medium.com/?source=post_page-----c78cb88b2cb1--------------------------------" rel="noopener follow"><p class="be b du z dt">Blog</p></a></div><div class="tj tk l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----c78cb88b2cb1--------------------------------" rel="noopener follow"><p class="be b du z dt">Privacy</p></a></div><div class="tj tk l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----c78cb88b2cb1--------------------------------" rel="noopener follow"><p class="be b du z dt">Terms</p></a></div><div class="tj tk l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://speechify.com/medium?source=post_page-----c78cb88b2cb1--------------------------------" rel="noopener follow"><p class="be b du z dt">Text to speech</p></a></div><div class="tj l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" rel="noopener follow" href="/business?source=post_page-----c78cb88b2cb1--------------------------------"><p class="be b du z dt">Teams</p></a></div></div></div></div></div></div></div></div></div></div><script>window.__BUILD_ID__="main-20240503-204930-ff3957f1fd"</script><script>window.__GRAPHQL_URI__ = "https://medium.com/_/graphql"</script><script>window.__PRELOADED_STATE__ = {"algolia":{"queries":{}},"cache":{"experimentGroupSet":true,"reason":"","group":"enabled","tags":["group-edgeCachePosts","post-c78cb88b2cb1","user-7766bf7322ef"],"serverVariantState":"44136fa355b3678a1146ad16f7e8649e94fb4fc21fe77e8310c060f61caaff8a","middlewareEnabled":true,"cacheStatus":"DYNAMIC","shouldUseCache":true,"vary":[],"loHomepageEnabled":false,"updatedPostPreviewsEnabled":false,"recommendedTagsQueryEnabled":false,"enableLohpWithSearch":"control","enableLohpFocused":"control","enableMobileLohpShortHero":"control","enableSpamBuster":"control"},"client":{"hydrated":false,"isUs":false,"isNativeMedium":false,"isSafariMobile":false,"isSafari":false,"isFirefox":false,"routingEntity":{"type":"DEFAULT","explicit":false},"viewerIsBot":false},"debug":{"requestId":"f685dba2-d6b0-4915-966c-082ee7ff5673","hybridDevServices":[],"originalSpanCarrier":{"ot-tracer-spanid":"72aa6e151ae3317b","ot-tracer-traceid":"716384cda9ddab0f","ot-tracer-sampled":"true"}},"multiVote":{"clapsPerPost":{}},"navigation":{"branch":{"show":null,"hasRendered":null,"blockedByCTA":false},"hideGoogleOneTap":false,"hasRenderedAlternateUserBanner":null,"currentLocation":"https:\u002F\u002Fmedium.com\u002F@shakhat\u002Fbuilding-a-network-topology-of-a-kubernetes-application-in-a-non-intrusive-way-c78cb88b2cb1","host":"medium.com","hostname":"medium.com","referrer":"","hasSetReferrer":false,"susiModal":{"step":null,"operation":"register"},"postRead":false,"queryString":"","currentHash":""},"config":{"nodeEnv":"production","version":"main-20240503-204930-ff3957f1fd","target":"production","productName":"Medium","publicUrl":"https:\u002F\u002Fcdn-client.medium.com\u002Flite","authDomain":"medium.com","authGoogleClientId":"216296035834-k1k6qe060s2tp2a2jam4ljdcms00sttg.apps.googleusercontent.com","favicon":"production","glyphUrl":"https:\u002F\u002Fglyph.medium.com","branchKey":"key_live_ofxXr2qTrrU9NqURK8ZwEhknBxiI6KBm","algolia":{"appId":"MQ57UUUQZ2","apiKeySearch":"394474ced050e3911ae2249ecc774921","indexPrefix":"medium_","host":"-dsn.algolia.net"},"recaptchaKey":"6Lfc37IUAAAAAKGGtC6rLS13R1Hrw_BqADfS1LRk","recaptcha3Key":"6Lf8R9wUAAAAABMI_85Wb8melS7Zj6ziuf99Yot5","recaptchaEnterpriseKeyId":"6Le-uGgpAAAAAPprRaokM8AKthQ9KNGdoxaGUvVp","datadog":{"applicationId":"6702d87d-a7e0-42fe-bbcb-95b469547ea0","clientToken":"pub853ea8d17ad6821d9f8f11861d23dfed","rumToken":"pubf9cc52896502b9413b68ba36fc0c7162","context":{"deployment":{"target":"production","tag":"main-20240503-204930-ff3957f1fd","commit":"ff3957f1fdfd974c63f2b81f8018b542172614cb"}},"datacenter":"us"},"googleAnalyticsCode":"G-7JY7T788PK","googlePay":{"apiVersion":"2","apiVersionMinor":"0","merchantId":"BCR2DN6TV7EMTGBM","merchantName":"Medium","instanceMerchantId":"13685562959212738550"},"applePay":{"version":3},"signInWallCustomDomainCollectionIds":["3a8144eabfe3","336d898217ee","61061eb0c96b","138adf9c44c","819cc2aaeee0"],"mediumMastodonDomainName":"me.dm","mediumOwnedAndOperatedCollectionIds":["8a9336e5bb4","b7e45b22fec3","193b68bd4fba","8d6b8a439e32","54c98c43354d","3f6ecf56618","d944778ce714","92d2092dc598","ae2a65f35510","1285ba81cada","544c7006046e","fc8964313712","40187e704f1c","88d9857e584e","7b6769f2748b","bcc38c8f6edf","cef6983b292","cb8577c9149e","444d13b52878","713d7dbc99b0","ef8e90590e66","191186aaafa0","55760f21cdc5","9dc80918cc93","bdc4052bbdba","8ccfed20cbb2"],"tierOneDomains":["medium.com","thebolditalic.com","arcdigital.media","towardsdatascience.com","uxdesign.cc","codeburst.io","psiloveyou.xyz","writingcooperative.com","entrepreneurshandbook.co","prototypr.io","betterhumans.coach.me","theascent.pub"],"topicsToFollow":["d61cf867d93f","8a146bc21b28","1eca0103fff3","4d562ee63426","aef1078a3ef5","e15e46793f8d","6158eb913466","55f1c20aba7a","3d18b94f6858","4861fee224fd","63c6f1f93ee","1d98b3a9a871","decb52b64abf","ae5d4995e225","830cded25262"],"topicToTagMappings":{"accessibility":"accessibility","addiction":"addiction","android-development":"android-development","art":"art","artificial-intelligence":"artificial-intelligence","astrology":"astrology","basic-income":"basic-income","beauty":"beauty","biotech":"biotech","blockchain":"blockchain","books":"books","business":"business","cannabis":"cannabis","cities":"cities","climate-change":"climate-change","comics":"comics","coronavirus":"coronavirus","creativity":"creativity","cryptocurrency":"cryptocurrency","culture":"culture","cybersecurity":"cybersecurity","data-science":"data-science","design":"design","digital-life":"digital-life","disability":"disability","economy":"economy","education":"education","equality":"equality","family":"family","feminism":"feminism","fiction":"fiction","film":"film","fitness":"fitness","food":"food","freelancing":"freelancing","future":"future","gadgets":"gadgets","gaming":"gaming","gun-control":"gun-control","health":"health","history":"history","humor":"humor","immigration":"immigration","ios-development":"ios-development","javascript":"javascript","justice":"justice","language":"language","leadership":"leadership","lgbtqia":"lgbtqia","lifestyle":"lifestyle","machine-learning":"machine-learning","makers":"makers","marketing":"marketing","math":"math","media":"media","mental-health":"mental-health","mindfulness":"mindfulness","money":"money","music":"music","neuroscience":"neuroscience","nonfiction":"nonfiction","outdoors":"outdoors","parenting":"parenting","pets":"pets","philosophy":"philosophy","photography":"photography","podcasts":"podcast","poetry":"poetry","politics":"politics","privacy":"privacy","product-management":"product-management","productivity":"productivity","programming":"programming","psychedelics":"psychedelics","psychology":"psychology","race":"race","relationships":"relationships","religion":"religion","remote-work":"remote-work","san-francisco":"san-francisco","science":"science","self":"self","self-driving-cars":"self-driving-cars","sexuality":"sexuality","social-media":"social-media","society":"society","software-engineering":"software-engineering","space":"space","spirituality":"spirituality","sports":"sports","startups":"startup","style":"style","technology":"technology","transportation":"transportation","travel":"travel","true-crime":"true-crime","tv":"tv","ux":"ux","venture-capital":"venture-capital","visual-design":"visual-design","work":"work","world":"world","writing":"writing"},"defaultImages":{"avatar":{"imageId":"1*dmbNkD5D-u45r44go_cf0g.png","height":150,"width":150},"orgLogo":{"imageId":"1*OMF3fSqH8t4xBJ9-6oZDZw.png","height":106,"width":545},"postLogo":{"imageId":"1*kFrc4tBFM_tCis-2Ic87WA.png","height":810,"width":1440},"postPreviewImage":{"imageId":"1*hn4v1tCaJy7cWMyb0bpNpQ.png","height":386,"width":579}},"collectionStructuredData":{"8d6b8a439e32":{"name":"Elemental","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F980\u002F1*9ygdqoKprhwuTVKUM0DLPA@2x.png","width":980,"height":159}}},"3f6ecf56618":{"name":"Forge","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F596\u002F1*uULpIlImcO5TDuBZ6lm7Lg@2x.png","width":596,"height":183}}},"ae2a65f35510":{"name":"GEN","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fmiro.medium.com\u002Fmax\u002F264\u002F1*RdVZMdvfV3YiZTw6mX7yWA.png","width":264,"height":140}}},"88d9857e584e":{"name":"LEVEL","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fmiro.medium.com\u002Fmax\u002F540\u002F1*JqYMhNX6KNNb2UlqGqO2WQ.png","width":540,"height":108}}},"7b6769f2748b":{"name":"Marker","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F383\u002F1*haCUs0wF6TgOOvfoY-jEoQ@2x.png","width":383,"height":92}}},"444d13b52878":{"name":"OneZero","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fmiro.medium.com\u002Fmax\u002F540\u002F1*cw32fIqCbRWzwJaoQw6BUg.png","width":540,"height":123}}},"8ccfed20cbb2":{"name":"Zora","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fmiro.medium.com\u002Fmax\u002F540\u002F1*tZUQqRcCCZDXjjiZ4bDvgQ.png","width":540,"height":106}}}},"embeddedPostIds":{"coronavirus":"cd3010f9d81f"},"sharedCdcMessaging":{"COVID_APPLICABLE_TAG_SLUGS":[],"COVID_APPLICABLE_TOPIC_NAMES":[],"COVID_APPLICABLE_TOPIC_NAMES_FOR_TOPIC_PAGE":[],"COVID_MESSAGES":{"tierA":{"text":"For more information on the novel coronavirus and Covid-19, visit cdc.gov.","markups":[{"start":66,"end":73,"href":"https:\u002F\u002Fwww.cdc.gov\u002Fcoronavirus\u002F2019-nCoV"}]},"tierB":{"text":"Anyone can publish on Medium per our Policies, but we don’t fact-check every story. For more info about the coronavirus, see cdc.gov.","markups":[{"start":37,"end":45,"href":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Fcategories\u002F201931128-Policies-Safety"},{"start":125,"end":132,"href":"https:\u002F\u002Fwww.cdc.gov\u002Fcoronavirus\u002F2019-nCoV"}]},"paywall":{"text":"This article has been made free for everyone, thanks to Medium Members. For more information on the novel coronavirus and Covid-19, visit cdc.gov.","markups":[{"start":56,"end":70,"href":"https:\u002F\u002Fmedium.com\u002Fmembership"},{"start":138,"end":145,"href":"https:\u002F\u002Fwww.cdc.gov\u002Fcoronavirus\u002F2019-nCoV"}]},"unbound":{"text":"This article is free for everyone, thanks to Medium Members. For more information on the novel coronavirus and Covid-19, visit cdc.gov.","markups":[{"start":45,"end":59,"href":"https:\u002F\u002Fmedium.com\u002Fmembership"},{"start":127,"end":134,"href":"https:\u002F\u002Fwww.cdc.gov\u002Fcoronavirus\u002F2019-nCoV"}]}},"COVID_BANNER_POST_ID_OVERRIDE_WHITELIST":["3b31a67bff4a"]},"sharedVoteMessaging":{"TAGS":["politics","election-2020","government","us-politics","election","2020-presidential-race","trump","donald-trump","democrats","republicans","congress","republican-party","democratic-party","biden","joe-biden","maga"],"TOPICS":["politics","election"],"MESSAGE":{"text":"Find out more about the U.S. election results here.","markups":[{"start":46,"end":50,"href":"https:\u002F\u002Fcookpolitical.com\u002F2020-national-popular-vote-tracker"}]},"EXCLUDE_POSTS":["397ef29e3ca5"]},"embedPostRules":[],"recircOptions":{"v1":{"limit":3},"v2":{"limit":8}},"braintreeClientKey":"production_zjkj96jm_m56f8fqpf7ngnrd4","braintree":{"enabled":true,"merchantId":"m56f8fqpf7ngnrd4","merchantAccountId":{"usd":"AMediumCorporation_instant","eur":"amediumcorporation_EUR","cad":"amediumcorporation_CAD"},"publicKey":"ds2nn34bg2z7j5gd","braintreeEnvironment":"production","dashboardUrl":"https:\u002F\u002Fwww.braintreegateway.com\u002Fmerchants","gracePeriodDurationInDays":14,"mediumMembershipPlanId":{"monthly":"ce105f8c57a3","monthlyV2":"e8a5e126-792b-4ee6-8fba-d574c1b02fc5","monthlyWithTrial":"d5ee3dbe3db8","monthlyPremium":"fa741a9b47a2","yearly":"a40ad4a43185","yearlyV2":"3815d7d6-b8ca-4224-9b8c-182f9047866e","yearlyStaff":"d74fb811198a","yearlyWithTrial":"b3bc7350e5c7","yearlyPremium":"e21bd2c12166","monthlyOneYearFree":"e6c0637a-2bad-4171-ab4f-3c268633d83c","monthly25PercentOffFirstYear":"235ecc62-0cdb-49ae-9378-726cd21c504b","monthly20PercentOffFirstYear":"ba518864-9c13-4a99-91ca-411bf0cac756","monthly15PercentOffFirstYear":"594c029b-9f89-43d5-88f8-8173af4e070e","monthly10PercentOffFirstYear":"c6c7bc9a-40f2-4b51-8126-e28511d5bdb0","monthlyForStudents":"629ebe51-da7d-41fd-8293-34cd2f2030a8","yearlyOneYearFree":"78ba7be9-0d9f-4ece-aa3e-b54b826f2bf1","yearly25PercentOffFirstYear":"2dbb010d-bb8f-4eeb-ad5c-a08509f42d34","yearly20PercentOffFirstYear":"47565488-435b-47f8-bf93-40d5fbe0ebc8","yearly15PercentOffFirstYear":"8259809b-0881-47d9-acf7-6c001c7f720f","yearly10PercentOffFirstYear":"9dd694fb-96e1-472c-8d9e-3c868d5c1506","yearlyForStudents":"e29345ef-ab1c-4234-95c5-70e50fe6bc23","monthlyCad":"p52orjkaceei","yearlyCad":"h4q9g2up9ktt"},"braintreeDiscountId":{"oneMonthFree":"MONTHS_FREE_01","threeMonthsFree":"MONTHS_FREE_03","sixMonthsFree":"MONTHS_FREE_06","fiftyPercentOffOneYear":"FIFTY_PERCENT_OFF_ONE_YEAR"},"3DSecureVersion":"2","defaultCurrency":"usd","providerPlanIdCurrency":{"4ycw":"usd","rz3b":"usd","3kqm":"usd","jzw6":"usd","c2q2":"usd","nnsw":"usd","q8qw":"usd","d9y6":"usd","fx7w":"cad","nwf2":"cad"}},"paypalClientId":"AXj1G4fotC2GE8KzWX9mSxCH1wmPE3nJglf4Z2ig_amnhvlMVX87otaq58niAg9iuLktVNF_1WCMnN7v","paypal":{"host":"https:\u002F\u002Fapi.paypal.com:443","clientMode":"production","serverMode":"live","webhookId":"4G466076A0294510S","monthlyPlan":{"planId":"P-9WR0658853113943TMU5FDQA","name":"Medium Membership (Monthly) with setup fee","description":"Unlimited access to the best and brightest stories on Medium. Membership billed monthly."},"yearlyPlan":{"planId":"P-7N8963881P8875835MU5JOPQ","name":"Medium Membership (Annual) with setup fee","description":"Unlimited access to the best and brightest stories on Medium. Membership billed annually."},"oneYearGift":{"name":"Medium Membership (1 Year, Digital Gift Code)","description":"Unlimited access to the best and brightest stories on Medium. Gift codes can be redeemed at medium.com\u002Fredeem.","price":"50.00","currency":"USD","sku":"membership-gift-1-yr"},"oldMonthlyPlan":{"planId":"P-96U02458LM656772MJZUVH2Y","name":"Medium Membership (Monthly)","description":"Unlimited access to the best and brightest stories on Medium. Membership billed monthly."},"oldYearlyPlan":{"planId":"P-59P80963JF186412JJZU3SMI","name":"Medium Membership (Annual)","description":"Unlimited access to the best and brightest stories on Medium. Membership billed annually."},"monthlyPlanWithTrial":{"planId":"P-66C21969LR178604GJPVKUKY","name":"Medium Membership (Monthly) with setup fee","description":"Unlimited access to the best and brightest stories on Medium. Membership billed monthly."},"yearlyPlanWithTrial":{"planId":"P-6XW32684EX226940VKCT2MFA","name":"Medium Membership (Annual) with setup fee","description":"Unlimited access to the best and brightest stories on Medium. Membership billed annually."},"oldMonthlyPlanNoSetupFee":{"planId":"P-4N046520HR188054PCJC7LJI","name":"Medium Membership (Monthly)","description":"Unlimited access to the best and brightest stories on Medium. Membership billed monthly."},"oldYearlyPlanNoSetupFee":{"planId":"P-7A4913502Y5181304CJEJMXQ","name":"Medium Membership (Annual)","description":"Unlimited access to the best and brightest stories on Medium. Membership billed annually."},"sdkUrl":"https:\u002F\u002Fwww.paypal.com\u002Fsdk\u002Fjs"},"stripePublishableKey":"pk_live_7FReX44VnNIInZwrIIx6ghjl","log":{"json":true,"level":"info"},"imageUploadMaxSizeMb":25,"staffPicks":{"title":"Staff Picks","catalogId":"c7bc6e1ee00f"}},"session":{"xsrf":""}}</script><script>window.__APOLLO_STATE__ = {"ROOT_QUERY":{"__typename":"Query","isLoggedIn":false,"viewer":null,"collectionByDomainOrSlug({\"domainOrSlug\":\"medium.com\"})":null,"postResult({\"id\":\"c78cb88b2cb1\"})":{"__ref":"Post:c78cb88b2cb1"}},"LinkedAccounts:7766bf7322ef":{"__typename":"LinkedAccounts","mastodon":null,"id":"7766bf7322ef"},"UserViewerEdge:userId:7766bf7322ef-viewerId:lo_aa17c9b7b6e2":{"__typename":"UserViewerEdge","id":"userId:7766bf7322ef-viewerId:lo_aa17c9b7b6e2","isFollowing":false,"isUser":false,"isMuting":false},"User:7766bf7322ef":{"__typename":"User","id":"7766bf7322ef","linkedAccounts":{"__ref":"LinkedAccounts:7766bf7322ef"},"isSuspended":false,"imageId":"1*mac3LkjCysodrgS9yGsgkQ.jpeg","mediumMemberAt":0,"verifications":{"__typename":"VerifiedInfo","isBookAuthor":false},"name":"Ilya Shakhat","socialStats":{"__typename":"SocialStats","followerCount":0},"username":"shakhat","customDomainState":null,"hasSubdomain":false,"bio":"","isPartnerProgramEnrolled":false,"viewerEdge":{"__ref":"UserViewerEdge:userId:7766bf7322ef-viewerId:lo_aa17c9b7b6e2"},"viewerIsUser":false,"newsletterV3":null,"postSubscribeMembershipUpsellShownAt":0,"allowNotes":true,"membership":null,"twitterScreenName":""},"Paragraph:748764c14030_0":{"__typename":"Paragraph","id":"748764c14030_0","name":"b9c5","type":"H3","href":null,"layout":null,"metadata":null,"text":"Building a network topology of a Kubernetes application in a non-intrusive way","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_1":{"__typename":"Paragraph","id":"748764c14030_1","name":"64ec","type":"H3","href":null,"layout":null,"metadata":null,"text":"Intro","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_2":{"__typename":"Paragraph","id":"748764c14030_2","name":"568b","type":"P","href":null,"layout":null,"metadata":null,"text":"An application in Kubernetes is logically split into two distinct parts: one is a computational resource (represented by pods) and the other exposes access to the application (represented by services). Application clients can access it by an abstract name without taking care of what pods actually handle requests. And since a single service may have multiple pods as a backend, it also plays a role of a load-balancer. In the default Kubernetes deployments this load-balancing feature is implemented pretty simple using iptables or Linux IPVS — both work at L4 (e.g. TCP) and do a naïve random-based round-robin. Of course, cloud providers may also offer a more traditional load-balancing solutions to expose applications, but let’s start simple.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"EM","start":521,"end":529,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":533,"end":543,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_3":{"__typename":"Paragraph","id":"748764c14030_3","name":"553c","type":"P","href":null,"layout":null,"metadata":null,"text":"When we think about issues that can occur in applications deployed in Kubernetes, there is one group that requires a knowledge of a specific instance that handles a client request. For example: (1) one of application pods is deployed at a host which has worse network connectivity and establishing of a new connection takes longer than for others, or (2) there is a pod which performance degrades over the time while of others stays constant or (3) there is a specific client which requests affect application performance. Distributed tracing is usually one of approaches to get insights into such issues and, obviously, to trace client requests to the backend application. Traditionally, the distributed tracing requires some sort of instrumentation — it can vary from manual code additions to a fully automatic injection into runtime. But can the same be achieved without any manipulations with client code at all?","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_4":{"__typename":"Paragraph","id":"748764c14030_4","name":"1864","type":"P","href":null,"layout":null,"metadata":null,"text":"To debug the mentioned issues we basically need two features of a distributed tracing: (1) to collect metrics related to request latency and (2) to know exactly where every single request goes. The first feature can easily be implemented in a non-intrusive way by using one of large variety of tools powered by eBPF — a technology that allows to dynamically attach probes to kernel functions and, for example, to record which process establishes a new connection, get socket\u002Fconnection related metrics, even check if there were retransmissions or evil connection resets. In openEuler ecosystem such tool is gala-gopher which offers a large collection of different probes, including socket, TCP and L7\u002FHTTP(s) probes. However the second feature (knowing where a single request goes) is much harder to achieve. In distributed tracing frameworks it is implemented by injecting a span\u002Ftrace id into application payload and then correlating observations with the same span id from both client and backend sides. Being a non-intrusive to application code would mean that the same information needs to be injected a generic way, but doing this into application protocols is not feasible at all as it would require to intercept outgoing traffic, parse it, inject id, serialize it back and forward. Looks like we just re-invented a service mesh!","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":574,"end":583,"href":"https:\u002F\u002Fopeneuler.org","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":607,"end":618,"href":"https:\u002F\u002Fgitee.com\u002Fopeneuler\u002Fgala-gopher\u002F","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_5":{"__typename":"Paragraph","id":"748764c14030_5","name":"efec","type":"P","href":null,"layout":null,"metadata":null,"text":"Before going further let’s first take a look at the data available from network monitoring. Here we assume that monitoring gets information from all nodes that host application pods and this data is then collected by e.g. Prometheus. In order to achieve this, we need some experiment environment.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_6":{"__typename":"Paragraph","id":"748764c14030_6","name":"e37e","type":"H3","href":null,"layout":null,"metadata":null,"text":"Experiment environment","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_7":{"__typename":"Paragraph","id":"748764c14030_7","name":"a1f2","type":"P","href":null,"layout":null,"metadata":null,"text":"First of all, we need a deployed multi-node Kubernetes cluster. In Huawei Cloud the corresponding service is called Cloud Container Engine (CCE).","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":116,"end":144,"href":"https:\u002F\u002Fwww.huaweicloud.com\u002Fintl\u002Fen-us\u002Fproduct\u002Fcce.html","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_8":{"__typename":"Paragraph","id":"748764c14030_8","name":"1a4b","type":"P","href":null,"layout":null,"metadata":null,"text":"Then we need a test application, for that purposes we will use a very simple Python program that accepts an HTTP request with ability to make outgoing HTTP requests to the address specified in the original request. That way we can chain applications easily.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":77,"end":91,"href":"https:\u002F\u002Fgist.github.com\u002Fshakhat\u002F059cc629803bbfbbde0975aee64c936b.js","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_9":{"__typename":"Paragraph","id":"748764c14030_9","name":"3e18","type":"P","href":null,"layout":null,"metadata":null,"text":"The applications will be called by Latin letters, A, B, etc. Application A is deployed as Deployment A and Service A, and so on. The very first application is also exposed externally, so it can be called from the outside.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*9g2pQdW-TrZRxVKGAIUojQ.png":{"__typename":"ImageMetadata","id":"1*9g2pQdW-TrZRxVKGAIUojQ.png","originalHeight":256,"originalWidth":539,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:748764c14030_10":{"__typename":"Paragraph","id":"748764c14030_10","name":"9b68","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*9g2pQdW-TrZRxVKGAIUojQ.png"},"text":"A and B applications topology in Kubernetes","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_11":{"__typename":"Paragraph","id":"748764c14030_11","name":"5aaa","type":"P","href":null,"layout":null,"metadata":null,"text":"Gala-gopher is deployed as a daemon set and runs on every Kubernetes node. It exposes metrics that are consumed by Prometheus and finally visualized with Grafana. Service topology is constructed based on metrics and visualized by NodeGraph plugin.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":230,"end":239,"href":"https:\u002F\u002Fgrafana.com\u002Fdocs\u002Fplugins\u002Fyesoreyeram-infinity-datasource\u002Flatest\u002Freferences\u002Fdisplay-options\u002Fnode-graph\u002F","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_12":{"__typename":"Paragraph","id":"748764c14030_12","name":"9579","type":"H3","href":null,"layout":null,"metadata":null,"text":"Observations","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_13":{"__typename":"Paragraph","id":"748764c14030_13","name":"683d","type":"P","href":null,"layout":null,"metadata":null,"text":"Let’s send a few requests to the application A with forwarding to the application B like this:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_14":{"__typename":"Paragraph","id":"748764c14030_14","name":"1de7","type":"PRE","href":null,"layout":null,"metadata":null,"text":"[root@debug-7d8bdd568c-5jrmf \u002F]# curl http:\u002F\u002Fa.app:8000\u002Fb.app:8000\n..Hello from pod b-67b75c8557-698tr ip 10.0.0.76 at node 192.168.3.218\nHello from pod a-7954c595f7-tmnx8 ip 10.0.0.148 at node 192.168.3.14\n\n[root@debug-7d8bdd568c-5jrmf \u002F]# curl http:\u002F\u002Fa.app:8000\u002Fb.app:8000\n..Hello from pod b-67b75c8557-mzn6p ip 10.0.0.149 at node 192.168.3.14\nHello from pod a-7954c595f7-tmnx8 ip 10.0.0.148 at node 192.168.3.14","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"EXPLICIT","lang":"bash"},"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_15":{"__typename":"Paragraph","id":"748764c14030_15","name":"d46c","type":"P","href":null,"layout":null,"metadata":null,"text":"In the output we see that one of requests to the application B went to one pod and the other to the different. This is how the topology look in Grafana:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*kMpQWptLhyGjsXagdEBJRg.png":{"__typename":"ImageMetadata","id":"1*kMpQWptLhyGjsXagdEBJRg.png","originalHeight":719,"originalWidth":974,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:748764c14030_16":{"__typename":"Paragraph","id":"748764c14030_16","name":"175e","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*kMpQWptLhyGjsXagdEBJRg.png"},"text":"A and B application topology as reconstructed from metrics","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_17":{"__typename":"Paragraph","id":"748764c14030_17","name":"7df6","type":"P","href":null,"layout":null,"metadata":null,"text":"The top and the middle rows show that something sent requests to pods of application B and the bottom part shows that a pod of A sent a request to a virtual IP of a service B. But this doesn’t look like what we expected at all, right? We only see three groups of nodes and they don’t link to each other. IP addresses from 192.168.3.0\u002F24 subnet are node addresses from cluster private network (VPC), 10.0.0.1\u002F24 are addresses of pods except 10.0.0.129 which is again a node address for intra-node communications.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_18":{"__typename":"Paragraph","id":"748764c14030_18","name":"1921","type":"P","href":null,"layout":null,"metadata":null,"text":"Now these metrics are collected at socket level, meaning that they are exactly what application processes can see. The collection is done by eBPF probes, so the first idea would be to check if OS kernel knows a bit more about application connections than is available in the sockets. The cluster is configured with the default CNI and Kubernetes services are implemented as iptables rules. Output of iptables-save reveals the configuration. Most interesting are these lines that actually configure load balancing:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_19":{"__typename":"Paragraph","id":"748764c14030_19","name":"c30a","type":"PRE","href":null,"layout":null,"metadata":null,"text":"-A KUBE-SERVICES -d 10.247.204.240\u002F32 -p tcp -m comment \n   --comment \"app\u002Fb:http-port cluster IP\" -m tcp --dport 8000 -j KUBE-SVC-CELO6J2CXNI7KVVA\n-A KUBE-SVC-CELO6J2CXNI7KVVA -d 10.247.204.240\u002F32 -p tcp -m comment \n   --comment \"app\u002Fb:http-port cluster IP\" -m tcp --dport 8000 -j KUBE-MARK-MASQ\n-A KUBE-SVC-CELO6J2CXNI7KVVA -m comment --comment \"app\u002Fb:http-port -\u003E 10.0.0.155:8000\" \n   -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-VFBYZLZKPEFJ3QIZ\n-A KUBE-SVC-CELO6J2CXNI7KVVA -m comment --comment \"app\u002Fb:http-port -\u003E 10.0.0.76:8000\" \n   -j KUBE-SEP-SXF6FD423VYX6VFB","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"EXPLICIT","lang":"shell"},"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_20":{"__typename":"Paragraph","id":"748764c14030_20","name":"c362","type":"P","href":null,"layout":null,"metadata":null,"text":"Load balancing is done on the same node where the client is. So if we map pods to nodes this looks like this:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*DUoAySaau2XK-H50JMQ3xQ.png":{"__typename":"ImageMetadata","id":"1*DUoAySaau2XK-H50JMQ3xQ.png","originalHeight":283,"originalWidth":460,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:748764c14030_21":{"__typename":"Paragraph","id":"748764c14030_21","name":"6c77","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*DUoAySaau2XK-H50JMQ3xQ.png"},"text":"A and B application topology mapped to Kubernetes nodes","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_22":{"__typename":"Paragraph","id":"748764c14030_22","name":"0e94","type":"P","href":null,"layout":null,"metadata":null,"text":"Internally iptables (actually nftables) use conntrack module to understand that packets belong to the same connection and should be processed similar. Conntrack is also responsible for address translation, so the node with the client application should know where to send packets to. Let’s check this with conntrack CLI tool.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":30,"end":38,"href":"https:\u002F\u002Fwiki.nftables.org\u002Fwiki-nftables\u002Findex.php\u002FWhat_is_nftables%3F","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_23":{"__typename":"Paragraph","id":"748764c14030_23","name":"345c","type":"PRE","href":null,"layout":null,"metadata":null,"text":"# node-1\n# conntrack -L | grep 8000\ntcp      6 82 TIME_WAIT src=10.0.0.164 dst=10.247.204.240 sport=51030 dport=8000 src=10.0.0.76 dst=192.168.3.14 sport=8000 dport=19554 [ASSURED] use=1\ntcp      6 79 TIME_WAIT src=10.0.0.164 dst=10.247.204.240 sport=51014 dport=8000 src=10.0.0.155 dst=10.0.0.129 sport=8000 dport=56734 [ASSURED] use=1\n\n# node-2\n# conntrack -L | grep 8000\ntcp      6 249 CLOSE_WAIT src=10.0.0.76 dst=192.168.3.14 sport=8000 dport=19554 [UNREPLIED] src=192.168.3.14 dst=10.0.0.76 sport=19554 dport=8000 use=1","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"EXPLICIT","lang":"bash"},"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_24":{"__typename":"Paragraph","id":"748764c14030_24","name":"73d8","type":"P","href":null,"layout":null,"metadata":null,"text":"Ok, we see that on the first node the address was translated from pod of application A and got address of node with some random port. At the second node the connection information is reversed because its own packets are actually a reply, but taking this into account we see that the request came from the first node and the same random port. Note that there are 2 requests at Node-1 because we sent 2 requests and they were handled by different pods: pod-b-1 at the same node and pod-b-2 at the other.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"EM","start":342,"end":501,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_25":{"__typename":"Paragraph","id":"748764c14030_25","name":"aab9","type":"P","href":null,"layout":null,"metadata":null,"text":"Good news here is that it is possible to know the actual request recipient right at the client node, but for a server side it requires correlation with the information collected at the client node. Like this:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"EM","start":29,"end":37,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":135,"end":146,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*KGVuOsLS8sDGrDalwlNciQ.png":{"__typename":"ImageMetadata","id":"1*KGVuOsLS8sDGrDalwlNciQ.png","originalHeight":391,"originalWidth":485,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:748764c14030_26":{"__typename":"Paragraph","id":"748764c14030_26","name":"fd58","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*KGVuOsLS8sDGrDalwlNciQ.png"},"text":"Connections as tracked by conntrack module. Blue circles are local addresses as observed in sockets, violet are remote. The challenge is to correlate violet to blue.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_27":{"__typename":"Paragraph","id":"748764c14030_27","name":"629e","type":"P","href":null,"layout":null,"metadata":null,"text":"When both client and server pods are at the same node the correlation becomes even more simple, but still with some assumptions regarding which addresses are true and which should be ignored:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*iiHSVPkHKfBnhaa2yKRoLQ.png":{"__typename":"ImageMetadata","id":"1*iiHSVPkHKfBnhaa2yKRoLQ.png","originalHeight":210,"originalWidth":490,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:748764c14030_28":{"__typename":"Paragraph","id":"748764c14030_28","name":"22cc","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*iiHSVPkHKfBnhaa2yKRoLQ.png"},"text":"Connection between 2 pods located at the same node. Source addresses are true while destination ones need to be mapped","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_29":{"__typename":"Paragraph","id":"748764c14030_29","name":"e5e1","type":"P","href":null,"layout":null,"metadata":null,"text":"Here OS has full view on NAT and can provide mapping between the real source and the real destination. It is possible to reconstruct a full flow from 10.0.0.164 to 10.0.0.155.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"EM","start":109,"end":117,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_30":{"__typename":"Paragraph","id":"748764c14030_30","name":"fc94","type":"P","href":null,"layout":null,"metadata":null,"text":"To conclude this section, it should be possible to extend existing eBPF probe to include information from conntrack module about address translation. It is possible for a client to know where the request goes. But it is not always possible for a server to know who was the client directly without a centralized correlation algorithm. To contrast, the distributed tracing approach gives both client and server information about peer directly and immediately from the communication data. So comes the FlowTracer!","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":432,"end":456,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":280,"end":322,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_31":{"__typename":"Paragraph","id":"748764c14030_31","name":"c152","type":"H3","href":null,"layout":null,"metadata":null,"text":"The FlowTracer","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":0,"end":14,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_32":{"__typename":"Paragraph","id":"748764c14030_32","name":"2edc","type":"P","href":null,"layout":null,"metadata":null,"text":"The idea is simple — to transfer data between peers right in the connection. It is not the first time such feature is needed, for example, HTTP load balancers insert X-Forwarded-For HTTP header to let back-end server know the client. The restriction here is that we want to stay at L4 and thus support any application level protocol. Such feature exists too and some L4 load balancers (e.g. this) can inject original address as TCP header option and make it available to the server.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":391,"end":395,"href":"https:\u002F\u002Fwww.tencentcloud.com\u002Fdocument\u002Fproduct\u002F608\u002F14429","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_33":{"__typename":"Paragraph","id":"748764c14030_33","name":"396c","type":"P","href":null,"layout":null,"metadata":null,"text":"To sum up the requirements:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_34":{"__typename":"Paragraph","id":"748764c14030_34","name":"0caa","type":"OLI","href":null,"layout":null,"metadata":null,"text":"Transfer peer address at L4.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_35":{"__typename":"Paragraph","id":"748764c14030_35","name":"8c3e","type":"OLI","href":null,"layout":null,"metadata":null,"text":"Be able to enable address injection dynamically (as easy as to deploy app in K8s).","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_36":{"__typename":"Paragraph","id":"748764c14030_36","name":"954f","type":"OLI","href":null,"layout":null,"metadata":null,"text":"Non-intrusive and fast.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_37":{"__typename":"Paragraph","id":"748764c14030_37","name":"4b64","type":"P","href":null,"layout":null,"metadata":null,"text":"The most straight-forward approach seems to use a TCP header option (also known as TOA). The payload is IP address and port number (since they change during address translation). We can restrict to support IPv4 only since Huawei Kubernetes deployment supports only it. IPv4 address is 32 bits, plus we need 16 bits for a port number, in total this gives 6 bytes plus 1 byte for option kind and one more byte for option length. Here’s how a TCP header looks in spec:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":460,"end":464,"href":"https:\u002F\u002Fen.wikipedia.org\u002Fwiki\u002FTransmission_Control_Protocol","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*5qFdrO9_Yyk_YTqk5w0IcA.png":{"__typename":"ImageMetadata","id":"1*5qFdrO9_Yyk_YTqk5w0IcA.png","originalHeight":634,"originalWidth":1574,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:748764c14030_38":{"__typename":"Paragraph","id":"748764c14030_38","name":"d743","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*5qFdrO9_Yyk_YTqk5w0IcA.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_39":{"__typename":"Paragraph","id":"748764c14030_39","name":"3e8e","type":"P","href":null,"layout":null,"metadata":null,"text":"The header may contain multiple options of up to 40 bytes in total. Each option can have variable length and a type \u002F kind.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*MJ_dpcekRR6fh3qum0M4dA.png":{"__typename":"ImageMetadata","id":"1*MJ_dpcekRR6fh3qum0M4dA.png","originalHeight":392,"originalWidth":1752,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:748764c14030_40":{"__typename":"Paragraph","id":"748764c14030_40","name":"7289","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*MJ_dpcekRR6fh3qum0M4dA.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_41":{"__typename":"Paragraph","id":"748764c14030_41","name":"94f7","type":"P","href":null,"layout":null,"metadata":null,"text":"Normally Linux TCP packets already have some options like MSS or Timestamp. But there’s still a room of approximately 20 bytes that can be used for our purposes.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_42":{"__typename":"Paragraph","id":"748764c14030_42","name":"a7f0","type":"P","href":null,"layout":null,"metadata":null,"text":"Now when we know where to put the data the next question is where should the code be added? We want the solution to be as much generic as possible and work for any TCP connection. The ideal place is somewhere in the kernel in the network stack operating over a so-called socket buffer — a structure that represents network connection information — available from the top level down to the packets ready to be transferred over the network. From the implementation point-of-view the code should be an eBPF code (of course!), then address injection feature can be dynamically enabled.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_43":{"__typename":"Paragraph","id":"748764c14030_43","name":"c0ae","type":"P","href":null,"layout":null,"metadata":null,"text":"The most obvious place for such code is TC, a traffic control module. There an eBPF program has access to already created packets, it can read and write data from packets. One of disadvantages is the need to parse packet from scratch, i.e. even bpf_skb_load_bytes_relative function provides a pointer to the beginning of L3 header, but the location of L4 still needs to be calculated manually. The most problematic though is inserting operation. There are 2 functions with promising names bpf_skb_adjust_room and bpf_skb_change_tail, but they allow to resize at most L3 packet and not L4. An alternative solution would be to check if existing TCP header contains some options and overwrite them, but let’s first check what an usual packet contains.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":245,"end":272,"href":"https:\u002F\u002Febpf-docs.dylanreimerink.nl\u002Flinux\u002Fhelper-function\u002Fbpf_skb_load_bytes_relative\u002F","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":489,"end":508,"href":"https:\u002F\u002Febpf-docs.dylanreimerink.nl\u002Flinux\u002Fhelper-function\u002Fbpf_skb_adjust_room\u002F","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":513,"end":532,"href":"https:\u002F\u002Febpf-docs.dylanreimerink.nl\u002Flinux\u002Fhelper-function\u002Fbpf_skb_change_tail\u002F","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":179,"end":192,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":245,"end":272,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_44":{"__typename":"Paragraph","id":"748764c14030_44","name":"5f70","type":"PRE","href":null,"layout":null,"metadata":null,"text":"1514772378.301862 IP (tos 0x0, ttl 64, id 20960, offset 0, flags [DF], proto TCP (6), length 60)\n    192.168.3.14.28301 \u003E 10.0.0.76.8000: Flags [S], cksum 0xbc03 (correct), seq 1849406961, win 64240, options [mss 1460,sackOK,TS val 142477455 ecr 0,nop,wscale 9], length 0\n        0x0000:  0000 0001 0006 fa16 3e22 3096 0000 0800  ........\u003E\"0.....\n        0x0010:  4500 003c 51e0 4000 4006 1ada c0a8 030e  E..\u003CQ.@.@.......\n        0x0020:  0a00 004c 6e8d 1f40 6e3b b5f1 0000 0000  ...Ln..@n;......\n        0x0030:  a002 faf0 bc03 0000 0204 05b4 0402 080a  ................\n        0x0040:  087e 088f 0000 0000 0103 0309            .~..........","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"AUTO","lang":"yaml"},"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_45":{"__typename":"Paragraph","id":"748764c14030_45","name":"aa84","type":"P","href":null,"layout":null,"metadata":null,"text":"This is a TCP SYN packet sent when the client establishes connection with the back-end application. The header contains multiple options: MSS used to specify maximum segment size, then selective acknowledgement, a Timestamp used in particular to ensure order of packets, a no-operation NOP probably used for word alignment and finally window scale used to tune window size. From this list the Timestamp option is the best candidate to be overwritten (the adoption is still ~40% according to Wikipedia) and that is what DeepFlow — one of leaders of non-intrusive eBPF tracing — does in their platform.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":591,"end":599,"href":"https:\u002F\u002Fzhuanlan.zhihu.com\u002Fp\u002F641197123","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_46":{"__typename":"Paragraph","id":"748764c14030_46","name":"4273","type":"P","href":null,"layout":null,"metadata":null,"text":"While this approach seems to be working it is still not a trivial to implement. TC program has access to an already translated address, meaning that the translation mapping should be somehow retrieved from conntrack module and stored. TC program is attached to network cards, so if a node has multiple of them then the deployment needs to correctly identify where to attach. The reading module will have to parse all packets in order to find TCP and then to iterate over headers to find where our header is. Is there another way?","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_47":{"__typename":"Paragraph","id":"748764c14030_47","name":"9f5b","type":"P","href":null,"layout":null,"metadata":null,"text":"While googling this question in August 2023, it was quite often to get to the bottom of a search result page telling no more results (hope this will change with this blog post!) The most useful reference was a link to a patch into Linux Kernel made by Facebook engineers back in 2020. This patch reveals what we were searching for:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":290,"end":295,"href":"https:\u002F\u002Flore.kernel.org\u002Fnetdev\u002F20200626175501.1459961-1-kafai@fb.com\u002F","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_48":{"__typename":"Paragraph","id":"748764c14030_48","name":"d630","type":"BQ","href":null,"layout":null,"metadata":null,"text":"The earlier effort in BPF-TCP-CC allows the TCP Congestion Control\nalgorithm to be written in BPF. It opens up opportunities to allow\na faster turnaround time in testing\u002Freleasing new congestion control\nideas to production environment.\n\nThe same flexibility can be extended to writing TCP header option.\nIt is not uncommon that people want to test new TCP header option\nto improve the TCP performance. Another use case is for data-center\nthat has a more controlled environment and has more flexibility in\nputting header options for internal traffic only.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_49":{"__typename":"Paragraph","id":"748764c14030_49","name":"ce57","type":"P","href":null,"layout":null,"metadata":null,"text":"And the grail are these functions: bpf_store_hdr_opt and bpf_load_hdr_opt! Both belong to a special type of sock ops programs, both are available since kernel 5.10 meaning almost any distro after the year 2022. A sock ops program is a single function attached to cgroup v2, which allows to enable it only for some sockets (e.g. belonging to a specific container). The program receives a single operation, which is used to indicate current state of a socket. When we want to write a new header option we first need to enable writing for active or passive connections, then we need to tell the length of a new header and only then to write header payload. Reading is simpler, but too, we need to enable reading feature first and then to read the header option. TCP header callbacks are called when TCP packet is created. This happens before address translation, so we can just copy socket source address into a header option. The reader can easily extract value from a header option and store in BPF map so later the consumer can read and map from the observed remote address to the real one. The BPF part of the first running code is well under 100 lines. Quite impressive!","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":35,"end":52,"href":"https:\u002F\u002Febpf-docs.dylanreimerink.nl\u002Flinux\u002Fhelper-function\u002Fbpf_store_hdr_opt\u002F","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":57,"end":73,"href":"https:\u002F\u002Febpf-docs.dylanreimerink.nl\u002Flinux\u002Fhelper-function\u002Fbpf_load_hdr_opt\u002F","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":108,"end":116,"href":"https:\u002F\u002Febpf-docs.dylanreimerink.nl\u002Flinux\u002Fprogram-type\u002FBPF_PROG_TYPE_SOCK_OPS\u002F","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":35,"end":52,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":832,"end":858,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_50":{"__typename":"Paragraph","id":"748764c14030_50","name":"c9f5","type":"H4","href":null,"layout":null,"metadata":null,"text":"Making the code production-ready","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_51":{"__typename":"Paragraph","id":"748764c14030_51","name":"d176","type":"P","href":null,"layout":null,"metadata":null,"text":"The evil is in details though. First of all, we need a way to delete old records from BPF map. The best time to do this is when conntrack module removes connection from its table. This post from Arthur Chiao describes very well the internals of conntrack module and connection life cycle, so it is easy to find the right function in kernel sources — nf_conntrack_destroy. This function receives a conntrack entry right before it is removed from the internal table. And since this is the time when a connection officially ended we can also add a probe that will remove the connection from our mapping table too.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":185,"end":189,"href":"http:\u002F\u002Farthurchiao.art\u002Fblog\u002Fconntrack-design-and-implementation\u002F","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":350,"end":370,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_52":{"__typename":"Paragraph","id":"748764c14030_52","name":"6bcc","type":"P","href":null,"layout":null,"metadata":null,"text":"In sock ops program we do not specify into which packets to inject a new header option assuming it to work for all packets. And in fact it is, but reading works only when a connection is in established\u002Fconfirmed state, meaning that a server side cannot read header option from an incoming SYN packet. SYN-ACKs are also handled before a regular TCP stack and it is not possible neither to inject header options, nor to read them. Effectively the feature works on both ends only when a connection fully operational with the first PSH (data packet). This is absolutely fine for working connections, but if connection attempt fails, then the client doesn’t know where it tried to connect. This is quite a crucial miss; this information would be useful to debug network failures. As we learned, the Kubernetes load balancing is implemented at a client node, so we can extract information from conntrack and store it in the same format as data received through a flow. Conntrack function __nf_conntrack_confirm is here to help — it is called when a new connection is about to be confirmed, for active client (outgoing) TCP connections this happens right with the first sent SYN packet.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"EM","start":667,"end":672,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":982,"end":1004,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_53":{"__typename":"Paragraph","id":"748764c14030_53","name":"f74b","type":"P","href":null,"layout":null,"metadata":null,"text":"With all these additions the code becomes a bit fatter, but still well under 1000 lines in total. Full patch is available in this MR. Time to enable it in our experimental setup and check metrics and topology again!","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":125,"end":132,"href":"https:\u002F\u002Fgitee.com\u002Fopeneuler\u002Fgala-gopher\u002Fpulls\u002F778","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:748764c14030_54":{"__typename":"Paragraph","id":"748764c14030_54","name":"1ce9","type":"P","href":null,"layout":null,"metadata":null,"text":"Et voilà:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*TyNE36F-CrXkMx6ru9aWew.png":{"__typename":"ImageMetadata","id":"1*TyNE36F-CrXkMx6ru9aWew.png","originalHeight":585,"originalWidth":902,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:748764c14030_55":{"__typename":"Paragraph","id":"748764c14030_55","name":"5257","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*TyNE36F-CrXkMx6ru9aWew.png"},"text":"A and B application topology made right","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Tag:kubernetes":{"__typename":"Tag","id":"kubernetes","displayTitle":"Kubernetes","normalizedTagSlug":"kubernetes"},"Tag:ebpf":{"__typename":"Tag","id":"ebpf","displayTitle":"Ebpf","normalizedTagSlug":"ebpf"},"Tag:distributed-tracing":{"__typename":"Tag","id":"distributed-tracing","displayTitle":"Distributed Tracing","normalizedTagSlug":"distributed-tracing"},"Post:c78cb88b2cb1":{"__typename":"Post","id":"c78cb88b2cb1","collection":null,"content({\"postMeteringOptions\":{}})":{"__typename":"PostContent","isLockedPreviewOnly":false,"bodyModel":{"__typename":"RichText","sections":[{"__typename":"Section","name":"31a3","startIndex":0,"textLayout":null,"imageLayout":null,"backgroundImage":null,"videoLayout":null,"backgroundVideo":null}],"paragraphs":[{"__ref":"Paragraph:748764c14030_0"},{"__ref":"Paragraph:748764c14030_1"},{"__ref":"Paragraph:748764c14030_2"},{"__ref":"Paragraph:748764c14030_3"},{"__ref":"Paragraph:748764c14030_4"},{"__ref":"Paragraph:748764c14030_5"},{"__ref":"Paragraph:748764c14030_6"},{"__ref":"Paragraph:748764c14030_7"},{"__ref":"Paragraph:748764c14030_8"},{"__ref":"Paragraph:748764c14030_9"},{"__ref":"Paragraph:748764c14030_10"},{"__ref":"Paragraph:748764c14030_11"},{"__ref":"Paragraph:748764c14030_12"},{"__ref":"Paragraph:748764c14030_13"},{"__ref":"Paragraph:748764c14030_14"},{"__ref":"Paragraph:748764c14030_15"},{"__ref":"Paragraph:748764c14030_16"},{"__ref":"Paragraph:748764c14030_17"},{"__ref":"Paragraph:748764c14030_18"},{"__ref":"Paragraph:748764c14030_19"},{"__ref":"Paragraph:748764c14030_20"},{"__ref":"Paragraph:748764c14030_21"},{"__ref":"Paragraph:748764c14030_22"},{"__ref":"Paragraph:748764c14030_23"},{"__ref":"Paragraph:748764c14030_24"},{"__ref":"Paragraph:748764c14030_25"},{"__ref":"Paragraph:748764c14030_26"},{"__ref":"Paragraph:748764c14030_27"},{"__ref":"Paragraph:748764c14030_28"},{"__ref":"Paragraph:748764c14030_29"},{"__ref":"Paragraph:748764c14030_30"},{"__ref":"Paragraph:748764c14030_31"},{"__ref":"Paragraph:748764c14030_32"},{"__ref":"Paragraph:748764c14030_33"},{"__ref":"Paragraph:748764c14030_34"},{"__ref":"Paragraph:748764c14030_35"},{"__ref":"Paragraph:748764c14030_36"},{"__ref":"Paragraph:748764c14030_37"},{"__ref":"Paragraph:748764c14030_38"},{"__ref":"Paragraph:748764c14030_39"},{"__ref":"Paragraph:748764c14030_40"},{"__ref":"Paragraph:748764c14030_41"},{"__ref":"Paragraph:748764c14030_42"},{"__ref":"Paragraph:748764c14030_43"},{"__ref":"Paragraph:748764c14030_44"},{"__ref":"Paragraph:748764c14030_45"},{"__ref":"Paragraph:748764c14030_46"},{"__ref":"Paragraph:748764c14030_47"},{"__ref":"Paragraph:748764c14030_48"},{"__ref":"Paragraph:748764c14030_49"},{"__ref":"Paragraph:748764c14030_50"},{"__ref":"Paragraph:748764c14030_51"},{"__ref":"Paragraph:748764c14030_52"},{"__ref":"Paragraph:748764c14030_53"},{"__ref":"Paragraph:748764c14030_54"},{"__ref":"Paragraph:748764c14030_55"}]},"validatedShareKey":"","shareKeyCreator":null},"creator":{"__ref":"User:7766bf7322ef"},"inResponseToEntityType":null,"isLocked":false,"isMarkedPaywallOnly":false,"lockedSource":"LOCKED_POST_SOURCE_NONE","mediumUrl":"https:\u002F\u002Fmedium.com\u002F@shakhat\u002Fbuilding-a-network-topology-of-a-kubernetes-application-in-a-non-intrusive-way-c78cb88b2cb1","primaryTopic":null,"topics":[{"__typename":"Topic","slug":"programming"}],"isPublished":true,"latestPublishedVersion":"748764c14030","visibility":"PUBLIC","postResponses":{"__typename":"PostResponses","count":0},"createdAt":1713731122855,"firstPublishedAt":1714129534654,"latestPublishedAt":1714136571799,"clapCount":1,"allowResponses":true,"isLimitedState":false,"title":"Building a network topology of a Kubernetes application in a non-intrusive way","isSeries":false,"sequence":null,"uniqueSlug":"building-a-network-topology-of-a-kubernetes-application-in-a-non-intrusive-way-c78cb88b2cb1","socialTitle":"","socialDek":"","noIndex":null,"canonicalUrl":"","metaDescription":"","readingTime":12.227672955974842,"previewContent":{"__typename":"PreviewContent","subtitle":"A magic of eBPF code propagating peer address right in TCP flow to reconstruct communication topology"},"previewImage":{"__ref":"ImageMetadata:1*9g2pQdW-TrZRxVKGAIUojQ.png"},"isShortform":false,"seoTitle":"","updatedAt":1714136577522,"shortformType":"SHORTFORM_TYPE_LINK","seoDescription":"A magic eBPF code propagating peers' addresses inside TCP flows to reconstruct full network topology of applications running in Kubernetes","isSuspended":false,"license":"ALL_RIGHTS_RESERVED","tags":[{"__ref":"Tag:kubernetes"},{"__ref":"Tag:ebpf"},{"__ref":"Tag:distributed-tracing"}],"isNewsletter":false,"statusForCollection":null,"pendingCollection":null,"detectedLanguage":"en","wordCount":2940,"layerCake":0}}</script><script>window.__MIDDLEWARE_STATE__={"session":{"xsrf":""},"cache":{"cacheStatus":"HIT"}}</script><script src="https://cdn-client.medium.com/lite/static/js/manifest.c53a8946.js"></script><script src="https://cdn-client.medium.com/lite/static/js/3057.5e22bbb0.js"></script><script src="https://cdn-client.medium.com/lite/static/js/main.7915f6f6.js"></script><script src="https://cdn-client.medium.com/lite/static/js/instrumentation.5e7f2981.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/reporting.2021fe63.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/4398.db4d4378.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/7883.0e445e04.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/9281.e9be8bce.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/7111.1421aaa2.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/6481.e3e8b67f.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/8695.17d1af21.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/6358.a78f5809.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/4341.e697d2a1.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/5971.fd9e1c6f.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/5203.e7a22052.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/5514.6018be2b.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/7098.7bbb418a.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/5700.db05a33f.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/8491.7fa46461.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/8597.86d62990.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/1711.b70f1a35.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/9174.244cf6ba.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/8883.c8b03d13.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/705.da9267d6.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/5781.39279ff8.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/8580.feeb2549.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/6046.f9be485b.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/6605.84e81b15.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/500.596a9584.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/9408.9f41b422.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/6637.8a411a8c.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/8565.ce53d42b.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/4667.993ebc2b.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/PostPage.MainContent.793c1f2c.chunk.js"></script><script>window.main();</script></body></html>