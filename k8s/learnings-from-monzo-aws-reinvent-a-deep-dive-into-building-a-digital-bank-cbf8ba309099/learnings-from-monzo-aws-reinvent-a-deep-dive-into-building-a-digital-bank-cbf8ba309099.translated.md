## 从 Monzo 汲取的经验：AWS re:Invent 深入了解数字银行的构建

让我们来窥探一下 Monzo 的世界，这是一家拥有约 800 万个账户的数字银行，主要位于英国。当他们达到 400 万客户时，基础设施和可靠性团队中只有八位技术人员在 AWS 上运行该服务。

我观看了 [视频](https://www.youtube.com/watch?v=NTgB2z0E9ZU) 并阅读了 Monzo 的 [案例研究](https://aws.amazon.com/solutions/case-studies/Monzo/)，以下是从中提取的关键要点。我添加了“先决条件”和进一步阅读主题中的引号。

本文分为两部分，对于那些想要快速了解的人来说，TL;DR 涵盖了内容要点，但如果你想获得更深入的解释，那么下一部分将满足你的需求。

*注意：* *大多数屏幕截图来自上述链接。*

## TL;DR

简而言之，截至 2019 年，该设置正在运行 1500 个微服务和约 9000 个 Pod。

**基础设施概述 — **以下是支付系统的工具和系统架构

**数据中心 (DC)** 处理传入请求，这些请求被重定向到在 **计算** [Kubernetes](https://kubernetes.io/) 上运行的微服务。

*数据存储：* [Apache Cassandra](https://cassandra.apache.org/_/index.html) 和 AWS S3 用于持久数据存储

*监控和警报：* [Prometheus](https://prometheus.io/docs/introduction/overview/) 用于监控和 [Thanos](https://thanos.io/) 的无限保留

*分布式锁定和协调：* [etcd](https://etcd.io/) 集群

*有序排队：* [Apache Kafka](https://kafka.apache.org/)

*无序排队和事件发布：* [NSQ](https://nsq.io/)

当发起付款请求时会发生什么？

- 卡片使用请求从支付提供商发送到 Monzo 的 DC。
- 然后将请求传输到 AWS，并且一些请求需要使用 etcd 的锁定机制。同时，一些请求将通过 Kubernetes 计算集群发送到 Cassandra 集群以获取数据。
- 如果交易获得批准，则发送回响应。

## 深入了解

将讨论 Monzo 支付系统的六个方面

- 数据中心
- 计算
- 数据存储
- 消息传递
- 锁定
- 监控

最后，是整个请求-响应过程。

### 1. 数据中心

什么是 AWS Direct Connect？

它充当内部网络（本地）到 AWS Direct Connect 位置（AWS 服务，例如 Amazon S3 或 Amazon VPC）之间的桥梁。

数据中心的需求源于支付提供商（如 [万事达卡](https://www.mastercard.co.uk/en-gb/html) 和 [Faster Payments](https://www.starlingbank.com/resources/banking/guide-to-faster-payments/)）的限制，它们专门提供光纤，并且缺乏与云提供商的集成能力。

**请求流：**

*来自服务提供商的入口：* 旅程从服务提供商发来的入站消息开始。

*Monzo 的数据中心：* 消息遍历 Monzo 的数据中心，在那里它经过加密并通过 AWS Direct Connect 进入虚拟专用网络 (VPN)。

- 最终到达 Kubernetes(K8s)集群，在那里它得到身份验证并通过多个微服务。

**响应：** 它遵循类似的反向路径并返回到终端。

如果你想知道 Monzo 如何保护其应用程序以符合 IP 规定，你可以阅读这篇文章 — [我们如何保护 Monzo 的银行平台](https://monzo.com/blog/2022/03/31/how-we-secure-monzos-banking-platform)。

### 2. 计算

如前所述，截至 2019 年，有 1500 个微服务和约 9000 个 Pod 在生产中，主要在单一区域 eu-west-1 中。

问题出现了：他们如何能够在集群中运行如此多的节点？

- 它归结为一个原因 — 一致性。在各个团队中，公司坚持语言、设计模式和基础设施的统一性。这使得能够无缝地编排大量节点。
- 此外，所有代码都是用 Go 编写的，这有助于减小 Docker 镜像大小并加快容器创建过程。

在此背景下，下面不是神经网络，而是微服务在同一天运行和通信。

Shipper 是 Monzo 使用的工具，用于构建、验证和向集群推出部署。

典型的部署命令如下所示，并且一天内会执行数百个类似的部署。

**使用 Envoy 进行服务发现**

Envoy：作为一种多功能软件，充当服务代理/网格，以管理和监督服务网格内所有服务的入站和出站流量。

- 由于有许多部署，因此设计一种机制让服务彼此查找和通信变得很重要，这是使用 Envoy 和称为 Envoy 配置提供程序的自定义逻辑解决的。
**1. 配置**

- 配置提供程序监视 K8s API 服务器中的状态更改，随后它编排所有代理进程的更新，并让它们知道在哪里可以找到什么。

**2. 数据存储**

**Cassandra 如何工作？**

Cassandra 作为无主分布式数据库运行，它具有连接成环的节点 ⇒ 数据跨越这些互连的环。
读取等操作使用负载均衡机制（如循环）进行，并且客户端对数据的实际位置一无所知。
[此处](https://cassandra.apache.org/doc/latest/architecture/index.html)了解更多

帐户数据存储在 NoSQL Cassandra 数据库中，所有日志存档都存储在 S3 存储桶中。它在 Ec2 实例上在 K8s 集群外部运行。

为了微调数据库的响应时间和一致性，复制和仲裁机制发挥了作用。例如，如果需要更快的响应，调整复制因子就成为策略，尽管了解到这可能会以降低一致性为代价。

深入研究团队的常规实践，某些练习涉及一次重新启动一个节点的数据库集群。此故意操作作为试金石测试，评估数据库在实际场景中的弹性和稳健性。

**3. 消息传递**

**什么是事件驱动架构？**

一种范例，其中系统的不同组件通过事件相互通信。事件可以是系统中需要关注的任何事件或更改。这些事件可以由用户、应用程序或外部系统生成。

许多计算工作都是异步的，例如事件驱动架构，因此引入了消息传递系统。在此系统中，Kafka 用于有序排队，而 NSQ 用于无序和事件发布场景。这些线程提供了有关 Kafka 与 NSQ 的有趣内容（
[link1](https://news.ycombinator.com/item?id=14455919)，[link2](https://gcore.com/learning/nats-rabbitmq-nsq-kafka-comparison/))

推送通知是使用异步消息传递的一种场景。每当客户成功购买或供应商请求批准付款时，都会立即向客户的应用程序发送通知。

**4. 锁定**

**什么是 AWS I3 实例？**

Amazon EC2 I3 实例是针对高事务、低延迟工作负载的存储优化实例。I3 实例为 NoSQL 数据库、内存数据库、数据仓库、Elasticsearch 和分析工作负载等工作负载提供良好的每 I/O 性能价格。

**什么是 etcd？**

分布式、高可用、键值存储。高吞吐量和低延迟锁定。它的工作方式类似于 Cassandra，但与前者不同，它有一个主选择过程。

鉴于分布式特性，在某些情况下，互斥和锁定变得势在必行。在此，
**etcd** 提供分布式锁定功能。如果没有适当的锁定，并发修改可能导致数据不一致或损坏。锁定确保一次只有一个进程可以修改数据，从而保持其完整性。

此外，在 AWS I3 基础设施上运行设置可确保更好的性能。

**5. 监控**

Prometheus 是一个时间序列数据存储和查询引擎，Thanos 是一个高可用 Prometheus 设置，提供无限保留功能。

**Sidecar 模式：**

Sidecar 模式是微服务架构中使用的一种设计模式。它涉及在主应用程序旁边运行一个单独的进程或容器以增强其功能。可以把它想象成连接到摩托车上的边车；边车为摩托车提供了附加功能。[了解更多](https://www.nginx.com/blog/sidecar-pattern-microservices/)

Prometheus 被“*共享*”到各个功能域，每个域有两个副本以处理故障，收集的时间序列数据是“*临时*”（仅存储 24 小时）。这为监控系统提出了两个要求。

- 用户需要一种轻松查询日志的方法，最好是集中查询以实现全面的搜索功能。
- 日志应保存超过 24 小时。

**解决方案 — Thanos 作为 Prometheus 服务器的边车**

- 使用 Thanos 将多个 Prometheus 服务器的查询搜索模拟为一个查询。它使用 Thanos 查询，该查询会扇出到所有边车应用程序，检索请求数据的所在位置，即并行搜索请求的数据。
- 为了满足第二个要求，Thanos 会定期采取措施，将数据保存到 S3 存储桶，确保存储库超过 24 小时的时间范围

除此之外，系统还会监控一系列指标，如请求指标、低级系统指标、业务逻辑、社交媒体趋势等。因此，使用 Prometheus 创建了各种警报管理器来检测异常并观察趋势。

我相信您会发现此探索很有用，请在评论中分享您的想法和反馈；您的见解非常宝贵。