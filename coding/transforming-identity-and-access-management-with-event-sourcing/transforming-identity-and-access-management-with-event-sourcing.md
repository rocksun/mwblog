
<!--
title: 利用事件溯源转换身份和访问管理
cover: https://cdn.thenewstack.io/media/2024/02/af087d1b-monarch-5093898_1280.jpg
-->

在数字领域，管理谁可以访问什么是一件大事，而健壮的端到端身份基础设施的基础成为项目的一个关键组成部分。作为此基础设施基石的身份和访问管理 (IAM) 系统充当数字门卫，精心管理谁可以访问什么。

> 译自 [Transforming Identity and Access Management with Event Sourcing](https://thenewstack.io/transforming-identity-and-access-management-with-event-sourcing/)，作者 Dakshitha Ratnayake。

它们不仅仅是守卫入口；它们还确保正确的人在正确的时间拥有正确的访问权限。但是，许多 IAM 系统缺失了以下功能：在用户进入后保留其详细活动记录。想象一下一个不仅知道谁进来了，还记得他们在里面做的每一个动作的保镖。这就是事件溯源发挥作用的地方，它在 IAM 领域是一个改变游戏规则的因素。

虽然至关重要，但许多 IAM 系统尚未利用事件溯源的全部潜力。此集成不仅仅是一个附加功能；对于任何 [认真对待数字安全的组织](https://thenewstack.io/zeronorth-one-risk-based-view-for-all-an-organizations-security-tools/)来说，它都是一项至关重要的升级。通过事件溯源，IAM 系统获得了无与伦比的洞察力和控制力。这种方法不仅对于故障排除非常宝贵，而且还提供了对用户行为和系统交互的更深入理解。

## 事件溯源用于 IAM 中的完整性和合规性

将 [事件溯源](https://martinfowler.com/eaaDev/EventSourcing.html) 视为捕获和存储用户执行的每个操作作为事件，然后按时间顺序存储在序列中。事件不仅仅是被动条目，而是被视为一流的数据库对象，代表系统的核心事实。这种方法标志着与传统日志的重大背离，传统日志只是记录活动。

相反，事件溯源中的事件主动定义系统在任何给定时刻的状态。如果事件没有发生，则状态实际上不会改变。如果出现问题，您可以通过这些事件追溯到事情失控的地方。

然后，系统可以生成一个审计跟踪，该跟踪涉及如何呈现和访问这些事件（或其中的一部分）以供审查。这是记录的事件可用于审计、安全分析和合规性检查的机制。在当今数据泄露与咖啡溢出一样普遍的世界中，拥有健壮的 [审计跟踪不仅仅是一种安全](https://thenewstack.io/15-considerations-for-your-next-cloud-native-security-audit/) 措施。它提供了透明度和问责制，向利益相关者表明您的组织不仅仅谈论数据安全，它还制定了数据安全。

本质上：

- **事件溯源**：一种架构模式，将数据作为上下文事件持久化到仅追加日志中，而不是当前状态。
- **审计跟踪**：审计日志是捕获软件系统中发生的事件或事务的详细记录。它们提供了对系统所做所有更改的详细历史记录，包括谁进行了更改、何时进行更改以及更改了什么。

在 IAM 系统中，事件溯源将持续捕获所有状态更改，作为与用户 [身份和访问](https://thenewstack.io/red-hats-keycloak-identity-access-management-bids-to-join-cncf/) 权限相关的事件。

## 在事件溯源 IAM 系统中发生的情况

以在线零售平台为例。通过事件溯源，客户执行的每个操作，从注册、逐步完成登录过程、更新用户个人资料、重置密码到通过受保护的 API 调用进行身份验证的请求（例如进行购买），都会被跟踪。

这种精确的记录有助于企业构建全面的客户档案、发现趋势并更有效地定制用户体验。事件溯源确保数据完整性。如果客户对交易有争议，企业可以快速查阅事件日志以验证详细信息。它还增强了安全性。异常模式（例如重复的登录失败尝试）会被标记，有助于防止欺诈和未经授权的访问。

随着 GDPR 等法规要求严格的数据处理，审计跟踪提供了用户同意和偏好的透明记录。想象一下客户更改其通信偏好；审计跟踪捕获此更改，确保企业尊重客户的意愿并遵守法律。

## ZITADEL 如何实施事件溯源

如上所述，事件溯源和审计跟踪的集成可以将标准 IAM 系统转变为一个健壮、以安全为重点的强大系统。这正是[ZITADEL](https://zitadel.com/)，一个[开源身份和访问管理解决方案](https://github.com/zitadel/zitadel)，从一开始就决定实施事件溯源。

## 事件溯源和 CQRS 的融合

[ZITADEL 的软件架构](https://zitadel.com/docs/concepts/architecture/software)因其集成了事件溯源和[命令和查询职责分离 (CQRS)](https://martinfowler.com/bliki/CQRS.html)而脱颖而出。CQRS 的重点是将任何系统的两个主要关注点分开——写操作（命令）和读操作（查询）。这种划分允许每个功能独立且最优地运行，而不会相互干扰，这种模式巧妙地承认添加和更新数据的方式不一定是最适合检索数据的方式。

ZITADEL 的架构经过战略性设计，最终实现一致性，利用事件溯源和 CQRS 的优势来维护一个[事件存储](https://zitadel.com/docs/concepts/eventstore/overview)，它是所有计算状态的权威存储库，并通过事务安全性进行维护，以确保操作的有序执行。

需要注意的是，虽然系统[确保了整体最终一致性](https://thenewstack.io/ensure-consistency-in-hybrid-clouds-with-amazon-web-services-eks-d-and-istio/)，但由各个 ID 执行的操作始终如一地处理，确保了可靠性和准确性。此区别主要适用于在最终一致性模型下管理的列表操作。

事件存储遵循事件溯源模式，将 ZITADEL 中的每个操作勤勉地记录为一个事件。这允许 ZITADEL 构建用户交互和系统更改的时间顺序分类帐，提供广泛的审计跟踪。捕获并保留每个用户注册、身份验证尝试或权限更改，确保可以在任何时间点重建任何资源的状态。

这与依赖于写入日志的其他系统形成对比，由于系统分离以及 IAM 系统中存储的内容与记录的内容之间可能存在差距，因此确保日志的完整性具有挑战性。此外，用户可以通过 ZITADEL 的多功能[事件 API](https://zitadel.com/docs/guides/integrate/event-api)无缝查询审计跟踪。

作为对事件溯源的补充，CQRS 模式将 ZITADEL 的读写操作分开，从而提高了系统的可扩展性和性能。写端或 CQRS 的“命令”部分处理系统中的所有状态更改操作，将每个命令通过严格验证以确保事务安全性和系统一致性。

另一方面，“查询”方面处理所有数据检索请求，即使在负载高峰期间也能优化速度和可靠性。

## ZITADEL 软件架构概述

为了充分理解机制，了解一些关键术语至关重要：

**事件**：表示系统中动作的发生，这些动作被永久记录。事件构成系统当前状态的基础。数据的当前[状态](https://thenewstack.io/how-kubernetes-stateful-data-management-can-work/)是所有事件的聚合。此累积过程确保摘要始终反映最新状态，以下是可能发生的事件：

- user.added
- user.changed
- project.added
- user.password.checked

**聚合**：相关事件的集合，共同确定对象的​​状态，例如[用户](https://zitadel.com/docs/concepts/structure/users)、[组织](https://zitadel.com/docs/concepts/structure/organizations)、[项目](https://zitadel.com/docs/concepts/structure/projects)等。它们充当事务边界。

**投影**：从事件日志派生的计算对象。这些对象针对读操作和查询进行了优化。投影提供了一种更有效的方式来访问各种实体（如用户列表、项目、身份验证请求等）的当前状态信息，而不是每次从事件日志中重建状态，可以通过搜索来实现。

![](https://cdn.thenewstack.io/media/2024/02/d2968e54-zit1.png)

*图像 1：ZITADEL 的软件架构*

### 前端层

ZITADEL 将所有必需组件封装在每个二进制文件中，简化了操作。这种一体化方法包括提供 API、呈现 GUI 以及处理事件和任务的后台处理（用 Go 编写的抽象层，将事件存储的所有功能封装在业务逻辑之外）。业务逻辑仅通过推送和过滤功能与事件交互。

### 服务层

ZITADEL 公开了所有可能与消费者交互的组件，包括：

- 用于管理 ZITADEL 控制台和提供静态资产的 HTTP 服务器
- API 服务器，包括 OpenID Connect、OAuth、SAML、身份验证、管理、系统和资产 API，支持 gRPC 和 REST 等各种协议

### 核心层

- 命令处理程序处理所有更改资源的操作，生成必要的命令进行验证。此阶段确保在创建反映更改的事件之前，每个操作（例如用户名更改）都是合法的。
- 然后，这些事件通过内存中发布-订阅系统或通过后台处理的后台处理程序实时处理。发布-订阅系统使查询视图保持最新，后台处理程序确保事件存储库后面不会出现重大延迟。
- ZITADEL 中的投影规范化 [用于查询或分析的数据](https://thenewstack.io/apache-flink-for-real-time-data-analysis/)，由后台处理程序或发布-订阅系统调用。它们生成存储在查询视图及其存储层中的规范化对象。
- 然后，查询处理程序处理所有读取请求，提供快速的响应时间和高可用性。

### 存储层

存储层对于像 ZITADEL 这样的无状态系统至关重要，它负责跨服务器、数据中心或区域的数据分发，确保命令的强一致性和最佳查询性能。事件存储机制取决于所使用的数据库类型，尤其是在处理不同数据库时，因为它们处理提交时间戳的方式不同。这对事件的顺序有影响，这是事件溯源的关键方面。ZITADEL 偏爱 [PostgreSQL](https://www.postgresql.org/)，因为它符合平台的需求，提供数据驻留选项和灾难恢复功能。

## 浏览审计跟踪

用户可以通过 ZITADEL 的[控制台](https://zitadel.com/docs/guides/manage/console/overview)和[事件 API](https://zitadel.com/docs/guides/integrate/event-api)访问事件数据。这提供了所有存储事件的完整视图，允许根据用户的需要进行自定义和过滤。事件数据对各种角色都有好处，例如可以跟踪其登录活动的最终用户，或可以监控用户活动以做出明智决策（例如扩展资源或调查安全事件）的管理员。

## 控制台视图

### 最近更改视图

在控制台中，用户可以查看对象（例如用户配置文件、组织或项目）的最新更改，从而立即了解最近的修改。

**管理员的事件视图**

管理员可以在控制台中直接过滤和查看实例中的所有事件，从而确保全面监督。

**事件 API**

对于编程方法，ZITADEL 的事件 API 允许完全 [访问所有事件和审计数据](https://thenewstack.io/a-look-at-datastaxs-ai-and-push-cache-for-data-access-at-scale/)，从而能够与自定义业务逻辑集成。

该 API 公开了各种类型的事件数据，包括聚合类型（例如用户、组织）和事件类型，它们描述了发生的特定操作。例如，使用搜索端点，管理员用户可以基于特定过滤器（例如序列号、事件类型、聚合 ID 等）查询和检索事件列表。这些详细的事件数据提供了对 ZITADEL 中的操作和状态更改的见解。

此外，用户可以使用事件 API 将数据导入外部系统。此外，ZITADEL 提供了将事件写入 stdout 以作为日志处理的灵活性，甚至可以通过 HTTP 请求直接将事件发送到外部工具，尽管由于潜在的反压和增加的处理时间，不建议这样做。

**ZITADEL 事件存储的关键优势和用途**
**历史见解：**

对于审计或分析，选择特定时间范围内的事件可以提供对过去变更的详细见解。ZITADEL 允许用户查看历史上的任何给定时间点的资源，这要归功于其独特的数据存储方法。人们可以在系统的整个状态的上下文中查看过去的数据。

**未来预测：**

自安装以来重播事件的能力促进了使用新业务逻辑轻松计算未来预测。为了加强用户帐户安全性，ZITADEL 用户可以利用其事件存储来训练预测模型。这些模型旨在主动识别和防止潜在攻击，从而增强整体帐户保护。

## 正在进行的增强

**指标和标准报告：**

ZITADEL 计划提供简化的报告以获得更好的见解。需要仪表板和报告来跟踪用户活动、应用程序请求、合规性、登录违规、威胁和审计跟踪查询。该列表还包括但不限于访问日志、执行日志和 CPU/内存使用等底层组件。查询可以包括每个客户端/项目的登录失败、身份验证失败的顶级用户、最活跃的身份提供商、上次执行日志等等。

**新 API：**

将提供一个指标 API 以便于访问仪表板和报告，以及一个审计 API 以一次过滤多个资源。这些功能包括将事件流式传输到指标模型，允许时间维度和指标，如用户注册、成功登录和登录失败。路线图中还包括用于二进制运行时指标的可抓取端点、用于时间序列的 Prometheus 兼容 API 和 LogQL 兼容 API。

**反馈循环和威胁检测：**

ZITADEL 将为客户端的最终用户提供对其事件日志的访问权限，使他们能够识别和报告任何异常活动。即将推出的功能不仅设计用于手动报告，还设计用于训练高级 AI 模型。这些模型将主动监控和标记异常行为，包括对历史事件发出警报的能力。主要功能将包括用户标记可疑事件、通知用户或敏感操作的管理人员、生成全面的系统范围审计报告、创建基于规则的审计事件以及在检测到异常活动时实施更严格的身份验证措施。这种 AI 驱动的做法旨在主动识别潜在威胁，确保 ZITADEL 内更强大、更具响应性的安全框架。

## 总结

IAM 中的事件溯源对于企业来说是一个改变游戏规则的因素，因为它提供了用户行为和交易的详细且不可更改的历史记录，这对于理解和管理身份至关重要。通过事件溯源以及 CQRS，IAM 解决方案可以维护详细的审计跟踪，远远超过传统系统。由事件溯源促成的内置审计跟踪不仅仅是一个功能；它是对透明性和完整性的承诺。通过仔细附加每个事件和更改，IAM 系统确保用户可以信任其数据的准确性，自信地深入了解其历史记录，并利用全面的见解进行未来发展。

## 关于 ZITADEL

[ZITADEL](https://zitadel.com/) 是一款开源身份和访问管理 (IAM) 解决方案，旨在增强应用程序和服务的安全性。它支持各种授权策略，包括基于角色的访问控制 (RBAC) 和委派访问，使其成为面向消费者和面向企业的场景的理想选择。ZITADEL 提供基于云的 SaaS 选项，也可以下载进行自托管，提供灵活性。其主要目标是提供无缝的身份验证和授权、促进审计、启用自定义扩展、遵守 OIDC/OAuth/SAML/LDAP 等标准，并确保易于操作和可扩展性。社区和 [团队积极为其开发做出贡献](https://thenewstack.io/managing-software-development-team-dynamics-from-within/) 和提供支持，使其成为身份管理领域的一款强大工具。

## 延伸阅读

[YOUTUBE.COM/THENEWSTACK](https://youtube.com/thenewstack?sub_confirmation=1)

技术发展迅速，不要错过任何一集。订阅我们的 YouTube 频道以流式传输我们所有的播客、访谈、演示等。