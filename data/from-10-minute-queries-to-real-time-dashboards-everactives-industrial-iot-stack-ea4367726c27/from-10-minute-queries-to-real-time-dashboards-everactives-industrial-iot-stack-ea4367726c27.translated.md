# 从 10 分钟查询到实时仪表板：Everactive 的工业物联网堆栈

Everactive 使用 Timescale 替换了脆弱的 OpenTSDB 设置，以简化其堆栈并在数千个无电池物联网传感器上扩展实时分析。他们从六个数据库减少到三个，将查询延迟从 10 分钟降至亚秒级，现在在一个地方管理关系数据和时间序列数据，从而减少了崩溃、降低了开销并提高了性能。

**TL;DR：**

*这是我们的“社区成员聚焦”系列文章，我们邀请客户分享他们的工作，展示他们的成功，并通过使用新技术解决问题的新方法来激励他人。*

*在本期中，来自 Everactive 的 **Carlos Olmos**、**Dan Wright** 和 **Clayton Yochum** 与我们分享了他们如何将分析和实时设备监控带到以前不可能的场景和地点。了解他们如何设置数据堆栈（从六个实例减少到仅三个实例）、他们的数据库评估标准、他们对其他开发人员的建议等等。*

# 关于公司

[Everactive](https://everactive.com/) 结合了无电池、自供电传感器和强大的云分析，为我们的客户提供“端到端”的超大规模物联网解决方案。我们公司正在经历一场巨大的转型，从只关注工业监控服务（[阅读更多关于工业物联网的信息](https://en.wikipedia.org/wiki/Industrial_internet_of_things)）到向开发人员开放我们的平台，他们可以利用我们的技术来创建自己的解决方案和服务。

构建一个平台并不容易，更不用说构建一个开放平台了。灵活性和稳定性是关键因素。到目前为止，我们发现通过 Timescale（以及底层的 PostgreSQL），我们已经能够调整我们的数据模型和数据服务需求，以实现平台的新用例，而不会感到痛苦。

我们内部设计和制造我们的传感器（直至芯片），它们经过加固以适应恶劣环境，并且可以从从热或光中收集的低能量水平无限期地运行。这意味着我们客户的设备可以持续传输资产健康数据，尽管存在无线电干扰和物理障碍（如设备、管道和管道），这在工业环境中很常见。

由于它们可以自行充电，因此这些传感器可以保持运行，远远超出传统的电池供电工业物联网设备的可能性。我们将来自数千个传感器的数据摄取到 Timescale 中，然后通过仪表板、图表和自动警报将其呈现给我们的客户。

我们的[初始产品](https://everactive.com/solutions/)旨在监控蒸汽系统，这些系统用于各种行业和应用，如过程制造、化学加工和区域能源，以及各种旋转设备，如电机、泵、风扇和压缩机。目前，我们为食品和饮料、消费品包装、化学过程工业、制药、纸浆和造纸以及设施管理等多个行业的大型财富 500 强制造商提供服务。

我们通过基于 Web 的仪表板向客户展示他们的数据，并且我们还有内部应用程序来帮助我们的内部领域专家审查和标记客户数据，以改进我们的自动故障检测。

# 关于团队

我们是一个由软件和数据工程师组成的小团队，横跨 Everactive 的云和数据科学团队。

我们之间拥有数十年的管理数据库、管道、API 和各种其他后端基础设施的经验。

# 关于项目

我们的主要区别在于我们的传感器是无电池的：定制的低功耗硅意味着可以将它们放置在更多地方，而无需在十年以上的时间内进行维修。

反过来，这意味着我们可以监控以前由于充电电池的困难或成本而导致传感器成本过高的工厂设备；能够*经济地*从更多设备收集数据也意味着我们的工业数据流比竞争对手的更详细，并且覆盖更多设备。

如今，客户将我们的传感器放置在疏水阀和电机上，我们捕获一系列指标，从简单的指标（如温度）到更复杂的指标（如 3D 振动数据。（您可以在[此概述视频](https://youtu.be/2M79gELukfU)中了解有关疏水阀系统以及对无电池系统需求的更多信息。）

*Everactive 的新一代传感器在野外，包括带有运输集装箱的液压臂上的传感器，以及下方，运输集装箱扣环上的传感器特写*

然后，我们使用这些数据来告知客户其工业系统的健康状况，以便他们可以在需要时采取行动。从这个意义上讲，“行动”可能意味着更换疏水阀、更换机器中的不良轴承或针对问题的各种其他解决方案。
例如，如果客户监控的设备发生故障，或者机器在应该启动时处于关闭状态，我们将自动提醒客户，以便他们可以派工作人员修复故障，或者远程启动机器。

除了接收来自我们的警报外，客户还可以随时使用我们的仪表板来查看其设备的最新数据和当前状态。

*Everactive 的一个仪表板，跟踪整体振动水平*

如前所述，我们的团队负责向我们的客户和内部领域专家提供这些直观的可视化效果，以及将传感器指标输入到我们的自定义分析中，以自动执行故障检测并改进我们的算法。

# 使用（和选择！）TimescaleDB

在使用 TimescaleDB 之前，我们将元数据存储在 PostgreSQL 中，并将传感器数据存储在 OpenTSDB 中。随着时间的推移，OpenTSDB 变得越来越慢且越来越脆弱。

我们的数据非常适合传统的关系数据库模型：我们在一个数据包中收集数十个指标，因此将它们存储在一起是有意义的。其他时序数据库会迫使我们将指标捆绑到 JSON blob 中（使其难以在数据库中使用），或者将每个指标单独存储（对于大多数感兴趣的查询，强制执行繁重而缓慢的连接）。

**TimescaleDB 是一个简单的选择，因为它让我们可以在 PostgreSQL 上加倍投入，我们已经喜欢使用它来处理有关数据包流的元数据。** 我们简要地研究了像 Influx 这样的竞争对手，但一旦明确 TimescaleDB 将超出我们的需求，我们就停止考虑它们。
我们的评估标准非常简单：它是否能满足我们的负载要求，以及我们是否能理解如何使用它？前者很容易通过经验进行测试，而后者本质上是“免费的”，因为 TimescaleDB “只是”一个 PostgreSQL 扩展。

这个“只是 PostgreSQL”的概念还允许我们仔细地将我们的模式作为代码进行管理，通过 CI/CD 管道测试和自动化更改。我们使用 [sqitch](https://sqitch.org/)，但流行的替代方案包括 [Flyway](https://flywaydb.org/) 和 [Liquibase](https://www.liquibase.com/)。我们喜欢 sqitch，因为它鼓励我们为每个迁移编写测试，并且是轻量级的（没有 JVM）。

我们之前使用过 [Alembic](https://alembic.sqlalchemy.org/en/latest/)，这是流行的 [SQLALchemy Python ORM](https://www.sqlalchemy.org/) 的迁移组件，但随着我们的 TimescaleDB 数据库增长到支持许多客户端，将我们的模式管理与任何一个客户端联系起来变得没有意义。

我们通过分离内部和外部模式来维护 TimescaleDB 中的抽象层。

> Timescale 在同一数据库中支持传统模式和时序数据的能力使我们能够整合到一个存储解决方案中

我们的数据以（超）表的形式存储在“packets”和“metadata”等内部模式中，但我们通过仅包含视图、函数和过程的“API”模式将它们暴露给客户端。这允许我们重构我们的数据布局，同时通过维护 API 契约来最大限度地减少下游系统的中断。这是关系数据库世界中一个众所周知的模式——TimescaleDB “仅仅”是一个 PostgreSQL 扩展的另一个优势。

# 当前部署和未来计划

*Everactive 仪表板的另一个例子*

我们使用 [Timescale](https://www.timescale.com/cloud) 并且喜欢它。我们已经在 Amazon RDS 上使用了 PostgreSQL，并且不想管理我们自己的数据库（OpenTSDB 说服了我们！）。

OpenTSDB 崩溃已经变得很正常，*每周多次*，原因是用户一次请求的数据量稍微过多。**TimescaleDB 显然比我们之前的 OpenTSDB 系统快得多。更重要的是，没有人让它崩溃过。**

我们看到的一个没有经过非常仔细的基准测试但性能大幅提升的例子？

我们有一个前端视图，需要来自所有传感器的最后一个数据点：在 OpenTSDB 中，它需要将近 10 *分钟*才能加载（由于 HBase 中难以修复的尾部延迟），而我们的第一个 TimescaleDB 部署将其缩短到大约 7 *秒*。对我们的模式和访问模式的进一步改进已将这些查询带入亚秒级范围。

> 我们将这些模式从 Amazon RDS for PostgreSQL 迁移到 Timescale。迁移非常简单：在 PostgreSQL 模式之间移动非常简单

即使在数据量增长的情况下，我们也能够保持亚秒级的响应：这对我们来说非常好。此外，由于压缩和[连续聚合](https://www.timescale.com/blog/an-incremental-materialized-view-on-steroids-how-we-made-continuous-aggregates-even-better/)，我们一直在控制我们的表大小，并具有出色的性能。

✨

编者注：有关更多比较和基准测试，请参阅 Timescale 与 Amazon RDS for PostgreSQL 的比较。要了解更多信息并亲自试用 Timescale，请参阅我们的[.]分步 Timescale 教程
Timescale 对我们来说非常好，它引发了一波向堆栈其他部分的托管解决方案的过渡。**我们最近将我们的 Amazon RDS 数据迁移到 Timescale，以进一步简化我们的数据基础设施，并使其更容易、更快速地处理我们的数据。**

我们大约 20% 的数据是保存在关系数据库中的元数据。我们将这些模式从 Amazon RDS for PostgreSQL 迁移到 Timescale。迁移非常简单：在 PostgreSQL 模式之间移动非常简单。

从一开始，我们就选择了 RDS，因为它很简单。最终，一旦我们启动并运行了 Timescale，很明显，当我们使用 Timescale 获得如此好的结果时，我们不需要两个单独的 PostgreSQL 供应商。

Timescale 在同一数据库中支持传统模式和时序数据的能力使我们能够整合到一个存储解决方案中。实例成倍增加，因为我们为每个数据库保留三个环境（开发、暂存和生产），因此我们从六个（三个 RDS 加上三个 Timescale）减少到只有三个 Timescale 实例。

正如您在下面的图表中看到的，我们的传感器不直接与 TimescaleDB 通信；它们通过我们专有的无线协议将测量数据包传递给网关。从那里，我们使用 [MQTT](https://mqtt.org/) 将这些数据包发送到我们的云。

从我们的云数据代理，[Kafka](https://kafka.apache.org/) 处理并将数据包路由到 TimescaleDB（和 Timescale），我们的 TimescaleDB 数据库为我们的仪表板和分析工具提供支持。我们还添加了第三个组件：我们平台用户的出站通道。

*Everactive 架构图*

与 Amazon RDS for PostgreSQL 相比，Timescale 还整合了与在 AWS 中运营我们的实例相关的许多成本——我们现在有了一个更简单的账单，可以更轻松地预测成本。

从运营的角度来看，处理更少的实例并更多地依赖 Timescale 支持团队进行基础设施维护，大大减少了我们的数据库维护工作量。我们的安全运营也受益于迁移，这再次归功于整合以及将某些职责转移给 Timescale。

✨ *编者注：**了解我们的支持团队如何在托管数据库支持方面提高标准**。*

我们将继续在我们的技术平台上进行创新，并增加 Everactive 的产品，包括提高我们传感器的无线范围，降低功耗要求以提高能量收集效率，与更多传感器集成，以及缩小设备外形尺寸。这些连续的芯片平台增强功能将使我们能够监控越来越多的资产的状况，并且我们还在开发一种定位功能来识别资产的*部署位置*。

最终，Everactive 的使命是从大量当前未数字化的物理世界资产中生成新的、海量的数据集。将这些数据转化为有意义的见解有可能从根本上改善我们的生活方式——影响我们管理工作场所、关爱环境、与社区互动以及管理我们个人健康的方式。

# 建议和资源

如果您正在评估您的数据库选项，以下是基于我们经验的两项建议。首先，如果您有足够的时序数据，以至于通用数据库无法满足您的需求（数百万行），那么 TimescaleDB 应该是您的首选。它很容易尝试，[文档很棒](https://docs.timescale.com/)，并且[社区](http://slack.timescale.com/) 非常有帮助。

其次，不要低估使用利用许多/大多数后端开发人员共享的广泛知识库的解决方案的重要性。与 OpenTSDB（一种建立在 HBase 上的深奥的东西）相比，TimescaleDB 带来的团队吞吐量增加和入职时间减少——每个人至少都知道*一些* SQL——一直是一个巨大的优势。我们在某种程度上预料到了这一点，但亲身体验后证实了它的价值。

此外，上面讨论的模式即代码工具和内部/外部模式分离的使用也是我们成功的基石。我们之前在 Everactive 并没有使用这些工具和模式，但此后看到它们在其他项目和团队中流行起来。

*想阅读更多开发人员成功案例吗？**注册我们的新闻通讯**，获取更多开发人员问答、技术文章、技巧和教程，以便更好地利用您的数据——每月两次直接发送到您的收件箱。*

*我们要感谢 Carlos, Dan, Clayton 和 Everactive 团队的所有人分享他们的故事（特别感谢 Brian, Joe, Carlos, Greg, 和 Elise 对这篇文章的贡献！）。我们赞赏你们为全球组织带来可持续、经济高效的传感器和易于操作的数据所做的努力 🙌。*
这篇博文最初于 2021 年 2 月发表**[在此](https://www.example.com)**，并于 2023 年 2 月更新，以反映 Everactive 的数据栈和业务发展。