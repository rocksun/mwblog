<!--
title: 从Kubernetes的探针到DevOps
cover: 
-->

今天在群里又看有人问如何设置 Kubernetes 的探针，感觉要补充的话太多了，结合我们在一些 DevOps 项目中痛苦的体验，今天一劳永逸的全部说完，此外，也为大家展现一下为什么 DevOps 这么难？

## 微观的作用

从微观上讲，探针的作用很简单，之前我也[发文](https://yylives.cc/2022/11/17/liveness-and-readiness/)澄清过许多人的一些概念不清，本文是希望让运维和开发都能理解，所以会尽量简单的表达。

探针功能是 Kubernetes 提供的一个侦测应用是否正常的检查机制。最常见的探测方式是 HTTP 探测，应用需要暴露一个接口，Kubernetes 会定期调用该接口，如果接口返回 200 状态码，则认为应用正常，否则认为应用异常。

一般情况下会需要为应用配置两个探针，分别是存活（liveness）探针和就绪（readiness）探针。存活探针可以在应用有问题时触发重启，应用应该能够在重启后重新恢复正常。而就绪探针，保证应用有问题时切断流量，避免该应用被调用到：

![](https://yylives.cc/wp-content/uploads/2023/12/liveness-and-readiness.png)

如果只是从微观角度看，似乎二者的区别不大，配置一个相同的应用接口似乎也没啥问题，那为什么还要设置两个不同的探针呢？“假设” Kubernetes 的开发者是理智的，则肯定有原因，这个原因先不分析，后面再说。

## 宏观的意义

运维的朋友，尤其是做过微服务应用运维的朋友，一定见识过某个基础组件或上游服务出故障的情况吧？可观测做的“到位”，可能是满大屏的**红色惊叹号**。《发布！设计与部署稳定的分布式系统》书中将这个稳定性反模式叫做“[级联效应](https://www.bilibili.com/video/BV13Q4y1K7FU/)”：


![](https://yylives.cc/wp-content/uploads/2023/12/chain.png)

产生级联效应的过程，可以用以下图来展示：

![](https://yylives.cc/wp-content/uploads/2023/12/jilian.png)

当上游的 Pod 不可用时，其下游的 Pod 也会失效，然后传播到所有相关的 Pod 中。

此时此刻，一个脑子正常的可观测性工具应该如何报告问题，显然它应该告诉我们始作俑者，而不要。



也许有一些可观测性工具陶醉于定位级联效应中找到那第一个失效的 Pod，但我们为什么不去设法避免链式反应的发生呢？探针正是实现这一目标的重要一环。





此外，这种链式反应的故障恢复时，也绝非“病去如抽丝”，可能不断会遇到个别的业务问题，有时运维人员需要去手工重启服务才能解决。

## 探针如何发挥作用




## 参考

- [1] 稳定性的反模式之链式反应和级联故障: https://www.bilibili.com/video/BV13Q4y1K7FU/
- 